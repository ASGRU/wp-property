<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>lib/shortcodes/property-overview.php - usabilitydynamics/wp-property</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="usabilitydynamics/wp-property"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 2.0.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/Bootstrap.html">Bootstrap</a></li>
            
                <li><a href="../classes/UsabilityDynamics\WPP.Bootstrap.html">UsabilityDynamics\WPP.Bootstrap</a></li>
            
                <li><a href="../classes/UsabilityDynamics\WPP.Loader.html">UsabilityDynamics\WPP.Loader</a></li>
            
                <li><a href="../classes/WPP.html">WPP</a></li>
            
                <li><a href="../classes/WPP_UI.html">WPP_UI</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: lib/shortcodes/property-overview.php</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&lt;?php
/**
 * Displays property overview
 *
 * Performs searching/filtering functions, provides template with $properties file
 * Retirms html content to be displayed after location attribute on property edit page
 *
 * @since 1.081
 *
 * @param string $atts
 *
 * @internal param string $listing_id Listing ID must be passed
 *
 * @return string $result
 *
 * @uses \UsabilityDynamics\WPP\Utility::get_properties()
 */
namespace UsabilityDynamics\WPP {

  if( !class_exists( &#x27;UsabilityDynamics\WPP\Property_Overview&#x27; ) ) {

    /**
     * Displays property overview
     * Performs searching/filtering functions, provides template with $properties file
     * Retirms html content to be displayed after location attribute on property edit page
     *
     * @since 1.081
     *
     * @param string $atts
     * @param string $content
     *
     * @internal param string $listing_id Listing ID must be passed
     *
     * @return string $result
     * @uses \UsabilityDynamics\WPP\Utility::get_properties()
     */
    class Property_Overview extends \UsabilityDynamics\WPP\Shortcode {

      function __construct( $atts = &#x27;&#x27;, $content = &#x27;&#x27; ) {
        global $wp_properties, $wpp_query, $property, $post, $wp_query;

        \UsabilityDynamics\WPP\Utility::wp_enqueue_script( &#x27;jquery-ui-widget&#x27; );
        \UsabilityDynamics\WPP\Utility::wp_enqueue_script( &#x27;jquery-ui-mouse&#x27; );
        \UsabilityDynamics\WPP\Utility::wp_enqueue_script( &#x27;jquery-ui-slider&#x27; );
        \UsabilityDynamics\WPP\Utility::wp_enqueue_script( &#x27;jquery-address&#x27; );
        \UsabilityDynamics\WPP\Utility::wp_enqueue_script( &#x27;jquery-scrollto&#x27; );
        \UsabilityDynamics\WPP\Utility::wp_enqueue_script( &#x27;jquery-fancybox&#x27; );
        \UsabilityDynamics\WPP\Utility::wp_enqueue_script( &#x27;wp-property-frontend&#x27; );

        /** This needs to be done because a key has to exist in the $deafult array for shortcode_atts() to load passed value */
        foreach( (array) \UsabilityDynamics\WPP\Utility::get_queryable_keys() as $key ) {
          $queryable_keys[ $key ] = false;
        }

        /** Allow the shorthand of &quot;type&quot; as long as there is not a custom attribute of &quot;type&quot;. If &quot;type&quot; does exist as an attribute, then users need to use the full &quot;property_type&quot; query tag. **/
        if( !array_key_exists( &#x27;type&#x27;, $queryable_keys ) &amp;&amp; ( is_array( $atts ) &amp;&amp; array_key_exists( &#x27;type&#x27;, $atts ) ) ) {
          $atts[ &#x27;property_type&#x27; ] = $atts[ &#x27;type&#x27; ];
          unset( $atts[ &#x27;type&#x27; ] );
        }

        /** Get ALL allowed attributes that may be passed via shortcode ( to include property attributes ) */
        $defaults[ &#x27;child_properties_title&#x27; ] = __( &#x27;Floor plans at location:&#x27;, &#x27;wpp&#x27; );
        $defaults[ &#x27;per_page&#x27; ]               = get_option( &#x27;posts_per_page&#x27; ) ? get_option( &#x27;posts_per_page&#x27; ) : 10;

        $defaults[ &#x27;fancybox_preview&#x27; ] = $wp_properties[ &#x27;configuration&#x27; ][ &#x27;property_overview&#x27; ][ &#x27;fancybox_preview&#x27; ];
        $defaults[ &#x27;thumbnail_size&#x27; ]   = $wp_properties[ &#x27;configuration&#x27; ][ &#x27;property_overview&#x27; ][ &#x27;thumbnail_size&#x27; ];

        $defaults[ &#x27;show_children&#x27; ]          = ( isset( $wp_properties[ &#x27;configuration&#x27; ][ &#x27;property_overview&#x27; ][ &#x27;show_children&#x27; ] ) ? $wp_properties[ &#x27;configuration&#x27; ][ &#x27;property_overview&#x27; ][ &#x27;show_children&#x27; ] : &#x27;true&#x27; );
        $defaults[ &#x27;bottom_pagination_flag&#x27; ] = ( $wp_properties[ &#x27;configuration&#x27; ][ &#x27;bottom_insert_pagenation&#x27; ] == &#x27;true&#x27; ? true : false );
        $defaults[ &#x27;sorter_type&#x27; ]            = $wp_properties[ &#x27;configuration&#x27; ][ &#x27;property_overview&#x27; ][ &#x27;sorter_type&#x27; ] ? $wp_properties[ &#x27;configuration&#x27; ][ &#x27;property_overview&#x27; ][ &#x27;sorter_type&#x27; ] : &#x27;buttons&#x27;;

        $defaults[ &#x27;sort_by_text&#x27; ]    = __( &#x27;Sort By:&#x27;, &#x27;wpp&#x27; );
        $defaults[ &#x27;sort_by&#x27; ]         = &#x27;menu_order&#x27;;
        $defaults[ &#x27;sort_order&#x27; ]      = &#x27;ASC&#x27;;
        $defaults[ &#x27;template&#x27; ]        = false;
        $defaults[ &#x27;ajax_call&#x27; ]       = false;
        $defaults[ &#x27;disable_wrapper&#x27; ] = false;
        $defaults[ &#x27;pagination&#x27; ]      = &#x27;on&#x27;;
        $defaults[ &#x27;hide_count&#x27; ]      = false;
        $defaults[ &#x27;starting_row&#x27; ]    = 0;
        $defaults[ &#x27;unique_hash&#x27; ]     = rand( 10000, 99900 );
        $defaults[ &#x27;detail_button&#x27; ]   = false;
        $defaults[ &#x27;stats&#x27; ]           = &#x27;&#x27;;
        $defaults[ &#x27;class&#x27; ]           = &#x27;wpp_property_overview_shortcode&#x27;;
        $defaults[ &#x27;in_new_window&#x27; ]   = false;

        $defaults = apply_filters( &#x27;shortcode_property_overview_allowed_args&#x27;, $defaults, $atts );

        if( !empty( $atts[ &#x27;ajax_call&#x27; ] ) ) {

          /** If AJAX call then the passed args have all the data we need */
          $wpp_query = $atts;

          //* Fix ajax data. Boolean value false is returned as string &#x27;false&#x27;. */
          foreach( (array) $wpp_query as $key =&gt; $value ) {
            if( $value == &#x27;false&#x27; ) {
              $wpp_query[ $key ] = false;
            }
          }

          $wpp_query[ &#x27;ajax_call&#x27; ] = true;

          /** Everything stays the same except for sort order and page */
          $wpp_query[ &#x27;starting_row&#x27; ] = ( ( $wpp_query[ &#x27;requested_page&#x27; ] - 1 ) * $wpp_query[ &#x27;per_page&#x27; ] );

          /** Figure out current page */
          $wpp_query[ &#x27;current_page&#x27; ] = $wpp_query[ &#x27;requested_page&#x27; ];

        } else {

          /** Merge defaults with passed arguments */
          $wpp_query            = shortcode_atts( $defaults, $atts );
          $wpp_query[ &#x27;query&#x27; ] = shortcode_atts( $queryable_keys, $atts );

          /** Handle search */
          if( $wpp_search = $_REQUEST[ &#x27;wpp_search&#x27; ] ) {
            $wpp_query[ &#x27;query&#x27; ] = shortcode_atts( $wpp_query[ &#x27;query&#x27; ], $wpp_search );
            $wpp_query[ &#x27;query&#x27; ] = \UsabilityDynamics\WPP\Utility::prepare_search_attributes( $wpp_query[ &#x27;query&#x27; ] );

            if( isset( $_REQUEST[ &#x27;wpp_search&#x27; ][ &#x27;sort_by&#x27; ] ) ) {
              $wpp_query[ &#x27;sort_by&#x27; ] = $_REQUEST[ &#x27;wpp_search&#x27; ][ &#x27;sort_by&#x27; ];
            }

            if( isset( $_REQUEST[ &#x27;wpp_search&#x27; ][ &#x27;sort_order&#x27; ] ) ) {
              $wpp_query[ &#x27;sort_order&#x27; ] = $_REQUEST[ &#x27;wpp_search&#x27; ][ &#x27;sort_order&#x27; ];
            }

            if( isset( $_REQUEST[ &#x27;wpp_search&#x27; ][ &#x27;pagination&#x27; ] ) ) {
              $wpp_query[ &#x27;pagination&#x27; ] = $_REQUEST[ &#x27;wpp_search&#x27; ][ &#x27;pagination&#x27; ];
            }

            if( isset( $_REQUEST[ &#x27;wpp_search&#x27; ][ &#x27;per_page&#x27; ] ) ) {
              $wpp_query[ &#x27;per_page&#x27; ] = $_REQUEST[ &#x27;wpp_search&#x27; ][ &#x27;per_page&#x27; ];
            }
          }

        }

        /** Load certain settings into query for get_properties() to use */
        $wpp_query[ &#x27;query&#x27; ][ &#x27;sort_by&#x27; ]    = $wpp_query[ &#x27;sort_by&#x27; ];
        $wpp_query[ &#x27;query&#x27; ][ &#x27;sort_order&#x27; ] = $wpp_query[ &#x27;sort_order&#x27; ];
        $wpp_query[ &#x27;query&#x27; ][ &#x27;pagi&#x27; ]       = $wpp_query[ &#x27;starting_row&#x27; ] . &#x27;--&#x27; . $wpp_query[ &#x27;per_page&#x27; ];

        if( !isset( $wpp_query[ &#x27;current_page&#x27; ] ) ) {
          $wpp_query[ &#x27;current_page&#x27; ] = ( $wpp_query[ &#x27;starting_row&#x27; ] / $wpp_query[ &#x27;per_page&#x27; ] ) + 1;
        }

        /** Load settings that are not passed via shortcode atts */
        $wpp_query[ &#x27;sortable_attrs&#x27; ] = \UsabilityDynamics\WPP\Utility::get_sortable_keys();

        /** Detect currently property for conditional in-shortcode usage that will be replaced from values */
        if( isset( $post ) ) {

          $dynamic_fields[ &#x27;post_id&#x27; ]       = $post-&gt;ID;
          $dynamic_fields[ &#x27;post_parent&#x27; ]   = $post-&gt;parent_id;
          $dynamic_fields[ &#x27;property_type&#x27; ] = $post-&gt;property_type;

          $dynamic_fields = apply_filters( &#x27;shortcode_property_overview_dynamic_fields&#x27;, $dynamic_fields );

          if( is_array( $dynamic_fields ) ) {
            foreach( (array) $wpp_query[ &#x27;query&#x27; ] as $query_key =&gt; $query_value ) {
              if( !empty( $dynamic_fields[ $query_value ] ) ) {
                $wpp_query[ &#x27;query&#x27; ][ $query_key ] = $dynamic_fields[ $query_value ];
              }
            }
          }
        }

        /** Remove all blank values */
        $wpp_query[ &#x27;query&#x27; ] = array_filter( $wpp_query[ &#x27;query&#x27; ] );

        /** Unset this because it gets passed with query ( for back-button support ) but not used by get_properties() */
        unset( $wpp_query[ &#x27;query&#x27; ][ &#x27;per_page&#x27; ] );
        unset( $wpp_query[ &#x27;query&#x27; ][ &#x27;pagination&#x27; ] );
        unset( $wpp_query[ &#x27;query&#x27; ][ &#x27;requested_page&#x27; ] );

        /** Load the results */
        $wpp_query[ &#x27;properties&#x27; ] = \UsabilityDynamics\WPP\Utility::get_properties( $wpp_query[ &#x27;query&#x27; ], true );

        /** Calculate number of pages */
        if( $wpp_query[ &#x27;pagination&#x27; ] == &#x27;on&#x27; ) {
          $wpp_query[ &#x27;pages&#x27; ] = ceil( $wpp_query[ &#x27;properties&#x27; ][ &#x27;total&#x27; ] / $wpp_query[ &#x27;per_page&#x27; ] );
        }

        /** Set for quick access ( for templates */
        $property_type = $wpp_query[ &#x27;query&#x27; ][ &#x27;property_type&#x27; ];

        if( !empty( $property_type ) ) {
          foreach( (array) $wp_properties[ &#x27;hidden_attributes&#x27; ][ $property_type ] as $attr_key ) {
            unset( $wpp_query[ &#x27;sortable_attrs&#x27; ][ $attr_key ] );
          }
        }

        /** Legacy Support - include variables so old templates still work */
        $properties             = $wpp_query[ &#x27;properties&#x27; ][ &#x27;results&#x27; ];
        $thumbnail_sizes        = \UsabilityDynamics\WPP\Utility::image_sizes( $wpp_query[ &#x27;thumbnail_size&#x27; ] );
        $child_properties_title = $wpp_query[ &#x27;child_properties_title&#x27; ];
        $unique                 = $wpp_query[ &#x27;unique_hash&#x27; ];
        $thumbnail_size         = $wpp_query[ &#x27;thumbnail_size&#x27; ];

        //* Debugger */
        if( $wp_properties[ &#x27;configuration&#x27; ][ &#x27;developer_mode&#x27; ] == &#x27;true&#x27; &amp;&amp; !$wpp_query[ &#x27;ajax_call&#x27; ] ) {
          echo &#x27;&lt;script type=&quot;text/javascript&quot;&gt;console.log( &#x27; . json_encode( $wpp_query ) . &#x27; ); &lt;/script&gt;&#x27;;
        }

        ob_start();

        /** Make certain variables available to be used within the single listing page */
        $wpp_overview_shortcode_vars = apply_filters( &#x27;wpp_overview_shortcode_vars&#x27;, array(
          &#x27;wp_properties&#x27; =&gt; $wp_properties,
          &#x27;wpp_query&#x27;     =&gt; $wpp_query
        ) );

        /** By merging our extra variables into $wp_query-&gt;query_vars they will be extracted in load_template() */
        if( is_array( $wpp_overview_shortcode_vars ) ) {
          $wp_query-&gt;query_vars = array_merge( $wp_query-&gt;query_vars, (array) $wpp_overview_shortcode_vars );
        }

        $template         = $wpp_query[ &#x27;template&#x27; ];
        $fancybox_preview = $wpp_query[ &#x27;fancybox_preview&#x27; ];
        $show_children    = $wpp_query[ &#x27;show_children&#x27; ];
        $class            = $wpp_query[ &#x27;class&#x27; ];
        $stats            = $wpp_query[ &#x27;stats&#x27; ];
        $in_new_window    = ( !empty( $wpp_query[ &#x27;in_new_window&#x27; ] ) ? &quot; target=\&quot;_blank\&quot; &quot; : &quot;&quot; );

        /** Make query_vars available to emulate WP template loading */
        extract( $wp_query-&gt;query_vars, EXTR_SKIP );

        /** Try find custom template */
        $template_found = \UsabilityDynamics\WPP\Utility::get_template_part( array(
          &quot;property-overview-{$template}&quot;,
          &quot;property-overview-{$property_type}&quot;,
          &quot;property-{$template}&quot;,
          &quot;property-overview&quot;,
        ), array( WPP_Templates ) );

        if( $template_found ) {
          include $template_found;
        }

        $ob_get_contents = ob_get_contents();
        ob_end_clean();

        $ob_get_contents = apply_filters( &#x27;shortcode_property_overview_content&#x27;, $ob_get_contents, $wpp_query );

        // Initialize result ( content which will be shown ) and open wrap ( div ) with unique id
        if( $wpp_query[ &#x27;disable_wrapper&#x27; ] != &#x27;true&#x27; ) {
          $result[ &#x27;top&#x27; ] = &#x27;&lt;div id=&quot;wpp_shortcode_&#x27; . $defaults[ &#x27;unique_hash&#x27; ] . &#x27;&quot; class=&quot;wpp_ui &#x27; . $wpp_query[ &#x27;class&#x27; ] . &#x27;&quot;&gt;&#x27;;
        }

        $result[ &#x27;top_pagination&#x27; ] = wpp_draw_pagination( array( &#x27;return&#x27; =&gt; true, &#x27;class&#x27; =&gt; &#x27;wpp_top_pagination&#x27;, &#x27;sorter_type&#x27; =&gt; $wpp_query[ &#x27;sorter_type&#x27; ], &#x27;hide_count&#x27; =&gt; $hide_count, &#x27;sort_by_text&#x27; =&gt; $wpp_query[ &#x27;sort_by_text&#x27; ] ) );
        $result[ &#x27;result&#x27; ]         = $ob_get_contents;

        if( $wpp_query[ &#x27;bottom_pagination_flag&#x27; ] == &#x27;true&#x27; ) {
          $result[ &#x27;bottom_pagination&#x27; ] = wpp_draw_pagination( array( &#x27;return&#x27; =&gt; true, &#x27;class&#x27; =&gt; &#x27;wpp_bottom_pagination&#x27;, &#x27;sorter_type&#x27; =&gt; $wpp_query[ &#x27;sorter_type&#x27; ], &#x27;hide_count&#x27; =&gt; $hide_count, &#x27;sort_by_text&#x27; =&gt; $wpp_query[ &#x27;sort_by_text&#x27; ] ) );
        }

        if( $wpp_query[ &#x27;disable_wrapper&#x27; ] != &#x27;true&#x27; ) {
          $result[ &#x27;bottom&#x27; ] = &#x27;&lt;/div&gt;&#x27;;
        }

        $result = apply_filters( &#x27;wpp_property_overview_render&#x27;, $result );

        if( $wpp_query[ &#x27;ajax_call&#x27; ] ) {
          return json_encode( array( &#x27;wpp_query&#x27; =&gt; $wpp_query, &#x27;display&#x27; =&gt; implode( &#x27;&#x27;, $result ) ) );
        } else {
          return implode( &#x27;&#x27;, $result );
        }
      }

      /**
       * Return property overview data for AJAX calls
       *
       * @since 0.723
       *
       * @uses WPP_Core::shortcode_property_overview()
       *
       */
      static function ajax_property_overview() {

        $params = $_REQUEST[ &#x27;wpp_ajax_query&#x27; ];

        if( !empty( $params[ &#x27;action&#x27; ] ) ) {
          unset( $params[ &#x27;action&#x27; ] );
        }

        $params[ &#x27;ajax_call&#x27; ] = true;

        $data = WPP_Core::shortcode_property_overview( $params );

        die( $data );

      }

      static function shortcode_property_overview( $atts = &quot;&quot; ) {
        global $wp_properties, $wpp_query, $property, $post, $wp_query;

        $atts = wp_parse_args( $atts, array(
          &#x27;strict_search&#x27; =&gt; &#x27;false&#x27;
        ) );

        \UsabilityDynamics\WPP\Utility::force_script_inclusion( &#x27;jquery-ui-widget&#x27; );
        \UsabilityDynamics\WPP\Utility::force_script_inclusion( &#x27;jquery-ui-mouse&#x27; );
        \UsabilityDynamics\WPP\Utility::force_script_inclusion( &#x27;jquery-ui-slider&#x27; );
        \UsabilityDynamics\WPP\Utility::force_script_inclusion( &#x27;wpp-jquery-address&#x27; );
        \UsabilityDynamics\WPP\Utility::force_script_inclusion( &#x27;wpp-jquery-scrollTo&#x27; );
        \UsabilityDynamics\WPP\Utility::force_script_inclusion( &#x27;wpp-jquery-fancybox&#x27; );
        \UsabilityDynamics\WPP\Utility::force_script_inclusion( &#x27;wp-property-frontend&#x27; );

        //** Load all queriable attributes **/
        foreach( \UsabilityDynamics\WPP\Utility::get_queryable_keys() as $key ) {
          //** This needs to be done because a key has to exist in the $deafult array for shortcode_atts() to load passed value */
          $queryable_keys[ $key ] = false;
        }

        //** Allow the shorthand of &quot;type&quot; as long as there is not a custom attribute of &quot;type&quot;. If &quot;type&quot; does exist as an attribute, then users need to use the full &quot;property_type&quot; query tag. **/
        if( !array_key_exists( &#x27;type&#x27;, $queryable_keys ) &amp;&amp; ( is_array( $atts ) &amp;&amp; array_key_exists( &#x27;type&#x27;, $atts ) ) ) {
          $atts[ &#x27;property_type&#x27; ] = $atts[ &#x27;type&#x27; ];
          unset( $atts[ &#x27;type&#x27; ] );
        }

        //** Get ALL allowed attributes that may be passed via shortcode (to include property attributes) */
        $defaults[ &#x27;show_children&#x27; ]          = ( isset( $wp_properties[ &#x27;configuration&#x27; ][ &#x27;property_overview&#x27; ][ &#x27;show_children&#x27; ] ) ? $wp_properties[ &#x27;configuration&#x27; ][ &#x27;property_overview&#x27; ][ &#x27;show_children&#x27; ] : &#x27;true&#x27; );
        $defaults[ &#x27;child_properties_title&#x27; ] = __( &#x27;Floor plans at location:&#x27;, &#x27;wpp&#x27; );
        $defaults[ &#x27;fancybox_preview&#x27; ]       = $wp_properties[ &#x27;configuration&#x27; ][ &#x27;property_overview&#x27; ][ &#x27;fancybox_preview&#x27; ];
        $defaults[ &#x27;bottom_pagination_flag&#x27; ] = ( $wp_properties[ &#x27;configuration&#x27; ][ &#x27;bottom_insert_pagenation&#x27; ] == &#x27;true&#x27; ? true : false );
        $defaults[ &#x27;thumbnail_size&#x27; ]         = $wp_properties[ &#x27;configuration&#x27; ][ &#x27;property_overview&#x27; ][ &#x27;thumbnail_size&#x27; ];
        $defaults[ &#x27;sort_by_text&#x27; ]           = __( &#x27;Sort By:&#x27;, &#x27;wpp&#x27; );
        $defaults[ &#x27;sort_by&#x27; ]                = &#x27;post_date&#x27;;
        $defaults[ &#x27;sort_order&#x27; ]             = &#x27;DESC&#x27;;
        $defaults[ &#x27;template&#x27; ]               = false;
        $defaults[ &#x27;ajax_call&#x27; ]              = false;
        $defaults[ &#x27;disable_wrapper&#x27; ]        = false;
        $defaults[ &#x27;sorter_type&#x27; ]            = &#x27;buttons&#x27;;
        $defaults[ &#x27;pagination&#x27; ]             = &#x27;on&#x27;;
        $defaults[ &#x27;hide_count&#x27; ]             = false;
        $defaults[ &#x27;per_page&#x27; ]               = 10;
        $defaults[ &#x27;starting_row&#x27; ]           = 0;
        $defaults[ &#x27;unique_hash&#x27; ]            = rand( 10000, 99900 );
        $defaults[ &#x27;detail_button&#x27; ]          = false;
        $defaults[ &#x27;stats&#x27; ]                  = &#x27;&#x27;;
        $defaults[ &#x27;class&#x27; ]                  = &#x27;wpp_property_overview_shortcode&#x27;;
        $defaults[ &#x27;in_new_window&#x27; ]          = false;

        $defaults = apply_filters( &#x27;shortcode_property_overview_allowed_args&#x27;, $defaults, $atts );

        //** We add # to value which says that we don&#x27;t want to use LIKE in SQL query for searching this value. */
        $required_strict_search = apply_filters( &#x27;wpp::required_strict_search&#x27;, array( &#x27;wpp_agents&#x27; ) );
        foreach( $atts as $key =&gt; $val ) {
          if( ( ( $atts[ &#x27;strict_search&#x27; ] == &#x27;true&#x27; &amp;&amp; isset( $wp_properties[ &#x27;property_stats&#x27; ][ $key ] ) ) ||
              in_array( $key, $required_strict_search ) ) &amp;&amp;
            !key_exists( $key, $defaults ) &amp;&amp; $key != &#x27;property_type&#x27;
          ) {
            if( substr_count( $val, &#x27;,&#x27; ) || substr_count( $val, &#x27;&amp;ndash;&#x27; ) || substr_count( $val, &#x27;--&#x27; ) ) {
              continue;
            }
            $atts[ $key ] = &#x27;#&#x27; . $val . &#x27;#&#x27;;
          }
        }

        if( !empty( $atts[ &#x27;ajax_call&#x27; ] ) ) {
          //** If AJAX call then the passed args have all the data we need */
          $wpp_query = $atts;

          //* Fix ajax data. Boolean value false is returned as string &#x27;false&#x27;. */
          foreach( $wpp_query as $key =&gt; $value ) {
            if( $value == &#x27;false&#x27; ) {
              $wpp_query[ $key ] = false;
            }
          }

          $wpp_query[ &#x27;ajax_call&#x27; ] = true;

          //** Everything stays the same except for sort order and page */
          $wpp_query[ &#x27;starting_row&#x27; ] = ( ( $wpp_query[ &#x27;requested_page&#x27; ] - 1 ) * $wpp_query[ &#x27;per_page&#x27; ] );

          //** Figure out current page */
          $wpp_query[ &#x27;current_page&#x27; ] = $wpp_query[ &#x27;requested_page&#x27; ];

        } else {
          /** Determine if fancybox style is included */
          \UsabilityDynamics\WPP\Utility::force_style_inclusion( &#x27;wpp-jquery-fancybox-css&#x27; );

          //** Merge defaults with passed arguments */
          $wpp_query            = shortcode_atts( $defaults, $atts );
          $wpp_query[ &#x27;query&#x27; ] = shortcode_atts( $queryable_keys, $atts );

          //** Handle search */
          if( $wpp_search = $_REQUEST[ &#x27;wpp_search&#x27; ] ) {
            $wpp_query[ &#x27;query&#x27; ] = shortcode_atts( $wpp_query[ &#x27;query&#x27; ], $wpp_search );
            $wpp_query[ &#x27;query&#x27; ] = \UsabilityDynamics\WPP\Utility::prepare_search_attributes( $wpp_query[ &#x27;query&#x27; ] );

            if( isset( $_REQUEST[ &#x27;wpp_search&#x27; ][ &#x27;sort_by&#x27; ] ) ) {
              $wpp_query[ &#x27;sort_by&#x27; ] = $_REQUEST[ &#x27;wpp_search&#x27; ][ &#x27;sort_by&#x27; ];
            }

            if( isset( $_REQUEST[ &#x27;wpp_search&#x27; ][ &#x27;sort_order&#x27; ] ) ) {
              $wpp_query[ &#x27;sort_order&#x27; ] = $_REQUEST[ &#x27;wpp_search&#x27; ][ &#x27;sort_order&#x27; ];
            }

            if( isset( $_REQUEST[ &#x27;wpp_search&#x27; ][ &#x27;pagination&#x27; ] ) ) {
              $wpp_query[ &#x27;pagination&#x27; ] = $_REQUEST[ &#x27;wpp_search&#x27; ][ &#x27;pagination&#x27; ];
            }

            if( isset( $_REQUEST[ &#x27;wpp_search&#x27; ][ &#x27;per_page&#x27; ] ) ) {
              $wpp_query[ &#x27;per_page&#x27; ] = $_REQUEST[ &#x27;wpp_search&#x27; ][ &#x27;per_page&#x27; ];
            }
          }

        }

        //** Load certain settings into query for get_properties() to use */
        $wpp_query[ &#x27;query&#x27; ][ &#x27;sort_by&#x27; ]    = $wpp_query[ &#x27;sort_by&#x27; ];
        $wpp_query[ &#x27;query&#x27; ][ &#x27;sort_order&#x27; ] = $wpp_query[ &#x27;sort_order&#x27; ];

        $wpp_query[ &#x27;query&#x27; ][ &#x27;pagi&#x27; ] = $wpp_query[ &#x27;starting_row&#x27; ] . &#x27;--&#x27; . $wpp_query[ &#x27;per_page&#x27; ];

        if( !isset( $wpp_query[ &#x27;current_page&#x27; ] ) ) {
          $wpp_query[ &#x27;current_page&#x27; ] = ( $wpp_query[ &#x27;starting_row&#x27; ] / $wpp_query[ &#x27;per_page&#x27; ] ) + 1;
        }

        //** Load settings that are not passed via shortcode atts */
        $wpp_query[ &#x27;sortable_attrs&#x27; ] = \UsabilityDynamics\WPP\Utility::get_sortable_keys();

        //** Replace dynamic field values */

        //** Detect currently property for conditional in-shortcode usage that will be replaced from values */
        if( isset( $post ) ) {

          $dynamic_fields[ &#x27;post_id&#x27; ]       = $post-&gt;ID;
          $dynamic_fields[ &#x27;post_parent&#x27; ]   = $post-&gt;parent_id;
          $dynamic_fields[ &#x27;property_type&#x27; ] = $post-&gt;property_type;

          $dynamic_fields = apply_filters( &#x27;shortcode_property_overview_dynamic_fields&#x27;, $dynamic_fields );

          if( is_array( $dynamic_fields ) ) {
            foreach( $wpp_query[ &#x27;query&#x27; ] as $query_key =&gt; $query_value ) {
              if( !empty( $dynamic_fields[ $query_value ] ) ) {
                $wpp_query[ &#x27;query&#x27; ][ $query_key ] = $dynamic_fields[ $query_value ];
              }
            }
          }
        }

        //** Remove all blank values */
        $wpp_query[ &#x27;query&#x27; ] = array_filter( $wpp_query[ &#x27;query&#x27; ] );

        //** Unset this because it gets passed with query (for back-button support) but not used by get_properties() */
        unset( $wpp_query[ &#x27;query&#x27; ][ &#x27;per_page&#x27; ] );
        unset( $wpp_query[ &#x27;query&#x27; ][ &#x27;pagination&#x27; ] );
        unset( $wpp_query[ &#x27;query&#x27; ][ &#x27;requested_page&#x27; ] );

        //** Load the results */
        $wpp_query[ &#x27;properties&#x27; ] = \UsabilityDynamics\WPP\Utility::get_properties( $wpp_query[ &#x27;query&#x27; ], true );

        //** Calculate number of pages */
        if( $wpp_query[ &#x27;pagination&#x27; ] == &#x27;on&#x27; ) {
          $wpp_query[ &#x27;pages&#x27; ] = ceil( $wpp_query[ &#x27;properties&#x27; ][ &#x27;total&#x27; ] / $wpp_query[ &#x27;per_page&#x27; ] );
        }

        //** Set for quick access (for templates */
        $property_type = $wpp_query[ &#x27;query&#x27; ][ &#x27;property_type&#x27; ];

        if( !empty( $property_type ) ) {
          foreach( (array) $wp_properties[ &#x27;hidden_attributes&#x27; ][ $property_type ] as $attr_key ) {
            unset( $wpp_query[ &#x27;sortable_attrs&#x27; ][ $attr_key ] );
          }
        }

        //** Legacy Support - include variables so old templates still work */
        $properties             = $wpp_query[ &#x27;properties&#x27; ][ &#x27;results&#x27; ];
        $thumbnail_sizes        = \UsabilityDynamics\WPP\Utility::image_sizes( $wpp_query[ &#x27;thumbnail_size&#x27; ] );
        $child_properties_title = $wpp_query[ &#x27;child_properties_title&#x27; ];
        $unique                 = $wpp_query[ &#x27;unique_hash&#x27; ];
        $thumbnail_size         = $wpp_query[ &#x27;thumbnail_size&#x27; ];

        //* Debugger */
        if( $wp_properties[ &#x27;configuration&#x27; ][ &#x27;developer_mode&#x27; ] == &#x27;true&#x27; &amp;&amp; !$wpp_query[ &#x27;ajax_call&#x27; ] ) {
          echo &#x27;&lt;script type=&quot;text/javascript&quot;&gt;console.log( &#x27; . json_encode( $wpp_query ) . &#x27; ); &lt;/script&gt;&#x27;;
        }

        ob_start();

        //** Make certain variables available to be used within the single listing page */
        $wpp_overview_shortcode_vars = apply_filters( &#x27;wpp_overview_shortcode_vars&#x27;, array(
          &#x27;wp_properties&#x27; =&gt; $wp_properties,
          &#x27;wpp_query&#x27;     =&gt; $wpp_query
        ) );

        //** By merging our extra variables into $wp_query-&gt;query_vars they will be extracted in load_template() */
        if( is_array( $wpp_overview_shortcode_vars ) ) {
          $wp_query-&gt;query_vars = array_merge( $wp_query-&gt;query_vars, $wpp_overview_shortcode_vars );
        }

        $template         = $wpp_query[ &#x27;template&#x27; ];
        $fancybox_preview = $wpp_query[ &#x27;fancybox_preview&#x27; ];
        $show_children    = $wpp_query[ &#x27;show_children&#x27; ];
        $class            = $wpp_query[ &#x27;class&#x27; ];
        $stats            = $wpp_query[ &#x27;stats&#x27; ];
        $in_new_window    = ( !empty( $wpp_query[ &#x27;in_new_window&#x27; ] ) ? &quot; target=\&quot;_blank\&quot; &quot; : &quot;&quot; );

        //** Make query_vars available to emulate WP template loading */
        extract( $wp_query-&gt;query_vars, EXTR_SKIP );

        //** Try find custom template */
        $template_found = \UsabilityDynamics\WPP\Utility::get_template_part( array(
          &quot;property-overview-{$template}&quot;,
          &quot;property-overview-{$property_type}&quot;,
          &quot;property-{$template}&quot;,
          &quot;property-overview&quot;,
        ), array( WPP_Templates ) );

        if( $template_found ) {
          include $template_found;
        }

        $ob_get_contents = ob_get_contents();
        ob_end_clean();

        $ob_get_contents = apply_filters( &#x27;shortcode_property_overview_content&#x27;, $ob_get_contents, $wpp_query );

        // Initialize result (content which will be shown) and open wrap (div) with unique id
        if( $wpp_query[ &#x27;disable_wrapper&#x27; ] != &#x27;true&#x27; ) {
          $result[ &#x27;top&#x27; ] = &#x27;&lt;div id=&quot;wpp_shortcode_&#x27; . $defaults[ &#x27;unique_hash&#x27; ] . &#x27;&quot; class=&quot;wpp_ui &#x27; . $wpp_query[ &#x27;class&#x27; ] . &#x27;&quot;&gt;&#x27;;
        }

        $result[ &#x27;top_pagination&#x27; ] = wpp_draw_pagination( array(
          &#x27;class&#x27;        =&gt; &#x27;wpp_top_pagination&#x27;,
          &#x27;sorter_type&#x27;  =&gt; $wpp_query[ &#x27;sorter_type&#x27; ],
          &#x27;hide_count&#x27;   =&gt; $wpp_query[ &#x27;hide_count&#x27; ],
          &#x27;sort_by_text&#x27; =&gt; $wpp_query[ &#x27;sort_by_text&#x27; ],
        ) );
        $result[ &#x27;result&#x27; ]         = $ob_get_contents;

        if( $wpp_query[ &#x27;bottom_pagination_flag&#x27; ] == &#x27;true&#x27; ) {
          $result[ &#x27;bottom_pagination&#x27; ] = wpp_draw_pagination( array(
            &#x27;class&#x27;        =&gt; &#x27;wpp_bottom_pagination&#x27;,
            &#x27;sorter_type&#x27;  =&gt; $wpp_query[ &#x27;sorter_type&#x27; ],
            &#x27;hide_count&#x27;   =&gt; $wpp_query[ &#x27;hide_count&#x27; ],
            &#x27;sort_by_text&#x27; =&gt; $wpp_query[ &#x27;sort_by_text&#x27; ],
            &#x27;javascript&#x27;   =&gt; false
          ) );
        }

        if( $wpp_query[ &#x27;disable_wrapper&#x27; ] != &#x27;true&#x27; ) {
          $result[ &#x27;bottom&#x27; ] = &#x27;&lt;/div&gt;&#x27;;
        }

        $result = apply_filters( &#x27;wpp_property_overview_render&#x27;, $result );

        if( $wpp_query[ &#x27;ajax_call&#x27; ] ) {
          return json_encode( array( &#x27;wpp_query&#x27; =&gt; $wpp_query, &#x27;display&#x27; =&gt; implode( &#x27;&#x27;, $result ) ) );
        } else {
          return implode( &#x27;&#x27;, $result );
        }
      }

    }

  }

}
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
