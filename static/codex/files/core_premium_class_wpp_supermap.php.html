<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>core/premium/class_wpp_supermap.php - WP-Property</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="WP-Property"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 1.38.2</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/wpp.html">wpp</a></li>
            
                <li><a href="../classes/wpp.overview.html">wpp.overview</a></li>
            
                <li><a href="../classes/wpp.ui.agents.html">wpp.ui.agents</a></li>
            
                <li><a href="../classes/wpp.ui.feps.html">wpp.ui.feps</a></li>
            
                <li><a href="../classes/wpp.ui.settings.html">wpp.ui.settings</a></li>
            
                <li><a href="../classes/wpp.xmli.html">wpp.xmli</a></li>
            
                <li><a href="../classes/WPP_RETS.html">WPP_RETS</a></li>
            
                <li><a href="../classes/WPP_UI.html">WPP_UI</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: core/premium/class_wpp_supermap.php</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&lt;?php
/**
 * Name: Supermap
 * Class: class_wpp_supermap
 * Version: 3.4.9.3
 * Minimum Core Version: 1.37.2
 * Feature ID: 3
 * Description: A big map for property overview.
 */

add_action( &#x27;wpp_init&#x27;, array( &#x27;class_wpp_supermap&#x27;, &#x27;init&#x27; ) );
add_action( &#x27;wpp_pre_init&#x27;, array( &#x27;class_wpp_supermap&#x27;, &#x27;pre_init&#x27; ) );

if( !class_exists( &#x27;class_wpp_supermap&#x27; ) ) :

  class class_wpp_supermap {

    /**
     * (custom) Capability to manage the current feature
     */
    static protected $capability = &quot;manage_wpp_supermap&quot;;

    function __construct() {

    }

    static function get( $key, $default ) {
    }

    static function set( $key, $value ) {
    }

    /**
     * Special functions that must be called prior to init
     *
     */
    static function pre_init() {
      //* Add capability */
      add_filter( &#x27;wpp_capabilities&#x27;, array( &#x27;class_wpp_supermap&#x27;, &quot;add_capability&quot; ) );
      //* Check and set specific supermap meta_keys */
      //* Check supermap markers files */
      add_filter( &#x27;wpp_settings_save&#x27;, array( &#x27;class_wpp_supermap&#x27;, &#x27;settings_save&#x27; ) );
    }

    /**
     * Something like constructor
     *
     */
    static function init() {
      add_shortcode( &#x27;supermap&#x27;, array( &#x27;class_wpp_supermap&#x27;, &#x27;shortcode_supermap&#x27; ) );

      add_action( &#x27;wp_ajax_supermap_get_properties&#x27;, array( &#x27;class_wpp_supermap&#x27;, &#x27;ajax_get_properties&#x27; ) );
      add_action( &#x27;wp_ajax_nopriv_supermap_get_properties&#x27;, array( &#x27;class_wpp_supermap&#x27;, &#x27;ajax_get_properties&#x27; ) );
      add_action( &#x27;template_redirect&#x27;, array( &#x27;class_wpp_supermap&#x27;, &#x27;supermap_template_redirect&#x27; ) );

      //* Load admin header scripts */
      add_action( &#x27;admin_enqueue_scripts&#x27;, array( &#x27;class_wpp_supermap&#x27;, &#x27;admin_enqueue_scripts&#x27; ) );

      add_filter( &#x27;wpp_supermap_marker&#x27;, array( &#x27;class_wpp_supermap&#x27;, &#x27;get_marker_by_post_id&#x27; ), 10, 2 );

      //* Add to settings page nav */
      if( current_user_can( self::$capability ) ) {
        add_filter( &#x27;wpp_settings_nav&#x27;, array( &#x27;class_wpp_supermap&#x27;, &#x27;settings_nav&#x27; ) );
        add_filter( &#x27;wpp_property_type_settings&#x27;, array( &#x27;class_wpp_supermap&#x27;, &#x27;property_type_settings&#x27; ), 10, 2 );

        //* Add Settings Page */
        add_action( &#x27;wpp_settings_content_supermap&#x27;, array( &#x27;class_wpp_supermap&#x27;, &#x27;settings_page&#x27; ) );

        //* For Admin panel */
        add_action( &#x27;add_meta_boxes&#x27;, array( &#x27;class_wpp_supermap&#x27;, &#x27;add_metabox&#x27; ) );
        add_action( &#x27;save_post&#x27;, array( &#x27;class_wpp_supermap&#x27;, &#x27;save_post&#x27; ) );

        //* Upload files (markers) */
        add_action( &#x27;wp_ajax_supermap_upload_marker&#x27;, array( &#x27;class_wpp_supermap&#x27;, &#x27;ajax_marker_upload&#x27; ) );
      }
      //** Filter meta keys during import process @author korotkov@ud */
      add_filter( &#x27;wpp_xml_import_value_on_import&#x27;, array( &#x27;class_wpp_supermap&#x27;, &#x27;importer_meta_filter&#x27; ), 10, 4 );
    }

    /**
     * Adds Custom capability to the current premium feature
     *
     * @param array $capabilities
     *
     * @return array $capabilities
     */
    static function add_capability( $capabilities ) {

      $capabilities[ self::$capability ] = __( &#x27;Manage Supermap&#x27;, &#x27;wpp&#x27; );

      return $capabilities;
    }

    /**
     * Adds slideshow menu to settings page navigation
     * Copyright 2010 Andy Potanin &lt;andy.potanin@twincitiestech.com&gt;
     *
     * @param array $tabs
     */
    static function settings_nav( $tabs ) {
      $tabs[ &#x27;supermap&#x27; ] = array(
        &#x27;slug&#x27;  =&gt; &#x27;supermap&#x27;,
        &#x27;title&#x27; =&gt; __( &#x27;Supermap&#x27;, &#x27;wpp&#x27; )
      );

      return $tabs;
    }

    /**
     * Add Supermap tab&#x27;s content on Settings Page
     *
     */
    static function settings_page() {
      global $wp_properties, $wpdb, $class_wpp_slideshow;

      $supermap_configuration = $wp_properties[ &#x27;configuration&#x27; ][ &#x27;feature_settings&#x27; ][ &#x27;supermap&#x27; ];

      if( empty( $supermap_configuration ) ) {
        $supermap_configuration = array();
      }

      //* Set default Marker */
      if( empty( $supermap_configuration[ &#x27;markers&#x27; ] ) ) {
        $supermap_configuration[ &#x27;markers&#x27; ][ &#x27;custom&#x27; ][ &#x27;name&#x27; ] = &#x27;Custom&#x27;;
        $supermap_configuration[ &#x27;markers&#x27; ][ &#x27;custom&#x27; ][ &#x27;file&#x27; ] = &#x27;&#x27;;
      }

      //* Set example of Area */
      if( empty( $supermap_configuration[ &#x27;areas&#x27; ] ) ) {
        $supermap_configuration[ &#x27;areas&#x27; ][ &#x27;example_area&#x27; ][ &#x27;strokeColor&#x27; ]   = &#x27;#a49b8a&#x27;;
        $supermap_configuration[ &#x27;areas&#x27; ][ &#x27;example_area&#x27; ][ &#x27;strokeOpacity&#x27; ] = &#x27;#a49b8a&#x27;;
        $supermap_configuration[ &#x27;areas&#x27; ][ &#x27;example_area&#x27; ][ &#x27;fillColor&#x27; ]     = &#x27;#a49b8a&#x27;;
        $supermap_configuration[ &#x27;areas&#x27; ][ &#x27;example_area&#x27; ][ &#x27;fillOpacity&#x27; ]   = &#x27;0.5&#x27;;
        $supermap_configuration[ &#x27;areas&#x27; ][ &#x27;example_area&#x27; ][ &#x27;paths&#x27; ]         = &#x27;&#x27;;
      }
      ?&gt;
      &lt;style&gt;
      #wpp_supermap_markers .wpp_supermap_ajax_uploader {
        position: relative;
        width: 42px;
        height: 42px;
        background: #ffffff;
        overflow: hidden;
        border: 1px solid #DFDFDF;
        text-align: center;
        cursor: pointer;
      }

      #wpp_supermap_markers .wpp_supermap_ajax_uploader div.qq-uploader {
        color: #fff;
      }

      #wpp_supermap_markers .wpp_supermap_ajax_uploader div.qq-upload-drop-area {
        display: none;
      }

      #wpp_supermap_markers .wpp_supermap_ajax_uploader .spinner {
        position: absolute;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
        background: url(&quot;&lt;?php echo WPP_URL; ?&gt;images/ajax_loader.gif&quot;) center center no-repeat;
        display: none;
      }

      #wpp_supermap_markers .wpp_supermap_ajax_uploader img {
        padding: 5px 0;
      }
    &lt;/style&gt;
      &lt;table class=&quot;form-table&quot;&gt;
      &lt;tbody&gt;
        &lt;tr valign=&quot;top&quot;&gt;
          &lt;th scope=&quot;row&quot;&gt;&lt;?php _e( &#x27;Sidebar Attributes&#x27;, &#x27;wpp&#x27; ); ?&gt;&lt;/th&gt;
          &lt;td&gt;
            &lt;p&gt;&lt;?php _e( &#x27;Select the attributes you want to display in the left sidebar on the supermap.&#x27;, &#x27;wpp&#x27; ); ?&gt;&lt;/p&gt;
            &lt;div class=&quot;wp-tab-panel&quot;&gt;
            &lt;ul&gt;
              &lt;?php foreach( $wp_properties[ &#x27;property_stats&#x27; ] as $slug =&gt; $title ): ?&gt;
                &lt;li&gt;
                  &lt;input &lt;?php if( @in_array( $slug, $supermap_configuration[ &#x27;display_attributes&#x27; ] ) ) echo &quot; CHECKED &quot;; ?&gt; value=&#x27;&lt;?php echo $slug; ?&gt;&#x27; type=&quot;checkbox&quot; id=&quot;display_attribute_&lt;?php echo $slug; ?&gt;&quot; name=&quot;wpp_settings[configuration][feature_settings][supermap][display_attributes][]&quot;/&gt;
                  &lt;label for=&quot;display_attribute_&lt;?php echo $slug; ?&gt;&quot;&gt;&lt;?php echo $title; ?&gt;&lt;/label&gt;
                &lt;/li&gt;
              &lt;?php endforeach; ?&gt;
            &lt;/ul&gt;
            &lt;/div&gt;
            &lt;ul style=&quot;margin-top:10px;&quot;&gt;
              &lt;li&gt;
                &lt;input &lt;?php if( @in_array( &#x27;view_property&#x27;, $supermap_configuration[ &#x27;display_attributes&#x27; ] ) ) echo &quot; CHECKED &quot;; ?&gt; value=&#x27;view_property&#x27; type=&quot;checkbox&quot; id=&quot;display_attribute_view_property&quot; name=&quot;wpp_settings[configuration][feature_settings][supermap][display_attributes][]&quot;/&gt;
                &lt;label for=&quot;display_attribute_view_property&quot;&gt;&lt;?php printf( __( &#x27;Display &quot;View %1s&quot; link in the left sidebar. It directs user to %2s Page.&#x27;, &#x27;wpp&#x27; ), WPP_F::property_label( &#x27;singular&#x27; ), WPP_F::property_label( &#x27;singular&#x27; ) ) ?&gt;&lt;/label&gt;
              &lt;/li&gt;
            &lt;/ul&gt;
          &lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
          &lt;th&gt;&lt;?php _e( &#x27;Supermap Sidebar Thumbnail:&#x27;, &#x27;wpp&#x27; ) ?&gt;&lt;/th&gt;
          &lt;td&gt;
            &lt;ul&gt;
              &lt;li&gt;
                &lt;input &lt;?php checked( &#x27;true&#x27;, $supermap_configuration[ &#x27;hide_sidebar_thumb&#x27; ] ); ?&gt; value=&#x27;true&#x27; type=&quot;checkbox&quot; id=&quot;supermap_hide_sidebar_thumb&quot; name=&quot;wpp_settings[configuration][feature_settings][supermap][hide_sidebar_thumb]&quot;/&gt;
                &lt;label for=&quot;supermap_hide_sidebar_thumb&quot;&gt;&lt;?php printf( __( &#x27;Do not show a %1s thumbnail in sidebar.&#x27;, &#x27;wpp&#x27; ), WPP_F::property_label( &#x27;singular&#x27; ) ) ?&gt;&lt;/label&gt;
              &lt;/li&gt;
              &lt;li&gt;&lt;?php WPP_F::image_sizes_dropdown( &quot;name=wpp_settings[configuration][feature_settings][supermap][supermap_thumb]&amp;selected=&quot; . $supermap_configuration[ &#x27;supermap_thumb&#x27; ] ); ?&gt;&lt;/li&gt;
              &lt;li&gt;&lt;?php _e( &#x27;If you create a new image size, please be sure to regenerate all thumbnails. &#x27;, &#x27;wpp&#x27; ) ?&gt;&lt;/li&gt;
            &lt;/ul&gt;
          &lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
          &lt;th&gt;&lt;?php _e( &#x27;Map Markers:&#x27;, &#x27;wpp&#x27; ) ?&gt;&lt;/th&gt;
          &lt;td&gt;
            &lt;table id=&quot;wpp_supermap_markers&quot; class=&quot;wpp_sortable ud_ui_dynamic_table widefat&quot; allow_random_slug=&quot;true&quot;&gt;
              &lt;thead&gt;
                &lt;tr&gt;
                  &lt;th style=&quot;width:10px;&quot; class=&quot;wpp_draggable_handle&quot;&gt;&amp;nbsp;&lt;/th&gt;
                  &lt;th style=&quot;width:50px;&quot;&gt;&lt;?php _e( &#x27;Image&#x27;, &#x27;wpp&#x27; ) ?&gt;&lt;/th&gt;
                  &lt;th style=&quot;width:150px;&quot;&gt;&lt;?php _e( &#x27;Name&#x27;, &#x27;wpp&#x27; ) ?&gt;&lt;/th&gt;
                  &lt;th style=&quot;width:250px;&quot;&gt;&lt;?php _e( &#x27;Slug&#x27;, &#x27;wpp&#x27; ) ?&gt;&lt;/th&gt;
                  &lt;th style=&quot;width:50px;&quot;&gt;&amp;nbsp;&lt;/th&gt;
                &lt;/tr&gt;
              &lt;/thead&gt;
              &lt;tbody&gt;
              &lt;?php
              $upload_dir = wp_upload_dir();
              $markers_dir = $upload_dir[ &#x27;basedir&#x27; ] . &#x27;/supermap_files/markers&#x27;;
              $markers_url = $upload_dir[ &#x27;baseurl&#x27; ] . &#x27;/supermap_files/markers&#x27;;
              foreach( $supermap_configuration[ &#x27;markers&#x27; ] as $slug =&gt; $marker ):  ?&gt;
                &lt;tr class=&quot;wpp_dynamic_table_row&quot; slug=&quot;&lt;?php echo $slug; ?&gt;&quot; new_row=&#x27;false&#x27;&gt;
                    &lt;td class=&quot;wpp_draggable_handle&quot;&gt;&amp;nbsp;&lt;/td&gt;
                    &lt;td class=&quot;wpp_ajax_image_upload&quot;&gt;
                      &lt;div class=&quot;wpp_supermap_ajax_uploader&quot;&gt;
                      &lt;?php if( !empty( $marker[ &#x27;file&#x27; ] ) &amp;&amp; file_exists( $markers_dir . &#x27;/&#x27; . $marker[ &#x27;file&#x27; ] ) ) : ?&gt;
                        &lt;img class=&quot;wpp_marker_image&quot; src=&quot;&lt;?php echo( $markers_url . &#x27;/&#x27; . $marker[ &#x27;file&#x27; ] ); ?&gt;&quot; alt=&quot;&quot;/&gt;
                      &lt;?php endif; ?&gt;
                      &lt;/div&gt;
                      &lt;input type=&quot;hidden&quot; class=&quot;wpp_supermap_marker_file&quot; name=&quot;wpp_settings[configuration][feature_settings][supermap][markers][&lt;?php echo $slug; ?&gt;][file]&quot; value=&quot;&lt;?php echo $marker[ &#x27;file&#x27; ]; ?&gt;&quot;/&gt;
                    &lt;/td&gt;
                    &lt;td&gt;
                      &lt;input class=&quot;slug_setter&quot; type=&quot;text&quot; name=&quot;wpp_settings[configuration][feature_settings][supermap][markers][&lt;?php echo $slug; ?&gt;][name]&quot; value=&quot;&lt;?php echo $marker[ &#x27;name&#x27; ]; ?&gt;&quot;/&gt;
                    &lt;/td&gt;
                    &lt;td&gt;
                      &lt;input type=&quot;text&quot; value=&quot;&lt;?php echo $slug; ?&gt;&quot; readonly=&quot;readonly&quot; class=&quot;slug wpp_marker_slug&quot;&gt;
                    &lt;/td&gt;
                    &lt;td&gt;
                      &lt;span class=&quot;wpp_delete_row wpp_link&quot;&gt;&lt;?php _e( &#x27;Delete&#x27;, &#x27;wpp&#x27; ) ?&gt;&lt;/span&gt;
                    &lt;/td&gt;
                  &lt;/tr&gt;
              &lt;?php endforeach; ?&gt;
              &lt;/tbody&gt;
              &lt;tfoot&gt;
                &lt;tr&gt;
                  &lt;td colspan=&#x27;5&#x27;&gt;
                  &lt;input type=&quot;button&quot; class=&quot;wpp_add_row button-secondary btn&quot; value=&quot;&lt;?php _e( &#x27;Add Marker&#x27;, &#x27;wpp&#x27; ) ?&gt;&quot;/&gt;
                  &lt;/td&gt;
                &lt;/tr&gt;
              &lt;/tfoot&gt;
            &lt;/table&gt;
            &lt;script type=&quot;text/javascript&quot;&gt;
              jQuery( document ).ready( function() {

                static
                function wpp_supermap_init_ajax_uploader( e ) {
                  // Don&#x27;t init ajaxuploader if image already exists
                  var img = jQuery( e ).find( &#x27;img&#x27; );
                  if( img.length &gt; 0 ) {
                    return;
                  }

                  var row = jQuery( e ).parents( &#x27;.wpp_dynamic_table_row&#x27; );
                  if( row.length &gt; 0 ) {
                    var slug = row.attr( &#x27;slug&#x27; );

                    if( typeof eval( &#x27;window.wpp_uploader_&#x27; + slug ) == &#x27;undefined&#x27; || eval( &#x27;window.wpp_uploader_&#x27; + slug ) == null ) {

                      /* Determine if slug field is empty, - it&#x27;s new row without own slug */
                      if( jQuery( &#x27;input.slug&#x27;, row ).val() == &#x27;&#x27; ) {
                        return;
                      }
                      /* Initialize Uploader */
                      var uploader = new qq.FileUploader( {
                        element: e,
                        action: &#x27;&lt;?php echo admin_url(&#x27;admin-ajax.php&#x27;); ?&gt;&#x27;,
                        params: {
                          action: &#x27;supermap_upload_marker&#x27;,
                          slug: slug
                        },
                        onSubmit: function() {
                          if( !jQuery( &#x27;.spinner&#x27;, e ).length &gt; 0 ) {
                            jQuery( e ).append( &#x27;&lt;div class=&quot;spinner&quot;&gt;&lt;/div&gt;&#x27; );
                          }
                          jQuery( &#x27;.spinner&#x27;, e ).show();
                        },
                        onComplete: function( id, fileName, responseJSON ) {
                          jQuery( &#x27;.spinner&#x27;, e ).hide();
                          if( responseJSON.success == &#x27;true&#x27; ) {
                            jQuery( &#x27;.qq-uploader&#x27;, e ).remove();
                            var url = responseJSON.url;
                            var filename = responseJSON.filename;
                            jQuery( e ).html( &#x27;&lt;img class=&quot;wpp_marker_image&quot; src=&quot;&#x27; + url + &#x27;&quot; alt=&quot;&quot; /&gt;&#x27; );
                            jQuery( &#x27;input.wpp_supermap_marker_file&#x27;, row ).val( filename );
                            //eval(&#x27;window.wpp_uploader_&#x27;+slug+&#x27; = null&#x27;);
                          }
                        }
                      } );
                      eval( &#x27;window.wpp_uploader_&#x27; + slug + &#x27; = uploader&#x27; );
                    }
                  }
                }

                /* Adds ajaxuploader functionality */
                jQuery( &#x27;#wpp_supermap_markers .wpp_supermap_ajax_uploader&#x27; ).each( function( i, e ) {
                  wpp_supermap_init_ajax_uploader( e );
                } );

                /* Remove ajaxuploader and image on Slug changing */
                jQuery( &#x27;#wpp_supermap_markers input.slug&#x27; ).live( &#x27;change&#x27;, function() {
                  var e = this;
                  var row = jQuery( e ).parents( &#x27;.wpp_dynamic_table_row&#x27; );
                  if( row.length &gt; 0 ) {
                    var slug = row.attr( &#x27;slug&#x27; );
                    eval( &#x27;window.wpp_uploader_&#x27; + slug + &#x27; = null&#x27; );
                    jQuery( &#x27;.wpp_supermap_ajax_uploader&#x27;, row ).html( &#x27;&#x27; );
                    jQuery( &#x27;input.wpp_supermap_marker_file&#x27;, row ).val( &#x27;&#x27; );

                    var uploader = jQuery( &#x27;.wpp_supermap_ajax_uploader&#x27;, row ).get( 0 );
                    wpp_supermap_init_ajax_uploader( uploader );
                  }
                } );

                /* Remove image from new Row */
                jQuery( &#x27;#wpp_supermap_markers tr&#x27; ).live( &#x27;added&#x27;, function() {
                  jQuery( &#x27;input.slug&#x27;, this ).trigger( &#x27;change&#x27; );
                } );

                /* Fire event after row removing to check table&#x27;s DOM */
                jQuery( &#x27;#wpp_supermap_markers&#x27; ).live( &#x27;row_removed&#x27;, function() {
                  var row_count = jQuery( this ).find( &quot;.wpp_delete_row:visible&quot; ).length;
                  if( row_count == 1 ) {
                    var slug = jQuery( this ).find( &#x27;input.wpp_marker_slug&#x27; ).val();
                    if( slug == &#x27;&#x27; ) {
                      jQuery( &#x27;.wpp_supermap_ajax_uploader&#x27;, this ).html( &#x27;&#x27; );
                      jQuery( &#x27;input.wpp_supermap_marker_file&#x27;, this ).val( &#x27;&#x27; );
                      jQuery( &#x27;tr&#x27;, this ).attr( &#x27;new_row&#x27;, &#x27;true&#x27; );
                    }
                  }
                  ;
                } );

              } );
            &lt;/script&gt;
          &lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
          &lt;th&gt;&lt;?php _e( &#x27;Map Areas:&#x27;, &#x27;wpp&#x27; ) ?&gt;&lt;/th&gt;
          &lt;td&gt;
            &lt;?php _e( &#x27;&lt;p&gt;Map areas let you draw our areas on the map, such as neighborhoods.&lt;/p&gt;&lt;p&gt;Just add to shortcode attribute &lt;b&gt;show_areas=all&lt;/b&gt; to draw all areas on the map. Also You can use area\&#x27;s slugs to show them on the map, like as &lt;b&gt;show_areas=new_york,washington&lt;/b&gt;. Please, use coordinates in this format: &lt;b&gt;(82.72, -37.79)(69.54, -57.48)(68.93, -18.63).&lt;/b&gt;&lt;/p&gt;&lt;p&gt;&lt;i&gt;This is an experimental feature, you may not want to use it on a live site.  We\&#x27;re eager to hear your feedback regarding this feature and the capabilities that would be useful to you.&lt;/i&gt;&lt;/p&gt;&#x27;, &#x27;wpp&#x27; ) ?&gt;
            &lt;table id=&quot;wpp_supermap_areas&quot; class=&quot;ud_ui_dynamic_table widefat&quot;&gt;
              &lt;thead&gt;
                &lt;tr&gt;
                  &lt;th&gt;&lt;?php _e( &#x27;Name&#x27;, &#x27;wpp&#x27; ) ?&gt;&lt;/th&gt;
                  &lt;th style=&quot;width:50px;&quot;&gt;&lt;?php _e( &#x27;Coordinates&#x27;, &#x27;wpp&#x27; ) ?&gt;&lt;/th&gt;
                  &lt;th&gt;&lt;?php _e( &#x27;Fill Color&#x27;, &#x27;wpp&#x27; ) ?&gt;&lt;/th&gt;
                  &lt;th&gt;&lt;?php _e( &#x27;Opacity&#x27;, &#x27;wpp&#x27; ) ?&gt;&lt;/th&gt;
                  &lt;th&gt;&lt;?php _e( &#x27;Stoke Color&#x27;, &#x27;wpp&#x27; ) ?&gt;&lt;/th&gt;
                  &lt;th&gt;&lt;?php _e( &#x27;Hover Color&#x27;, &#x27;wpp&#x27; ) ?&gt;&lt;/th&gt;
                  &lt;th&gt;&amp;nbsp;&lt;/th&gt;
                &lt;/tr&gt;
              &lt;/thead&gt;
              &lt;tbody&gt;
              &lt;?php
              foreach( $supermap_configuration[ &#x27;areas&#x27; ] as $slug =&gt; $area_data ):  ?&gt;
                &lt;tr class=&quot;wpp_dynamic_table_row&quot; slug=&quot;&lt;?php echo $slug; ?&gt;&quot; new_row=&#x27;true&#x27;&gt;
                    &lt;td&gt;
                      &lt;input class=&quot;slug_setter&quot; type=&quot;text&quot; name=&quot;wpp_settings[configuration][feature_settings][supermap][areas][&lt;?php echo $slug; ?&gt;][name]&quot; value=&quot;&lt;?php echo $area_data[ &#x27;name&#x27; ]; ?&gt;&quot;/&gt;
                      &lt;input type=&quot;text&quot; value=&quot;&lt;?php echo $slug; ?&gt;&quot; readonly=&quot;readonly&quot; class=&quot;slug&quot;&gt;
                    &lt;/td&gt;
                    &lt;td&gt;
                      &lt;textarea name=&quot;wpp_settings[configuration][feature_settings][supermap][areas][&lt;?php echo $slug; ?&gt;][paths]&quot;&gt;&lt;?php echo $area_data[ &#x27;paths&#x27; ]; ?&gt;&lt;/textarea&gt;
                    &lt;/td&gt;
                    &lt;td&gt;
                      &lt;input type=&quot;text&quot; class=&quot;wpp_input_colorpicker&quot; id=&quot;&quot; name=&quot;wpp_settings[configuration][feature_settings][supermap][areas][&lt;?php echo $slug; ?&gt;][fillColor]&quot; value=&quot;&lt;?php echo $area_data[ &#x27;fillColor&#x27; ]; ?&gt;&quot;/&gt;
                    &lt;/td&gt;
                    &lt;td&gt;
                      &lt;input style=&quot;width:40px;&quot; type=&quot;text&quot; name=&quot;wpp_settings[configuration][feature_settings][supermap][areas][&lt;?php echo $slug; ?&gt;][fillOpacity]&quot; value=&quot;&lt;?php echo $area_data[ &#x27;fillOpacity&#x27; ]; ?&gt;&quot;/&gt;
                    &lt;/td&gt;
                    &lt;td&gt;
                      &lt;input type=&quot;text&quot; class=&quot;wpp_input_colorpicker&quot; name=&quot;wpp_settings[configuration][feature_settings][supermap][areas][&lt;?php echo $slug; ?&gt;][strokeColor]&quot; value=&quot;&lt;?php echo $area_data[ &#x27;strokeColor&#x27; ]; ?&gt;&quot;/&gt;
                    &lt;/td&gt;
                    &lt;td&gt;
                      &lt;input type=&quot;text&quot; class=&quot;wpp_input_colorpicker&quot; name=&quot;wpp_settings[configuration][feature_settings][supermap][areas][&lt;?php echo $slug; ?&gt;][hoverColor]&quot; value=&quot;&lt;?php echo $area_data[ &#x27;hoverColor&#x27; ]; ?&gt;&quot;/&gt;
                    &lt;/td&gt;
                    &lt;td&gt;
                      &lt;span class=&quot;wpp_delete_row wpp_link&quot;&gt;&lt;?php _e( &#x27;Delete&#x27;, &#x27;wpp&#x27; ) ?&gt;&lt;/span&gt;
                    &lt;/td&gt;
                  &lt;/tr&gt;
              &lt;?php endforeach; ?&gt;
              &lt;/tbody&gt;
              &lt;tfoot&gt;
                &lt;tr&gt;
                  &lt;td colspan=&#x27;7&#x27;&gt;
                  &lt;input type=&quot;button&quot; class=&quot;wpp_add_row button-secondary btn&quot; value=&quot;&lt;?php _e( &#x27;Add Row&#x27;, &#x27;wpp&#x27; ) ?&gt;&quot;/&gt;
                  &lt;/td&gt;
                &lt;/tr&gt;
              &lt;/tfoot&gt;
            &lt;/table&gt;
          &lt;/td&gt;
        &lt;/tr&gt;
      &lt;/tbody&gt;
    &lt;/table&gt;
    &lt;?php
    }

    /**
     * Add supermap settings for property type
     *
     * @param $settings
     * @param $slug
     *
     * @return $settings
     * @author Maxim Peshkov
     */
    static function property_type_settings( $settings, $slug ) {
      global $wp_properties;

      $supermap_configuration = $wp_properties[ &#x27;configuration&#x27; ][ &#x27;feature_settings&#x27; ][ &#x27;supermap&#x27; ];
      $upload_dir             = wp_upload_dir();
      $markers_url            = $upload_dir[ &#x27;baseurl&#x27; ] . &#x27;/supermap_files/markers&#x27;;
      $markers_dir            = $upload_dir[ &#x27;basedir&#x27; ] . &#x27;/supermap_files/markers&#x27;;
      $default_marker         = WPP_URL . &#x27;images/google_maps_marker.png&#x27;;

      ob_start();
      ?&gt;
      &lt;div class=&quot;wp-tab-panel supermap_marker_settings&quot;&gt;
    &lt;div class=&quot;wpp_property_type_supermap_settings&quot;&gt;
      &lt;div class=&quot;wpp_supermap_marker_image&quot;&gt;
      &lt;?php $marker_url = $markers_url . &quot;/&quot; . $supermap_configuration[ &#x27;property_type_markers&#x27; ][ $slug ]; ?&gt;
        &lt;?php $marker_dir = $markers_dir . &quot;/&quot; . $supermap_configuration[ &#x27;property_type_markers&#x27; ][ $slug ]; ?&gt;
        &lt;?php if( !empty( $supermap_configuration[ &#x27;property_type_markers&#x27; ][ $slug ] ) &amp;&amp; file_exists( $marker_dir ) ) : ?&gt;
          &lt;img src=&quot;&lt;?php echo $marker_url; ?&gt;&quot; alt=&quot;&quot;/&gt;
        &lt;?php else : ?&gt;
          &lt;img src=&quot;&lt;?php echo $default_marker; ?&gt;&quot; alt=&quot;&quot;/&gt;
        &lt;?php endif; ?&gt;
      &lt;/div&gt;
      &lt;div class=&quot;wpp_supermap_marker_selector&quot;&gt;
      &lt;label for=&quot;wpp_setting_property_type_&lt;?php echo $slug ?&gt;_marker&quot;&gt;&lt;?php _e( &#x27;Map Marker&#x27;, &#x27;wpp&#x27; ); ?&gt;:&lt;/label&gt;
      &lt;select class=&quot;wpp_setting_property_type_marker&quot; id=&quot;wpp_setting_property_type_&lt;?php echo $slug ?&gt;_marker&quot; name=&quot;wpp_settings[configuration][feature_settings][supermap][property_type_markers][&lt;?php echo $slug; ?&gt;]&quot;&gt;
        &lt;option value=&quot;&quot;&gt;&lt;?php _e( &#x27;Default by Google&#x27;, &#x27;wpp&#x27; ); ?&gt;&lt;/option&gt;
        &lt;?php if( !empty( $supermap_configuration[ &#x27;markers&#x27; ] ) ) : ?&gt;
          &lt;?php foreach( $supermap_configuration[ &#x27;markers&#x27; ] as $mslug =&gt; $mvalue ) : ?&gt;
            &lt;option value=&quot;&lt;?php echo $mvalue[ &#x27;file&#x27; ]; ?&gt;&quot; &lt;?php selected( $supermap_configuration[ &#x27;property_type_markers&#x27; ][ $slug ], $mvalue[ &#x27;file&#x27; ] ); ?&gt;&gt;&lt;?php echo $mvalue[ &#x27;name&#x27; ]; ?&gt;&lt;/option&gt;
          &lt;?php endforeach; ?&gt;
        &lt;?php endif; ?&gt;
      &lt;/select&gt;
      &lt;/div&gt;
      &lt;div class=&quot;clear&quot;&gt;&lt;/div&gt;
    &lt;/div&gt;
    &lt;script type=&quot;text/javascript&quot;&gt;
      jQuery( document ).ready( function() {
        if( typeof property_type_marker_events == &#x27;undefined&#x27; ) {
          /* Change marker&#x27;s image preview on marker changing */
          jQuery( &#x27;select.wpp_setting_property_type_marker&#x27; ).live( &#x27;change&#x27;, function() {
            var e = jQuery( this ).parents( &#x27;.wpp_property_type_supermap_settings&#x27; );
            var filename = jQuery( this ).val();
            var rand = Math.random();
            var HTML = &#x27;&#x27;;
            if( filename != &#x27;&#x27; ) {
              HTML = &#x27;&lt;img src=&quot;&lt;?php echo $markers_url; ?&gt;/&#x27; + filename + &#x27;?&#x27; + rand + &#x27;&quot; alt=&quot;&quot; /&gt;&#x27;;
            } else {
              HTML = &#x27;&lt;img src=&quot;&lt;?php echo $default_marker; ?&gt;&quot; alt=&quot;&quot; /&gt;&#x27;;
            }
            e.find( &#x27;.wpp_supermap_marker_image&#x27; ).html( HTML );
          } );

          /* Fire marker&#x27;s image changing Event after Row is added */
          if( jQuery( &#x27;#wpp_inquiry_property_types&#x27; ).length &gt; 0 ) {
            jQuery( &#x27;#wpp_inquiry_property_types tr&#x27; ).live( &#x27;added&#x27;, function() {
              jQuery( &#x27;select.wpp_setting_property_type_marker&#x27;, this ).trigger( &#x27;change&#x27; );
            } );
          }

          property_type_marker_events = true;
        }
      } );
    &lt;/script&gt;
    &lt;/div&gt;
      &lt;?php
      $content = ob_get_contents();
      ob_end_clean();

      $settings[ ] = $content;

      return $settings;
    }

    /**
     * Handles ajax file uploads.
     * Uploads submitted file.
     *
     * @author Maxim Peshkov
     */
    static function ajax_marker_upload() {
      global $wp_properties;

      $return = array();

      $file_name = $_REQUEST[ &#x27;qqfile&#x27; ];
      $slug      = $_REQUEST[ &#x27;slug&#x27; ];

      //* Available Extensions */
      $exts = array( &#x27;jpg&#x27;, &#x27;jpeg&#x27;, &#x27;png&#x27;, &#x27;gif&#x27;, &#x27;bmp&#x27; );
      $ext  = pathinfo( $file_name, PATHINFO_EXTENSION );

      if( !in_array( $ext, $exts ) ) {
        $return[ &#x27;error&#x27; ] = __( &#x27;File should be an image&#x27;, &#x27;wpp&#x27; );
      } else {
        $upload_dir        = wp_upload_dir();
        $files_dir         = $upload_dir[ &#x27;basedir&#x27; ] . &#x27;/supermap_files&#x27;;
        $files_markers_dir = $files_dir . &#x27;/markers&#x27;;
        $files_markers_url = $upload_dir[ &#x27;baseurl&#x27; ] . &#x27;/supermap_files/markers&#x27;;

        if( !is_dir( $files_dir ) ) {
          mkdir( $files_dir, 0755 );
        }

        if( !is_dir( $files_markers_dir ) ) {
          mkdir( $files_markers_dir, 0755 );
          fopen( $files_markers_dir . &#x27;/index.php&#x27;, &quot;w&quot; );
        }

        $path = $files_markers_dir . &#x27;/&#x27; . $file_name;

        if( empty( $_FILES ) ) {
          $temp     = tmpfile();
          $input    = fopen( &quot;php://input&quot;, &quot;r&quot; );
          $realSize = stream_copy_to_stream( $input, $temp );
          fclose( $input );
          $target = fopen( $path, &quot;w&quot; );
          fseek( $temp, 0, SEEK_SET );
          stream_copy_to_stream( $temp, $target );
          fclose( $target );
        } else {
          //* for IE!!! */
          move_uploaded_file( $_FILES[ &#x27;qqfile&#x27; ][ &#x27;tmp_name&#x27; ], $path );
        }

        //* Try to resize file */
        $rf = image_make_intermediate_size( $path, 32, 32, false );
        if( !empty( $rf[ &#x27;file&#x27; ] ) ) {
          $resized_file_old = $files_markers_dir . &#x27;/&#x27; . $rf[ &#x27;file&#x27; ];
        } else {
          $resized_file_old = $path;
        }

        //* Rename file */
        $resized_file_new = $files_markers_dir . &#x27;/&#x27; . $slug . &#x27;.&#x27; . $ext;
        if( file_exists( $resized_file_new ) ) {
          $return[ &#x27;step&#x27; ] = $resized_file_new;
          unlink( $resized_file_new );
        }
        rename( $resized_file_old, $resized_file_new );
        if( file_exists( $path ) ) {
          unlink( $path );
        }
        //* END Resize and Rename file */

        if( !file_exists( $resized_file_new ) ) {
          $return[ &#x27;error&#x27; ] = __( &#x27;Looks like, Image can not be uploaded.&#x27;, &#x27;wpp&#x27; );
        } else {
          $return[ &#x27;success&#x27; ]  = &#x27;true&#x27;;
          $return[ &#x27;url&#x27; ]      = $files_markers_url . &#x27;/&#x27; . $slug . &#x27;.&#x27; . $ext . &#x27;?&#x27; . ( rand( 0, 100 ) );
          $return[ &#x27;filename&#x27; ] = $slug . &#x27;.&#x27; . $ext;
        }
      }

      die( htmlspecialchars( json_encode( $return ), ENT_NOQUOTES ) );
    }

    /**
     * Enqueue scripts on specific pages, and print content into head
     *
     * @uses $current_screen global variable
     * @author Maxim Peshkov
     */
    static function admin_enqueue_scripts() {
      global $current_screen, $wp_properties;

      //* WPP Settings Page */
      if( $current_screen-&gt;id == &#x27;property_page_property_settings&#x27; ) {
        wp_enqueue_script( &#x27;wpp-jquery-ajaxupload&#x27; );
      }

      //* Add custom supermap styles */
      ?&gt;
      &lt;style&gt;
      .supermap_marker_settings .wpp_supermap_marker_image {
        float: left;
        position: relative;
        width: 42px;
        height: 38px;
        padding-top: 5px;
        background: #ffffff;
        overflow: hidden;
        border: 1px solid #DFDFDF;
        text-align: center;
      }

      .wp-tab-panel.supermap_marker_settings {
        height: auto;
      }

      .supermap_marker_settings .wpp_supermap_marker_selector {
        margin-left: 5px;
        float: left;
        width: 70%;
      }

      .supermap_marker_settings .wpp_supermap_marker_selector select {
        width: 100%;
      }

      .supermap_marker_settings label {
        line-height: 20px;
      }
    &lt;/style&gt;
    &lt;?php
    }

    /**
     * Determine if post has &#x27;supermap&#x27; shortcode and
     * Enqueue scripts and style
     *
     */
    static function supermap_template_redirect() {
      global $post;

      if( strpos( $post-&gt;post_content, &quot;supermap&quot; ) ) {
        wp_enqueue_script( &#x27;google-maps&#x27; );
        wp_enqueue_script( &#x27;google-infobubble&#x27; );
        wp_enqueue_script( &#x27;wpp-jquery-fancybox&#x27; );
        wp_enqueue_style( &#x27;wpp-jquery-fancybox-css&#x27; );
      }
    }

    /**
     * Adds metabox to property editor
     *
     */
    static function add_metabox() {
      add_meta_box( &#x27;wp_property_supermap&#x27;, __( &#x27;Supermap Options&#x27;, &#x27;wpp&#x27; ),
        array( &#x27;class_wpp_supermap&#x27;, &#x27;property_supermap_options&#x27; ), &#x27;property&#x27;, &#x27;side&#x27; );
    }

    /**
     * Renders content for metabox
     *
     */
    static function property_supermap_options() {
      global $post_id, $wp_properties;

      //* Exclude From Supermap checkbox */
      $disable_exclude = get_post_meta( $post_id, &#x27;exclude_from_supermap&#x27;, true );
      $text            = sprintf( __( &#x27;Exclude %1s from Supermap&#x27;, &#x27;wpp&#x27; ), WPP_F::property_label( &#x27;singular&#x27; ) );
      echo WPP_F::checkbox( &quot;name=exclude_from_supermap&amp;id=exclude_from_supermap&amp;label=$text&quot;, $disable_exclude );

      //* START Renders Supermap Marker&#x27;s settings */
      //* Get supermap marker for the current property */
      $supermap_marker = get_post_meta( $post_id, &#x27;supermap_marker&#x27;, true );
      $default_marker  = WPP_URL . &#x27;images/google_maps_marker.png&#x27;;

      $supermap_configuration = $wp_properties[ &#x27;configuration&#x27; ][ &#x27;feature_settings&#x27; ][ &#x27;supermap&#x27; ];
      if( empty( $supermap_configuration[ &#x27;property_type_markers&#x27; ] ) ) {
        $supermap_configuration[ &#x27;property_type_markers&#x27; ] = array();
      }

      $property_type = get_post_meta( $post_id, &#x27;property_type&#x27;, true );
      if( empty( $supermap_marker ) &amp;&amp; !empty( $property_type ) ) {
        $supermap_marker = $supermap_configuration[ &#x27;property_type_markers&#x27; ][ $property_type ];
      }

      $upload_dir  = wp_upload_dir();
      $markers_url = $upload_dir[ &#x27;baseurl&#x27; ] . &#x27;/supermap_files/markers&#x27;;
      $markers_dir = $upload_dir[ &#x27;basedir&#x27; ] . &#x27;/supermap_files/markers&#x27;;

      //* Set default marker image */
      if( empty( $supermap_marker ) ) {
        $marker_url = $default_marker;
      } else {
        $marker_url = $markers_url . &quot;/&quot; . $supermap_marker;
        $marker_dir = $markers_dir . &quot;/&quot; . $supermap_marker;
        if( !file_exists( $marker_dir ) ) {
          $marker_url = $default_marker;
        }
      }
      ?&gt;
      &lt;div class=&quot;wp-tab-panel supermap_marker_settings&quot; id=&quot;wpp_supermap_marker_settings&quot; style=&quot;margin-top:10px;&quot;&gt;
      &lt;div class=&quot;wpp_supermap_marker_image&quot;&gt;
        &lt;img src=&quot;&lt;?php echo $marker_url; ?&gt;&quot; alt=&quot;&quot;/&gt;
      &lt;/div&gt;
      &lt;div class=&quot;wpp_supermap_marker_selector&quot;&gt;
      &lt;label for=&quot;wpp_setting_supermap_marker&quot;&gt;&lt;?php _e( &#x27;Map Marker&#x27;, &#x27;wpp&#x27; ); ?&gt;:&lt;/label&gt;
      &lt;select id=&quot;wpp_setting_supermap_marker&quot; name=&quot;supermap_marker&quot;&gt;
        &lt;option value=&quot;default_google_map_marker&quot;&gt;&lt;?php _e( &#x27;Default by Google&#x27;, &#x27;wpp&#x27; ); ?&gt;&lt;/option&gt;
        &lt;?php if( !empty( $supermap_configuration[ &#x27;markers&#x27; ] ) ) : ?&gt;
          &lt;?php foreach( $supermap_configuration[ &#x27;markers&#x27; ] as $mslug =&gt; $mvalue ) : ?&gt;
            &lt;option value=&quot;&lt;?php echo $mvalue[ &#x27;file&#x27; ]; ?&gt;&quot; &lt;?php selected( $supermap_marker, $mvalue[ &#x27;file&#x27; ] ); ?&gt;&gt;&lt;?php echo $mvalue[ &#x27;name&#x27; ]; ?&gt;&lt;/option&gt;
          &lt;?php endforeach; ?&gt;
        &lt;?php endif; ?&gt;
      &lt;/select&gt;
      &lt;/div&gt;
      &lt;div class=&quot;clear&quot;&gt;&lt;/div&gt;
      &lt;script type=&quot;text/javascript&quot;&gt;
        /* The list of markers images for property types */
        var property_type_markers = &lt;?php echo json_encode((array)$supermap_configuration[&#x27;property_type_markers&#x27;]); ?&gt;

          jQuery( document ).ready( function() {
            /* Change marker image */
            jQuery( &#x27;#wpp_setting_supermap_marker&#x27; ).live( &#x27;change&#x27;, function() {
              var e = jQuery( &#x27;#wpp_supermap_marker_settings&#x27; );
              var filename = jQuery( this ).val();
              var rand = Math.random();
              var HTML = &#x27;&#x27;;
              if( filename != &#x27;&#x27; &amp;&amp; filename != &#x27;default_google_map_marker&#x27; ) {
                HTML = &#x27;&lt;img src=&quot;&lt;?php echo $markers_url; ?&gt;/&#x27; + filename + &#x27;?&#x27; + rand + &#x27;&quot; alt=&quot;&quot; /&gt;&#x27;;
              } else {
                HTML = &#x27;&lt;img src=&quot;&lt;?php echo $default_marker; ?&gt;&quot; alt=&quot;&quot; /&gt;&#x27;;
              }
              e.find( &#x27;.wpp_supermap_marker_image&#x27; ).html( HTML );
            } );

            /* Change supermap marker on Property Type &#x27;change&#x27; Event */
            jQuery( &#x27;#wpp_meta_property_type&#x27; ).live( &#x27;change&#x27;, function() {
              var property_type = jQuery( this ).val();
              for( var i in property_type_markers ) {
                if( property_type == i ) {
                  jQuery( &#x27;#wpp_setting_supermap_marker&#x27; ).val( property_type_markers[i] );
                  jQuery( &#x27;#wpp_setting_supermap_marker&#x27; ).trigger( &#x27;change&#x27; );
                }
              }
            } );
          } );
      &lt;/script&gt;
    &lt;/div&gt;
      &lt;?php
      //* END Renders Supermap Marker&#x27;s settings */
    }

    /**
     * Updates/Adds custom &#x27;supermap&#x27; postmeta on post saving
     *
     * @param int $post_id
     */
    static function save_post( $post_id ) {
      global $wp_properties;

      if( isset( $_POST[ &#x27;exclude_from_supermap&#x27; ] ) ) {
        update_post_meta( $post_id, &#x27;exclude_from_supermap&#x27;, $_POST[ &#x27;exclude_from_supermap&#x27; ] );
      }

      //* Save custom supermap marker for property */
      if( isset( $_POST[ &#x27;supermap_marker&#x27; ] ) ) {
        $supermap_marker = $_POST[ &#x27;supermap_marker&#x27; ];

        /* Determine if property marker is the same as property&#x27;s &#x27;property type&#x27; marker
       * We reset (clear) property marker to avoid the issues on &#x27;property type&#x27; marker changes.
       * peshkov@UD
       */
        if( !empty( $_POST[ &#x27;wpp_data&#x27; ][ &#x27;meta&#x27; ][ &#x27;property_type&#x27; ] ) ) {
          $property_type          = $_POST[ &#x27;wpp_data&#x27; ][ &#x27;meta&#x27; ][ &#x27;property_type&#x27; ];
          $supermap_configuration = $wp_properties[ &#x27;configuration&#x27; ][ &#x27;feature_settings&#x27; ][ &#x27;supermap&#x27; ];

          if( !empty( $supermap_configuration[ &#x27;property_type_markers&#x27; ] ) ) {
            if( $supermap_configuration[ &#x27;property_type_markers&#x27; ][ $property_type ] == $supermap_marker ) {
              $supermap_marker = &#x27;&#x27;;
            }
          }
        }
        update_post_meta( $post_id, &#x27;supermap_marker&#x27;, $supermap_marker );
      }
    }

    /**
     * Returns Supermap marker url for property if exists
     * If not, returns empty string
     *
     * @param string  $marker_url
     * @param integer $post_id
     *
     * @return string $marker_url
     *
     * @author Maxim Peshkov
     */
    static function get_marker_by_post_id( $marker_url = &#x27;&#x27;, $post_id ) {
      global $wp_properties;

      //* Get supermap marker for the current property */
      $supermap_marker = get_post_meta( $post_id, &#x27;supermap_marker&#x27;, true );

      //* Return empty string if property uses default marker */
      if( $supermap_marker == &#x27;default_google_map_marker&#x27; ) {
        return &#x27;&#x27;;
      }

      $supermap_configuration = $wp_properties[ &#x27;configuration&#x27; ][ &#x27;feature_settings&#x27; ][ &#x27;supermap&#x27; ];
      if( empty( $supermap_configuration[ &#x27;property_type_markers&#x27; ] ) ) {
        $supermap_configuration[ &#x27;property_type_markers&#x27; ] = array();
      }

      $property_type = get_post_meta( $post_id, &#x27;property_type&#x27;, true );
      if( empty( $supermap_marker ) &amp;&amp; !empty( $property_type ) ) {
        $supermap_marker = $supermap_configuration[ &#x27;property_type_markers&#x27; ][ $property_type ];
      }

      $upload_dir  = wp_upload_dir();
      $markers_url = $upload_dir[ &#x27;baseurl&#x27; ] . &#x27;/supermap_files/markers&#x27;;
      $markers_dir = $upload_dir[ &#x27;basedir&#x27; ] . &#x27;/supermap_files/markers&#x27;;

      //* Set default marker image */
      if( empty( $supermap_marker ) ) {
        $marker_url = &#x27;&#x27;;
      } else {
        $marker_url = $markers_url . &quot;/&quot; . $supermap_marker;
        $marker_dir = $markers_dir . &quot;/&quot; . $supermap_marker;
        if( !file_exists( $marker_dir ) ) {
          $marker_url = &#x27;&#x27;;
        }
      }

      return $marker_url;
    }

    /**
     * Returns supermap for shortcode
     * Copyright 2010 Andy Potanin &lt;andy.potanin@twincitiestech.com&gt;
     *
     * Example of Atts:
     * zoom=5
     * center_on=74.3434,-130.22
     *
     * @param array $atts Attributes of shortcode
     */
    static function shortcode_supermap( $atts = array() ) {
      global $wp_properties, $wp_scripts;
      $css_class = empty( $css_class ) ? &#x27;&#x27; : $css_class;
      $defaults  = array(
        &#x27;per_page&#x27;       =&gt; 10,
        &#x27;css_class&#x27;      =&gt; &#x27;&#x27;,
        &#x27;starting_row&#x27;   =&gt; 0,
        &#x27;pagination&#x27;     =&gt; &#x27;on&#x27;,
        &#x27;sidebar_width&#x27;  =&gt; &#x27;&#x27;,
        &#x27;hide_sidebar&#x27;   =&gt; &#x27;false&#x27;,
        &#x27;map_height&#x27;     =&gt; &#x27;&#x27;,
        &#x27;map_width&#x27;      =&gt; &#x27;&#x27;,
        &#x27;options_label&#x27;  =&gt; __( &#x27;Options&#x27;, &#x27;wpp&#x27; ),
        &#x27;silent_failure&#x27; =&gt; &#x27;true&#x27;,
        &#x27;sort_order&#x27;     =&gt; &#x27;DESC&#x27;,
        &#x27;sort_by&#x27;        =&gt; &#x27;post_date&#x27;
      );

      $atts = array_merge( $defaults, (array) $atts );

      WPP_F::load_assets();

      //** Quit function if Google Maps is not loaded */
      if( !WPP_F::is_asset_loaded( &#x27;google-maps&#x27; ) ) {
        return ( $atts[ &#x27;silent_failure&#x27; ] == &#x27;true&#x27; ? false : sprintf( __( &#x27;Element cannot be rendered, missing %1s script.&#x27;, &#x27;wpp&#x27; ), &#x27;google-maps&#x27; ) );
      }

      //* Available search attributes */
      $searchable_attributes = (array) $wp_properties[ &#x27;searchable_attributes&#x27; ];

      //* Set property types */
      if( !isset( $atts[ &#x27;property_type&#x27; ] ) ) {
        //* Need this for better UI and to avoid mistakes */
        //* @TODO: need to determine if custom attribute &#x27;type&#x27; does not isset at first to use this condition. peshkov@UD */
        if( !empty( $atts[ &#x27;type&#x27; ] ) ) {
          $atts[ &#x27;property_type&#x27; ] = $atts[ &#x27;type&#x27; ];
        } else {
          $atts[ &#x27;property_type&#x27; ] = $wp_properties[ &#x27;searchable_property_types&#x27; ];
        }
      }
      /* END Set property types */

      //* Set Available query keys */
      $query_keys = array_flip( $searchable_attributes );
      foreach( $query_keys as $key =&gt; $val ) {
        $query_keys[ $key ] = &#x27;&#x27;;
      }

      $query_keys[ &#x27;property_type&#x27; ] = &#x27;&#x27;;

      //* START Set query */
      $query = shortcode_atts( $query_keys, $atts );

      if( isset( $_REQUEST[ &#x27;wpp_search&#x27; ] ) ) {
        $query = shortcode_atts( $query, $_REQUEST[ &#x27;wpp_search&#x27; ] );
      }

      /* HACK: Remove attribute with value &#x27;all&#x27; from query to avoid search result issues:
     * Because &#x27;all&#x27; means any attribute&#x27;s value,
     * But if property has no the attribute, which has value &#x27;all&#x27; - query doesn&#x27;t return this property
     */
      foreach( $query as $k =&gt; $v ) {
        if( $v == &#x27;all&#x27; ) {
          unset( $query[ $k ] );
        }
      }

      //* Exclude properties which has no latitude,longitude keys */
      $query[ &#x27;latitude&#x27; ]             = &#x27;all&#x27;;
      $query[ &#x27;longitude&#x27; ]            = &#x27;all&#x27;;
      $query[ &#x27;address_is_formatted&#x27; ] = &#x27;true&#x27;;

      //* Add only properties which are not excluded from supermap (option on Property editing form) */
      $query[ &#x27;exclude_from_supermap&#x27; ] = &#x27;false,0&#x27;;

      //* Prepare search attributes to use them in get_properties() */
      $query = WPP_F::prepare_search_attributes( $query );

      if( $atts[ &#x27;pagination&#x27; ] == &#x27;on&#x27; ) {
        $query[ &#x27;pagi&#x27; ] = $atts[ &#x27;starting_row&#x27; ] . &#x27;--&#x27; . $atts[ &#x27;per_page&#x27; ];
      }

      $query[ &#x27;sort_by&#x27; ]    = $atts[ &#x27;sort_by&#x27; ];
      $query[ &#x27;sort_order&#x27; ] = $atts[ &#x27;sort_order&#x27; ];

      //* END Set query */

      //* Get properties */
      $property_ids = WPP_F::get_properties( $query, true );

      //** We do this so if there are properties that are so close the icons overlap, the properties in the beginning of the array will be he overlapping ones */

      if( is_array( $property_ids[ &#x27;results&#x27; ] ) ) {
        $property_ids[ &#x27;results&#x27; ] = array_reverse( $property_ids[ &#x27;results&#x27; ] );
      }

      if( !empty( $property_ids[ &#x27;results&#x27; ] ) ) {

        $atts[ &#x27;total&#x27; ] = $property_ids[ &#x27;total&#x27; ];

        $properties = array();
        foreach( $property_ids[ &#x27;results&#x27; ] as $key =&gt; $id ) {

          $property = prepare_property_for_display( $id, array(
            &#x27;load_gallery&#x27; =&gt; &#x27;false&#x27;,
            &#x27;get_children&#x27; =&gt; &#x27;false&#x27;,
            &#x27;load_parent&#x27;  =&gt; &#x27;false&#x27;,
            &#x27;scope&#x27;        =&gt; &#x27;supermap_sidebar&#x27;
          ) );

          $properties[ $id ] = $property;
        }

        //* Get supermap content */
        $supermap = self::supermap_template( $properties, $atts );

        return $supermap;
      }
    }

    /**
     * Ajax. Returns javascript:
     * list of properties and markers
     *
     */
    static function ajax_get_properties() {
      global $wpdb, $wp_properties;

      $defaults = array(
        &#x27;per_page&#x27;      =&gt; 10,
        &#x27;starting_row&#x27;  =&gt; 0,
        &#x27;pagination&#x27;    =&gt; &#x27;on&#x27;,
        &#x27;sort_order&#x27;    =&gt; &#x27;ASC&#x27;,
        &#x27;sort_by&#x27;       =&gt; &#x27;menu_order&#x27;,
        &#x27;property_type&#x27; =&gt; ( $wp_properties[ &#x27;searchable_property_types&#x27; ] )
      );

      $atts = shortcode_atts( $defaults, $_REQUEST );

      //* Supermap configuration */
      $supermap_configuration = $wp_properties[ &#x27;configuration&#x27; ][ &#x27;feature_settings&#x27; ][ &#x27;supermap&#x27; ];
      if( empty( $supermap_configuration[ &#x27;supermap_thumb&#x27; ] ) ) {
        $supermap_configuration[ &#x27;supermap_thumb&#x27; ] = &#x27;thumbnail&#x27;;
      }

      //* START Prepare search params for get_properties() */
      $query = array();
      if( !empty( $_REQUEST[ &#x27;wpp_search&#x27; ] ) ) {
        //* Available search attributes */
        $searchable_attributes = (array) $wp_properties[ &#x27;searchable_attributes&#x27; ];
        $query_keys            = array_flip( $searchable_attributes );
        foreach( $query_keys as $key =&gt; $val ) {
          $query_keys[ $key ] = &#x27;&#x27;;
        }
        $query = $_REQUEST[ &#x27;wpp_search&#x27; ];
        $query = shortcode_atts( $query_keys, $query );
      }

      //* Exclude properties which has no latitude,longitude keys */
      $query[ &#x27;latitude&#x27; ]             = &#x27;all&#x27;;
      $query[ &#x27;longitude&#x27; ]            = &#x27;all&#x27;;
      $query[ &#x27;address_is_formatted&#x27; ] = &#x27;1&#x27;;
      //* Add only properties which are not excluded from supermap (option on Property editing form) */
      $query[ &#x27;exclude_from_supermap&#x27; ] = &#x27;false,0&#x27;;
      //* Set Property type */
      $query[ &#x27;property_type&#x27; ] = $atts[ &#x27;property_type&#x27; ];

      //* Prepare Query params */
      $query = WPP_F::prepare_search_attributes( $query );

      if( $atts[ &#x27;pagination&#x27; ] == &#x27;on&#x27; ) {
        $query[ &#x27;pagi&#x27; ] = $atts[ &#x27;starting_row&#x27; ] . &#x27;--&#x27; . $atts[ &#x27;per_page&#x27; ];
      }
      $query[ &#x27;sort_by&#x27; ]    = $atts[ &#x27;sort_by&#x27; ];
      $query[ &#x27;sort_order&#x27; ] = $atts[ &#x27;sort_order&#x27; ];
      //* END Prepare search params for get_properties() */

      //* Get Properties */
      $property_ids = WPP_F::get_properties( $query, true );

      if( !empty( $property_ids[ &#x27;results&#x27; ] ) ) {
        $properties = array();
        foreach( (array) $property_ids[ &#x27;results&#x27; ] as $key =&gt; $id ) {

          $property = (array) prepare_property_for_display( $id, array(
            &#x27;load_gallery&#x27; =&gt; &#x27;false&#x27;,
            &#x27;get_children&#x27; =&gt; &#x27;false&#x27;,
            &#x27;load_parent&#x27;  =&gt; &#x27;false&#x27;,
            &#x27;scope&#x27;        =&gt; &#x27;supermap_sidebar&#x27;
          ) );

          $properties[ $id ] = $property;
        }
      }

      $supermap_configuration[ &#x27;display_attributes&#x27; ] = ( is_array( $supermap_configuration[ &#x27;display_attributes&#x27; ] ) ? $supermap_configuration[ &#x27;display_attributes&#x27; ] : array() );

      foreach( $supermap_configuration[ &#x27;display_attributes&#x27; ] as $attribute ) {
        $display_attributes[ $attribute ] = $wp_properties[ &#x27;property_stats&#x27; ][ $attribute ];
      }

      ob_start();

      if( !empty( $properties ) ) : ?&gt;
        var HTML = &#x27;&#x27;;
        window.supermap_&lt;?php echo $_POST[ &#x27;random&#x27; ]; ?&gt;.total = &#x27;&lt;?php echo $property_ids[ &#x27;total&#x27; ]; ?&gt;&#x27;;
        &lt;?php

        $labels_to_keys = array_flip( $wp_properties[ &#x27;property_stats&#x27; ] );

        foreach( $properties as $property_id =&gt; $value ) {

          $attributes = array();

          $property_stats = WPP_F::get_stat_values_and_labels( $value, array(
            &#x27;property_stats&#x27; =&gt; $display_attributes
          ) );

          if( is_array( $property_stats ) ) {
            foreach( $property_stats as $attribute_label =&gt; $attribute_value ) {

              $boolean_field = false;

              $attribute_slug = $labels_to_keys[ $attribute_label ];
              $attribute_data = WPP_F::get_attribute_data( $attribute_slug );

              if( empty( $attribute_value ) ) {
                continue;
              }

              if( ( $attribute_data[ &#x27;data_input_type&#x27; ] == &#x27;checkbox&#x27; &amp;&amp; ( $attribute_value == &#x27;true&#x27; || $attribute_value == 1 ) ) ) {
                if( $wp_properties[ &#x27;configuration&#x27; ][ &#x27;google_maps&#x27; ][ &#x27;show_true_as_image&#x27; ] == &#x27;true&#x27; ) {
                  $attribute_value = &#x27;&lt;div class=&quot;true-checkbox-image&quot;&gt;&lt;/div&gt;&#x27;;
                } else {
                  $attribute_value = __( &#x27;Yes&#x27;, &#x27;wpp&#x27; );
                }
                $boolean_field = true;
              } elseif( $attribute_value == &#x27;false&#x27; ) {
                continue;
              }

              $attributes[ ] = &#x27;&lt;li class=&quot;supermap_list_&#x27; . $attribute_slug . &#x27; wpp_supermap_attribute_row&quot;&gt;&#x27;;
              $attributes[ ] = &#x27;&lt;span class=&quot;attribute&quot;&gt;&#x27; . $attribute_label . ( !$boolean_field ? &#x27;:&#x27; : &#x27;&#x27; ) . &#x27; &lt;/span&gt;&#x27;;
              $attributes[ ] = &#x27;&lt;span class=&quot;value&quot;&gt;&#x27; . $attribute_value . &#x27;&lt;/span&gt;&#x27;;
              $attributes[ ] = &#x27;&lt;/li&gt;&#x27;;

            }
          }

          if( in_array( &#x27;view_property&#x27;, $supermap_configuration[ &#x27;display_attributes&#x27; ] ) ) {
            $attributes[ ] = &#x27;&lt;li class=&quot;supermap_list_view_property&quot;&gt;&lt;a href=&quot;&#x27; . get_permalink( $value[ &#x27;ID&#x27; ] ) . &#x27;&quot;&gt;&lt;span&gt;&#x27; . __( &#x27;View Property&#x27;, &#x27;wpp&#x27; ) . &#x27;&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;&#x27;;
          }

          if( $supermap_configuration[ &#x27;hide_sidebar_thumb&#x27; ] != &#x27;true&#x27; ) {
            $image = wpp_get_image_link( $value[ &#x27;featured_image&#x27; ], $supermap_configuration[ &#x27;supermap_thumb&#x27; ], array( &#x27;return&#x27; =&gt; &#x27;array&#x27; ) );
          }

          ?&gt;
          window.myLatlng_&lt;?php echo $_POST[ &#x27;random&#x27; ]; ?&gt;_&lt;?php echo $value[ &#x27;ID&#x27; ]; ?&gt; = new google.maps.LatLng(&lt;?php echo $value[ &#x27;latitude&#x27; ]; ?&gt;,&lt;?php echo $value[ &#x27;longitude&#x27; ]; ?&gt;);
          window.content_&lt;?php echo $_POST[ &#x27;random&#x27; ]; ?&gt;_&lt;?php echo $value[ &#x27;ID&#x27; ]; ?&gt; = &#x27;&lt;?php echo WPP_F::google_maps_infobox( $value ); ?&gt;&#x27;;

          window.marker_&lt;?php echo $_POST[ &#x27;random&#x27; ]; ?&gt;_&lt;?php echo $value[ &#x27;ID&#x27; ]; ?&gt; = new google.maps.Marker({
          position: myLatlng_&lt;?php echo $_POST[ &#x27;random&#x27; ]; ?&gt;_&lt;?php echo $value[ &#x27;ID&#x27; ]; ?&gt;,
          map: map_&lt;?php echo $_POST[ &#x27;random&#x27; ]; ?&gt;,
          title: &#x27;&lt;?php echo str_replace( &quot;&#x27;&quot;, &quot;\&#x27;&quot;, $value[ &#x27;location&#x27; ] ); ?&gt;&#x27;,
          icon: &#x27;&lt;?php echo apply_filters( &#x27;wpp_supermap_marker&#x27;, &#x27;&#x27;, $value[ &#x27;ID&#x27; ] ); ?&gt;&#x27;
          });

          window.markers_&lt;?php echo $_POST[ &#x27;random&#x27; ]; ?&gt;.push(window.marker_&lt;?php echo $_POST[ &#x27;random&#x27; ]; ?&gt;_&lt;?php echo $value[ &#x27;ID&#x27; ]; ?&gt;);

          google.maps.event.addListener(marker_&lt;?php echo $_POST[ &#x27;random&#x27; ]; ?&gt;_&lt;?php echo $value[ &#x27;ID&#x27; ]; ?&gt;, &#x27;click&#x27;, function() {
          infowindow_&lt;?php echo $_POST[ &#x27;random&#x27; ]; ?&gt;.close();
          infowindow_&lt;?php echo $_POST[ &#x27;random&#x27; ]; ?&gt;.setContent(content_&lt;?php echo $_POST[ &#x27;random&#x27; ]; ?&gt;_&lt;?php echo $value[ &#x27;ID&#x27; ]; ?&gt;);
          infowindow_&lt;?php echo $_POST[ &#x27;random&#x27; ]; ?&gt;.open(map_&lt;?php echo $_POST[ &#x27;random&#x27; ]; ?&gt;,marker_&lt;?php echo $_POST[ &#x27;random&#x27; ]; ?&gt;_&lt;?php echo $value[ &#x27;ID&#x27; ]; ?&gt;);
          loadFuncy();
          makeActive(&lt;?php echo $_POST[ &#x27;random&#x27; ]; ?&gt;,&lt;?php echo $value[ &#x27;ID&#x27; ]; ?&gt;);
          });

          google.maps.event.addListener(infowindow_&lt;?php echo $_POST[ &#x27;random&#x27; ]; ?&gt;, &#x27;domready&#x27;, function() {
          document.getElementById(&#x27;infowindow&#x27;).parentNode.style.overflow=&#x27;&#x27;;
          document.getElementById(&#x27;infowindow&#x27;).parentNode.parentNode.style.overflow=&#x27;&#x27;;
          });

          bounds_&lt;?php echo $_POST[ &#x27;random&#x27; ]; ?&gt;.extend(window.myLatlng_&lt;?php echo $_POST[ &#x27;random&#x27; ]; ?&gt;_&lt;?php echo $value[ &#x27;ID&#x27; ]; ?&gt;);
          map_&lt;?php echo $_POST[ &#x27;random&#x27; ]; ?&gt;.fitBounds(bounds_&lt;?php echo $_POST[ &#x27;random&#x27; ]; ?&gt;);

          HTML += &#x27;
          &lt;div id=&quot;property_in_list_&lt;?php echo $_POST[ &#x27;random&#x27; ]; ?&gt;_&lt;?php echo $value[ &#x27;ID&#x27; ]; ?&gt;&quot; class=&quot;property_in_list clearfix&quot;&gt;&#x27;;
      HTML += &#x27;&lt;ul class=&quot;property_in_list_items clearfix&quot;&gt;&#x27;;
      HTML += &#x27;&lt;li class=&quot;supermap_list_thumb&quot;&gt;&#x27;;
      HTML += &#x27;&lt;span onclick=&quot;showInfobox_&lt;?php echo $_POST[ &#x27;random&#x27; ]; ?&gt;(&lt;?php echo $value[ &#x27;ID&#x27; ]; ?&gt;);&quot;&gt;&#x27;;
                  &lt;?php if( $supermap_configuration[ &#x27;hide_sidebar_thumb&#x27; ] != &#x27;true&#x27; ) { ?&gt;
                    HTML += &#x27;
                    &lt;img src=&quot;&lt;?php echo ( empty( $image[ &#x27;link&#x27; ] ) ) ? WPP_URL . &#x27;templates/images/no_image.png&#x27; : $image[ &#x27;link&#x27; ]; ?&gt;&quot; width=&quot;&lt;?php echo esc_attr( $image[ &#x27;width&#x27; ] ); ?&gt;&quot; alt=&quot;&lt;?php echo esc_attr( $value[ &#x27;post_title&#x27; ] ); ?&gt;&quot;/&gt;&#x27;;
                  &lt;?php } ?&gt;
                  HTML += &#x27;&lt;/span&gt;&#x27;;
      HTML += &#x27;&lt;/li&gt;&#x27;;
      HTML += &#x27;&lt;li class=&quot;supermap_list_title&quot;&gt;&#x27;;
      HTML += &#x27;&lt;span onclick=&quot;showInfobox_&lt;?php echo $_POST[ &#x27;random&#x27; ]; ?&gt;(&lt;?php echo $value[ &#x27;ID&#x27; ]; ?&gt;);&quot;&gt;&lt;?php echo addslashes( trim( $value[ &#x27;post_title&#x27; ] ) ) ?&gt;&lt;/span&gt;&#x27;;
      HTML += &#x27;&lt;/li&gt;&#x27;;
              &lt;?php if( count( $attributes ) &gt; 0 ) {
                echo &quot;HTML += &#x27;&quot; . addcslashes( implode( &#x27;&#x27;, $attributes ), &quot;&#x27;&quot; ) . &quot;&#x27;;&quot;;
              } ?&gt;
              HTML += &#x27;&lt;/ul&gt;&lt;/div&gt;&#x27;;
        &lt;?php } ?&gt;

        var wpp_supermap_&lt;?php echo $_POST[ &#x27;random&#x27; ]; ?&gt; = document.getElementById(&#x27;super_map_list_property_&lt;?php echo $_POST[ &#x27;random&#x27; ]; ?&gt;&#x27;);
        wpp_supermap_&lt;?php echo $_POST[ &#x27;random&#x27; ]; ?&gt;.innerHTML += HTML;

      &lt;?php else : ?&gt;

        window.supermap_&lt;?php echo $_POST[ &#x27;random&#x27; ]; ?&gt;.total = &#x27;0&#x27;;

        var wpp_supermap_&lt;?php echo $_POST[ &#x27;random&#x27; ]; ?&gt; = document.getElementById(&quot;super_map_list_property_&lt;?php echo $_POST[ &#x27;random&#x27; ]; ?&gt;&quot;);
        var y = &#x27;
        &lt;div style=&quot;text-align:center;&quot; class=&quot;no_properties&quot;&gt;&lt;?php _e( &#x27;No results found.&#x27;, &#x27;wpp&#x27; ); ?&gt;&lt;/div&gt;&#x27;;

        wpp_supermap_&lt;?php echo $_POST[ &#x27;random&#x27; ]; ?&gt;.innerHTML += y;

      &lt;?php endif; ?&gt;
      &lt;?php

      $result = ob_get_contents();
      ob_end_clean();

      echo WPP_F::minify_js( $result );

      exit();
    }

    /**
     * Renders Supermap Content
     *
     * @param array $properties
     * @param array $atts
     *
     * @return string $content HTML
     */
    static function supermap_template( $properties, $atts = array() ) {
      global $wp_properties;

      //* Determine if properties exist */
      if( empty( $properties ) ) {
        return &#x27;&#x27;;
      }

      //* Default settings */
      $hide_sidebar  = empty( $hide_sidebar ) ? false : $hide_sidebar;
      $show_areas    = empty( $show_areas ) ? false : $show_areas;
      $rand          = empty( $rand ) ? &#x27;&#x27; : $rand;
      $zoom          = empty( $zoom ) ? &#x27;&#x27; : $zoom;
      $css_class     = empty( $css_class ) ? &#x27;&#x27; : $css_class;
      $options_label = empty( $options_label ) ? __( &#x27;Options&#x27;, &#x27;wpp&#x27; ) : $options_label;
      $defaults      = array(
        &#x27;hide_sidebar&#x27;  =&gt; &#x27;false&#x27;,
        &#x27;css_class&#x27;     =&gt; &#x27;&#x27;,
        &#x27;show_areas&#x27;    =&gt; false,
        &#x27;sidebar_width&#x27; =&gt; &#x27;&#x27;,
        &#x27;map_height&#x27;    =&gt; &#x27;&#x27;,
        &#x27;map_width&#x27;     =&gt; &#x27;&#x27;,
        &#x27;zoom&#x27;          =&gt; &#x27;&#x27;,
        &#x27;options_label&#x27; =&gt; __( &#x27;Options&#x27;, &#x27;wpp&#x27; ),
        &#x27;center_on&#x27;     =&gt; &#x27;&#x27;,
        &#x27;property_type&#x27; =&gt; (array) $wp_properties[ &#x27;searchable_property_types&#x27; ],
        &#x27;rand&#x27;          =&gt; rand( 1000, 5000 )
      );

      if( !empty( $sidebar_width ) ) {
        $sidebar_width = trim( str_replace( array( &#x27;%&#x27;, &#x27;px&#x27; ), &#x27;&#x27;, $sidebar_width ) );
      }

      //* Supermap configuration */
      $supermap_configuration = $wp_properties[ &#x27;configuration&#x27; ][ &#x27;feature_settings&#x27; ][ &#x27;supermap&#x27; ];
      if( empty( $supermap_configuration[ &#x27;supermap_thumb&#x27; ] ) ) {
        $supermap_configuration[ &#x27;supermap_thumb&#x27; ] = &#x27;thumbnail&#x27;;
      }

      //* Set available search attributes for &#x27;Options&#x27; form */
      $searchable_attributes = (array) $wp_properties[ &#x27;searchable_attributes&#x27; ];
      $flip                  = array_flip( $searchable_attributes );
      if( is_array( $flip ) &amp; is_array( $atts ) ) {
        $searchable_attributes = ( array_intersect_key( $atts, $flip ) );
      } else {
        unset( $searchable_attributes );
      }

      //* Get template Attributes */
      extract( shortcode_atts( $defaults, $atts ) );

      //** Get and set any inline styles */
      if( $hide_sidebar != &quot;true&quot; &amp;&amp; !empty( $sidebar_width ) ) {
        $inline_styles[ &#x27;sidebar&#x27; ][ &#x27;width&#x27; ] = &#x27;width: &#x27; . $sidebar_width . &#x27;%&#x27;;
        $inline_styles[ &#x27;map&#x27; ][ &#x27;width&#x27; ]     = &#x27;width: &#x27; . ( 100 - $sidebar_width ) . &#x27;%;&#x27;;
        $inline_styles[ &#x27;map&#x27; ][ &#x27;margin&#x27; ]    = &#x27;margin: 0;&#x27;; /* If using fluid widths, must elimiate all margins */
        $inline_styles[ &#x27;map&#x27; ][ &#x27;padding&#x27; ]   = &#x27;padding: 0;&#x27;; /* If using fluid widths, must elimiate all padding */
      }

      if( !isset( $inline_styles[ &#x27;map&#x27; ][ &#x27;width&#x27; ] ) &amp;&amp; !empty( $map_width ) ) {
        $inline_styles[ &#x27;map&#x27; ][ &#x27;width&#x27; ] = &#x27;width: &#x27; . str_replace( &#x27;px&#x27;, &#x27;&#x27;, $map_width ) . &#x27;px;&#x27;;
      }

      if( !empty( $map_height ) ) {
        $inline_styles[ &#x27;map&#x27; ][ &#x27;height&#x27; ]     = &#x27;height: &#x27; . str_replace( &#x27;px&#x27;, &#x27;&#x27;, $map_height ) . &#x27;px;&#x27;;
        $inline_styles[ &#x27;sidebar&#x27; ][ &#x27;height&#x27; ] = &#x27;height: &#x27; . str_replace( &#x27;px&#x27;, &#x27;&#x27;, $map_height ) . &#x27;px;&#x27;;
      }

      $inline_styles[ &#x27;map&#x27; ]     = &#x27;style=&quot;&#x27; . implode( &#x27; &#x27;, (array) $inline_styles[ &#x27;map&#x27; ] ) . &#x27;&quot;&#x27;;
      $inline_styles[ &#x27;sidebar&#x27; ] = &#x27;style=&quot;&#x27; . implode( &#x27; &#x27;, (array) $inline_styles[ &#x27;sidebar&#x27; ] ) . &#x27;&quot;&#x27;;

      //* START Render Javascript functionality for Areas */
      $areas      = $wp_properties[ &#x27;configuration&#x27; ][ &#x27;feature_settings&#x27; ][ &#x27;supermap&#x27; ][ &#x27;areas&#x27; ];
      $area_lines = array();
      // Plot areas
      if( is_array( $areas ) &amp;&amp; $show_areas ) {
        // Check attribute &#x27;show_areas&#x27;
        if( $show_areas != &#x27;all&#x27; ) {
          $show_areas = explode( &#x27;,&#x27;, $show_areas );
          $show_areas = array_fill_keys( $show_areas, 1 );
        }
        foreach( $areas as $count =&gt; $area ) {
          // If the current area (slug) is not added to shortcode, we didn&#x27;t draw it.
          if( ( is_array( $show_areas ) &amp;&amp; !array_key_exists( $count, $show_areas ) ) || $count == &#x27;example_area&#x27; ) {
            continue;
          }

          // Set defaults
          if( empty( $area[ &#x27;strokeColor&#x27; ] ) ) $area[ &#x27;strokeColor&#x27; ] = &#x27;#a49b8a&#x27;;
          if( empty( $area[ &#x27;fillColor&#x27; ] ) ) $area[ &#x27;fillColor&#x27; ] = &#x27;#dad1c2&#x27;;
          if( empty( $area[ &#x27;hoverColor&#x27; ] ) ) $area[ &#x27;hoverColor&#x27; ] = &#x27;#bfb89a&#x27;;
          if( empty( $area[ &#x27;fillOpacity&#x27; ] ) ) $area[ &#x27;fillOpacity&#x27; ] = &#x27;0.6&#x27;;
          if( empty( $area[ &#x27;strokeOpacity&#x27; ] ) ) $area[ &#x27;strokeOpacity&#x27; ] = &#x27;1&#x27;;
          if( empty( $area[ &#x27;strokeWeight&#x27; ] ) ) $area[ &#x27;strokeWeight&#x27; ] = &#x27;1&#x27;;

          $area[ &#x27;paths&#x27; ] = str_replace( &quot;)(&quot;, &quot;)|(&quot;, $area[ &#x27;paths&#x27; ] );
          $area[ &#x27;paths&#x27; ] = explode( &quot;|&quot;, $area[ &#x27;paths&#x27; ] );

          if( count( $area[ &#x27;paths&#x27; ] ) &lt; 1 ) {
            continue;
          }
          unset( $this_area_coords );

          foreach( $area[ &#x27;paths&#x27; ] as $coords ) {
            if( empty( $coords ) )
              continue;
            $this_area_coords[ ] = &quot;new google.maps.LatLng{$coords}&quot;;
          }

          if( empty( $this_area_coords ) ) {
            continue;
          }

          $area_lines[ ] = &quot;var areaCoords_{$count} = [&quot; . implode( &quot;,\n&quot;, $this_area_coords ) . &quot;]&quot;;
          $area_lines[ ] = &quot;
            areaCoords_{$count} = new google.maps.Polygon({
            paths: areaCoords_{$count},
            strokeColor: &#x27;{$area[&#x27;strokeColor&#x27;]}&#x27;,
            strokeOpacity: {$area[&#x27;strokeOpacity&#x27;]},
            strokeWeight: {$area[&#x27;strokeWeight&#x27;]},
            fillColor: &#x27;{$area[&#x27;fillColor&#x27;]}&#x27;,
            fillOpacity: {$area[&#x27;fillOpacity&#x27;]}
          });
          areaCoords_{$count}.setMap(map_{$rand});
          google.maps.event.addListener(areaCoords_{$count},&#x27;click&#x27;,function(event){
            // Set content and Replace our Info Window&#x27;s position
            infowindow_{$rand}.setContent(&#x27;&lt;div id=\&quot;infowindow\&quot; style=\&quot;height:50px;line-height:50px;text-align:center;font-weight:bold;\&quot;&gt;{$area[&#x27;name&#x27;]}&lt;/div&gt;&#x27;);
            infowindow_{$rand}.setPosition(event.latLng);
            infowindow_{$rand}.open(map_{$rand});
          });
          google.maps.event.addListener(areaCoords_{$count},&#x27;mouseover&#x27;,function(event){
            this.setOptions({
              fillColor: &#x27;{$area[&#x27;hoverColor&#x27;]}&#x27;
            });
          });
          google.maps.event.addListener(areaCoords_{$count},&#x27;mouseout&#x27;,function(event){
            this.setOptions({
              fillColor: &#x27;{$area[&#x27;fillColor&#x27;]}&#x27;
            });
          });
        &quot;;
        }
      }
      $area_lines = implode( &#x27;&#x27;, $area_lines );

      //* END Render Areas */

      ob_start();
      ?&gt;
      &lt;script type=&quot;text/javascript&quot;&gt;
      &lt;?php if (wp_script_is( &#x27;jquery-ui-tabs&#x27;, $list = &#x27;queue&#x27; )) : ?&gt;
      jQuery( window ).load( function() {
        superMap_&lt;?php echo $rand; ?&gt;();
      } );
      &lt;?php else: ?&gt;
      jQuery( document ).ready( function() {
        superMap_&lt;?php echo $rand; ?&gt;();
      } );
      &lt;?php endif;?&gt;

      jQuery( document ).bind( &quot;wpp::ui-tabs::tabsshow&quot;, function( e, ui ) {
        superMap_&lt;?php echo $rand; ?&gt;();
      } );

      jQuery( document ).bind( &quot;wpp_redraw_supermaps&quot;, function( e ) {
        superMap_&lt;?php echo $rand; ?&gt;();
      } );

      /**
       * Renders Supermap
       */
      static
      function superMap_&lt;?php echo $rand; ?&gt;() {
        /* Map settings */
        var myOptions_&lt;?php echo $rand; ?&gt; = {
          &lt;?php if($zoom): ?&gt;
          zoom: &lt;?php echo $zoom; ?&gt;,
          &lt;?php endif; ?&gt;
          &lt;?php if(!empty($center_on)): ?&gt;
          center: new google.maps.LatLng( &lt;?php echo $center_on; ?&gt; ),
          &lt;?php endif; ?&gt;
          mapTypeId: google.maps.MapTypeId.ROADMAP
        }

        if( typeof window.map_&lt;?php echo $rand; ?&gt; === &#x27;object&#x27; || jQuery( &quot;#super_map_&lt;?php echo $rand; ?&gt;:visible&quot; ).length === 0 ) {
          return false;
        }

        /* Set global map, Infowindow and other params */
        window.map_&lt;?php echo $rand; ?&gt; = new google.maps.Map( document.getElementById( &quot;super_map_&lt;?php echo $rand; ?&gt;&quot; ), myOptions_&lt;?php echo $rand; ?&gt; );
        window.infowindow_&lt;?php echo $rand; ?&gt; = new google.maps.InfoWindow();
        window.bounds_&lt;?php echo $rand; ?&gt; = new google.maps.LatLngBounds();
        window.markers_&lt;?php echo $rand; ?&gt; = [];

        /* Set search params */
        var formFilter = jQuery( &#x27;#formFilter_&lt;?php echo $rand; ?&gt;&#x27; );
        window.supermap_&lt;?php echo $rand; ?&gt; = {
          total: &#x27;&lt;?php echo $atts[&#x27;total&#x27;]; ?&gt;&#x27;,
          per_page: &#x27;&lt;?php echo $atts[&#x27;per_page&#x27;]; ?&gt;&#x27;,
          starting_row: &#x27;&lt;?php echo $atts[&#x27;starting_row&#x27;]; ?&gt;&#x27;,
          pagination: &#x27;&lt;?php echo $atts[&#x27;pagination&#x27;]; ?&gt;&#x27;,
          sort_order: &#x27;&lt;?php echo $atts[&#x27;sort_order&#x27;]; ?&gt;&#x27;,
          sort_by: &#x27;&lt;?php echo $atts[&#x27;sort_by&#x27;]; ?&gt;&#x27;,
          action: &#x27;supermap_get_properties&#x27;,
          random: &#x27;&lt;?php echo $rand; ?&gt;&#x27;,
          property_type: &#x27;&lt;?php echo trim(( is_array($atts[&#x27;property_type&#x27;]) ? implode(&#x27;,&#x27;,$atts[&#x27;property_type&#x27;]) : $atts[&#x27;property_type&#x27;] )); ?&gt;&#x27;,
          search_atts: (formFilter.length &gt; 0 ? formFilter.serialize() : &#x27;&#x27;)
        };

        /* START Markers functionality */
        &lt;?php foreach ((array) $properties as $id =&gt; $value) : ?&gt;
        &lt;?php if ($value[&#x27;latitude&#x27;] &amp;&amp; $value[&#x27;longitude&#x27;]) : ?&gt;
        window.myLatlng_&lt;?php echo $rand; ?&gt;_&lt;?php echo $value[&#x27;ID&#x27;]; ?&gt; = new google.maps.LatLng( &lt;?php echo $value[&#x27;latitude&#x27;]; ?&gt;, &lt;?php echo $value[&#x27;longitude&#x27;]; ?&gt; );
        window.content_&lt;?php echo $rand; ?&gt;_&lt;?php echo $value[&#x27;ID&#x27;]; ?&gt; = &#x27;&lt;?php echo WPP_F::google_maps_infobox($value); ?&gt;&#x27;;

        window.marker_&lt;?php echo $rand; ?&gt;_&lt;?php echo $value[&#x27;ID&#x27;]; ?&gt; = new google.maps.Marker( {
          position: myLatlng_&lt;?php echo $rand; ?&gt;_&lt;?php echo $value[&#x27;ID&#x27;]; ?&gt;,
          map: map_&lt;?php echo $rand; ?&gt;,
          title: &#x27;&lt;?php echo str_replace(&quot;&#x27;&quot;,&quot;\&#x27;&quot;, !empty($value[$wp_properties[&#x27;configuration&#x27;][&#x27;address_attribute&#x27;]]) ? $value[$wp_properties[&#x27;configuration&#x27;][&#x27;address_attribute&#x27;]] : &#x27;&#x27; ); ?&gt;&#x27;,
          icon: &#x27;&lt;?php echo apply_filters(&#x27;wpp_supermap_marker&#x27;, &#x27;&#x27;, $value[&#x27;ID&#x27;]); ?&gt;&#x27;
        } );

        window.markers_&lt;?php echo $rand; ?&gt;.push( window.marker_&lt;?php echo $rand; ?&gt;_&lt;?php echo $value[&#x27;ID&#x27;]; ?&gt; );

        google.maps.event.addListener( marker_&lt;?php echo $rand; ?&gt;_&lt;?php echo $value[&#x27;ID&#x27;]; ?&gt;, &#x27;click&#x27;, function() {
          infowindow_&lt;?php echo $rand; ?&gt;.close();
          infowindow_&lt;?php echo $rand;  ?&gt;.setContent( content_&lt;?php echo $rand; ?&gt;_&lt;?php echo $value[&#x27;ID&#x27;]; ?&gt; );
          infowindow_&lt;?php echo $rand; ?&gt;.open( map_&lt;?php echo $rand; ?&gt;, marker_&lt;?php echo $rand; ?&gt;_&lt;?php echo $value[&#x27;ID&#x27;]; ?&gt; );
          loadFuncy();
          /* Highlighting clicked property on the map */
          makeActive( &lt;?php echo $rand; ?&gt;, &lt;?php echo $value[&#x27;ID&#x27;]; ?&gt; );
        } );

        google.maps.event.addListener( infowindow_&lt;?php echo $rand; ?&gt;, &#x27;domready&#x27;, function() {
          document.getElementById( &#x27;infowindow&#x27; ).parentNode.style.overflow = &#x27;hidden&#x27;;
          document.getElementById( &#x27;infowindow&#x27; ).parentNode.parentNode.style.overflow = &#x27;hidden&#x27;;
        } );

        bounds_&lt;?php echo $rand; ?&gt;.extend( window.myLatlng_&lt;?php echo $rand; ?&gt;_&lt;?php echo $value[&#x27;ID&#x27;]; ?&gt; );
        &lt;?php endif; ?&gt;
        &lt;?php endforeach; ?&gt;
        /* END Markers functionality */

        /* Set zoom */
        map_&lt;?php echo $rand; ?&gt;.setZoom( &lt;?php echo ((int)$zoom != 0 ? $zoom : 10); ?&gt; );
        /* Set center */
        &lt;?php if (!empty($center_on)) : ?&gt;
        map_&lt;?php echo $rand; ?&gt;.setCenter( new google.maps.LatLng( &lt;?php echo $center_on; ?&gt; ) );
        &lt;?php else: ?&gt;
        &lt;?php foreach ((array) $properties as $id =&gt; $p) : ?&gt;
        if( typeof myLatlng_&lt;?php echo $rand; ?&gt;_&lt;?php echo $p[&#x27;ID&#x27;]; ?&gt; != &#x27;undefined&#x27; ) {
          map_&lt;?php echo $rand; ?&gt;.setCenter( myLatlng_&lt;?php echo $rand; ?&gt;_&lt;?php echo $p[&#x27;ID&#x27;]; ?&gt; );
        }
        &lt;?php endforeach; ?&gt;
        &lt;?php endif; ?&gt;

        /* Prevent issue with map having no height if no CSS is included and no height is set via shortcode */
        if( jQuery( &quot;#super_map_&lt;?php echo $rand; ?&gt;&quot; ).height() === 0 ) {
          jQuery( &quot;#super_map_&lt;?php echo $rand; ?&gt;&quot; ).height( 400 );
        }

        &lt;?php if(empty($zoom) &amp;&amp; empty($center_on)): ?&gt;
        /* Set defaults */
        map_&lt;?php echo $rand; ?&gt;.fitBounds( bounds_&lt;?php echo $rand; ?&gt; );
        &lt;?php endif; ?&gt;

        &lt;?php if (!empty($area_lines)) : ?&gt;
        /* Renders Areas */
        &lt;?php echo $area_lines; ?&gt;
        &lt;?php endif; ?&gt;

        /* Bind events */
        /* Show More Event */
        jQuery( &#x27;.show_more&#x27;, &#x27;#super_map_list_&lt;?php echo $rand; ?&gt;&#x27; ).click( function() {
          getProperties( &lt;?php echo $rand; ?&gt;, &#x27;more&#x27; );
        } );

      }

      /**
       * Shows Infobox on Supermap
       */
      static
      function showInfobox_&lt;?php echo $rand; ?&gt;( id ) {
        map_&lt;?php echo $rand; ?&gt;.setCenter( eval( &#x27;myLatlng_&lt;?php echo $rand; ?&gt;_&#x27; + id ) );
        map_&lt;?php echo $rand; ?&gt;.setZoom( &lt;?php echo (int)$zoom != 0 ? $zoom : 10; ?&gt; );

        makeActive( &lt;?php echo $rand; ?&gt;, id );

        infowindow_&lt;?php echo $rand; ?&gt;.setContent( eval( &#x27;content_&lt;?php echo $rand; ?&gt;_&#x27; + id ) );

        setTimeout( function() {
          infowindow_&lt;?php echo $rand; ?&gt;.open( map_&lt;?php echo $rand; ?&gt;, eval( &#x27;marker_&lt;?php echo $rand; ?&gt;_&#x27; + id ) );
          loadFuncy();
        }, 500 );
      }

      /**
       * Set property as active in sidebar when property&#x27;s popup is opened on supermap
       */
      if( typeof makeActive != &#x27;function&#x27; ) {
        static
        function makeActive( rand, id ) {
          if( jQuery( &quot;.property_in_list&quot; ).length &gt; 0 ) {
            jQuery( &quot;.property_in_list&quot; ).removeClass( &quot;active&quot; );
          }
          if( jQuery( &quot;#property_in_list_&quot; + rand + &quot;_&quot; + id ).length &gt; 0 ) {
            jQuery( &quot;#property_in_list_&quot; + rand + &quot;_&quot; + id ).addClass( &quot;active&quot; );
          }
        }
      }

      /**
       *
       */
      if( typeof loadFuncy != &#x27;function&#x27; ) {
        static
        function loadFuncy() {
          jQuery( &quot;a#single_image&quot; ).fancybox( {
            transitionIn: &#x27;elastic&#x27;,
            transitionOut: &#x27;elastic&#x27;,
            speedIn: 600,
            speedOut: 200,
            overlayShow: false
          } );
        }
      }

      /**
       * Search properties and renders found ones on supermap
       *
       * @param rand
       * @param type
       */
      if( typeof getProperties != &#x27;function&#x27; ) {
        static
        function getProperties( rand, type ) {
          /* Set default type as &#x27;search&#x27; */
          if( typeof type == &#x27;undefined&#x27; ) {
            type = &#x27;search&#x27;;
          }

          /* Get search settings */
          var s = eval( &#x27;supermap_&#x27; + rand );
          var markers = eval( &#x27;markers_&#x27; + rand );
          var ajaxloader = jQuery( &#x27;.super_map_list .map_filters .search_loader&#x27; );

          switch( type ) {

            case &#x27;search&#x27;:
              jQuery( &#x27;#super_map_list_property_&#x27; + rand ).html( &#x27;&#x27; );
              s.search_atts = jQuery( &#x27;#formFilter_&#x27; + rand ).serialize();
              s.starting_row = 0;
              clearMarkers( markers );
              break;

            case &#x27;more&#x27;:
              s.starting_row = parseInt( s.starting_row ) + parseInt( s.per_page );
              break;

          }

          /* Prepare params for Ajax search */
          params = prepareSupermapSearchParams( s );

          ajaxloader.show();

          jQuery.ajax( {
            async: false,
            type: &quot;POST&quot;,
            url: &quot;&lt;?php echo admin_url(&#x27;admin-ajax.php&#x27;); ?&gt;&quot;,
            data: params,
            success: function( msg ) {
              eval( msg );
            }
          } );

          ajaxloader.hide();

          /* Show or hide &#x27;Show More&#x27; button */
          var sm = jQuery( &#x27;.show_more&#x27;, jQuery( &#x27;#super_map_list_property_&#x27; + rand ).parent() );
          if( sm.length &gt; 0 ) {
            if( (parseInt( s.starting_row ) + parseInt( s.per_page ) ) &gt;= parseInt( s.total ) ) {
              sm.hide();
            } else {
              sm.show();
            }
          }
        }
      }

      /**
       * Prepares Search params for get Properties
       *
       * @param rand
       * @return string $params Prepared params
       * @author Maxim Peshkov
       */
      if( typeof prepareSupermapSearchParams != &#x27;function&#x27; ) {
        static
        function prepareSupermapSearchParams( obj ) {
          var params = &#x27;&#x27;;
          for( var i in obj ) {
            if( params != &#x27;&#x27; ) {
              params += &#x27;&amp;&#x27;
            }
            if( i == &#x27;search_atts&#x27; ) {
              params += obj[i];
            } else {
              params += i + &#x27;=&#x27; + obj[i];
            }
          }
          return params;
        }
      }

      /**
       * Clear Markers on Supermap
       *
       * @param array $markers Array of google map objects (markers)
       * @author Maxim Peshkov
       */
      if( typeof clearMarkers != &#x27;function&#x27; ) {
        static
        function clearMarkers( markers ) {
          for( var i in markers ) {
            markers[i].setMap( null );
          }
        }
      }
    &lt;/script&gt;

      &lt;?php
      $return_content[ &#x27;script&#x27; ] = ob_get_contents();
      ob_end_clean();

      //** For now if only one attribute exists, and it&#x27;s the property_type, we do not render the form at all */
      if( count( $searchable_attributes ) == 1 &amp;&amp; in_array( &#x27;property_type&#x27;, array_keys( (array) $searchable_attributes ) ) ) {
        $searchable_attributes = false;
      }

      $supermap_configuration[ &#x27;display_attributes&#x27; ] = ( is_array( $supermap_configuration[ &#x27;display_attributes&#x27; ] ) ? $supermap_configuration[ &#x27;display_attributes&#x27; ] : array() );

      foreach( $supermap_configuration[ &#x27;display_attributes&#x27; ] as $attribute ) {
        $display_attributes[ $attribute ] = $wp_properties[ &#x27;property_stats&#x27; ][ $attribute ];
      }

      ob_start();
      ?&gt;
      &lt;div id=&quot;map_cont_&lt;?php echo $rand; ?&gt;&quot; class=&quot;wpp_supermap_wrapper &lt;?php echo $css_class; ?&gt;&quot; supermap_id=&quot;&lt;?php echo $rand; ?&gt;&quot;&gt;
      &lt;div id=&quot;super_map_&lt;?php echo $rand; ?&gt;&quot; class=&quot;super_map &lt;?php if( $hide_sidebar == &#x27;true&#x27; ): ?&gt;no_sidebar&lt;?php endif; ?&gt;&quot; &lt;?php echo $inline_styles[ &#x27;map&#x27; ]; ?&gt;&gt;&lt;/div&gt;
        &lt;?php if( $hide_sidebar == &#x27;false&#x27; ): ?&gt;
          &lt;div id=&quot;super_map_list_&lt;?php echo $rand; ?&gt;&quot; class=&quot;super_map_list&quot; &lt;?php echo $inline_styles[ &#x27;sidebar&#x27; ]; ?&gt;&gt;
        &lt;?php if( !empty( $searchable_attributes ) ) : ?&gt;
          &lt;?php //* hide the option link if  supermap shortcode doesn&#x27;t include any attribute connected with sortable attribute */ ?&gt;
          &lt;div class=&quot;supermap_filter_wrapper&quot;&gt;
            &lt;div class=&quot;hide_filter&quot;&gt;
              &lt;a onclick=&quot;jQuery(&#x27;#map_filters_&lt;?php echo $rand; ?&gt;&#x27;).slideToggle(&#x27;fast&#x27;);return false;&quot; href=&quot;javascript:;&quot;&gt;&lt;?php echo $options_label; ?&gt;&lt;/a&gt;
            &lt;/div&gt;
            &lt;div id=&quot;map_filters_&lt;?php echo $rand; ?&gt;&quot; class=&quot;map_filters&quot;&gt;
              &lt;?php //* Dynamic search options (attributes sets in shortcode) */ ?&gt;
              &lt;?php class_wpp_supermap::draw_supermap_options_form( $searchable_attributes, $atts[ &#x27;property_type&#x27; ], $rand ); ?&gt;
            &lt;/div&gt;
          &lt;/div&gt;&lt;!-- END  .supermap_filter_wrapper --&gt;
        &lt;?php endif; ?&gt;
            &lt;div id=&quot;super_map_list_property_&lt;?php echo $rand; ?&gt;&quot; class=&quot;super_map_list_property&quot;&gt;
        &lt;?php if( !empty( $properties ) ) {

          foreach( $properties as $key =&gt; $value ) {
            $attributes = array();

            $property_stats = WPP_F::get_stat_values_and_labels( $value, array(
              &#x27;property_stats&#x27; =&gt; $display_attributes
            ) );

            if( is_array( $property_stats ) ) {
              $labels_to_keys = array_flip( $wp_properties[ &#x27;property_stats&#x27; ] );

              foreach( $property_stats as $attribute_label =&gt; $attribute_value ) {
                $boolean_field  = false;
                $attribute_slug = $labels_to_keys[ $attribute_label ];
                $attribute_data = WPP_F::get_attribute_data( $attribute_slug );

                if( empty( $attribute_value ) ) {
                  continue;
                }

                if( ( $attribute_data[ &#x27;data_input_type&#x27; ] == &#x27;checkbox&#x27; &amp;&amp; ( $attribute_value == &#x27;true&#x27; || $attribute_value == 1 ) ) ) {
                  if( $wp_properties[ &#x27;configuration&#x27; ][ &#x27;google_maps&#x27; ][ &#x27;show_true_as_image&#x27; ] == &#x27;true&#x27; ) {
                    $attribute_value = &#x27;&lt;div class=&quot;true-checkbox-image&quot;&gt;&lt;/div&gt;&#x27;;
                  } else {
                    $attribute_value = __( &#x27;Yes&#x27;, &#x27;wpp&#x27; );
                  }
                  $boolean_field = true;
                } elseif( $attribute_value == &#x27;false&#x27; ) {
                  continue;
                }

                $attributes[ ] = &#x27;&lt;li class=&quot;supermap_list_&#x27; . $attribute_slug . &#x27; wpp_supermap_attribute_row&quot;&gt;&#x27;;
                $attributes[ ] = &#x27;&lt;span class=&quot;attribute&quot;&gt;&#x27; . $attribute_label . ( !$boolean_field ? &#x27;:&#x27; : &#x27;&#x27; ) . &#x27; &lt;/span&gt;&#x27;;
                $attributes[ ] = &#x27;&lt;span class=&quot;value&quot;&gt;&#x27; . $attribute_value . &#x27;&lt;/span&gt;&#x27;;
                $attributes[ ] = &#x27;&lt;/li&gt;&#x27;;
              }
            }

            if( in_array( &#x27;view_property&#x27;, $supermap_configuration[ &#x27;display_attributes&#x27; ] ) ) {
              $attributes[ ] = &#x27;&lt;li class=&quot;supermap_list_view_property&quot;&gt;&lt;a href=&quot;&#x27; . get_permalink( $value[ &#x27;ID&#x27; ] ) . &#x27;&quot; class=&quot;btn btn-info btn-small&quot;&gt;&lt;span&gt;&#x27; . __( &#x27;View Property&#x27;, &#x27;wpp&#x27; ) . &#x27;&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;&#x27;;
            }
            $image = array();
            if( $supermap_configuration[ &#x27;hide_sidebar_thumb&#x27; ] != &#x27;true&#x27; ) {
              $image = wpp_get_image_link( $value[ &#x27;featured_image&#x27; ], $supermap_configuration[ &#x27;supermap_thumb&#x27; ], array( &#x27;return&#x27; =&gt; &#x27;array&#x27; ) );
            }

            ?&gt;
            &lt;?php if( $value[ &#x27;latitude&#x27; ] &amp;&amp; $value[ &#x27;longitude&#x27; ] &amp;&amp; $value[ &#x27;ID&#x27; ] ) { ?&gt;
              &lt;div id=&quot;property_in_list_&lt;?php echo $rand; ?&gt;_&lt;?php echo $value[ &#x27;ID&#x27; ]; ?&gt;&quot; class=&quot;property_in_list clearfix&quot;&gt;
                &lt;ul class=&#x27;property_in_list_items clearfix&#x27;&gt;
                  &lt;?php if( $supermap_configuration[ &#x27;hide_sidebar_thumb&#x27; ] != &#x27;true&#x27; ) { ?&gt;
                    &lt;li class=&#x27;supermap_list_thumb&#x27;&gt;&lt;span onclick=&quot;showInfobox_&lt;?php echo $rand; ?&gt;(&lt;?php echo $value[ &#x27;ID&#x27; ]; ?&gt;);&quot;&gt;&lt;img class=&quot;&lt;?php echo( $image[ &#x27;link&#x27; ] ? &#x27;wpp_supermap_thumb&#x27; : &#x27;wpp_supermap_thumb wpp_default_iamge&#x27; ); ?&gt;&quot; src=&quot;&lt;?php echo( empty( $image[ &#x27;link&#x27; ] ) ? WPP_URL . &#x27;templates/images/no_image.png&#x27; : $image[ &#x27;link&#x27; ] ); ?&gt;&quot; style=&quot;&lt;?php echo( $image[ &#x27;width&#x27; ] ? &#x27;width: &#x27; . $image[ &#x27;width&#x27; ] . &#x27;px; &#x27; : &#x27;&#x27; ); ?&gt;&quot; alt=&quot;&lt;?php echo $value[ &#x27;post_title&#x27; ]; ?&gt;&quot;/&gt;&lt;/span&gt;&lt;/li&gt;
                  &lt;?php } ?&gt;
                  &lt;li class=&#x27;supermap_list_title&#x27;&gt;&lt;span onclick=&quot;showInfobox_&lt;?php echo $rand; ?&gt;(&lt;?php echo $value[ &#x27;ID&#x27; ]; ?&gt;);&quot;&gt;&lt;?php echo stripslashes( $value[ &#x27;post_title&#x27; ] ); ?&gt;&lt;/span&gt;&lt;/li&gt;
                  &lt;?php if( count( $attributes ) &gt; 0 ) {
                    echo implode( &#x27;&#x27;, $attributes );
                  } ?&gt;
                &lt;/ul&gt;
              &lt;/div&gt;
            &lt;?php } ?&gt;
          &lt;?php } ?&gt;
        &lt;?php } ?&gt;
        &lt;/div&gt;
            &lt;?php if( $atts[ &#x27;pagination&#x27; ] == &#x27;on&#x27; ) { ?&gt;
              &lt;div class=&quot;show_more btn&quot; style=&quot;&lt;?php echo count( $properties ) &lt; $atts[ &#x27;total&#x27; ] ? &#x27;&#x27; : &#x27;display:none;&#x27;; ?&gt;&quot;&gt;
          &lt;?php _e( &#x27;Show More&#x27;, &#x27;wpp&#x27; ); ?&gt;
                &lt;div class=&quot;search_loader&quot; style=&quot;display:none&quot;&gt;&lt;?php _e( &#x27;Loading...&#x27;, &#x27;wpp&#x27; ); ?&gt;&lt;/div&gt;
        &lt;/div&gt;
            &lt;?php } ?&gt;
      &lt;/div&gt;

        &lt;?php endif; /*hide_sidebar */ ?&gt;
        &lt;br class=&quot;cb clear&quot;/&gt;
    &lt;/div&gt;
      &lt;?php
      $return_content[ &#x27;html&#x27; ] = ob_get_contents();
      ob_end_clean();

      $return_content[ &#x27;script&#x27; ] = WPP_F::minify_js( $return_content[ &#x27;script&#x27; ] );

      return implode( $return_content );

    }

    /**
     * Draws Option Form on sidebar of Supermap
     *
     * @param $search_attributes
     * @param $searchable_property_types
     * @param $rand
     */
    static function draw_supermap_options_form( $search_attributes = false, $searchable_property_types = false, $rand = 0 ) {
      global $wp_properties;
      if( !$search_attributes ) {
        return;
      }

      $search_values = WPP_F::get_search_values( array_keys( (array) $search_attributes ), $searchable_property_types );
      ?&gt;
      &lt;form id=&quot;formFilter_&lt;?php echo $rand; ?&gt;&quot; name=&quot;formFilter&quot; action=&quot;&quot;&gt;
        &lt;div class=&quot;class_wpp_supermap_elements&quot;&gt;
          &lt;ul&gt;
            &lt;?php if( is_array( $search_attributes ) ) foreach( $search_attributes as $attrib =&gt; $search_value ) {
              // Don&#x27;t display search attributes that have no values
              if( !isset( $search_values[ $attrib ] ) )
                continue;

              $delimiter = &#x27;,&#x27;;
              /* Set $search_value to use it in form fields */
              if( strtolower( $search_value ) == &#x27;all&#x27; ) {
                $search_value = &#x27;&#x27;;
              } else if( strpos( $search_value, &#x27;-&#x27; ) !== false ) {
                $v = explode( &#x27;-&#x27;, $search_value );
                if( is_array( $v ) &amp;&amp; count( $v ) == 2 &amp;&amp; ( (int) $v[ 0 ] &gt; 0 || (int) $v[ 1 ] &gt; 0 ) ) {
                  $delimiter    = &#x27;-&#x27;;
                  $search_value = array(
                    &#x27;min&#x27; =&gt; (int) $v[ 0 ],
                    &#x27;max&#x27; =&gt; (int) $v[ 1 ],
                  );
                }
              } else if( strpos( $search_value, &#x27;,&#x27; ) !== false ) {
                $v = explode( &#x27;,&#x27;, $search_value );
                if( is_array( $v ) ) {
                  $search_value = $v;
                }
              }
              ?&gt;
              &lt;li class=&quot;seach_attribute_&lt;?php echo $attrib; ?&gt; field_&lt;?php echo $wp_properties[ &#x27;searchable_attr_fields&#x27; ][ $attrib ]; ?&gt;&quot;&gt;
              &lt;label class=&quot;class_wpp_supermap_label class_wpp_supermap_label_&lt;?php echo $attrib; ?&gt;&quot; for=&quot;class_wpp_supermap_input_field_&lt;?php echo $attrib; ?&gt;_&lt;?php echo $rand; ?&gt;&quot;&gt;
                &lt;?php echo( empty( $wp_properties[ &#x27;property_stats&#x27; ][ $attrib ] ) ? ucwords( $attrib ) : $wp_properties[ &#x27;property_stats&#x27; ][ $attrib ] ) ?&gt;
                :
              &lt;/label&gt;
                &lt;?php
                wpp_render_search_input( array(
                  &#x27;attrib&#x27;            =&gt; $attrib,
                  &#x27;random_element_id&#x27; =&gt; &quot;class_wpp_supermap_input_field_{$attrib}_{$rand}&quot;,
                  &#x27;search_values&#x27;     =&gt; $search_values,
                  &#x27;value&#x27;             =&gt; $search_value
                ) );
                ?&gt;
                &lt;div class=&quot;clear&quot;&gt;&lt;/div&gt;
            &lt;/li&gt;
            &lt;?php } ?&gt;
        &lt;/ul&gt;
        &lt;input class=&quot;search_b btn&quot; type=&quot;button&quot; value=&quot;Search&quot; onclick=&quot;getProperties(&lt;?php echo $rand; ?&gt;)&quot;/&gt;
        &lt;div class=&quot;search_loader&quot; style=&quot;display:none&quot;&gt;&lt;?php _e( &#x27;Loading&#x27;, &#x27;wpp&#x27; ) ?&gt;&lt;/div&gt;
      &lt;/div&gt; &lt;?php //end of class_wpp_supermap_elements ?&gt;
    &lt;/form&gt;
    &lt;?php
    }

    /**
     * Check specific supermap keys to properties
     * and add/remove/modify them to avoid issues on supermap
     * &amp;
     * Check supermap files (markers): remove unused.
     *
     * @author Maxim Peshkov
     */
    static function settings_save( $wpp_settings ) {
      global $wpdb;

      //* START Markers (files) checking */
      $upload_dir  = wp_upload_dir();
      $markers_dir = $upload_dir[ &#x27;basedir&#x27; ] . &#x27;/supermap_files/markers&#x27;;
      $markers     = $wpp_settings[ &#x27;configuration&#x27; ][ &#x27;feature_settings&#x27; ][ &#x27;supermap&#x27; ][ &#x27;markers&#x27; ];
      //* Get all markers files */
      $files = array();
      foreach( (array) $markers as $marker ) {
        if( !empty( $marker[ &#x27;file&#x27; ] ) ) {
          $files[ ] = $marker[ &#x27;file&#x27; ];
        }
      }
      //* Remove image if it&#x27;s not related to marker */
      if( file_exists( $markers_dir ) ) {
        if( $dh = opendir( $markers_dir ) ) {
          while( ( $file = readdir( $dh ) ) !== false ) {
            if( !is_dir( $file ) &amp;&amp; preg_match( &quot;/(.*)\.(bmp|jpe?g|gif|png)$/&quot;, $file, $matches ) ) {
              if( !in_array( $file, $files ) ) {
                unlink( $markers_dir . &#x27;/&#x27; . $file );
              }
            }
          }
          closedir( $dh );
        }
      }

      //* END Markers (files) checking */
      return $wpp_settings;
    }

    /**
     * Filters every import attribute
     *
     * @global array $wp_properties
     *
     * @param mixed  $value
     * @param string $attribute
     * @param string $type
     * @param int    $post_id
     *
     * @return mixed
     * @author korotkov@ud
     */
    static function importer_meta_filter( $value, $attribute, $type, $post_id ) {
      global $wp_properties;

      /**
       * Add missed meta required for Supermap
       */
      if( $type &amp;&amp; $type == &#x27;meta_field&#x27; ) {
        $address_attribute = !empty( $wp_properties[ &#x27;configuration&#x27; ][ &#x27;address_attribute&#x27; ] ) ? $wp_properties[ &#x27;configuration&#x27; ][ &#x27;address_attribute&#x27; ] : &#x27;&#x27;;
        if( $address_attribute == $attribute ) {
          update_post_meta( $post_id, &#x27;exclude_from_supermap&#x27;, &#x27;false&#x27; );
        }
      }

      return $value;
    }

  }

endif; // Class Exists

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
