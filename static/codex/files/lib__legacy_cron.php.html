<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>lib/_legacy/cron.php - usabilitydynamics/wp-property</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="usabilitydynamics/wp-property"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 2.0.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/Bootstrap.html">Bootstrap</a></li>
            
                <li><a href="../classes/UsabilityDynamics\WPP.Bootstrap.html">UsabilityDynamics\WPP.Bootstrap</a></li>
            
                <li><a href="../classes/UsabilityDynamics\WPP.Loader.html">UsabilityDynamics\WPP.Loader</a></li>
            
                <li><a href="../classes/WPP.html">WPP</a></li>
            
                <li><a href="../classes/wpp_default_api.html">wpp_default_api</a></li>
            
                <li><a href="../classes/WPP_UI.html">WPP_UI</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: lib/_legacy/cron.php</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&lt;?php
/**
Name: Cron for WP Property
Description: Allow cron jobs to be executed from Command Line interface.
@todo Fix so that we&#x27;re using the correct deletion function.
*/
ini_set( &quot;display_errors&quot;, 1);
set_time_limit(0);
ignore_user_abort(true);

//** It seams cron service in CPanel works not like normal Linux Cron, so we have to emulate $argv */
$VERBOSE = true;
if (!empty($_REQUEST) &amp;&amp; array_key_exists(&#x27;do_xml_import&#x27;,$_REQUEST)){
  $argv = array_keys($_REQUEST);
}

/** Need to at least have the do_xml_import argument */
if (empty($argv[0])) {
  if($VERBOSE){ print(&quot;Missing arguments.\n&quot;); }
  exit(1);
}

$cron_action = $argv[1];
$schedule_hash = $argv[2];
$ms_url = (!empty($argv[3])) ? $argv[3] : &#x27;&#x27;;

//** Load WP */
$wp_load_path = preg_replace(&#x27;%wp-content[/\\\\]plugins[/\\\\]wp-property[/\\\\]cron.php%ix&#x27;, &#x27;wp-load.php&#x27;, __FILE__);

if(!file_exists($wp_load_path)) {
  if($VERBOSE){ print(&#x27;Cannot load WP using: &#x27; . $wp_load_path .&quot;\n&quot;); }
  exit(1);
} else {

  /** these argumants should be passed in multisite mode */
  if (!empty($ms_url) ) {

    $site_name = parse_url(&#x27;http://&#x27;.$ms_url,PHP_URL_PATH);
    $site_domain = parse_url(&#x27;http://&#x27;.$ms_url, PHP_URL_HOST);
    /**
    * Construct a fake $_SERVER global to get WordPress to load a specific site.
    * This avoids alot of messing about with switch_to_blog() and all its pitfalls.
    */
    $_SERVER=array(
      &#x27;HTTP_HOST&#x27;=&gt;$site_domain,
      &#x27;REQUEST_METHOD&#x27;=&gt;&#x27;GET&#x27;,
      &#x27;REQUEST_URI&#x27;=&gt;&quot;{$site_name}/&quot;,
      &#x27;SERVER_NAME&#x27;=&gt;$site_domain,
    );

    // Remove all our bespoke variables as they&#x27;ll be in scope as globals and could affect WordPress
    unset($site_name,$site_domain);

    // Pretend that we&#x27;re executing an AJAX process. This should help WordPress not load all of the things.
    define(&#x27;DOING_AJAX&#x27;,true);

    // Stop WordPress doing any of its normal output handling.
    define(&#x27;WP_USE_THEMES&#x27;,false);
  }

  // Load WordPress - intentionally using an absolute URL due to issues with relative paths on the CLI.
  include $wp_load_path;

}

//** Enable/disable debug mode. debug_mode argv must be passed to enable it. */
if( !defined( &#x27;WPP_DEBUG_MODE&#x27; ) ) {
  define( &#x27;WPP_DEBUG_MODE&#x27;, ( !empty( $argv[3] ) &amp;&amp; $argv[3] == &#x27;debug_mode&#x27; ? true : false ) );
}

//** Ensure file was loaded and procesed */
if(ABSPATH &amp;&amp; class_exists(&#x27;class_wpp_property_import&#x27;)) {
  define(&#x27;DOING_WPP_CRON&#x27;, true);
} else {
  if($VERBOSE){ print(&#x27;Unable to load XML Importer.&#x27; . &quot;\n&quot;); }
  exit(1);
}


if(empty($cron_action)) {
  if($VERBOSE){ print(&quot;Missing action argument.\n&quot;); }
  exit(1);
}

/** Begin Loading Import*/
if($cron_action == &#x27;do_xml_import&#x27; &amp;&amp; !empty($schedule_hash)) {

    define(&#x27;WPP_IMPORTER_HASH&#x27;, $schedule_hash);

    //class_wpp_property_import::init();
    class_wpp_property_import::run_from_cron_hash();

    exit(0);

} elseif($cron_action == &#x27;erase_all_properties&#x27;) {
  global $wpdb;
  $wpdb-&gt;show_errors();
  /** First, delete attachments */
  $sql = &quot;SELECT ID FROM {$wpdb-&gt;prefix}posts WHERE post_type = &#x27;attachment&#x27; AND post_parent IN (SELECT ID FROM {$wpdb-&gt;prefix}posts WHERE post_type = &#x27;property&#x27;) OR post_excerpt = &#x27;qr_code&#x27;&quot;;
  foreach($wpdb-&gt;get_results($sql) as $row) {
    wp_delete_attachment($row-&gt;ID, true);
    if($VERBOSE){ print( &quot;Deleted attachment: &quot;.$row-&gt;ID.&quot;\r\n&quot;); }
  }
  /** Now, delete posts */
  $sql = &quot;SELECT ID FROM {$wpdb-&gt;prefix}posts WHERE post_type = &#x27;property&#x27;&quot;;
  foreach($wpdb-&gt;get_results($sql) as $row){
    wp_delete_post($row-&gt;ID, true);
    if($VERBOSE){ print( &quot;Deleted post: &quot;.$row-&gt;ID.&quot;\r\n&quot;); }
  }
  print( &quot;Done deleting posts.\r\n&quot;);
  exit(0);
}
else {
  print( &quot;Nothing done.\r\n&quot;);
  exit(0);
}
exit(0);
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
