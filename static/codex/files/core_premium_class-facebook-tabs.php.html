<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>core/premium/class-facebook-tabs.php - WP-Property</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="WP-Property"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 1.38.2</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/wpp.html">wpp</a></li>
            
                <li><a href="../classes/wpp.overview.html">wpp.overview</a></li>
            
                <li><a href="../classes/wpp.ui.agents.html">wpp.ui.agents</a></li>
            
                <li><a href="../classes/wpp.ui.feps.html">wpp.ui.feps</a></li>
            
                <li><a href="../classes/wpp.ui.settings.html">wpp.ui.settings</a></li>
            
                <li><a href="../classes/wpp.xmli.html">wpp.xmli</a></li>
            
                <li><a href="../classes/WPP_RETS.html">WPP_RETS</a></li>
            
                <li><a href="../classes/WPP_UI.html">WPP_UI</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: core/premium/class-facebook-tabs.php</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&lt;?php
/**
 * Name: Facebook Tabs
 * Feature ID: 18
 * Minimum Core Version: 1.38.3
 * Version: 1.0.2
 * Description: Allows Facebook users insert Page Tabs with WP-Property Canvas to Facebook pages.
 * Class: UsabilityDynamics\WPP\Facebok_Tabs
 *
 */
namespace UsabilityDynamics\WPP {

  if( !class_exists( &#x27;UsabilityDynamics\WPP\Facebok_Tabs&#x27; ) ) {

    /**
     * Facebok_Tabs Class
     *
     * Contains administrative functions
     *
     * Copyright 2010 Andy Potanin, TwinCitiesTech.com, Inc.  &lt;andy.potanin@twincitiestech.com&gt;
     *
     * @version 1.0
     * @author Andy Potanin &lt;andy.potanin@twincitiestech.com&gt;
     * @package WP-Property
     * @subpackage Admin Functions
     */
    class Facebok_Tabs {

      function __construct() {


      }

      function get( $key, $default ) {}
      function set( $key, $value ) {}

      /**
       * Prevent Facebook integration if &#x27;Facebook Tabs&#x27; did not enabled.
       *
       * Migrated out of WP-Property Core.
       *
       * @todo Convert to check if feature is enabled.
       *
       * @author korotkov@ud
       */
      static function check_facebook_tabs() {

        //** Check if FB Tabs is not installed to prevent an ability to use WPP as Facebook App or Page Tab */
        if( !class_exists( &#x27;class_wpp_facebook_tabs&#x27; ) ) {

          //** If request goes really from Facebook */
          if( !empty( $_REQUEST[ &#x27;signed_request&#x27; ] ) &amp;&amp; strstr( $_SERVER[ &#x27;HTTP_REFERER&#x27; ], &#x27;facebook.com&#x27; ) ) {

            //** Show message */
            die( sprintf( __( &#x27;You cannot use your site as Facebook Application. You should &lt;a href=&quot;%s&quot;&gt;purchase&lt;/a&gt; WP-Property Premium Feature &quot;Facebook Tabs&quot; to manage your Facebook Tabs.&#x27;, &#x27;wpp&#x27; ), &#x27;https://usabilitydynamics.com/products/wp-property/premium/&#x27; ) );
          }
        }

      }

      static protected $version = &#x27;1.0.2&#x27;;

      /**
       * Capability to manage the current feature
       *
       * @var string
       * @author korotkov@UD
       */
      const capability = &quot;manage_wpp_facebook_tabs&quot;;

      /**
       * Input name base
       *
       * @var string
       * @author korotkov@ud
       */
      const post_name_base = &quot;wpp_settings[configuration][feature_settings][facebook_tabs]&quot;;

      /**
       * Query var which is used for parse request.
       * Determines if the request to facebook tab canvas
       *
       * @var string
       * @author peshkov@UD
       */
      const query_var = &quot;wpp_fb_canvas&quot;;

      function _construct() {
        add_action( &#x27;wpp_init&#x27;, array( &amp;$this, &#x27;wpp_init&#x27; ) );
        add_action( &#x27;wpp_pre_init&#x27;, array( &amp;$this, &#x27;wpp_pre_init&#x27; ) );

        // Check if Facebook tries to request site.
        add_action( &#x27;init&#x27;, array( &amp;$this, &#x27;check_facebook_tabs&#x27; ) );


      }

      /**
       * Special functions that must be called prior to init
       *
       * @action wpp_pre_init (10)
       * @author korotkov@UD
       */
      function wpp_pre_init() {
        global $wp_properties;

        /** Add Facebook Tabs page under Properties nav menu */
        add_action( &quot;admin_menu&quot;, array( __CLASS__, &quot;admin_menu&quot; ), 11 );

        /** Admin specific */
        add_action( &quot;admin_init&quot;, array( __CLASS__, &quot;admin_init&quot; ) );
        add_filter( &#x27;wpp_settings_save&#x27;, array( __CLASS__, &#x27;wpp_settings_save&#x27; ), 0, 2 );

        //** Add filter to hide selected pages */
        add_filter( &#x27;get_pages&#x27;, array( __CLASS__, &quot;hide_pages&quot; ) );

        //** Template Redirect: Capture Single Properties and Overview Pages */
        add_action( &#x27;template_redirect_single_property&#x27;, array( __CLASS__, &quot;template_redirect&quot; ) );
        add_action( &#x27;template_redirect_property_overview&#x27;, array( __CLASS__, &quot;template_redirect&quot; ) );

        //** Template Redirect: Capture all other pages after WPP&#x27;s template_redirect has gone */
        add_action( &#x27;wpp_template_redirect_post_scripts&#x27;, array( __CLASS__, &quot;template_redirect&quot; ) );

        //** Add capability */
        add_filter( &#x27;wpp_capabilities&#x27;, array( __CLASS__, &quot;add_capability&quot; ) );

        //** Add AJAX action for get_properties */
        add_action( &#x27;wp_ajax_wpp_fb_tabs_get_properties&#x27;, array( __CLASS__, &quot;get_properties&quot; ) );

        //** Updates all WPP rewrite rules on flush_rewrite_rules() */
        add_action( &#x27;rewrite_rules_array&#x27;, array( __CLASS__, &#x27;_rewrite_rules&#x27; ), 20 );
        add_filter( &#x27;query_vars&#x27;, array( __CLASS__, &#x27;_insertqv&#x27; ) );
        add_filter( &#x27;the_posts&#x27;, array( __CLASS__, &#x27;_wpp_fb_page&#x27; ) );
        add_action( &#x27;wp_loaded&#x27;, array( __CLASS__, &#x27;_flush_rules&#x27; ) );
        add_filter( &#x27;ud::template_part::fb_tabs&#x27;, array( __CLASS__, &quot;template_part_fb_tabs&quot; ), 10, 2 );
        add_filter( &#x27;ud::current_instance&#x27;, array( __CLASS__, &#x27;current_template_instance&#x27; ) );

      }

      /**
       * Apply feature&#x27;s Hooks and other functionality
       *
       * @global array $wp_properties
       * @author korotkov@ud
       */
      static function wpp_init() {

        //** If user have permissions */
        if( current_user_can( self::capability ) ) {
          global $wp_properties;

          //** FT contextual help */
          add_action( &#x27;load-property_page_facebook_tabs&#x27;, array( __CLASS__, &#x27;add_contextual_help&#x27; ) );

        }
      }

      /**
       * Handle pre-headers functions.
       *
       * @author peshkov@UD
       */
      function admin_init() {

        add_action( &quot;admin_enqueue_scripts&quot;, array( __CLASS__, &quot;admin_enqueue_scripts&quot; ) );

        if( wp_verify_nonce( $_REQUEST[ &#x27;_wpnonce&#x27; ], &#x27;wpp_save_facebook_tabs_page&#x27; ) ) {
          //** Update facebook tabs settings */
          $_wp_properties                                                                           = get_option( &#x27;wpp_settings&#x27; );
          $_wp_properties[ &#x27;configuration&#x27; ][ &#x27;feature_settings&#x27; ][ &#x27;facebook_tabs&#x27; ][ &#x27;canvases&#x27; ] = $_REQUEST[ &#x27;wpp_fb&#x27; ];
          update_option( &#x27;wpp_settings&#x27;, $_wp_properties );

          wp_redirect( &#x27;edit.php?post_type=property&amp;page=facebook_tabs&amp;message=updated&#x27; );
        }

      }

      /**
       *
       * @author peshkov@UD
       */
      function admin_menu() {
        add_submenu_page( &#x27;edit.php?post_type=property&#x27;, __( &#x27;Facebook Tabs&#x27;, &#x27;wpp&#x27; ), __( &#x27;Facebook Tabs&#x27;, &#x27;wpp&#x27; ), self::capability, &#x27;facebook_tabs&#x27;, array( __CLASS__, &#x27;page_facebook_tabs&#x27; ) );
      }

      /**
       * Prevents missing canvases configuration on global settings saving
       *
       * @global array $wp_properties
       *
       * @param array  $settings
       *
       * @return array
       * @author peshkov@UD
       */
      function wpp_settings_save( $settings ) {
        global $wp_properties;

        if( !empty( $wp_properties[ &#x27;configuration&#x27; ][ &#x27;feature_settings&#x27; ][ &#x27;facebook_tabs&#x27; ][ &#x27;canvases&#x27; ] ) ) {
          $settings[ &#x27;configuration&#x27; ][ &#x27;feature_settings&#x27; ][ &#x27;facebook_tabs&#x27; ][ &#x27;canvases&#x27; ] = $wp_properties[ &#x27;configuration&#x27; ][ &#x27;feature_settings&#x27; ][ &#x27;facebook_tabs&#x27; ][ &#x27;canvases&#x27; ];
        } else {
          $settings[ &#x27;configuration&#x27; ][ &#x27;feature_settings&#x27; ][ &#x27;facebook_tabs&#x27; ][ &#x27;canvases&#x27; ] = array();
        }

        return $settings;
      }

      /**
       * Ajax handler for searching properties in autocomplete
       *
       * @author korotkov@ud
       */
      function get_properties() {

        //** Flush variables */
        $found_post_data = array();

        //** Search properties */
        $properties = new WP_Query(
          array(
            &#x27;s&#x27;         =&gt; $_REQUEST[ &#x27;s&#x27; ],
            &#x27;post_type&#x27; =&gt; &#x27;property&#x27;
          )
        );

        //** Get required data */
        if( !empty( $properties ) &amp;&amp; !empty( $properties-&gt;posts ) ) {
          foreach( $properties-&gt;posts as $post ) {
            $data               = new stdClass();
            $data-&gt;title        = $post-&gt;post_title;
            $data-&gt;id           = $post-&gt;ID;
            $found_post_data[ ] = $data;
          }
        }

        //** Print json that will be recognized as Object by JS */
        die( json_encode( $found_post_data ) );
      }

      /**
       * Contextual Help
       *
       * @author korotkov@ud
       */
      function add_contextual_help() {

        $contextual_help[ &#x27;About&#x27; ][ ] = &#x27;&lt;h3&gt;&#x27; . __( &#x27;Facebook Tabs&#x27;, &#x27;wpp&#x27; ) . &#x27;&lt;/h3&gt;&#x27;;
        $contextual_help[ &#x27;About&#x27; ][ ] = &#x27;&lt;p&gt;&#x27; . __( &#x27;Feature allows you to create Facebook Canvases for Tabs or Applications.&#x27;, &#x27;wpp&#x27; ) . &#x27;&lt;/p&gt;&#x27;;
        $contextual_help[ &#x27;About&#x27; ][ ] = &#x27;&lt;p&gt;&#x27; . __( &#x27;Note that SSL support for your page tab app has been mandatory since October 1, 2011.&#x27;, &#x27;wpp&#x27; ) . &#x27;&lt;/p&gt;&#x27;;

        $contextual_help[ &#x27;Name&#x27; ][ ] = &#x27;&lt;p&gt;&#x27; . __( &#x27;&lt;b&gt;Name&lt;/b&gt;&lt;br /&gt;&#x27;, &#x27;wpp&#x27; ) . &#x27;&lt;/p&gt;&#x27;;
        $contextual_help[ &#x27;Name&#x27; ][ ] = &#x27;&lt;p&gt;&#x27; . __( &#x27;General name of your Canvas.&#x27;, &#x27;wpp&#x27; ) . &#x27;&lt;/p&gt;&#x27;;
        $contextual_help[ &#x27;Name&#x27; ][ ] = &#x27;&lt;p&gt;&#x27; . __( &#x27;Name is used for canvas links generation. See Facebook App Setup tab.&#x27;, &#x27;wpp&#x27; ) . &#x27;&lt;/p&gt;&#x27;;
        $contextual_help[ &#x27;Name&#x27; ][ ] = &#x27;&lt;p&gt;&#x27; . __( &#x27;Links use sanitized name of your Canvas\&#x27; name. So they will be recreated every time you change the name.&#x27;, &#x27;wpp&#x27; ) . &#x27;&lt;/p&gt;&#x27;;
        $contextual_help[ &#x27;Name&#x27; ][ ] = &#x27;&lt;p&gt;&#x27; . __( &#x27;Make sure you do not have Canvases with the same slugs.&#x27;, &#x27;wpp&#x27; ) . &#x27;&lt;/p&gt;&#x27;;

        $contextual_help[ &#x27;Page&#x27; ][ ] = &#x27;&lt;p&gt;&#x27; . __( &#x27;&lt;b&gt;Page Settings&lt;/b&gt;&lt;br/&gt;&#x27;, &#x27;wpp&#x27; ) . &#x27;&lt;/p&gt;&#x27;;
        $contextual_help[ &#x27;Page&#x27; ][ ] = &#x27;&lt;p&gt;&#x27; . __( &#x27;&lt;b&gt;Type&lt;/b&gt;&lt;br /&gt;The list of available post types. Available pages depend on the selected type.&#x27;, &#x27;wpp&#x27; ) . &#x27;&lt;/p&gt;&#x27;;
        $contextual_help[ &#x27;Page&#x27; ][ ] = &#x27;&lt;p&gt;&#x27; . __( &#x27;&lt;b&gt;Page&lt;/b&gt;&lt;br /&gt;The page of your site which has the content which you need to display in your Facebook Tab or Application.&#x27;, &#x27;wpp&#x27; ) . &#x27;&lt;/p&gt;&#x27;;
        $contextual_help[ &#x27;Page&#x27; ][ ] = &#x27;&lt;p&gt;&#x27; . __( &#x27;&lt;b&gt;Hide the selected page from Regular WordPress&lt;/b&gt;&lt;br /&gt;Hidden pages will not be accessible in Regular Wordpress and in other Premium Features too. The current option is only related to pages.&#x27;, &#x27;wpp&#x27; ) . &#x27;&lt;/p&gt;&#x27;;

        $contextual_help[ &#x27;Template Settings&#x27; ][ ] = &#x27;&lt;p&gt;&#x27; . __( &#x27;&lt;b&gt;Template Settings&lt;/b&gt;&lt;br/&gt;&#x27;, &#x27;wpp&#x27; ) . &#x27;&lt;/p&gt;&#x27;;
        $contextual_help[ &#x27;Template Settings&#x27; ][ ] = &#x27;&lt;p&gt;&#x27; . __( &#x27;&lt;b&gt;Template&lt;/b&gt;&lt;br /&gt;Specify one of existing templates for displaying Page content. Default are &lt;code&gt;templates/fb-tab-page.php&lt;/code&gt; and &lt;code&gt;templates/fb-tab-property.php&lt;/code&gt;.&lt;br/&gt;&#x27;, &#x27;wpp&#x27; );
        $contextual_help[ &#x27;Template Settings&#x27; ][ ] = __( &#x27;You can add your own templates named like &lt;code&gt;fb-tab-{your name}.php&lt;/code&gt; in your theme folder and with the comment inside like:&#x27;, &#x27;wpp&#x27; );
        $contextual_help[ &#x27;Template Settings&#x27; ][ ] = __( &#x27;&lt;pre&gt;&lt;code&gt;/**&lt;br/&gt;&amp;nbsp;* Template Name: {your name}&lt;br/&gt;&amp;nbsp;* Type: {page|property}&lt;br/&gt;&amp;nbsp*/&lt;/code&gt;&lt;/pre&gt;Use Default template as a base for your own.&#x27;, &#x27;wpp&#x27; ) . &#x27;&lt;/p&gt;&#x27;;
        $contextual_help[ &#x27;Template Settings&#x27; ][ ] = &#x27;&lt;p&gt;&#x27; . __( &#x27;&lt;b&gt;Enable theme\&#x27;s template parts&lt;/b&gt;&lt;br /&gt;Canvas uses default WP-Property template parts by default ( e.g. &lt;code&gt;templates/property_overview.php&lt;/code&gt; , &lt;code&gt;templates/property_search.php&lt;/code&gt; ).&lt;br/&gt;If enabled (checked), application will load template parts from your theme\&#x27;s folder if they exist. &lt;b&gt;But, remember, custom template parts can be incompatible with default CSS styles.&lt;/b&gt;&#x27;, &#x27;wpp&#x27; ) . &#x27;&lt;/p&gt;&#x27;;
        $contextual_help[ &#x27;Template Settings&#x27; ][ ] = &#x27;&lt;p&gt;&#x27; . __( &#x27;&lt;b&gt;Open links in new window&lt;/b&gt;&lt;br /&gt;Check this option if you need to open EACH link of your WP-Property Facebook Tab in new window.&#x27;, &#x27;wpp&#x27; ) . &#x27;&lt;/p&gt;&#x27;;
        $contextual_help[ &#x27;Template Settings&#x27; ][ ] = &#x27;&lt;p&gt;&#x27; . __( &#x27;&lt;b&gt;Open forms in new window&lt;/b&gt;&lt;br /&gt;The same as &lt;b&gt;Open links in new window&lt;/b&gt; but for forms. Every form will be submitted in new window.&#x27;, &#x27;wpp&#x27; ) . &#x27;&lt;/p&gt;&#x27;;
        $contextual_help[ &#x27;Template Settings&#x27; ][ ] = &#x27;&lt;p&gt;&#x27; . __( &#x27;&lt;b&gt;Disable default CSS&lt;/b&gt;&lt;br/&gt;Canvases use default specific CSS styles which can be disabled if this option is checked.&#x27;, &#x27;wpp&#x27; ) . &#x27;&lt;/p&gt;&#x27;;
        $contextual_help[ &#x27;Template Settings&#x27; ][ ] = &#x27;&lt;p&gt;&#x27; . __( &#x27;&lt;b&gt;Allow inline CSS&lt;/b&gt;&lt;br/&gt;Enables to add specific CSS styles to the current canvas. Toggles &lt;b&gt;Inline CSS&lt;/b&gt; textarea for adding CSS styles.&#x27;, &#x27;wpp&#x27; ) . &#x27;&lt;/p&gt;&#x27;;
        $contextual_help[ &#x27;Template Settings&#x27; ][ ] = &#x27;&lt;p&gt;&#x27; . __( &#x27;&lt;b&gt;Custom CSS and Javascript files&lt;/b&gt;&lt;br/&gt;You can create custom CSS and Javascript files which will be loaded on all your canvases.&lt;br/&gt;&#x27;, &#x27;wpp&#x27; );
        $contextual_help[ &#x27;Template Settings&#x27; ][ ] = __( &#x27;To add custom CSS or JS file, you need to create css or js file in your theme folder like &lt;code&gt;fb-tab-{specific_name}.{css|js}&lt;/code&gt;.&#x27;, &#x27;wpp&#x27; ) . &#x27;&lt;/p&gt;&#x27;;

        $contextual_help[ &#x27;Facebook App Setup&#x27; ][ ] = &#x27;&lt;p&gt;&#x27; . __( &#x27;&lt;b&gt;Facebook Application Setup&lt;/b&gt;&lt;br/&gt;&#x27;, &#x27;wpp&#x27; ) . &#x27;&lt;/p&gt;&#x27;;
        $contextual_help[ &#x27;Facebook App Setup&#x27; ][ ] = &#x27;&lt;p&gt;&#x27; . __( &#x27;&lt;a href=&quot;https://developers.facebook.com/docs/guides/canvas/&quot; target=&quot;_blank&quot;&gt;How to create Facebook Application&lt;/a&gt;&#x27;, &#x27;wpp&#x27; ) . &#x27;&lt;/p&gt;&#x27;;
        $contextual_help[ &#x27;Facebook App Setup&#x27; ][ ] = &#x27;&lt;p&gt;&#x27; . __( &#x27;&lt;b&gt;App ID&lt;/b&gt;&lt;br /&gt;App ID is your application\&#x27;s App ID/API Key which you can get from Application Settings page.&#x27;, &#x27;wpp&#x27; ) . &#x27;&lt;/p&gt;&#x27;;
        $contextual_help[ &#x27;Facebook App Setup&#x27; ][ ] = &#x27;&lt;p&gt;&#x27; . __( &#x27;&lt;b&gt;Secret&lt;/b&gt;&lt;br /&gt;Secret is long hashed string associated with your application. You can get it from Application Settings page.&#x27;, &#x27;wpp&#x27; ) . &#x27;&lt;/p&gt;&#x27;;
        $contextual_help[ &#x27;Facebook App Setup&#x27; ][ ] = &#x27;&lt;p&gt;&#x27; . __( &#x27;&lt;b&gt;Canvas URL&lt;/b&gt;&lt;br /&gt;Copy the current URL to your facebook application settings.&#x27;, &#x27;wpp&#x27; ) . &#x27;&lt;/p&gt;&#x27;;
        $contextual_help[ &#x27;Facebook App Setup&#x27; ][ ] = &#x27;&lt;p&gt;&#x27; . __( &#x27;&lt;b&gt;Secure Canvas URL&lt;/b&gt;&lt;br /&gt;Copy the current URL to your facebook application settings.&#x27;, &#x27;wpp&#x27; ) . &#x27;&lt;/p&gt;&#x27;;
        $contextual_help[ &#x27;Facebook App Setup&#x27; ][ ] = &#x27;&lt;p&gt;&#x27; . __( &#x27;&lt;b&gt;Debug URL&lt;/b&gt;&lt;br /&gt;This link can be used for troubleshooting the issues directly.&#x27;, &#x27;wpp&#x27; ) . &#x27;&lt;/p&gt;&#x27;;

        //** Hook this is you need to add some helps to Agents Settings page */
        $contextual_help = apply_filters( &#x27;wpp_facebook_tabs_help&#x27;, $contextual_help );

        do_action( &#x27;wpp_contextual_help&#x27;, array( &#x27;contextual_help&#x27; =&gt; $contextual_help ) );
      }

      /**
       * Filter
       * Returns current template instance
       *
       * @see UD_API::get_template_part()
       * @author peshkov@UD
       */
      function current_template_instance( $instance ) {
        global $wp_query;
        if( isset( $_SERVER[ &quot;HTTP_X_FB_CANVAS&quot; ] ) || ( isset( $wp_query-&gt;query_vars[ &quot;wpp_fb_canvas&quot; ] ) &amp;&amp; isset( $wp_query-&gt;query_vars[ &quot;signed_request&quot; ] ) ) ) {
          $instance = &quot;fb_tabs&quot;;
        }

        return $instance;
      }

      /**
       * Search template in plugin directory, ignores stylesheet
       *
       * @param type $template
       * @param type $args
       *
       * @return type
       * @author odokienko@UD
       */
      function template_part_fb_tabs( $template, $args ) {
        global $wp_query, $wp_properties;

        //** Determine if canvas is defined */
        $canvas = isset( $_SERVER[ &quot;HTTP_X_FB_CANVAS&quot; ] ) ? $_SERVER[ &quot;HTTP_X_FB_CANVAS&quot; ] : ( isset( $wp_query-&gt;query_vars[ &quot;wpp_fb_canvas&quot; ] ) ? $wp_query-&gt;query_vars[ &quot;wpp_fb_canvas&quot; ] : false );
        if( !$canvas || empty( $wp_properties[ &#x27;configuration&#x27; ][ &#x27;feature_settings&#x27; ][ &#x27;facebook_tabs&#x27; ][ &#x27;canvases&#x27; ][ $canvas ] ) ) {
          return $template;
        }

        //** If enabled theme template parts for current canvas we don&#x27;t continue; */
        $settings = $wp_properties[ &#x27;configuration&#x27; ][ &#x27;feature_settings&#x27; ][ &#x27;facebook_tabs&#x27; ][ &#x27;canvases&#x27; ][ $canvas ];
        if( isset( $settings[ &#x27;settings&#x27; ][ &#x27;enable_theme_templates&#x27; ] ) &amp;&amp; $settings[ &#x27;settings&#x27; ][ &#x27;enable_theme_templates&#x27; ] == &#x27;true&#x27; ) {
          return $template;
        }
        $name = &#x27;&#x27;;
        extract( $args );

        $new_template = &#x27;&#x27;;

        foreach( (array) $name as $n ) {
          $n = &quot;{$n}.php&quot;;
          if( !empty( $path ) ) {
            foreach( (array) $path as $p ) {
              if( file_exists( $p . &quot;/&quot; . $n ) ) {
                $new_template = $p . &quot;/&quot; . $n;
                break( 2 );
              }
            }
          }

        }

        WPP_F::console_log( $new_template );

        return !empty( $new_template ) ? $new_template : $template;
      }

      /**
       * Template redirect for facebook tabs.
       *
       * Listens for a signed Facebook request.
       *
       * @author korotkov@ud
       */
      function template_redirect() {
        global $wp_properties, $wp_query;

        $wpp_fb_canvas  = get_query_var( self::query_var );
        $signed_request = get_query_var( &#x27;signed_request&#x27; );

        //** If request goes not from facebook */
        if( empty( $signed_request ) || empty( $wpp_fb_canvas ) ) {

          $hidden_pages = self::get_hidden_pages();

          //** If we have hidden pages */
          if( !empty( $hidden_pages ) &amp;&amp; is_array( $hidden_pages ) &amp;&amp; $wp_query-&gt;is_page ) {
            //** Set 404 for hidden pages */
            foreach( $hidden_pages as $id ) {
              if( $wp_query-&gt;post-&gt;ID == $id ) {
                status_header( &#x27;404&#x27; );
                $wp_query-&gt;set_404();
              }
            }
          }

          return;
        }

        add_filter( &#x27;use_default_gallery_style&#x27;, &#x27;__return_true&#x27; );

        //** Current canvas configuration */
        $current_canvas = $wp_properties[ &#x27;configuration&#x27; ][ &#x27;feature_settings&#x27; ][ &#x27;facebook_tabs&#x27; ][ &#x27;canvases&#x27; ][ $wpp_fb_canvas ];

        //** If no such canvas */
        if( empty( $current_canvas ) ) die( __( &#x27;Requested Canvas does not exist.&#x27;, &#x27;wpp&#x27; ) );

        //** Decode &#x27;signed_request&#x27; using &#x27;secret&#x27; */
        $canvas_request_data = self::parse_signed_request( $signed_request, $current_canvas[ &#x27;secret&#x27; ] );

        //** Decode failed */
        if( !is_array( $canvas_request_data ) &amp;&amp; $signed_request !== md5( &quot;debug::{$wpp_fb_canvas}&quot; ) ) {
          die( __( &#x27;Canvas settings are invalid. Check &quot;Secret&quot; field.&#x27;, &#x27;wpp&#x27; ) );
        }

        if( empty( $current_canvas[ &#x27;template&#x27; ] ) ) {
          //** Template is not specified */
          die( __( &#x27;You did not specify Facebook Template for requested Canvas&#x27;, &#x27;wpp&#x27; ) );
        }

        //** Hide Admin bar */
        show_admin_bar( false );
        wp_deregister_script( &#x27;admin-bar&#x27; );
        wp_deregister_style( &#x27;admin-bar&#x27; );

        //** Facebook page must not use theme scripts and styles. Only specific ones with prefix &#x27;fb-tab-&#x27; are allowed. */
        self::deregister_assets( &#x27;css&#x27; );
        self::deregister_assets( &#x27;js&#x27; );

        //** Enqueue FB style */
        if( $current_canvas[ &#x27;disable_default_css&#x27; ] !== &#x27;true&#x27; ) {
          wp_enqueue_style( &#x27;fb-properties&#x27;, WPP_URL . &quot;templates/theme-specific/fb_properties.css&quot; );
        }

        //** Available Facebook Tab assets */
        $assets = self::get_facebook_assets();
        foreach( (array) $assets[ &#x27;css&#x27; ] as $style_asset =&gt; $data ) {
          wp_enqueue_style( $style_asset, $data[ &#x27;url&#x27; ] );
        }
        foreach( (array) $assets[ &#x27;js&#x27; ] as $js_asset =&gt; $data ) {
          wp_enqueue_script( $js_asset, $data[ &#x27;url&#x27; ] );
        }

        if( $current_canvas[ &#x27;allow_inline_css&#x27; ] == &#x27;true&#x27; &amp;&amp; !empty( $current_canvas[ &#x27;inline_css_data&#x27; ] ) ) {
          global $wpp_inline_css;
          $wpp_inline_css = WPP_F::minify_css( $current_canvas[ &#x27;inline_css_data&#x27; ] );
          add_action( &#x27;wp_head&#x27;, create_function( &#x27;&#x27;, &#x27;
        global $wpp_inline_css;
        echo &quot;&lt;style type=\&quot;text/css\&quot;&gt;&quot;;
        echo $wpp_inline_css;
        echo &quot;&lt;/style&gt;&quot;;
      &#x27; ) );
          unset( $wpp_inline_css );
        }

        //** Enqueue FB scripts */
        wp_enqueue_script( &#x27;fb-properties&#x27;, WPP_URL . &quot;js/fb_properties.js&quot;, array( &#x27;jquery&#x27; ) );
        wp_localize_script( &#x27;fb-properties&#x27;, &#x27;wpp_fb_tabs&#x27;, array( &#x27;canvas&#x27; =&gt; $wpp_fb_canvas, &#x27;data&#x27; =&gt; json_encode( $current_canvas ) ) );

        //** */
        switch( $current_canvas[ &#x27;use_page_as&#x27; ] ) {

          //** */
          case &#x27;property&#x27;:

            $property = WPP_F::get_property( $current_canvas[ &#x27;page&#x27; ], &quot;load_gallery=true&quot; );

            if( empty( $property ) || is_wp_error( $property ) ) {
              //** Page is not specified */
              die( __( &#x27;You did not specify the page for requested Canvas&#x27;, &#x27;wpp&#x27; ) );
            }

            $property = prepare_property_for_display( $property );

            //** Make certain variables available to be used within the single listing page */
            $single_page_vars = apply_filters( &#x27;wpp_property_page_vars&#x27;, array(
              &#x27;property&#x27;      =&gt; $property,
              &#x27;wp_properties&#x27; =&gt; $wp_properties
            ) );

            //** By merging our extra variables into $wp_query-&gt;query_vars they will be extracted in load_template() */
            if( is_array( $single_page_vars ) ) {
              $wp_query-&gt;query_vars = array_merge( $wp_query-&gt;query_vars, $single_page_vars );
            }
            break;

          //** */
          case &#x27;page&#x27;:
            // There is nothing to do here for now
            break;

        }

        //** Remove unwanted meta from header */
        remove_action( &#x27;wp_head&#x27;, &#x27;wlwmanifest_link&#x27; );
        remove_action( &#x27;wp_head&#x27;, &#x27;rsd_link&#x27; );
        remove_action( &#x27;wp_head&#x27;, &#x27;wp_enqueue_scripts&#x27; );
        remove_action( &#x27;wp_head&#x27;, &#x27;feed_links&#x27; );
        remove_action( &#x27;wp_head&#x27;, &#x27;feed_links_extra&#x27; );
        remove_action( &#x27;wp_head&#x27;, &#x27;rsd_link&#x27; );
        remove_action( &#x27;wp_head&#x27;, &#x27;wlwmanifest_link&#x27; );
        remove_action( &#x27;wp_head&#x27;, &#x27;adjacent_posts_rel_link_wp_head&#x27; );
        remove_action( &#x27;wp_head&#x27;, &#x27;locale_stylesheet&#x27; );
        remove_action( &#x27;wp_head&#x27;, &#x27;noindex&#x27; );
        remove_action( &#x27;wp_head&#x27;, &#x27;wp_print_styles&#x27; );
        remove_action( &#x27;wp_head&#x27;, &#x27;wp_print_head_scripts&#x27; );
        remove_action( &#x27;wp_head&#x27;, &#x27;wp_generator&#x27; );
        remove_action( &#x27;wp_head&#x27;, &#x27;rel_canonical&#x27; );
        remove_action( &#x27;wp_head&#x27;, &#x27;wp_shortlink_wp_head&#x27; );
        remove_action( &#x27;wp_head&#x27;, &#x27;_admin_bar_bump_cb&#x27; );

        //** Try find specific template */
        $template_found = WPP_F::get_template_part( array(
          $current_canvas[ &#x27;template&#x27; ][ $current_canvas[ &#x27;use_page_as&#x27; ] ]
        ), array( WPP_Templates ), array( &#x27;instance&#x27; =&gt; &#x27;default&#x27; ) );

        //** if page used as regular page - load the first found template */
        if( !empty( $template_found ) ) {
          load_template( $template_found );
          die();
        } else {
          //** Template file does not exists */
          die( __( &#x27;Can\&#x27;t find proper Facebook Template file &quot;&#x27; . $current_canvas[ &#x27;template&#x27; ][ $current_canvas[ &#x27;use_page_as&#x27; ] ] . &#x27;&quot;&#x27;, &#x27;wpp&#x27; ) );
        }

      }

      /**
       * Deregisters all theme assets ( styles or scripts ) and specific ones which are not related to Facebook Tabs
       *
       * @param string $type . File extension. Available &#x27;css&#x27;,&#x27;js&#x27;. Default is &#x27;css&#x27;
       *
       * @author peshkov@UD
       */
      private function deregister_assets( $type = &#x27;css&#x27; ) {

        $prefix     = &#x27;fb-tab-&#x27;;
        $exceptions = array();
        $predefined = array();

        if( !in_array( $type, array( &#x27;css&#x27;, &#x27;js&#x27; ) ) ) return false;

        switch( $type ) {
          case &#x27;css&#x27;:
            global $wp_styles;
            $inst       = $wp_styles-&gt;registered;
            $exceptions = apply_filters( &#x27;wpp::fb_tabs::exceptions::styles&#x27;, array() );
            $predefined = apply_filters( &#x27;wpp::fb_tabs::predefined::styles&#x27;, array() );
            break;
          case &#x27;js&#x27;:
            global $wp_scripts;
            $inst       = $wp_scripts-&gt;registered;
            $exceptions = apply_filters( &#x27;wpp::fb_tabs::exceptions::scripts&#x27;, array() );
            $predefined = apply_filters( &#x27;wpp::fb_tabs::predefined::scripts&#x27;, array( &#x27;wpp.global&#x27; ) );
            break;
          default:
            return false;
            break;
        }

        if( !is_array( $inst ) ) return false;

        $exceptions = self::get_asset_dependencies( array_unique( (array) $exceptions ), $type );

        foreach( $inst as $key =&gt; $data ) {

          if( in_array( $key, $exceptions ) ) continue;

          $flag = false;

          //** Determine if the current asset is related to theme */
          if( is_string( $data-&gt;src ) &amp;&amp; strpos( $data-&gt;src, &#x27;wp-content/themes&#x27; ) !== false || strpos( $data-&gt;src, &#x27;templates/theme-specific&#x27; ) !== false ) {
            preg_match( &#x27;#\/(&#x27; . $prefix . &#x27;.+)\.&#x27; . $type . &#x27;$#&#x27;, $data-&gt;src, $matches );
            if( empty( $matches ) ) {
              $flag = true;
            }
          }

          if( !$flag &amp;&amp; in_array( $key, $predefined ) ) {
            $flag = true;
          }

          if( $flag ) {
            switch( $type ) {
              case &#x27;css&#x27;:
                wp_deregister_style( $key );
                break;
              case &#x27;js&#x27;:
                wp_deregister_script( $key );
                break;
            }
          }

        }

      }

      /**
       * Recursively goes through registered assets and finds dependencies of passed $assets
       *
       * @global type  $wp_styles
       * @global type  $wp_scripts
       *
       * @param mixed  $assets
       * @param string $type
       *
       * @return array
       * @author peshkov@UD
       */
      function get_asset_dependencies( $assets, $type ) {

        if( !in_array( $type, array( &#x27;css&#x27;, &#x27;js&#x27; ) ) ) return $assets;

        switch( $type ) {
          case &#x27;css&#x27;:
            global $wp_styles;
            $inst = $wp_styles-&gt;registered;
            break;
          case &#x27;js&#x27;:
            global $wp_scripts;
            $inst = $wp_scripts-&gt;registered;
            break;
        }

        if( !is_array( $assets ) ) {
          $assets = array( $assets );
        }

        $deps = array();
        foreach( $assets as $ex ) {
          if( !empty( $inst[ $ex ] ) &amp;&amp; !empty( $inst[ $ex ]-&gt;deps ) &amp;&amp; is_array( $inst[ $ex ]-&gt;deps ) ) {
            foreach( $inst[ $ex ]-&gt;deps as $dep ) {
              $dep  = self::get_asset_dependencies( $dep, $type );
              $deps = array_unique( array_merge( $deps, (array) $dep ) );
            }
          }
        }

        $assets = array_unique( array_merge( $assets, $deps ) );

        return $assets;

      }

      /**
       * Adds Custom capability to the current premium feature
       *
       * @param array $capabilities
       *
       * @return array
       */
      function add_capability( $capabilities ) {
        $capabilities[ self::capability ] = __( &#x27;Manage Facebook Tabs&#x27;, &#x27;wpp&#x27; );

        return $capabilities;
      }

      /**
       * Echos full input name
       *
       * @param string $field_name
       * @param array  $args
       *
       * @return mixed
       * @author korotkov@ud
       */
      static function post_name( $field_name, $args = array() ) {
        if( empty( $field_name ) ) return;
        $return   = false;
        $defaults = array(
          &#x27;return&#x27; =&gt; false
        );

        extract( wp_parse_args( $args, $defaults ) );

        if( $return ) return self::post_name_base . trim( $field_name );
        echo self::post_name_base . trim( $field_name );
      }

      /**
       * Rewrite Rules - called only on flush.
       *
       * @action rewrite_rules_array ( 20 )
       * @author odokienko@UD
       */
      public function _rewrite_rules( $rules ) {

        $rules = array( self::query_var . &#x27;/(.+?)/?$&#x27; =&gt; &quot;index.php?&quot; . self::query_var . &quot;=\$matches[1]&quot; ) + $rules;

        return $rules;
      }

      /**
       * flush_rules() if our rules are not yet included
       *
       * @global object $wp_rewrite
       * @author odokienko@UD
       */
      function _flush_rules() {
        $rules = get_option( &#x27;rewrite_rules&#x27; );

        if( !isset( $rules[ self::query_var . &#x27;/(.+?)/?$&#x27; ] ) ) {
          global $wp_rewrite;
          $wp_rewrite-&gt;flush_rules();
        }
      }

      /**
       * Tell WordPress to accept our custom query variable
       *
       * @param type $vars
       *
       * @return array $vars
       * @author odokienko@UD
       */
      function _insertqv( $vars ) {
        array_push( $vars, self::query_var );
        array_push( $vars, &#x27;signed_request&#x27; );

        return $vars;
      }

      /**
       * Creates $posts array based on fb_tabs canvas data
       *
       * @global type  $wp
       * @global type  $wp_query -&gt;query_vars[ self::query_var ]
       * @global array $wp_properties
       *
       * @param array  $posts
       *
       * @return array $posts
       * @author odokienko@UD
       */
      function _wpp_fb_page( $posts ) {
        global $wp_query, $wp_properties;

        $current_canvas = $wp_properties[ &#x27;configuration&#x27; ][ &#x27;feature_settings&#x27; ][ &#x27;facebook_tabs&#x27; ][ &#x27;canvases&#x27; ][ $wp_query-&gt;query_vars[ self::query_var ] ];

        //check if user is requesting our fb_tabs page
        if( !empty( $current_canvas[ &#x27;page&#x27; ] ) ) {

          $post = get_post( $current_canvas[ &#x27;page&#x27; ] );

          $posts    = NULL;
          $posts[ ] = $post;

          $wp_query-&gt;is_page     = true;
          $wp_query-&gt;is_singular = true;
          $wp_query-&gt;is_home     = false;
          $wp_query-&gt;is_archive  = false;
          $wp_query-&gt;is_category = false;
          unset( $wp_query-&gt;query[ &quot;error&quot; ] );
          $wp_query-&gt;query_vars[ &quot;error&quot; ] = &quot;&quot;;
          $wp_query-&gt;is_404                = false;
        }

        return $posts;
      }

      /**
       * Returns list of available templates.
       *
       * @return array
       * @author korotkov@ud
       */
      function get_templates() {

        $files     = array();
        $templates = array();

        //** Available template dirs */
        $files[ STYLESHEETPATH ] = scandir( STYLESHEETPATH );
        $files[ TEMPLATEPATH ]   = scandir( TEMPLATEPATH );
        $files[ WPP_Templates ]  = scandir( WPP_Templates );

        //** Find template files */
        foreach( $files as $key =&gt; $file_list ) {

          //** Loop each file in dirs */
          foreach( $file_list as $dirfile ) {
            $ext = pathinfo( $dirfile, PATHINFO_EXTENSION );
            //** If file is FT template */
            if( strstr( $dirfile, &#x27;fb-tab-&#x27; ) &amp;&amp; $ext === &#x27;php&#x27; ) {
              if( !isset( $templates[ $dirfile ] ) ) {
                $file_data                                        = get_file_data( $key . &#x27;/&#x27; . $dirfile, array( &#x27;name&#x27; =&gt; &#x27;Template Name&#x27;, &#x27;type&#x27; =&gt; &#x27;Type&#x27; ) );
                $file_data[ &#x27;type&#x27; ]                              = !empty( $file_data[ &#x27;type&#x27; ] ) ? $file_data[ &#x27;type&#x27; ] : &#x27;page&#x27;;
                $templates[ str_replace( &#x27;.php&#x27;, &#x27;&#x27;, $dirfile ) ] = $file_data;
              }
            }
          }
        }

        return $templates;
      }

      /**
       * Returns list of facebook assets
       *
       * @param string $prefix
       *
       * @return array
       * @author peshkov@UD
       */
      static function get_facebook_assets( $prefix = &#x27;&#x27; ) {

        $assets = array();

        $prefix = ( !empty( $prefix ) &amp;&amp; is_string( $prefix ) ) ? $prefix : &#x27;fb-tab&#x27;;

        //** Available template dirs */
        $files = array(
          &#x27;stylesheet&#x27;   =&gt; array( STYLESHEETPATH, get_stylesheet_directory_uri(), scandir( STYLESHEETPATH ) ),
          &#x27;templatepath&#x27; =&gt; array( TEMPLATEPATH, get_template_directory_uri(), scandir( TEMPLATEPATH ) ),
        );

        //** Find template files */
        foreach( $files as $key =&gt; $p ) {
          //** Loop each file in dirs */
          foreach( $p[ 2 ] as $dirfile ) {
            preg_match( &#x27;#(&#x27; . $prefix . &#x27;.*)\.(css|js)$#&#x27;, $dirfile, $matches );

            if( !empty( $matches ) ) {
              if( empty( $assets[ $matches[ 2 ] ][ $matches[ 1 ] ] ) ) {
                $assets[ $matches[ 2 ] ][ sanitize_key( $matches[ 1 ] ) ] = array(
                  &#x27;path&#x27;     =&gt; $p[ 0 ] . &#x27;/&#x27; . $dirfile,
                  &#x27;url&#x27;      =&gt; $p[ 1 ] . &#x27;/&#x27; . $dirfile,
                  &#x27;filename&#x27; =&gt; $dirfile,
                );
              }
            }
          }
        }

        //var_dump($assets);

        return $assets;
      }

      /**
       * Parse signed_request from Facebook
       *
       * @param string $signed_request
       * @param string $secret
       *
       * @return array
       * @author korotkov@ud
       */
      private static function parse_signed_request( $signed_request, $secret ) {
        list( $encoded_sig, $payload ) = explode( &#x27;.&#x27;, $signed_request, 2 );

        //** decode the data */
        $sig  = self::base64_url_decode( $encoded_sig );
        $data = json_decode( self::base64_url_decode( $payload ), true );

        if( strtoupper( $data[ &#x27;algorithm&#x27; ] ) !== &#x27;HMAC-SHA256&#x27; ) {
          return null;
        }

        //** check sig */
        $expected_sig = hash_hmac( &#x27;sha256&#x27;, $payload, $secret, $raw = true );
        if( $sig !== $expected_sig ) {
          return null;
        }

        return $data;
      }

      /**
       * base64 URL Decode
       *
       * @param string $input
       *
       * @return string
       * @author korotkov@ud
       */
      private static function base64_url_decode( $input ) {
        return base64_decode( strtr( $input, &#x27;-_&#x27;, &#x27;+/&#x27; ) );
      }

      /**
       * Get available pages to display
       *
       * @return array
       * @author korotkov@ud
       */
      private static function get_available_pages() {

        //** Temporary remove filter to get all pages */
        remove_filter( &#x27;get_pages&#x27;, array( __CLASS__, &quot;hide_pages&quot; ) );
        //** Get ALL pages */
        $pages = get_pages();
        //** Set filter back */
        add_filter( &#x27;get_pages&#x27;, array( __CLASS__, &quot;hide_pages&quot; ) );

        $page_data = array();

        foreach( $pages as $key =&gt; $page ) {
          $page_data[ $page-&gt;ID ][ &#x27;title&#x27; ] = $page-&gt;post_title;
        }

        return $page_data;
      }

      /**
       * Collects affected page IDs
       *
       * @param array $canvases
       *
       * @return array
       * @author korotkov@ud
       */
      private static function get_affected_pages( $canvases ) {

        //** Flush used variables */
        $pages = array();
        $ids   = array();

        //**  Loop canvases to look for pages used */
        if( !empty( $canvases ) ) {
          foreach( $canvases as $canvas ) {

            //** If canvas used as page */
            if( $canvas[ &#x27;use_page_as&#x27; ] == &#x27;page&#x27; ) {

              //** If it is not processed yet */
              if( !in_array( $canvas[ &#x27;page&#x27; ], $ids ) ) {

                //** Collect page data */
                $pages[ ] = array(
                  &#x27;id&#x27;    =&gt; $canvas[ &#x27;page&#x27; ],
                  &#x27;title&#x27; =&gt; get_page( $canvas[ &#x27;page&#x27; ] )-&gt;post_title
                );
                //** Mark as processed to be unique */
                $ids[ ] = $canvas[ &#x27;page&#x27; ];
              }
            }
          }
        }

        //** Return collected data */
        return $pages;

      }

      /**
       * Hide selected pages
       *
       * @global array $wp_properties
       *
       * @param array  $pages
       *
       * @return array
       * @author korotkov@ud
       */
      public function hide_pages( $pages ) {
        global $wp_properties;

        $hidden_pages = self::get_hidden_pages();

        if( !empty( $hidden_pages ) &amp;&amp; is_array( $hidden_pages ) ) {
          foreach( $pages as $key =&gt; $page ) {
            if( in_array( $page-&gt;ID, $hidden_pages ) ) {
              unset( $pages[ $key ] );
            }
          }
        }

        return $pages;
      }

      /**
       * Returns ids of hidden canvas pages
       *
       * @return array
       * @author peshkov@UD
       */
      static function get_hidden_pages() {
        global $wp_properties;

        $ids = array();

        if( !empty( $wp_properties[ &#x27;configuration&#x27; ][ &#x27;feature_settings&#x27; ][ &#x27;facebook_tabs&#x27; ][ &#x27;canvases&#x27; ] ) ) {
          foreach( (array) $wp_properties[ &#x27;configuration&#x27; ][ &#x27;feature_settings&#x27; ][ &#x27;facebook_tabs&#x27; ][ &#x27;canvases&#x27; ] as $canvas =&gt; $data ) {
            if( $data[ &#x27;use_page_as&#x27; ] == &#x27;page&#x27; &amp;&amp; !empty( $data[ &#x27;page&#x27; ] ) &amp;&amp; $data[ &#x27;settings&#x27; ][ &#x27;hide_from_wp&#x27; ] == &#x27;true&#x27; ) {
              $ids[ ] = $data[ &#x27;page&#x27; ];
            }
          }
        }

        return $ids;
      }

      /**
       * Load admin scripts
       *
       * @author peshkov@UD
       */
      function admin_enqueue_scripts() {
        global $current_screen;

        // Load scripts on specific pages
        switch( $current_screen-&gt;id ) {

          case &#x27;property_page_facebook_tabs&#x27;:
            wp_enqueue_script( &#x27;wpp.admin&#x27; );
            wp_enqueue_script( &#x27;wpp-md5&#x27; );
            wp_enqueue_script( &#x27;jquery-ui-tabs&#x27; );
            break;
        }

      }

      /**
       *
       * @author peshkov@UD
       */
      function page_facebook_tabs() {
        global $wp_properties;

        $canvases = array();
        if( !empty( $wp_properties[ &#x27;configuration&#x27; ][ &#x27;feature_settings&#x27; ][ &#x27;facebook_tabs&#x27; ][ &#x27;canvases&#x27; ] ) ) {
          $canvases = $wp_properties[ &#x27;configuration&#x27; ][ &#x27;feature_settings&#x27; ][ &#x27;facebook_tabs&#x27; ][ &#x27;canvases&#x27; ];
        } else {
          $canvases[ &#x27;sample_canvas&#x27; ] = array(
            &#x27;name&#x27; =&gt; &#x27;Sample Canvas&#x27;
          );
        }

        //** Templates */
        $templates = self::get_templates();

        //** The variables below are used by javascript */
        $is_permalink = get_option( &#x27;permalink_structure&#x27; ) !== &#x27;&#x27; ? &#x27;true&#x27; : &#x27;false&#x27;;
        $site_url     = site_url();
        $query_var    = self::query_var;

        $wp_messages = array();
        if( isset( $_REQUEST[ &#x27;message&#x27; ] ) ) {
          switch( $_REQUEST[ &#x27;message&#x27; ] ) {
            case &#x27;updated&#x27;:
              $wp_messages[ &#x27;notice&#x27; ][ ] = __( &quot;Facebook Tabs updated.&quot;, &#x27;wpp&#x27; );
              break;
          }
        }
        ?&gt;

        &lt;script type=&quot;text/javascript&quot;&gt;
      var wpp_fb_tabs = {
        auto_complete_timer: null,
        is_permalink: &lt;?php echo $is_permalink; ?&gt;,
        site_url: &#x27;&lt;?php echo $site_url; ?&gt;&#x27;,
        query_var: &#x27;&lt;?php echo $query_var; ?&gt;&#x27;,

        //** Init basic actions */
        init: function() {
          var params = {
            create: function( event, ui ) {
              jQuery( &#x27;.wpp_add_tab&#x27; ).click( wpp_fb_tabs.add_canvas );
              jQuery( &#x27;input.slug_setter&#x27; ).live( &#x27;change&#x27;, wpp_fb_tabs.set_slug );
              jQuery( &#x27;.wpp_fb_page_type&#x27; ).live( &#x27;change&#x27;, wpp_fb_tabs.update_fields_by_type ).trigger( &#x27;change&#x27; );
              jQuery( &#x27;input.wpp_fb_property_input&#x27; ).live( &#x27;keyup&#x27;, wpp_fb_tabs.property_input_keyup ).live( &#x27;focus&#x27;, wpp_fb_tabs.property_input_focus ).live( &#x27;blur&#x27;, wpp_fb_tabs.property_input_blur ).live( &#x27;keydown&#x27;, function( event ) {
                if( event.keyCode == 13 ) {
                  event.preventDefault();
                  return false;
                }
              } );
              jQuery( &#x27;.wpp_fb_app_id&#x27; ).live( &#x27;change&#x27;, wpp_fb_tabs.set_add_to_fb_link ).trigger( &#x27;change&#x27; );
              jQuery( &#x27;a.wpp_fb_tabs_property_link&#x27; ).live( &#x27;click&#x27;, wpp_fb_tabs.property_link_click );
              jQuery( &#x27;.current_slug&#x27; ).live( &#x27;change&#x27;, wpp_fb_tabs.set_urls ).each( function( i, e ) {
                jQuery( e ).trigger( &#x27;change&#x27; );
              } );
              jQuery( &#x27;#save_form&#x27; ).show();
              wpp_fb_tabs.init_close_btn();
            }
          }
          if( !wpp.version_compare( jQuery.ui.version, &#x27;1.10&#x27;, &#x27;&gt;=&#x27; ) ) {
            params.add = wpp_fb_tabs.canvas_added;
          }
          jQuery( &quot;.wpp_fb_tabs&quot; ).tabs( params );
        },

        canvas_added: function( event, ui ) {
          jQuery( &#x27;.wpp_fb_tab table:first&#x27; ).clone().appendTo( ui.panel );
          wpp_fb_tabs.set_default_values( ui.panel );
          wpp_fb_tabs.init_close_btn();
        },

        add_canvas: function() {
          var new_tab_href_id = parseInt( Math.random() * 1000000 );
          if( wpp.version_compare( jQuery.ui.version, &#x27;1.10&#x27;, &#x27;&gt;=&#x27; ) ) {
            var tabs = jQuery( &quot;.wpp_fb_tabs&quot; ), ul = tabs.find( &quot;&gt;ul&quot; ), index = tabs.find( &#x27;&gt;ul &gt;li&#x27; ).size(), panel = jQuery( &#x27;&lt;div id=&quot;fb_form_&#x27; + new_tab_href_id + &#x27;&quot;&gt;&lt;/div&gt;&#x27; );

            jQuery( &quot;&lt;li&gt;&lt;a href=&#x27;#fb_form_&quot; + new_tab_href_id + &quot;&#x27;&gt;&lt;/a&gt;&lt;/li&gt;&quot; ).appendTo( ul );
            jQuery( &#x27;.wpp_fb_tabs table:first&#x27; ).clone().appendTo( panel );
            panel.appendTo( tabs );
            tabs.tabs( &quot;refresh&quot; );

            wpp_fb_tabs.set_default_values( panel );
            wpp_fb_tabs.init_close_btn();

            tabs.tabs( &quot;option&quot;, &quot;active&quot;, index );
          } else {
            jQuery( &#x27;.wpp_fb_tabs&#x27; ).tabs( &quot;add&quot;, &quot;#fb_canvas_&quot; + new_tab_href_id, &#x27;&#x27; );
            jQuery( &#x27;.wpp_fb_tabs&#x27; ).tabs( &quot;select&quot;, jQuery( &quot;.wpp_fb_tabs&quot; ).tabs( &#x27;length&#x27; ) - 1 );
          }
        },

        set_slug: function( event ) {
          var value = jQuery( event.currentTarget ).val(), panel = jQuery( jQuery( event.currentTarget ).parents( &#x27;div.ui-tabs-panel&#x27; ).get( 0 ) ), old_slug = jQuery( &#x27;input.current_slug&#x27;, panel ).val(), new_slug = wpp_create_slug( value );

          jQuery( &#x27;a[href=&quot;#&#x27; + panel.attr( &#x27;id&#x27; ) + &#x27;&quot;]&#x27; ).html( value ).closest( &#x27;li&#x27; ).attr( &#x27;fb_canvas_id&#x27;, new_slug );
          jQuery( &#x27;input.current_slug&#x27;, panel ).val( new_slug ).trigger( &#x27;change&#x27; );

          // Cycle through all child elements and fix names
          jQuery( &#x27;input,select, textarea&#x27;, panel ).each( function( i, e ) {
            var old_name = jQuery( e ).attr( &#x27;name&#x27; );
            if( typeof old_name != &#x27;undefined&#x27; ) {
              var new_name = old_name.replace( &#x27;[&#x27; + old_slug + &#x27;]&#x27;, &#x27;[&#x27; + new_slug + &#x27;]&#x27; );
              // Update to new name
              jQuery( e ).attr( &#x27;name&#x27;, new_name );
            }
            var old_id = jQuery( e ).attr( &#x27;id&#x27; );
            if( typeof old_id != &#x27;undefined&#x27; ) {
              var new_id = old_id.replace( old_slug, new_slug );
              jQuery( e ).attr( &#x27;id&#x27;, new_id );
            }
            // Cycle through labels too
            jQuery( &#x27;label&#x27;, panel ).each( function( i, e ) {
              if( typeof jQuery( e ).attr( &#x27;for&#x27; ) != &#x27;undefined&#x27; ) {
                var old_for = jQuery( e ).attr( &#x27;for&#x27; );
                var new_for = old_for.replace( old_slug, new_slug );
                // Update to new name
                jQuery( e ).attr( &#x27;for&#x27;, new_for );
              }
            } );
          } );
        },

        //** Set URLs for canvases */
        set_urls: function() {
          var slug = jQuery( this ).val(), panel = jQuery( jQuery( this ).parents( &#x27;div.ui-tabs-panel&#x27; ).get( 0 ) ), url = wpp_fb_tabs.site_url, secure_url, debug_url;
          if( wpp_fb_tabs.is_permalink ) {
            url += &#x27;/&#x27; + wpp_fb_tabs.query_var + &#x27;/&#x27; + slug + &#x27;/&#x27;;
            debug_url = url + &#x27;?signed_request=&#x27; + md5( &#x27;debug::&#x27; + slug );
          } else {
            url += &#x27;?&#x27; + wpp_fb_tabs.query_var + &#x27;=&#x27; + slug;
            debug_url = url + &#x27;&amp;signed_request=&#x27; + md5( &#x27;debug::&#x27; + slug );
          }
          secure_url = url.replace( &#x27;http://&#x27;, &#x27;https://&#x27; );

          jQuery( &#x27;input.default_canvas_url&#x27;, panel ).val( url );
          jQuery( &#x27;input.secure_canvas_url&#x27;, panel ).val( secure_url );
          jQuery( &#x27;input.debug_canvas_url&#x27;, panel ).val( debug_url );
        },

        set_default_values: function( ui ) {
          jQuery( &#x27;input.wpp_default_empty[type=&quot;text&quot;]&#x27;, ui ).val( &#x27;&#x27; );
          jQuery( &#x27;input.wpp_default_empty[type=&quot;checkbox&quot;]&#x27;, ui ).attr( &#x27;checked&#x27;, false );
          jQuery( &#x27;.wpp_fb_page_type&#x27;, ui ).val( &#x27;page&#x27; ).trigger( &#x27;change&#x27; );
          jQuery( &#x27;input.slug_setter&#x27;, ui ).val( &#x27;&lt;?php _e( &#x27;Unnamed Canvas&#x27;, &#x27;wpp&#x27; ); ?&gt;&#x27; ).trigger( &#x27;change&#x27; );
        },

        set_add_to_fb_link: function( event ) {
          var panel = jQuery( jQuery( event.currentTarget ).parents( &#x27;div.ui-tabs-panel&#x27; ).get( 0 ) );
          var value = jQuery( event.currentTarget ).val();
          var button = jQuery( &#x27;a.wpp_fb_tabs_add_to_page&#x27;, panel );
          button.attr( &#x27;href&#x27;, &#x27;https://www.facebook.com/dialog/pagetab?app_id=&#x27; + value + &#x27;&amp;redirect_uri=http%3A%2F%2Fwww.facebook.com&#x27; );
          if( value == &#x27;&#x27; ) button.hide(); else button.show();
        },

        update_fields_by_type: function( event ) {
          var panel = jQuery( jQuery( event.currentTarget ).parents( &#x27;div.ui-tabs-panel&#x27; ).get( 0 ) );
          var value = jQuery( event.currentTarget ).val();
          switch( value ) {
            case &#x27;page&#x27;:
              jQuery( &#x27;.wpp_fb_type_property&#x27;, panel ).hide().attr( &#x27;disabled&#x27;, &#x27;disabled&#x27; );
              jQuery( &#x27;.wpp_fb_type_page&#x27;, panel ).show().removeAttr( &#x27;disabled&#x27; );
              break;
            case &#x27;property&#x27;:
              jQuery( &#x27;.wpp_fb_type_page&#x27;, panel ).hide().attr( &#x27;disabled&#x27;, &#x27;disabled&#x27; );
              jQuery( &#x27;.wpp_fb_type_property&#x27;, panel ).show().removeAttr( &#x27;disabled&#x27; );
              break;
          }
        },

        init_close_btn: function() {
          // Add remove button for tabs
          jQuery( &#x27;ul.tabs li.ui-state-default:not(:first):not(:has(a.remove-tab))&#x27; ).append( &#x27;&lt;a href=&quot;javascript:void(0);&quot; class=&quot;remove-tab&quot;&gt;x&lt;/a&gt;&#x27; ).mouseenter(function() {
            jQuery( &#x27;a.remove-tab&#x27;, this ).show( &#x27;fast&#x27; );
          } ).mouseleave( function() {
              jQuery( &#x27;a.remove-tab&#x27;, this ).hide( &#x27;fast&#x27; );
            } );

          // On remove tab button click
          jQuery( &#x27;ul.tabs li a.remove-tab&#x27; ).unbind( &#x27;click&#x27; );
          jQuery( &#x27;ul.tabs li a.remove-tab&#x27; ).click( function( e ) {
            if( wpp.version_compare( jQuery.ui.version, &#x27;1.10&#x27;, &#x27;&gt;=&#x27; ) ) {
              var index = jQuery( this ).parent().index();
              if( jQuery( &#x27;.wpp_fb_tabs&#x27; ).tabs( &#x27;option&#x27;, &#x27;active&#x27; ) == index ) {
                jQuery( &#x27;.wpp_fb_tabs&#x27; ).tabs( &quot;option&quot;, &quot;active&quot;, index - 1 );
              }
              // Remove the tab
              var tab = jQuery( &quot;.wpp_fb_tabs&quot; ).find( &quot;.ui-tabs-nav li:eq(&quot; + index + &quot;)&quot; ).remove();
              // Find the id of the associated panel
              var panelId = tab.attr( &quot;aria-controls&quot; );
              // Remove the panel
              jQuery( &quot;#&quot; + panelId ).remove();
              // Refresh the tabs widget
              jQuery( &quot;.wpp_feps_tabs&quot; ).tabs( &quot;refresh&quot; );
            } else {
              jQuery( &quot;.wpp_fb_tabs&quot; ).tabs( &#x27;remove&#x27;, jQuery( e ).parent().index() );
            }
          } );
        },

        //** Process keyup */
        property_input_keyup: function() {
          var typing_timeout = 600;
          var input = jQuery( this );
          var panel = input.parents( &#x27;div.ui-tabs-panel&#x27; ).get( 0 );
          jQuery( &#x27;.wpp_fb_tabs_found_properies&#x27;, panel ).hide().empty();
          window.clearTimeout( wpp_fb_tabs.auto_complete_timer );
          wpp_fb_tabs.auto_complete_timer = window.setTimeout( function() {
            jQuery( &#x27;.wpp_fb_tabs_loader_image&#x27;, panel ).show();
            jQuery.post( wpp.instance.ajax_url, {
              action: &#x27;wpp_fb_tabs_get_properties&#x27;,
              s: input.val()
            }, function( response ) {
              jQuery( &#x27;.wpp_fb_tabs_loader_image&#x27;, panel ).hide();
              if( response &amp;&amp; typeof response == &#x27;object&#x27; ) {
                jQuery.each( response, function() {
                  jQuery( &#x27;.wpp_fb_tabs_found_properies&#x27;, panel ).width( input.outerWidth() ).append( &#x27;&lt;li&gt;&lt;a class=&quot;wpp_fb_tabs_property_link&quot; href=&quot;&#x27; + this.id + &#x27;&quot;&gt;&#x27; + this.title + &#x27;&lt;/a&gt;&lt;/li&gt;&#x27; ).show();
                } );
              }
            }, &#x27;json&#x27; );
          }, typing_timeout );
        },

        //** Process focus */
        property_input_focus: function() {
          var panel = jQuery( this ).parents( &#x27;div.ui-tabs-panel&#x27; ).get( 0 );
          jQuery( &#x27;.wpp_fb_tabs_found_properies&#x27;, panel ).hide().empty();
        },

        //** Process blur */
        property_input_blur: function() {
          var panel = jQuery( this ).parents( &#x27;div.ui-tabs-panel&#x27; ).get( 0 );
          jQuery( &#x27;.wpp_fb_tabs_found_properies&#x27;, panel ).delay( 300 ).queue( function() {
            jQuery( this ).hide().empty();
          } );
        },

        //** Process click */
        property_link_click: function() {
          var a = jQuery( this );
          var panel = a.parents( &#x27;div.ui-tabs-panel&#x27; ).get( 0 );
          jQuery( &#x27;.wpp_fb_property_input&#x27;, panel ).val( a.text() );
          jQuery( &#x27;.wpp_fb_property_input_hidden&#x27;, panel ).val( a.attr( &#x27;href&#x27; ) );
          jQuery( &#x27;.wpp_fb_tabs_found_properies&#x27;, panel ).hide().empty();
          return false;
        }
      }

      jQuery( document ).ready( wpp_fb_tabs.init );
    &lt;/script&gt;


        &lt;div id=&quot;wpp_facebook_canvases&quot; class=&quot;wrap wpp_facebook_wrapper wpp_settings_page&quot;&gt;
      &lt;h2&gt;&lt;?php _e( &#x27;Facebook Tabs&#x27;, &#x27;wpp&#x27; ); ?&gt;
        &lt;span class=&quot;wpp_add_tab add-new-h2&quot;&gt;&lt;?php _e( &#x27;Add New&#x27;, &#x27;wpp&#x27; ); ?&gt;&lt;/span&gt;
      &lt;/h2&gt;

      &lt;p&gt;&lt;?php _e( &#x27;Apps on Facebook are web apps that are loaded in the context of Facebook in what we refer to as a Canvas Page.&#x27;, &#x27;wpp&#x27; ); ?&gt;&lt;/p&gt;

          &lt;?php if( isset( $wp_messages[ &#x27;error&#x27; ] ) &amp;&amp; $wp_messages[ &#x27;error&#x27; ] ): ?&gt;
            &lt;div class=&quot;error&quot;&gt;
        &lt;?php foreach ($wp_messages[ &#x27;error&#x27; ] as $error_message): ?&gt;
              &lt;p&gt;&lt;?php echo $error_message; ?&gt;
                &lt;?php endforeach; ?&gt;
      &lt;/div&gt;
          &lt;?php endif; ?&gt;

          &lt;?php if( isset( $wp_messages[ &#x27;notice&#x27; ] ) &amp;&amp; $wp_messages[ &#x27;notice&#x27; ] ): ?&gt;
            &lt;div class=&quot;updated fade&quot;&gt;
        &lt;?php foreach ($wp_messages[ &#x27;notice&#x27; ] as $notice_message): ?&gt;
              &lt;p&gt;&lt;?php echo $notice_message; ?&gt;
                &lt;?php endforeach; ?&gt;
      &lt;/div&gt;
          &lt;?php endif; ?&gt;

          &lt;form id=&quot;save_form&quot; class=&quot;hidden&quot; action=&quot;&lt;?php echo admin_url( &#x27;edit.php?post_type=property&amp;page=facebook_tabs&#x27; ); ?&gt;&quot; method=&quot;POST&quot;&gt;

        &lt;input type=&quot;hidden&quot; name=&quot;_wpnonce&quot; value=&quot;&lt;?php echo wp_create_nonce( &#x27;wpp_save_facebook_tabs_page&#x27; ); ?&gt;&quot;/&gt;
        &lt;input class=&quot;current_tab&quot; type=&quot;hidden&quot; name=&quot;current_tab&quot; value=&quot;&quot;/&gt;

        &lt;div class=&quot;wpp_fb_tabs wpp_tabs&quot;&gt;

          &lt;ul class=&quot;tabs&quot;&gt;
            &lt;?php foreach( $canvases as $slug =&gt; $canvas ) : ?&gt;
              &lt;li fb_canvas_id=&quot;&lt;?php echo $slug; ?&gt;&quot;&gt;&lt;a href=&quot;#fb_canvas_&lt;?php echo $slug; ?&gt;&quot;&gt;&lt;span&gt;&lt;?php echo $canvas[ &#x27;name&#x27; ]; ?&gt;&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;
            &lt;?php endforeach; ?&gt;
          &lt;/ul&gt;

          &lt;?php foreach( $canvases as $slug =&gt; $canvas ) : ?&gt;
            &lt;div id=&quot;fb_canvas_&lt;?php echo $slug; ?&gt;&quot; class=&quot;wpp_fb_tab ui-tabs-panel&quot; feps_form_id=&quot;&lt;?php echo esc_attr( $slug ); ?&gt;&quot;&gt;

            &lt;!-- Settings form table --&gt;
            &lt;table class=&quot;form-table wpp_option_table&quot;&gt;
              &lt;tr&gt;
                &lt;th&gt;
                  &lt;p&gt;&lt;strong&gt;&lt;?php _e( &#x27;Name:&#x27;, &#x27;wpp&#x27; ); ?&gt;&lt;/strong&gt;&lt;/p&gt;
                  &lt;div class=&quot;description&quot;&gt;
                    &lt;p&gt;
                      &lt;?php _e( &#x27;Note that Name is used for canvas link generation ( see Facebook Application Setup options below ).&#x27;, &#x27;wpp&#x27; ); ?&gt;
                    &lt;/p&gt;
                  &lt;/div&gt;
                &lt;/th&gt;
                &lt;td&gt;
                  &lt;input class=&quot;slug_setter&quot; type=&quot;text&quot; name=&quot;wpp_fb[&lt;?php echo $slug; ?&gt;][name]&quot; value=&quot;&lt;?php echo $canvas[ &#x27;name&#x27; ]; ?&gt;&quot;/&gt;
                  &lt;input class=&quot;current_slug hidden&quot; type=&quot;text&quot; value=&quot;&lt;?php echo $slug; ?&gt;&quot; readonly=&quot;readonly&quot;/&gt;
                &lt;/td&gt;
              &lt;/tr&gt;
              &lt;tr&gt;
                &lt;th&gt;
                  &lt;p&gt;&lt;strong&gt;&lt;?php _e( &#x27;Page:&#x27;, &#x27;wpp&#x27; ); ?&gt;&lt;/strong&gt;&lt;/p&gt;
                  &lt;div class=&quot;description&quot;&gt;
                    &lt;p&gt;
                      &lt;?php _e( &#x27;Set the page which will be shown in your Facebook Application/Tab canvas.&#x27;, &#x27;wpp&#x27; ); ?&gt;
                    &lt;/p&gt;
                  &lt;/div&gt;
                &lt;/th&gt;
                &lt;td&gt;
                  &lt;ul class=&quot;wpp_fb_canvas_options_list&quot;&gt;
                    &lt;li&gt;
                      &lt;label&gt;&lt;?php _e( &#x27;Type&#x27;, &#x27;wpp&#x27; ); ?&gt;&lt;/label&gt;
                      &lt;select class=&quot;wpp_fb_page_type&quot; name=&quot;wpp_fb[&lt;?php echo $slug; ?&gt;][use_page_as]&quot;&gt;
                        &lt;option value=&quot;page&quot; &lt;?php echo $canvas[ &#x27;use_page_as&#x27; ] == &#x27;page&#x27; ? &#x27;selected=&quot;selected&quot;&#x27; : &#x27;&#x27;; ?&gt; &gt;&lt;?php _e( &#x27;Page&#x27;, &#x27;wpp&#x27; ); ?&gt;&lt;/option&gt;
                        &lt;option value=&quot;property&quot; &lt;?php echo $canvas[ &#x27;use_page_as&#x27; ] == &#x27;property&#x27; ? &#x27;selected=&quot;selected&quot;&#x27; : &#x27;&#x27;; ?&gt; &gt;&lt;?php printf( __( &#x27;%1$s&#x27;, &#x27;wpp&#x27; ), ucfirst( WPP_F::property_label( &#x27;singular&#x27; ) ) ); ?&gt;&lt;/option&gt;
                      &lt;/select&gt;
                      &lt;span class=&quot;description&quot;&gt;&lt;?php _e( &quot;Note: Select the type to determine the available pages below.&quot;, &#x27;wpp&#x27; ); ?&gt;&lt;/span&gt;
                    &lt;/li&gt;
                    &lt;li&gt;
                      &lt;label&gt;&lt;?php _e( &#x27;Page&#x27;, &#x27;wpp&#x27; ); ?&gt;&lt;/label&gt;
                      &lt;select class=&quot;wpp_fb_page_select wpp_fb_type_page&quot; name=&quot;wpp_fb[&lt;?php echo $slug; ?&gt;][page]&quot;&gt;
                        &lt;?php foreach( self::get_available_pages() as $page_key =&gt; $page ) : ?&gt;
                          &lt;option &lt;?php echo $canvas[ &#x27;page&#x27; ] == $page_key ? &#x27;selected=&quot;selected&quot;&#x27; : &#x27;&#x27;; ?&gt; value=&quot;&lt;?php echo $page_key; ?&gt;&quot;&gt;&lt;?php echo $page[ &#x27;title&#x27; ]; ?&gt;&lt;/option&gt;
                        &lt;?php endforeach; ?&gt;
                      &lt;/select&gt;
                      &lt;input value=&quot;&lt;?php echo $canvas[ &#x27;page&#x27; ]; ?&gt;&quot; type=&quot;hidden&quot; class=&quot;wpp_default_empty wpp_fb_property_input_hidden wpp_fb_type_property&quot; name=&quot;wpp_fb[&lt;?php echo $slug; ?&gt;][page]&quot;/&gt;
                      &lt;input autocomplete=&quot;off&quot; placeholder=&quot;&lt;?php _e( &#x27;Search...&#x27;, &#x27;wpp&#x27; ); ?&gt;&quot; value=&quot;&lt;?php echo $canvas[ &#x27;page_title&#x27; ]; ?&gt;&quot; type=&quot;text&quot; class=&quot;wpp_default_empty wpp_fb_property_input wpp_fb_type_property&quot; name=&quot;wpp_fb[&lt;?php echo $slug; ?&gt;][page_title]&quot;/&gt;
                      &lt;img class=&quot;wpp_fb_tabs_loader_image hidden&quot; src=&quot;&lt;?php echo WPP_URL . &#x27;images/ajax_loader.gif&#x27; ?&gt;&quot;/&gt;
                      &lt;ul class=&quot;wpp_fb_tabs_found_properies hidden&quot;&gt;&lt;/ul&gt;
                    &lt;/li&gt;
                    &lt;li class=&quot;wpp_fb_type_page&quot;&gt;
                      &lt;?php echo WPP_F::checkbox( &quot;class=wpp_default_empty&amp;name=wpp_fb[{$slug}][settings][hide_from_wp]&amp;label=&quot; . __( &#x27;Hide the selected page from Regular WordPress.&#x27;, &#x27;wpp&#x27; ), $canvas[ &#x27;settings&#x27; ][ &#x27;hide_from_wp&#x27; ] ); ?&gt;
                      &lt;span class=&quot;description&quot;&gt;&lt;?php _e( &quot;Note: Hidden page will not be accessible in other Premium Features too.&quot;, &#x27;wpp&#x27; ); ?&gt;&lt;/span&gt;
                    &lt;/li&gt;
                  &lt;/ul&gt;
                &lt;/td&gt;
              &lt;/tr&gt;
              &lt;tr&gt;
                &lt;th&gt;
                  &lt;p&gt;&lt;strong&gt;&lt;?php _e( &#x27;Template Settings:&#x27;, &#x27;wpp&#x27; ); ?&gt;&lt;/strong&gt;&lt;/p&gt;
                  &lt;div class=&quot;description&quot;&gt;
                    &lt;p&gt;
                      &lt;?php _e( &#x27;Set the template, CSS and other options for your Facebook Application/Tab canvas.&#x27;, &#x27;wpp&#x27; ); ?&gt;
                    &lt;/p&gt;
                  &lt;/div&gt;
                &lt;/th&gt;
                &lt;td&gt;
                  &lt;ul class=&quot;wpp_fb_canvas_options_list&quot;&gt;
                    &lt;li&gt;
                      &lt;label class=&quot;wpp_fb_template_label&quot;&gt;&lt;?php _e( &#x27;Template:&#x27;, &#x27;wpp&#x27; ); ?&gt;&lt;/label&gt;
                      &lt;select class=&quot;wpp_default_empty wpp_fb_template_page wpp_fb_template_select wpp_fb_type_page&quot; name=&quot;wpp_fb[&lt;?php echo $slug; ?&gt;][template][page]&quot;&gt;
                        &lt;?php foreach( $templates as $key =&gt; $template ) : ?&gt;
                          &lt;?php if( $template[ &#x27;type&#x27; ] !== &#x27;page&#x27; ) continue; ?&gt;
                          &lt;option &lt;?php echo $key == $canvas[ &#x27;template&#x27; ][ &#x27;page&#x27; ] ? &#x27;selected=&quot;selected&quot;&#x27; : &#x27;&#x27;; ?&gt; value=&quot;&lt;?php echo $key; ?&gt;&quot;&gt;&lt;?php _e( $template[ &#x27;name&#x27; ], &#x27;wpp&#x27; ); ?&gt;&lt;/option&gt;
                        &lt;?php endforeach; ?&gt;
                      &lt;/select&gt;
                      &lt;select class=&quot;wpp_default_empty wpp_fb_template_property wpp_fb_template_select wpp_fb_type_property&quot; name=&quot;wpp_fb[&lt;?php echo $slug; ?&gt;][template][property]&quot;&gt;
                        &lt;?php foreach( $templates as $key =&gt; $template ) : ?&gt;
                          &lt;?php if( $template[ &#x27;type&#x27; ] !== &#x27;property&#x27; ) continue; ?&gt;
                          &lt;option &lt;?php echo $key == $canvas[ &#x27;template&#x27; ][ &#x27;property&#x27; ] ? &#x27;selected=&quot;selected&quot;&#x27; : &#x27;&#x27;; ?&gt; value=&quot;&lt;?php echo $key; ?&gt;&quot;&gt;&lt;?php _e( $template[ &#x27;name&#x27; ], &#x27;wpp&#x27; ); ?&gt;&lt;/option&gt;
                        &lt;?php endforeach; ?&gt;
                      &lt;/select&gt;
                      &lt;span class=&quot;description&quot;&gt;&lt;?php _e( &quot;Note: The list of available templates depends on selected page type. You can add your own templates. See help link above.&quot;, &#x27;wpp&#x27; ); ?&gt;&lt;/span&gt;
                    &lt;/li&gt;
                    &lt;li&gt;
                      &lt;?php echo WPP_F::checkbox( &quot;class=wpp_default_empty&amp;name=wpp_fb[{$slug}][settings][enable_theme_templates]&amp;label=&quot; . __( &#x27;Enable theme\&#x27;s template parts.&#x27;, &#x27;wpp&#x27; ), $canvas[ &#x27;settings&#x27; ][ &#x27;enable_theme_templates&#x27; ] ); ?&gt;
                      &lt;span class=&quot;description&quot;&gt;&lt;?php _e( &quot;Note: canvas uses default WP-Property template parts by default. If enabled, application will try to load parts from theme folder. But custom part templates can be incompatible with default CSS styles.&quot;, &#x27;wpp&#x27; ); ?&gt;&lt;/span&gt;
                    &lt;/li&gt;
                    &lt;li&gt;
                      &lt;?php echo WPP_F::checkbox( &quot;class=wpp_default_empty&amp;name=wpp_fb[{$slug}][settings][open_links_in_new_window]&amp;label=&quot; . __( &#x27;Open links in new window.&#x27;, &#x27;wpp&#x27; ), $canvas[ &#x27;settings&#x27; ][ &#x27;open_links_in_new_window&#x27; ] ); ?&gt;
                    &lt;/li&gt;
                    &lt;li&gt;
                      &lt;?php echo WPP_F::checkbox( &quot;class=wpp_default_empty&amp;name=wpp_fb[{$slug}][settings][open_forms_in_new_window]&amp;label=&quot; . __( &#x27;Open forms in new window.&#x27;, &#x27;wpp&#x27; ), $canvas[ &#x27;settings&#x27; ][ &#x27;open_forms_in_new_window&#x27; ] ); ?&gt;
                    &lt;/li&gt;
                    &lt;li&gt;
                      &lt;?php echo WPP_F::checkbox( &quot;class=wpp_default_empty&amp;name=wpp_fb[$slug][disable_default_css]&amp;label=&quot; . __( &#x27;Disable default CSS.&#x27;, &#x27;wpp&#x27; ), $canvas[ &#x27;disable_default_css&#x27; ] ); ?&gt;
                    &lt;/li&gt;
                    &lt;li&gt;
                      &lt;input class=&quot;wpp_fb_allow_inline_css wpp_show_advanced&quot; wrapper=&quot;wpp_fb_canvas_options_list&quot; advanced_option_class=&quot;wpp_advanced_option&quot; id=&quot;wpp_fb_allow_inline_css_&lt;?php echo $slug; ?&gt;&quot; type=&quot;checkbox&quot; name=&quot;wpp_fb[&lt;?php echo $slug; ?&gt;][allow_inline_css]&quot; &lt;?php checked( $canvas[ &#x27;allow_inline_css&#x27; ], &#x27;true&#x27; ); ?&gt; value=&quot;true&quot;/&gt;
                      &lt;label for=&quot;wpp_fb_allow_inline_css_&lt;?php echo $slug; ?&gt;&quot;&gt;&lt;?php _e( &#x27;Allow inline CSS.&#x27;, &#x27;wpp&#x27; ); ?&gt;&lt;/label&gt;
                    &lt;/li&gt;
                    &lt;li class=&quot;wpp_advanced_option&quot; &lt;?php echo ( &#x27;true&#x27; !== $canvas[ &#x27;allow_inline_css&#x27; ] ) ? &quot; style=&#x27;display:none&#x27; &quot; : &#x27;&#x27;; ?&gt;&gt;
                      &lt;label for=&quot;wpp_fb_inline_css_data_&lt;?php echo $slug; ?&gt;&quot;&gt;&lt;?php _e( &#x27;Inline CSS:&#x27;, &#x27;wpp&#x27; ); ?&gt;&lt;/label&gt;&lt;br&gt;
                      &lt;textarea id=&quot;wpp_fb_inline_css_data_&lt;?php echo $slug; ?&gt;&quot; name=&quot;wpp_fb[&lt;?php echo $slug; ?&gt;][inline_css_data]&quot; type=&quot;text&quot; class=&quot;wpp_full_width wpp_default_empty&quot;&gt;&lt;?php echo $canvas[ &#x27;inline_css_data&#x27; ] ?&gt;&lt;/textarea&gt;
                    &lt;/li&gt;
                  &lt;/ul&gt;
                &lt;/td&gt;
              &lt;/tr&gt;
              &lt;tr&gt;
                &lt;th&gt;
                  &lt;p&gt;&lt;strong&gt;&lt;?php _e( &#x27;Facebook Application Setup:&#x27;, &#x27;wpp&#x27; ); ?&gt;&lt;/strong&gt;&lt;/p&gt;
                  &lt;div class=&quot;description&quot;&gt;
                    &lt;p&gt;&lt;?php _e( &#x27;Applicable for both Application and Page Tab&#x27;, &#x27;wpp&#x27; ); ?&gt;&lt;/p&gt;
                    &lt;p&gt;&lt;?php _e( &#x27;You will need to create an app using your Facebook account.  Once the app is created, you will be able to add it to one of your pages.&#x27;, &#x27;wpp&#x27; ); ?&gt;
                      &lt;a target=&quot;_blank&quot; href=&quot;https://developers.facebook.com/apps&quot;&gt;&lt;?php _e( &#x27;Create Facebook App.&#x27;, &#x27;wpp&#x27; ); ?&gt;&lt;/a&gt;&lt;/p&gt;
                  &lt;/div&gt;
                &lt;/th&gt;
                &lt;td&gt;
                  &lt;ul class=&quot;wpp_fb_canvas_options_list&quot;&gt;
                    &lt;li&gt;
                      &lt;label for=&quot;wpp_canvas_app_id_&lt;?php echo $slug; ?&gt;&quot;&gt;&lt;?php _e( &#x27;App ID:&#x27;, &#x27;wpp&#x27; ); ?&gt;&lt;/label&gt;
                      &lt;input class=&quot;wpp_default_empty wpp_fb_app_id&quot; id=&quot;wpp_canvas_app_id_&lt;?php echo $slug; ?&gt;&quot; type=&quot;text&quot; name=&quot;wpp_fb[&lt;?php echo $slug; ?&gt;][app_id]&quot; value=&quot;&lt;?php echo $canvas[ &#x27;app_id&#x27; ]; ?&gt;&quot;/&gt;
                      &lt;a target=&quot;_blank&quot; class=&quot;button-secondary btn wpp_fb_tabs_add_to_page&quot; style=&quot;display:none;&quot; href=&quot;&quot;&gt;&lt;?php _e( &#x27;Add to Facebook&#x27;, &#x27;wpp&#x27; ); ?&gt;&lt;/a&gt;
                    &lt;/li&gt;
                    &lt;li&gt;
                      &lt;label for=&quot;wpp_canvas_secret_&lt;?php echo $slug; ?&gt;&quot;&gt;&lt;?php _e( &#x27;Secret:&#x27;, &#x27;wpp&#x27; ); ?&gt;&lt;/label&gt;
                      &lt;input class=&quot;wpp_default_empty&quot; id=&quot;wpp_canvas_secret_&lt;?php echo $slug; ?&gt;&quot; type=&quot;text&quot; name=&quot;wpp_fb[&lt;?php echo $slug; ?&gt;][secret]&quot; value=&quot;&lt;?php echo $canvas[ &#x27;secret&#x27; ]; ?&gt;&quot;/&gt;
                    &lt;/li&gt;
                  &lt;/ul&gt;
                  &lt;ul class=&quot;wpp_fb_canvas_urls&quot;&gt;
                    &lt;li&gt;
                      &lt;label&gt;&lt;?php _e( &#x27;Canvas URL:&#x27;, &#x27;wpp&#x27; ); ?&gt;&lt;/label&gt;
                      &lt;input type=&quot;text&quot; class=&quot;default_canvas_url wpp_default_empty&quot; readonly=&quot;readonly&quot; value=&quot;&quot;/&gt;
                      &lt;small&gt;&lt;i&gt;&lt;/i&gt;&lt;/small&gt;
                    &lt;/li&gt;
                    &lt;li&gt;
                      &lt;label&gt;&lt;?php _e( &#x27;Secure Canvas URL:&#x27;, &#x27;wpp&#x27; ); ?&gt;&lt;/label&gt;
                      &lt;input type=&quot;text&quot; class=&quot;secure_canvas_url wpp_default_empty&quot; readonly=&quot;readonly&quot; value=&quot;&quot;/&gt;
                    &lt;/li&gt;
                    &lt;li&gt;
                      &lt;label&gt;&lt;?php _e( &#x27;Debug URL:&#x27;, &#x27;wpp&#x27; ); ?&gt;&lt;/label&gt;
                      &lt;input type=&quot;text&quot; class=&quot;debug_canvas_url wpp_default_empty&quot; readonly=&quot;readonly&quot; value=&quot;&quot;/&gt;
                    &lt;/li&gt;
                  &lt;/ul&gt;
                &lt;/td&gt;
              &lt;/tr&gt;
            &lt;/table&gt;
            &lt;!-- EO Settings form table --&gt;

          &lt;/div&gt;
            &lt;div class=&quot;clear&quot;&gt;&lt;/div&gt;
          &lt;?php endforeach; ?&gt;
        &lt;/div&gt;
        &lt;br class=&quot;cb&quot;/&gt;
        &lt;p class=&quot;wpp_save_changes_row&quot;&gt;
          &lt;input type=&quot;submit&quot; value=&quot;&lt;?php _e( &#x27;Save Changes&#x27;, &#x27;wpp&#x27; ); ?&gt;&quot; class=&quot;button-primary btn&quot; name=&quot;Submit&quot;/&gt;
        &lt;/p&gt;
      &lt;/form&gt;

    &lt;/div&gt;
      &lt;?php
      }

    }
  }

}
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
