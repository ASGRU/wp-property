<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>lib/class-module.php - usabilitydynamics/wp-property</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="usabilitydynamics/wp-property"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 2.0.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/Bootstrap.html">Bootstrap</a></li>
            
                <li><a href="../classes/Exception.html">Exception</a></li>
            
                <li><a href="../classes/Theme.html">Theme</a></li>
            
                <li><a href="../classes/UsabilityDynamics\WPP.Bootstrap.html">UsabilityDynamics\WPP.Bootstrap</a></li>
            
                <li><a href="../classes/UsabilityDynamics\WPP.Loader.html">UsabilityDynamics\WPP.Loader</a></li>
            
                <li><a href="../classes/WP_Error.html">WP_Error</a></li>
            
                <li><a href="../classes/WPP.html">WPP</a></li>
            
                <li><a href="../classes/WPP_UI.html">WPP_UI</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: lib/class-module.php</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&lt;?php
/**
 * Class Module
 */
namespace UsabilityDynamics\WPP {

  if( !class_exists( &#x27;UsabilityDynamics\WPP\Module&#x27; ) ) {

    /**
     * Feature Upgrader
     *
     * @package UsabilityDynamics\WPP
     */
    class Module extends \WP_Upgrader {

      var $result;
      var $bulk = false;

      function upgrade_strings() {
        $this-&gt;strings[ &#x27;up_to_date&#x27; ]          = __( &#x27;The plugin is at the latest version.&#x27; );
        $this-&gt;strings[ &#x27;no_package&#x27; ]          = __( &#x27;Update package not available.&#x27; );
        $this-&gt;strings[ &#x27;downloading_package&#x27; ] = __( &#x27;Downloading update from &lt;span class=&quot;code&quot;&gt;%s&lt;/span&gt;&amp;#8230;&#x27; );
        $this-&gt;strings[ &#x27;unpack_package&#x27; ]      = __( &#x27;Unpacking the update&amp;#8230;&#x27; );
        $this-&gt;strings[ &#x27;remove_old&#x27; ]          = __( &#x27;Removing the old version of the plugin&amp;#8230;&#x27; );
        $this-&gt;strings[ &#x27;remove_old_failed&#x27; ]   = __( &#x27;Could not remove the old plugin.&#x27; );
        $this-&gt;strings[ &#x27;process_failed&#x27; ]      = __( &#x27;Plugin update failed.&#x27; );
        $this-&gt;strings[ &#x27;process_success&#x27; ]     = __( &#x27;Plugin updated successfully.&#x27; );
      }

      function install_strings() {
        $this-&gt;strings[ &#x27;no_package&#x27; ]          = __( &#x27;Install package not available.&#x27; );
        $this-&gt;strings[ &#x27;downloading_package&#x27; ] = __( &#x27;Downloading install package from &lt;span class=&quot;code&quot;&gt;%s&lt;/span&gt;&amp;#8230;&#x27; );
        $this-&gt;strings[ &#x27;unpack_package&#x27; ]      = __( &#x27;Unpacking the package&amp;#8230;&#x27; );
        $this-&gt;strings[ &#x27;installing_package&#x27; ]  = __( &#x27;Installing the plugin&amp;#8230;&#x27; );
        $this-&gt;strings[ &#x27;no_files&#x27; ]            = __( &#x27;The plugin contains no files.&#x27; );
        $this-&gt;strings[ &#x27;process_failed&#x27; ]      = __( &#x27;Plugin install failed.&#x27; );
        $this-&gt;strings[ &#x27;process_success&#x27; ]     = __( &#x27;Plugin installed successfully.&#x27; );
      }

      function install( $package, $args = array() ) {

        $defaults    = array(
          &#x27;clear_update_cache&#x27; =&gt; true,
        );
        $parsed_args = wp_parse_args( $args, $defaults );

        $this-&gt;init();
        $this-&gt;install_strings();

        add_filter( &#x27;upgrader_source_selection&#x27;, array( $this, &#x27;check_package&#x27; ) );

        $this-&gt;run( array(
          &#x27;package&#x27;           =&gt; $package,
          &#x27;destination&#x27;       =&gt; WP_PLUGIN_DIR,
          &#x27;clear_destination&#x27; =&gt; false, // Do not overwrite files.
          &#x27;clear_working&#x27;     =&gt; true,
          &#x27;hook_extra&#x27;        =&gt; array(
            &#x27;type&#x27;   =&gt; &#x27;plugin&#x27;,
            &#x27;action&#x27; =&gt; &#x27;install&#x27;,
          )
        ) );

        remove_filter( &#x27;upgrader_source_selection&#x27;, array( $this, &#x27;check_package&#x27; ) );

        if( !$this-&gt;result || is_wp_error( $this-&gt;result ) )
          return $this-&gt;result;

        // Force refresh of plugin update information
        wp_clean_plugins_cache( $parsed_args[ &#x27;clear_update_cache&#x27; ] );

        return true;
      }

      function upgrade( $plugin, $args = array() ) {

        $defaults    = array(
          &#x27;clear_update_cache&#x27; =&gt; true,
        );
        $parsed_args = wp_parse_args( $args, $defaults );

        $this-&gt;init();
        $this-&gt;upgrade_strings();

        $current = get_site_transient( &#x27;update_plugins&#x27; );
        if( !isset( $current-&gt;response[ $plugin ] ) ) {
          $this-&gt;skin-&gt;before();
          $this-&gt;skin-&gt;set_result( false );
          $this-&gt;skin-&gt;error( &#x27;up_to_date&#x27; );
          $this-&gt;skin-&gt;after();

          return false;
        }

        // Get the URL to the zip file
        $r = $current-&gt;response[ $plugin ];

        add_filter( &#x27;upgrader_pre_install&#x27;, array( $this, &#x27;deactivate_plugin_before_upgrade&#x27; ), 10, 2 );
        add_filter( &#x27;upgrader_clear_destination&#x27;, array( $this, &#x27;delete_old_plugin&#x27; ), 10, 4 );
        //&#x27;source_selection&#x27; =&gt; array($this, &#x27;source_selection&#x27;), //there&#x27;s a trac ticket to move up the directory for zip&#x27;s which are made a bit differently, useful for non-.org plugins.

        $this-&gt;run( array(
          &#x27;package&#x27;           =&gt; $r-&gt;package,
          &#x27;destination&#x27;       =&gt; WP_PLUGIN_DIR,
          &#x27;clear_destination&#x27; =&gt; true,
          &#x27;clear_working&#x27;     =&gt; true,
          &#x27;hook_extra&#x27;        =&gt; array(
            &#x27;plugin&#x27; =&gt; $plugin,
            &#x27;type&#x27;   =&gt; &#x27;plugin&#x27;,
            &#x27;action&#x27; =&gt; &#x27;update&#x27;,
          ),
        ) );

        // Cleanup our hooks, in case something else does a upgrade on this connection.
        remove_filter( &#x27;upgrader_pre_install&#x27;, array( $this, &#x27;deactivate_plugin_before_upgrade&#x27; ) );
        remove_filter( &#x27;upgrader_clear_destination&#x27;, array( $this, &#x27;delete_old_plugin&#x27; ) );

        if( !$this-&gt;result || is_wp_error( $this-&gt;result ) )
          return $this-&gt;result;

        // Force refresh of plugin update information
        wp_clean_plugins_cache( $parsed_args[ &#x27;clear_update_cache&#x27; ] );

        return true;
      }

      function bulk_upgrade( $plugins, $args = array() ) {

        $defaults    = array(
          &#x27;clear_update_cache&#x27; =&gt; true,
        );
        $parsed_args = wp_parse_args( $args, $defaults );

        $this-&gt;init();
        $this-&gt;bulk = true;
        $this-&gt;upgrade_strings();

        $current = get_site_transient( &#x27;update_plugins&#x27; );

        add_filter( &#x27;upgrader_clear_destination&#x27;, array( $this, &#x27;delete_old_plugin&#x27; ), 10, 4 );

        $this-&gt;skin-&gt;header();

        // Connect to the Filesystem first.
        $res = $this-&gt;fs_connect( array( WP_CONTENT_DIR, WP_PLUGIN_DIR ) );
        if( !$res ) {
          $this-&gt;skin-&gt;footer();

          return false;
        }

        $this-&gt;skin-&gt;bulk_header();

        // Only start maintenance mode if:
        // - running Multisite and there are one or more plugins specified, OR
        // - a plugin with an update available is currently active.
        // @TODO: For multisite, maintenance mode should only kick in for individual sites if at all possible.
        $maintenance = ( is_multisite() &amp;&amp; !empty( $plugins ) );
        foreach( $plugins as $plugin )
          $maintenance = $maintenance || ( is_plugin_active( $plugin ) &amp;&amp; isset( $current-&gt;response[ $plugin ] ) );
        if( $maintenance )
          $this-&gt;maintenance_mode( true );

        $results = array();

        $this-&gt;update_count   = count( $plugins );
        $this-&gt;update_current = 0;
        foreach( $plugins as $plugin ) {
          $this-&gt;update_current++;
          $this-&gt;skin-&gt;plugin_info = get_plugin_data( WP_PLUGIN_DIR . &#x27;/&#x27; . $plugin, false, true );

          if( !isset( $current-&gt;response[ $plugin ] ) ) {
            $this-&gt;skin-&gt;set_result( true );
            $this-&gt;skin-&gt;before();
            $this-&gt;skin-&gt;feedback( &#x27;up_to_date&#x27; );
            $this-&gt;skin-&gt;after();
            $results[ $plugin ] = true;
            continue;
          }

          // Get the URL to the zip file
          $r = $current-&gt;response[ $plugin ];

          $this-&gt;skin-&gt;plugin_active = is_plugin_active( $plugin );

          $result = $this-&gt;run( array(
            &#x27;package&#x27;           =&gt; $r-&gt;package,
            &#x27;destination&#x27;       =&gt; WP_PLUGIN_DIR,
            &#x27;clear_destination&#x27; =&gt; true,
            &#x27;clear_working&#x27;     =&gt; true,
            &#x27;is_multi&#x27;          =&gt; true,
            &#x27;hook_extra&#x27;        =&gt; array(
              &#x27;plugin&#x27; =&gt; $plugin
            )
          ) );

          $results[ $plugin ] = $this-&gt;result;

          // Prevent credentials auth screen from displaying multiple times
          if( false === $result )
            break;
        } //end foreach $plugins

        $this-&gt;maintenance_mode( false );

        do_action( &#x27;upgrader_process_complete&#x27;, $this, array(
          &#x27;action&#x27;  =&gt; &#x27;update&#x27;,
          &#x27;type&#x27;    =&gt; &#x27;plugin&#x27;,
          &#x27;bulk&#x27;    =&gt; true,
          &#x27;plugins&#x27; =&gt; $plugins,
        ) );

        $this-&gt;skin-&gt;bulk_footer();

        $this-&gt;skin-&gt;footer();

        // Cleanup our hooks, in case something else does a upgrade on this connection.
        remove_filter( &#x27;upgrader_clear_destination&#x27;, array( $this, &#x27;delete_old_plugin&#x27; ) );

        // Force refresh of plugin update information
        wp_clean_plugins_cache( $parsed_args[ &#x27;clear_update_cache&#x27; ] );

        return $results;
      }

      function check_package( $source ) {
        global $wp_filesystem;

        if( is_wp_error( $source ) )
          return $source;

        $working_directory = str_replace( $wp_filesystem-&gt;wp_content_dir(), trailingslashit( WP_CONTENT_DIR ), $source );
        if( !is_dir( $working_directory ) ) // Sanity check, if the above fails, lets not prevent installation.
          return $source;

        // Check the folder contains at least 1 valid plugin.
        $plugins_found = false;
        foreach( glob( $working_directory . &#x27;*.php&#x27; ) as $file ) {
          $info = get_plugin_data( $file, false, false );
          if( !empty( $info[ &#x27;Name&#x27; ] ) ) {
            $plugins_found = true;
            break;
          }
        }

        if( !$plugins_found )
          return new WP_Error( &#x27;incompatible_archive_no_plugins&#x27;, $this-&gt;strings[ &#x27;incompatible_archive&#x27; ], __( &#x27;No valid plugins were found.&#x27; ) );

        return $source;
      }

      //return plugin info.
      function plugin_info() {
        if( !is_array( $this-&gt;result ) )
          return false;
        if( empty( $this-&gt;result[ &#x27;destination_name&#x27; ] ) )
          return false;

        $plugin = get_plugins( &#x27;/&#x27; . $this-&gt;result[ &#x27;destination_name&#x27; ] ); //Ensure to pass with leading slash
        if( empty( $plugin ) )
          return false;

        $pluginfiles = array_keys( $plugin ); //Assume the requested plugin is the first in the list

        return $this-&gt;result[ &#x27;destination_name&#x27; ] . &#x27;/&#x27; . $pluginfiles[ 0 ];
      }

      //Hooked to pre_install
      function deactivate_plugin_before_upgrade( $return, $plugin ) {

        if( is_wp_error( $return ) ) //Bypass.
          return $return;

        // When in cron (background updates) don&#x27;t deactivate the plugin, as we require a browser to reactivate it
        if( defined( &#x27;DOING_CRON&#x27; ) &amp;&amp; DOING_CRON )
          return $return;

        $plugin = isset( $plugin[ &#x27;plugin&#x27; ] ) ? $plugin[ &#x27;plugin&#x27; ] : &#x27;&#x27;;
        if( empty( $plugin ) )
          return new WP_Error( &#x27;bad_request&#x27;, $this-&gt;strings[ &#x27;bad_request&#x27; ] );

        if( is_plugin_active( $plugin ) ) {
          //Deactivate the plugin silently, Prevent deactivation hooks from running.
          deactivate_plugins( $plugin, true );
        }
      }

      //Hooked to upgrade_clear_destination
      function delete_old_plugin( $removed, $local_destination, $remote_destination, $plugin ) {
        global $wp_filesystem;

        if( is_wp_error( $removed ) )
          return $removed; //Pass errors through.

        $plugin = isset( $plugin[ &#x27;plugin&#x27; ] ) ? $plugin[ &#x27;plugin&#x27; ] : &#x27;&#x27;;
        if( empty( $plugin ) )
          return new WP_Error( &#x27;bad_request&#x27;, $this-&gt;strings[ &#x27;bad_request&#x27; ] );

        $plugins_dir     = $wp_filesystem-&gt;wp_plugins_dir();
        $this_plugin_dir = trailingslashit( dirname( $plugins_dir . $plugin ) );

        if( !$wp_filesystem-&gt;exists( $this_plugin_dir ) ) //If it&#x27;s already vanished.
          return $removed;

        // If plugin is in its own directory, recursively delete the directory.
        if( strpos( $plugin, &#x27;/&#x27; ) &amp;&amp; $this_plugin_dir != $plugins_dir ) //base check on if plugin includes directory separator AND that it&#x27;s not the root plugin folder
          $deleted = $wp_filesystem-&gt;delete( $this_plugin_dir, true );
        else
          $deleted = $wp_filesystem-&gt;delete( $plugins_dir . $plugin );

        if( !$deleted )
          return new WP_Error( &#x27;remove_old_failed&#x27;, $this-&gt;strings[ &#x27;remove_old_failed&#x27; ] );

        return true;
      }

    }

  }

}
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
