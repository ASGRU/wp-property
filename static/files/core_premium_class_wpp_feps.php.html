<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>core/premium/class_wpp_feps.php - WP-Property</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="http://a3d72a45d111006ec192-ec5b80a12b0b09b4d52373336afb4254.r80.cf1.rackcdn.com/usability-dynamics.png" title="WP-Property"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 1.38.2</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/wpp.html">wpp</a></li>
            
                <li><a href="../classes/wpp.overview.html">wpp.overview</a></li>
            
                <li><a href="../classes/wpp.xmli.html">wpp.xmli</a></li>
            
                <li><a href="../classes/WPP_RETS.html">WPP_RETS</a></li>
            
                <li><a href="../classes/WPP_UI.html">WPP_UI</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: core/premium/class_wpp_feps.php</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&lt;?php
/**
 * Name: Front End Property Submissions (FEPS)
 * Class: class_wpp_feps
 * Version: 2.0.2
 * Minimum Core Version: 1.38.2
 * Feature ID: 14
 * Description: Allow users to add properties from the front-end.
 *
 * == To Do ==
 *  - Use _device_can_upload() if not already used, or switch over to backend WP upload form.
 *
 */

define( &#x27;WPP_FEPS_Version&#x27;, &#x27;2.0.2&#x27; );

add_action(&#x27;wpp_pre_init&#x27;, array(&#x27;class_wpp_feps&#x27;, &#x27;wpp_pre_init&#x27;));
add_action(&#x27;wpp_post_init&#x27;, array(&#x27;class_wpp_feps&#x27;, &#x27;wpp_post_init&#x27;));
add_action(&#x27;widgets_init&#x27;, create_function(&#x27;&#x27;, &#x27;return register_widget(&quot;MyFepsWidget&quot;);&#x27;));

if ( !defined( &#x27;FEPS_VIEW_PAGE&#x27; ) ) define( &#x27;FEPS_VIEW_PAGE&#x27;, &#x27;my_feps_listings&#x27; );
if ( !defined( &#x27;FEPS_EDIT_PAGE&#x27; ) ) define( &#x27;FEPS_EDIT_PAGE&#x27;, &#x27;feps_edit_page&#x27; );
if ( !defined( &#x27;FEPS_SPC_PAGE&#x27; ) ) define( &#x27;FEPS_SPC_PAGE&#x27;, &#x27;feps_spc_page&#x27; );

//** Specific FEPS meta data */
if ( !defined( &#x27;FEPS_META_FORM&#x27; ) ) define( &#x27;FEPS_META_FORM&#x27;, &#x27;wpp::feps::form_id&#x27; );
if ( !defined( &#x27;FEPS_META_PLAN&#x27; ) ) define( &#x27;FEPS_META_PLAN&#x27;, &#x27;wpp::feps::subscription_plan&#x27; );
if ( !defined( &#x27;FEPS_META_EXPIRED&#x27; ) ) define( &#x27;FEPS_META_EXPIRED&#x27;, &#x27;wpp::feps::expired_time&#x27; );


class class_wpp_feps {

  /**
   * (custom) Capability to manage the current feature
   */
  static protected $capability = &quot;manage_wpp_feps&quot;;


  /**
   * CRM Notification actions
   *
   * Available template tags you can use in WP CRM plugin for user natifications:
   *
   * For &#x27;pending_property_approve&#x27;:
   * - [user_email] Email where to send notification
   * - [display_name] User&#x27;s name
   * - [url] Property url
   * - [title] Property title
   *
   * For &#x27;pending_property_added&#x27;:
   * - [user_email] Email where to send notification
   * - [pending_url] Pending Property url
   * - [title] Property title
   *
   * For &#x27;pending_account_approved&#x27;:
   * - [user_email] Email where to send notification
   * - [user_login] User&#x27;s login
   * - [site_url] Current site url
   *
   */
  static protected $crm_notification_actions = array(
    &#x27;pending_property_approve&#x27; =&gt; &#x27;FEPS: Pending Approval&#x27;,
    &#x27;pending_property_added&#x27;   =&gt; &#x27;FEPS: Property Submitted&#x27;,
    &#x27;pending_account_approved&#x27; =&gt; &#x27;FEPS: User Account Approved&#x27;,
    &#x27;feps_use_account_created&#x27; =&gt; &#x27;FEPS: User Account Created&#x27;,
    &#x27;feps_status_updated&#x27;      =&gt; &#x27;FEPS: Property Status Updated&#x27;
  );

  /**
   * Available property statuses
   * @var array
   */
  static protected $statuses = array( &#x27;publish&#x27;, &#x27;pending&#x27;, &#x27;trash&#x27; );

  /**
   * Special functions that must be called prior to init
   *
   */
  function wpp_pre_init() {

    self::_handle_upgrade();

    /** Add capability */
    add_filter(&quot;wpp_capabilities&quot;, array(&#x27;class_wpp_feps&#x27;, &quot;add_capability&quot;));

    /** Add CRM notification fire action */
    add_filter(&quot;wp_crm_notification_actions&quot;, array(&#x27;class_wpp_feps&#x27;, &#x27;crm_custom_notification&#x27;));

    /** Register feps schedule events */
    self::feps_schedule_events();

    //** If WP-Invoice and SPC premium feature is installed we add custom templates from wp-property */
    add_filter( &#x27;wpi::spc::template&#x27;, array( __CLASS__, &#x27;wpi_spc_template&#x27; ), 0, 1 );

    //** Add localization of javascript files */
    add_filter( &#x27;wpp::js::localization&#x27;, array( __CLASS__, &#x27;js_localization&#x27; ), 0, 1 );

    //** Templates filters */
    add_filter( &#x27;feps::template::submit::btn&#x27;, array( __CLASS__, &#x27;filter_submit_button&#x27; ), 0, 3 );


  }


  /**
   * Primary feature function.  Ran an init level.
   *
   * @since 0.1
   */
  function wpp_post_init() {
    global $wp_properties;

    if( current_user_can( self::$capability ) ) {
      //** Add Inquiry page to Property Settings page array */
      add_filter( &#x27;wpp_settings_nav&#x27;, array( __CLASS__, &#x27;settings_nav&#x27; ) );
      //** Add Settings Page */
      add_action( &#x27;wpp_settings_content_feps&#x27;, array( __CLASS__, &#x27;settings_page&#x27; ) );

      //** Adds Contextual Helps */
      add_action( &#x27;load-property_page_page_feps&#x27;, array( __CLASS__, &#x27;contextual_help_property_forms&#x27; ) );
      add_action( &#x27;property_page_property_settings_help&#x27;, array( __CLASS__, &#x27;contextual_help_settings&#x27; ) );

      //** Adds custom FEPS column in &#x27;All Properties&#x27; table if needed */
      add_filter( &#x27;wpp_overview_columns&#x27;, array( __CLASS__, &#x27;overview_column&#x27; ) );
      add_filter( &#x27;wpp::single_row::feps&#x27;, create_function( &#x27;$boolean, $post&#x27;, &#x27;return true;&#x27; ), 0, 2 );
      add_filter( &#x27;wpp::single_row::feps::render&#x27;, array( __CLASS__, &#x27;render_overview_column&#x27; ), 0, 2 );
    }

    add_shortcode(&#x27;wpp_feps_form&#x27;, array(&#x27;class_wpp_feps&#x27;, &#x27;wpp_feps_form&#x27;));
    add_shortcode(&#x27;wpp_feps_menu&#x27;, array(&#x27;class_wpp_feps&#x27;, &#x27;wpp_feps_menu&#x27;));

    /** Add FEPS shortcode form creation page under Properties nav menu */
    add_action(&quot;admin_menu&quot;, array(&quot;class_wpp_feps&quot;, &quot;admin_menu&quot;));

    add_filter(&quot;added_post_meta&quot;, array(&#x27;class_wpp_feps&#x27;, &quot;handle_post_meta&quot;), 10, 4);

    add_action(&quot;admin_init&quot;, array(&quot;class_wpp_feps&quot;, &quot;admin_init&quot;));

    add_action( &#x27;post_submitbox_misc_actions&#x27;, array( __CLASS__, &#x27;post_submitbox_misc_actions&#x27; ), 30);
    add_action( &#x27;edit_form_after_title&#x27;, array( __CLASS__, &#x27;post_property_form_information&#x27; ), 0 );

    add_action(&quot;wpp_template_redirect&quot;, array(&quot;class_wpp_feps&quot;, &quot;wpp_template_redirect&quot;));

    //** Upload image */
    add_action( &quot;wp_ajax_wpp_feps_image_upload&quot;, array(&quot;class_wpp_feps&quot;, &quot;ajax_feps_image_upload&quot; ) );
    add_action( &quot;wp_ajax_nopriv_wpp_feps_image_upload&quot;, array(&quot;class_wpp_feps&quot;, &quot;ajax_feps_image_upload&quot; ) );

    //** Delete uploaded image */
    add_action( &quot;wp_ajax_wpp_feps_image_delete&quot;, array(&quot;class_wpp_feps&quot;, &quot;ajax_feps_image_delete&quot; ) );
    add_action( &quot;wp_ajax_nopriv_wpp_feps_image_delete&quot;, array(&quot;class_wpp_feps&quot;, &quot;ajax_feps_image_delete&quot; ) );

    add_action( &quot;wp_ajax_wpp_feps_email_lookup&quot;, create_function(&#x27;&#x27;, &#x27;die(json_encode(class_wpp_feps::email_lookup($_REQUEST[&quot;user_email&quot;],$_REQUEST[&quot;user_password&quot;])));&#x27;));
    add_action( &quot;wp_ajax_nopriv_wpp_feps_email_lookup&quot;, create_function(&#x27;&#x27;, &#x27;die(json_encode(class_wpp_feps::email_lookup($_REQUEST[&quot;user_email&quot;],$_REQUEST[&quot;user_password&quot;])));&#x27;));

    add_action( &quot;wp_ajax_wpp_feps_save_property&quot;, array( __CLASS__, &quot;ajax_feps_save_property&quot; ) );
    add_action( &quot;wp_ajax_nopriv_wpp_feps_save_property&quot;, array( __CLASS__, &quot;ajax_feps_save_property&quot; ) );

    //* On FEPS Form removing */
    add_action( &quot;wp_ajax_wpp_feps_can_remove_form&quot;, array(&quot;class_wpp_feps&quot;, &quot;ajax_can_remove_form&quot;) );

    add_action(&quot;admin_enqueue_scripts&quot;, array(&#x27;class_wpp_feps&#x27;, &quot;admin_enqueue_scripts&quot;));

    add_action(&quot;post_updated&quot;, array(&#x27;class_wpp_feps&#x27;, &quot;post_updated&quot;), 10, 3);

    add_action(&quot;all_admin_notices&quot;, array(&#x27;class_wpp_feps&#x27;, &quot;all_admin_notices&quot;));

    add_action(&#x27;admin_notices&#x27;, array( __CLASS__, &#x27;admin_notices&#x27;));

    add_filter( &#x27;wpp_get_property&#x27;, array( __CLASS__, &#x27;wpp_get_property&#x27;) );

    add_filter( &#x27;wpp_get_search_filters&#x27;, array( __CLASS__, &#x27;wpp_get_search_filters&#x27;) );

    add_filter( &#x27;wpp_attribute_filter&#x27;, array( __CLASS__, &#x27;wpp_attribute_filter&#x27;),10, 2 );

    add_filter(&#x27;wpp_overview_columns&#x27;, array( __CLASS__ , &#x27;wpp_overview_columns&#x27;));

    add_action(&quot;wpp_settings_overview_bottom&quot;, array( __CLASS__, &#x27;wpp_settings_overview_bottom&#x27;) );

    add_filter(&quot;wpp_attribute_data&quot;, array(&#x27;class_wpp_feps&#x27;, &quot;add_attribute_data&quot;));

    add_filter(&quot;wpp_pending_template_query&quot;, array(&#x27;class_wpp_feps&#x27;, &#x27;wpp_query_filter&#x27;), 10, 2);

    add_filter(&quot;authenticate&quot;, array(&#x27;class_wpp_feps&#x27;, &#x27;authenticate&#x27;), 40, 3);

    add_filter(&quot;wpp_feps_property_statuses&quot;, array(&#x27;class_wpp_feps&#x27;, &#x27;property_statuses&#x27;));

    add_filter(&quot;wpp_feps_available_attributes&quot;, array(&#x27;class_wpp_feps&#x27;, &#x27;available_attributes&#x27;) ,10, 3);

    add_filter( &#x27;get_queryable_keys&#x27;, array( __CLASS__, &#x27;queryable_keys&#x27; ) );

    add_action(&quot;wpp_feps_account_created&quot;, array(&#x27;class_wpp_feps&#x27;, &#x27;account_created&#x27;), 10);

    /** Notifications */
    add_action( &quot;wpp_feps_submission_approved&quot;, array( &#x27;WPP_Mail&#x27;, &#x27;feps_post_approved&#x27; ), 10, 1 );
    add_action( &quot;wpp_feps_submitted&quot;, array( &#x27;WPP_Mail&#x27;, &#x27;feps_post_created&#x27; ), 10, 1 );

    add_filter(&quot;parse_query&quot;, array(&#x27;class_wpp_feps&#x27;, &#x27;fix_404&#x27;));

    //* Loads template for My FEPS Page */
    add_action( &#x27;wpp_my_feps_page&#x27;, array( __CLASS__, &#x27;my_feps_page_load&#x27; ) );
    //* Loads template for FEPS Edit Page */
    add_action( &#x27;wpp_feps_edit_page&#x27;, array( __CLASS__, &#x27;feps_edit_page_load&#x27; ) );

    //** Always login user */
    add_action(&#x27;wpp_feps_credentials_verified&#x27;, array(__CLASS__, &#x27;credentials_verified_action&#x27;));

    //** User activator */
    add_action(&quot;template_redirect&quot;,                       array(__CLASS__, &quot;feps_user_activation&quot;), 1);

    //** FEPS+SPC integration */
    if ( class_exists(&#x27;wpi_spc&#x27;) ) {
      add_action(&#x27;wpp_feps_form_settings_after_general&#x27;,  array(__CLASS__, &#x27;spc_options&#x27;));
      add_action(&#x27;wpp_feps_form_settings_general_top&#x27;,    array(__CLASS__, &#x27;spc_options_general&#x27;));
      add_action(&#x27;wpp::feps::save::callback&#x27;,             array(__CLASS__, &#x27;save_property_callback&#x27; ), 10, 3 );
      add_filter(&#x27;wpp_feps_submit_property_form&#x27;,         array(__CLASS__, &#x27;filter_form_data&#x27;));
      add_filter(&#x27;wpp::feps::fix_404&#x27;,                    array(__CLASS__, &#x27;spc_fix_404&#x27;), 10, 2);
      add_filter(&#x27;wpp_feps_form_output&#x27;,                  array(__CLASS__, &#x27;feps_output_filter&#x27;), 10, 2);
      add_action(&#x27;wpp_feps_add_feps_credits&#x27;,             array(__CLASS__, &#x27;after_add_credits&#x27;));
      add_action(&#x27;wp_ajax_wpp_feps_pay_now&#x27;,              array(__CLASS__, &#x27;feps_pay_now&#x27;));
      //** Loads template for FEPS Credits Adding Page */
      add_action( &#x27;wpp_feps_spc_page&#x27;,                    array( __CLASS__, &#x27;spc_page_load&#x27; ) );
      //** Adds ability to manage user&#x27;s credits */
      add_action( &#x27;show_user_profile&#x27;, array( __CLASS__, &#x27;user_profile_fields&#x27; ), 0 );
      add_action( &#x27;edit_user_profile&#x27;, array( __CLASS__, &#x27;user_profile_fields&#x27; ), 0 );
      add_action( &#x27;personal_options_update&#x27;, array( __CLASS__, &#x27;update_user_fields&#x27; ), 0 );
      add_action( &#x27;edit_user_profile_update&#x27;, array( __CLASS__, &#x27;update_user_fields&#x27; ), 0 );
    }else{
      add_action(&#x27;wpp_feps_form_settings_general_top&#x27;,    array(__CLASS__, &#x27;spc_options_general_miss&#x27;));
    }

  }


  /**
   * Handle pre-headers functions.
   *
   * @author potanin@ud
   */
  function admin_init() {
    if( wp_verify_nonce($_REQUEST[&#x27;_wpnonce&#x27;], &#x27;wpp_save_feps_page&#x27; ) ) {
      //** Update settings and commit to DB */
      class_wpp_feps::save_feps_settings($_REQUEST[&#x27;wpp_feps&#x27;]);
      wp_redirect(&#x27;edit.php?post_type=property&amp;page=page_feps&amp;message=updated&#x27;);
    }
  }


  /**
   * Adds &#x27;FEPS Details&#x27; column to &#x27;All Properties&#x27; table
   *
   * @global array $wp_properties
   * @param array $columns
   * @return array
   * @author peshkov@UD
   * @since 2.0
   */
  static function overview_column( $columns ) {
    global $wp_properties;

    if ( isset( $wp_properties[&#x27;configuration&#x27;][&#x27;feps&#x27;][&#x27;enable_column_feps&#x27;] ) &amp;&amp; $wp_properties[&#x27;configuration&#x27;][&#x27;feps&#x27;][&#x27;enable_column_feps&#x27;] == &#x27;true&#x27; ) {
      $columns[ &#x27;feps&#x27; ] = __( &#x27;FEPS Details&#x27;, &#x27;wpp&#x27; );
    }
    return $columns;
  }


  /**
   * Adds data to column &#x27;FEPS Details&#x27; on &#x27;All Properties&#x27; table
   *
   * @param string $value
   * @param object $post
   * @param
   * @author peshkov@UD
   * @since 2.0
   */
  static function render_overview_column( $value, $post ) {

    $form = self::get_form_by_post( $post-&gt;ID );

    if( $form ) {
      $user = get_userdata( $post-&gt;post_author );
      $credits = get_the_author_meta( &#x27;wpp::feps::credits&#x27;, $user-&gt;ID );
      $expired_time = get_post_meta( $post-&gt;ID, FEPS_META_EXPIRED, true );
      $expired_time = !empty( $expired_time ) ? WPP_F::nice_time( $expired_time, array(&#x27;format&#x27;=&gt;&#x27;date&#x27;) ) : __( &#x27;Not set&#x27;, &#x27;wpp&#x27; );
      $sponsored = !empty( $form[ &#x27;feps_credits&#x27; ] ) &amp;&amp; $form[ &#x27;feps_credits&#x27; ] == &#x27;true&#x27; ? true : false;
      $plan = get_post_meta( $post-&gt;ID, FEPS_META_PLAN, true );

      ob_start();

      ?&gt;
      &lt;ul class=&quot;wpp_overview_column_stats wpp_feps_overview_column&quot;&gt;
        &lt;li&gt;
          &lt;span class=&quot;wpp_label&quot;&gt;&lt;?php _e( &#x27;Property Form&#x27;, &#x27;wpp&#x27; ); ?&gt;:&lt;/span&gt;
          &lt;span class=&quot;wpp_value&quot;&gt;&lt;a target=&quot;_blank&quot; href=&quot;&lt;?php echo admin_url( &#x27;edit.php?post_type=property&amp;page=page_feps&#x27; ); ?&gt;&quot;&gt;&lt;?php echo $form[ &#x27;title&#x27; ]; ?&gt;&lt;/a&gt;&lt;/span&gt;
        &lt;/li&gt;
        &lt;li&gt;
          &lt;span class=&quot;wpp_label&quot;&gt;&lt;?php _e( &#x27;Author&#x27;, &#x27;wpp&#x27; ); ?&gt;:&lt;/span&gt;
          &lt;?php if ( current_user_can( &#x27;edit_users&#x27;, $user-&gt;ID ) ) : ?&gt;
          &lt;span class=&quot;wpp_value&quot;&gt;&lt;a target=&quot;_blank&quot; href=&quot;&lt;?php echo get_edit_user_link( $user-&gt;ID ); ?&gt;&quot;&gt;&lt;?php echo $user-&gt;data-&gt;display_name; ?&gt;&lt;/a&gt;&lt;/span&gt;
          &lt;?php else : ?&gt;
          &lt;span class=&quot;wpp_value&quot;&gt;&lt;?php echo $user-&gt;data-&gt;display_name; ?&gt;&lt;/span&gt;
          &lt;?php endif; ?&gt;
        &lt;/li&gt;
        &lt;li&gt;
          &lt;span class=&quot;wpp_label&quot;&gt;&lt;?php _e( &#x27;Sponsored&#x27;, &#x27;wpp&#x27; ); ?&gt;:&lt;/span&gt;
          &lt;span class=&quot;wpp_value&quot;&gt;&lt;?php $sponsored ? _e( &#x27;Yes&#x27;, &#x27;wpp&#x27; ) : _e( &#x27;No&#x27;, &#x27;wpp&#x27; ) ; ?&gt;&lt;/span&gt;
        &lt;/li&gt;
        &lt;?php if( $sponsored ) : ?&gt;
          &lt;li&gt;
            &lt;span class=&quot;wpp_label&quot;&gt;&lt;?php _e( &#x27;Subscription Plan&#x27;, &#x27;wpp&#x27; ); ?&gt;:&lt;/span&gt;
            &lt;span class=&quot;wpp_value&quot;&gt;&lt;?php echo !empty( $plan ) &amp;&amp; is_array( $plan ) ? $plan[ &#x27;name&#x27; ] : __( &#x27;Not set&#x27;, &#x27;wpp&#x27; ); ?&gt;&lt;/span&gt;
          &lt;/li&gt;
        &lt;?php endif; ?&gt;
        &lt;li&gt;
          &lt;span class=&quot;wpp_label&quot;&gt;&lt;?php _e( &#x27;Expired date&#x27;, &#x27;wpp&#x27; ); ?&gt;:&lt;/span&gt;
          &lt;span class=&quot;wpp_value&quot;&gt;&lt;?php echo $expired_time; ?&gt;&lt;/span&gt;
        &lt;/li&gt;
      &lt;/ul&gt;
      &lt;?php

      $content = ob_get_clean();
      $value = apply_filters( &#x27;wpp::feps::render_overview_column&#x27;, $content, $post );
    }

    return $value;
  }


  /**
   * Adds admin tools manu to settings page navigation
   *
   * @author peshkov@UD
   * @since 2.0
   */
  static function settings_nav( $tabs ) {

     $tabs[&#x27;feps&#x27;] = array(
      &#x27;slug&#x27; =&gt; &#x27;feps&#x27;,
      &#x27;title&#x27; =&gt; __(&#x27;FEPS&#x27;,&#x27;wpp&#x27;),
    );

    return $tabs;
  }


  /**
   * Displays FEPS management page
   *
   *
   * @author peshkov@UD
   * @since 2.0
   */
  static function settings_page() {
    global $wp_properties;

    $templates = get_page_templates();

    ?&gt;
    &lt;table class=&quot;form-table&quot;&gt;
      &lt;tbody&gt;
        &lt;tr&gt;
          &lt;th&gt;&lt;?php _e(&#x27;Property Forms&#x27;,&#x27;wpp&#x27;); ?&gt;&lt;/th&gt;
          &lt;td&gt;
            &lt;?php printf( __( &#x27;&lt;a href=&quot;%s&quot;&gt;Manage %s Forms&#x27; ), admin_url( &#x27;edit.php?post_type=property&amp;page=page_feps&#x27; ), WPP_F::property_label() ); ?&gt;
          &lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
          &lt;th&gt;&lt;?php _e(&#x27;FEPS Menu&#x27;,&#x27;wpp&#x27;); ?&gt;&lt;/th&gt;
          &lt;td&gt;
            &lt;p&gt;
              &lt;?php printf( __( &#x27;It is neccessary block menu which contains user\&#x27;s specific data and links to submitted %s via FEPS frontend forms.&#x27;, &#x27;wpp&#x27; ), WPP_F::property_label( &#x27;plural&#x27; ) ); ?&gt;&lt;br/&gt;
              &lt;?php printf( __( &#x27;Menu can be added to your site via &lt;b&gt;FEPS Menu&lt;/b&gt; &lt;a href=&quot;%s&quot;&gt;widget&lt;/a&gt; or &lt;b&gt;%s&lt;/b&gt; shortcode.&#x27;, &#x27;wpp&#x27; ), admin_url( &#x27;widgets.php&#x27; ), &#x27;[wpp_feps_menu]&#x27; ); ?&gt;&lt;br/&gt;
              &lt;?php _e( &#x27;Note, menu is shown only for logged in users.&#x27;, &#x27;wpp&#x27; ); ?&gt;
            &lt;/p&gt;
            &lt;ul&gt;
              &lt;?php if ( class_exists( &#x27;wpi_spc&#x27; ) ) : ?&gt;
              &lt;li&gt;&lt;?php echo WPP_F::input(&quot;name=wpp_settings[configuration][feps][menu][add_credits_label]&amp;style=width:250px;&quot;, $wp_properties[&#x27;configuration&#x27;][&#x27;feps&#x27;][&#x27;menu&#x27;][&#x27;add_credits_label&#x27;] ); ?&gt; &lt;?php _e( &#x27;&quot;Add Credits to Balance&quot; custom label&#x27;, &#x27;wpp&#x27; ); ?&gt;&lt;/li&gt;
              &lt;?php endif; ?&gt;
              &lt;li&gt;&lt;?php echo WPP_F::input(&quot;name=wpp_settings[configuration][feps][menu][add_property_label]&amp;style=width:250px;&quot;, $wp_properties[&#x27;configuration&#x27;][&#x27;feps&#x27;][&#x27;menu&#x27;][&#x27;add_property_label&#x27;]); ?&gt; &lt;?php printf ( __(&#x27;&quot;Add New %s&quot; custom label&#x27;,&#x27;wpp&#x27;), WPP_F::property_label() ); ?&gt;&lt;/li&gt;
              &lt;li&gt;&lt;?php echo WPP_F::checkbox(&quot;name=wpp_settings[configuration][feps][menu][disable_if_no_properties]&amp;label=&quot; . sprintf( __(&#x27;Disable Menu if there are no %s and no credits on Balance&#x27;, &#x27;wpp&#x27;), WPP_F::property_label( &#x27;plural&#x27; ) ), $wp_properties[&#x27;configuration&#x27;][&#x27;feps&#x27;][&#x27;menu&#x27;][&#x27;disable_if_no_properties&#x27;]); ?&gt;&lt;/li&gt;
            &lt;/ul&gt;
          &lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
          &lt;th&gt;&lt;?php _e(&#x27;Specific Pages&#x27;,&#x27;wpp&#x27;); ?&gt;&lt;/th&gt;
          &lt;td&gt;
            &lt;p&gt;
              &lt;?php printf( __( &#x27;The feature has specific pages. The links below can be added directly to your &lt;a href=&quot;%s&quot;&gt;Menus&lt;/a&gt; or wherever else, i.e. if you don\&#x27;t want to use FEPS menu.&#x27;, &#x27;wpp&#x27; ), admin_url( &#x27;nav-menus.php&#x27; ), WPP_F::property_label( &#x27;plural&#x27; ) ); ?&gt;&lt;br/&gt;
              &lt;?php _e( &#x27;But note, that the current pages are available only for logged in users.&#x27;, &#x27;wpp&#x27; ); ?&gt;
            &lt;/p&gt;
            &lt;ul class=&quot;feps_specific_pages_links&quot;&gt;
              &lt;li class=&quot;feps_title&quot;&gt;&lt;?php _e( &#x27;Templates&#x27;, &#x27;wpp&#x27; ); ?&gt;&lt;/li&gt;
              &lt;li class=&quot;feps_templates&quot;&gt;
                &lt;label&gt;&lt;?php _e( &#x27;Overview Page&#x27;, &#x27;wpp&#x27; ); ?&gt;:&lt;/label&gt;
                &lt;select name=&quot;wpp_settings[configuration][feps][templates][overview_page]&quot;&gt;
                  &lt;option value=&quot;&quot; &gt;-&lt;/option&gt;
                  &lt;?php if( !empty( $templates ) ) : ?&gt;
                    &lt;?php foreach ( $templates as $title =&gt; $slug ) : ?&gt;
                      &lt;option value=&quot;&lt;?php echo $slug ?&gt;&quot; &lt;?php echo $wp_properties[&#x27;configuration&#x27;][&#x27;feps&#x27;][&#x27;templates&#x27;][&#x27;overview_page&#x27;] == $slug ? &#x27;selected=&quot;selected&quot;&#x27; : &#x27;&#x27;; ?&gt; &gt;&lt;?php echo $title; ?&gt;&lt;/option&gt;
                    &lt;?php endforeach; ?&gt;
                  &lt;?php endif; ?&gt;
                &lt;/select&gt;
              &lt;/li&gt;
              &lt;li class=&quot;feps_templates&quot;&gt;
                &lt;label&gt;&lt;?php _e( &#x27;Add Credits Page&#x27;, &#x27;wpp&#x27; ); ?&gt;:&lt;/label&gt;
                &lt;select name=&quot;wpp_settings[configuration][feps][templates][add_credits_page]&quot;&gt;
                  &lt;option value=&quot;&quot; &gt;-&lt;/option&gt;
                  &lt;?php if( !empty( $templates ) ) : ?&gt;
                    &lt;?php foreach ( $templates as $title =&gt; $slug ) : ?&gt;
                      &lt;option value=&quot;&lt;?php echo $slug ?&gt;&quot; &lt;?php echo $wp_properties[&#x27;configuration&#x27;][&#x27;feps&#x27;][&#x27;templates&#x27;][&#x27;add_credits_page&#x27;] == $slug ? &#x27;selected=&quot;selected&quot;&#x27; : &#x27;&#x27;; ?&gt; &gt;&lt;?php echo $title; ?&gt;&lt;/option&gt;
                    &lt;?php endforeach; ?&gt;
                  &lt;?php endif; ?&gt;
                &lt;/select&gt;
              &lt;/li&gt;
              &lt;li class=&quot;feps_title&quot;&gt;&lt;?php _e( &#x27;Links&#x27;, &#x27;wpp&#x27; ); ?&gt;&lt;/li&gt;
              &lt;li&gt;&lt;label&gt;&lt;?php printf( __( &#x27;Overview Page ( All %s )&#x27;, &#x27;wpp&#x27; ), WPP_F::property_label( &#x27;plural&#x27; ) ); ?&gt;:&lt;/label&gt;&lt;input type=&quot;text&quot; class=&quot;readonly&quot; readonly=&quot;readonly&quot; value=&quot;&lt;?php echo WPP_F::base_url( FEPS_VIEW_PAGE, &quot;status=all&quot; ); ?&gt;&quot; /&gt;&lt;/li&gt;
              &lt;li&gt;&lt;label&gt;&lt;?php printf( __( &#x27;Overview Page ( Published %s )&#x27;, &#x27;wpp&#x27; ), WPP_F::property_label( &#x27;plural&#x27; ) ); ?&gt;:&lt;/label&gt;&lt;input type=&quot;text&quot; class=&quot;readonly&quot; readonly=&quot;readonly&quot; value=&quot;&lt;?php echo WPP_F::base_url( FEPS_VIEW_PAGE, &quot;status=publish&quot; ); ?&gt;&quot; /&gt;&lt;/li&gt;
              &lt;li&gt;&lt;label&gt;&lt;?php printf( __( &#x27;Overview Page ( Pending %s )&#x27;, &#x27;wpp&#x27; ), WPP_F::property_label( &#x27;plural&#x27; ) ); ?&gt;:&lt;/label&gt;&lt;input type=&quot;text&quot; class=&quot;readonly&quot; readonly=&quot;readonly&quot; value=&quot;&lt;?php echo WPP_F::base_url( FEPS_VIEW_PAGE, &quot;status=pending&quot; ); ?&gt;&quot; /&gt;&lt;/li&gt;
              &lt;?php if ( class_exists( &#x27;wpi_spc&#x27; ) ) : ?&gt;
              &lt;li&gt;&lt;label&gt;&lt;?php _e( &#x27;Add Credits Page&#x27;, &#x27;wpp&#x27; ); ?&gt;:&lt;/label&gt;&lt;input type=&quot;text&quot; class=&quot;readonly&quot; readonly=&quot;readonly&quot; value=&quot;&lt;?php echo WPP_F::base_url( FEPS_SPC_PAGE ); ?&gt;&quot; /&gt;&lt;/li&gt;
              &lt;?php endif; ?&gt;
            &lt;/ul&gt;
          &lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
          &lt;th&gt;&lt;?php _e(&#x27;Administration&#x27;,&#x27;wpp&#x27;); ?&gt;&lt;/th&gt;
          &lt;td&gt;
            &lt;ul&gt;
              &lt;li&gt;&lt;?php
              echo WPP_F::checkbox( array(
                &#x27;name&#x27; =&gt; &#x27;wpp_settings[configuration][feps][enable_column_feps]&#x27;,
                &#x27;label&#x27; =&gt; sprintf( __(&quot;Enable Column &lt;b&gt;FEPS Details&lt;/b&gt; on &lt;a href=&#x27;%s&#x27;&gt;All %s&lt;/a&gt; page.&quot;, &#x27;wpp&#x27;), admin_url( &#x27;edit.php?post_type=property&amp;page=all_properties&#x27; ), WPP_F::property_label( &#x27;plural&#x27; ) ),
              ), $wp_properties[&#x27;configuration&#x27;][&#x27;feps&#x27;][&#x27;enable_column_feps&#x27;]);
              ?&gt;&lt;/li&gt;
            &lt;/ul&gt;
          &lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
          &lt;th&gt;&lt;?php _e(&#x27;Notifications&#x27;,&#x27;wpp&#x27;); ?&gt;&lt;/th&gt;
          &lt;td&gt;
            &lt;?php printf( __( &#x27;All FEPS notifications can be customized via &lt;a href=&quot;%s&quot;&gt;WP-CRM&lt;/a&gt; plugin. For more details, look through &lt;b&gt;FEPS -&gt; Integration with other UsabilityDynamics plugins&lt;/b&gt; section in Help tab above.&#x27;, &#x27;wpp&#x27; ), &#x27;https://usabilitydynamics.com/products/wp-invoice/&#x27; ); ?&gt;
          &lt;/td&gt;
        &lt;/tr&gt;
      &lt;/tbody&gt;
    &lt;/table&gt;
    &lt;?php
  }


  /**
   * Adds contextual help to Property Forms page
   *
   * @author korotkov@ud
   * @author peshkov@UD
   */
  function contextual_help_property_forms() {

    $contextual_help = array();

    $tabs = array(
      &#x27;general&#x27; =&gt; __( &#x27;General Information&#x27;, &#x27;wpp&#x27; ),
      &#x27;name&#x27; =&gt; __( &#x27;Form Name&#x27;, &#x27;wpp&#x27; ),
      &#x27;shortcode&#x27; =&gt; __( &#x27;Shortcode&#x27;, &#x27;wpp&#x27; ),
      &#x27;options&#x27; =&gt; __( &#x27;General Options&#x27;, &#x27;wpp&#x27; ),
      &#x27;plans&#x27; =&gt; __( &#x27;Subscriptions Plans&#x27;, &#x27;wpp&#x27; ),
      &#x27;attributes&#x27; =&gt; __( &#x27;Propery Attributes&#x27; ),
    );

    foreach( $tabs as $tab ) {
      $contextual_help[ $tab ] = array();
    }

    $contextual_help[ $tabs[&#x27;general&#x27;] ][] = &#x27;&lt;h3&gt;&#x27; . __( &#x27;Front End Property Submissions (FEPS)&#x27;, &#x27;wpp&#x27; ) .&#x27;&lt;/h3&gt;&#x27;;
    $contextual_help[ $tabs[&#x27;general&#x27;] ][] = &#x27;&lt;p&gt;&lt;i&gt;&#x27; . sprintf( __( &#x27;Note, that &lt;a href=&quot;%s&quot;&gt;Settings page&lt;/a&gt; also contains helpfull information about FEPS premium feature functionality. So if the current \&#x27;Help\&#x27; does not contain enough information to help you, we suggest to proceed there for looking through FEPS tab and \&#x27;Help\&#x27; information.&#x27;, &#x27;wpp&#x27; ), admin_url( &#x27;edit.php?post_type=property&amp;page=property_settings&#x27; ) ) . &#x27;&lt;/i&gt;&lt;/p&gt;&#x27;;
    $contextual_help[ $tabs[&#x27;general&#x27;] ][] = &#x27;&lt;p&gt;&#x27; . __( &#x27;Front End Property Submission (FEPS) lets you create forms and display them on the front-end of the website. The forms may be used by visitors to submit properties for free or for credits.&#x27;, &#x27;wpp&#x27; ) .&#x27;&lt;/p&gt;&#x27;;
    $contextual_help[ $tabs[&#x27;general&#x27;] ][] = &#x27;&lt;p&gt;&#x27; . sprintf( __( &#x27;If you want to display a %1$s submission form for homes in a certain neighborhood, you can place the FEPS form into the content of the parent (neighborhood) %1$s like so&#x27;, &#x27;wpp&#x27; ), WPP_F::property_label() ) .&#x27;:&lt;/p&gt;&#x27;;
    $contextual_help[ $tabs[&#x27;general&#x27;] ][] = &#x27;&lt;p&gt;&lt;b&gt;[wpp_feps_form form=name_of_form detect_parent=true map_height=300]&lt;/b&gt;&lt;/p&gt;&#x27;;
    $contextual_help[ $tabs[&#x27;general&#x27;] ][] = &#x27;&lt;p&gt;&#x27; . sprintf( __( &#x27;On a pending %s a body class is added for styling, which is: &lt;b&gt;%s&lt;/b&gt;&#x27;, &#x27;wpp&#x27; ), WPP_F::property_label(), &#x27;feps-pending  wpp_[post_status]&#x27; ) . &#x27;&lt;br/&gt;&#x27;;
    $contextual_help[ $tabs[&#x27;general&#x27;] ][] = sprintf( __( &#x27;Pending pages use the same front-end templates as regular %s, and will load conditional %s-type templates if they exist.  Below is the the load order of templates based on specificity:&#x27;, &#x27;wpp&#x27; ), WPP_F::property_label( &#x27;plural&#x27; ), WPP_F::property_label() ) .&#x27;&lt;/p&gt;&#x27;;
    $contextual_help[ $tabs[&#x27;general&#x27;] ][] = &#x27;&lt;ul&gt;&#x27;;
    $contextual_help[ $tabs[&#x27;general&#x27;] ][] = &#x27;&lt;li&gt;your_theme/property-pending.php&lt;/li&gt;&#x27;;
    $contextual_help[ $tabs[&#x27;general&#x27;] ][] = &#x27;&lt;li&gt;your_theme/property-pending-[property-type].php&lt;/li&gt;&#x27;;
    $contextual_help[ $tabs[&#x27;general&#x27;] ][] = &#x27;&lt;li&gt;your_theme/property-[property-type].php&lt;/li&gt;&#x27;;
    $contextual_help[ $tabs[&#x27;general&#x27;] ][] = &#x27;&lt;li&gt;your_theme/property.php&lt;/li&gt;&#x27;;
    $contextual_help[ $tabs[&#x27;general&#x27;] ][] = &#x27;&lt;/ul&gt;&#x27;;
    $contextual_help[ $tabs[&#x27;general&#x27;] ][] = &#x27;&lt;p&gt;&#x27; . sprintf( __( &#x27;So if your %1$s type is called &quot;&lt;b&gt;%2$s&lt;/b&gt;&quot;, then the %1$s type slug is &lt;b&gt;%3$s&lt;/b&gt;, and the template would be: &lt;b&gt;%4$s&lt;/b&gt;&#x27;, &#x27;wpp&#x27; ), WPP_F::property_label(), &#x27;Single Family Home&#x27;, &#x27;single_familly_home&#x27;, &#x27;property-single-family-home.php&#x27; ) . &#x27;&lt;br/&gt;&#x27;;

    $contextual_help[ $tabs[&#x27;name&#x27;] ][] = &#x27;&lt;h3&gt;&#x27; . $tabs[&#x27;name&#x27;] .&#x27;&lt;/h3&gt;&#x27;;
    $contextual_help[ $tabs[&#x27;name&#x27;] ][] = &#x27;&lt;p&gt;&#x27; . __( &#x27;Form\&#x27;s name must be unique. Form slug, which is used for setting shortcode ( attribute &quot;form&quot; ) is generated using form name. So, be carefull with changing name of already existing form!&#x27;, &#x27;wpp&#x27; ) . &#x27;&lt;/p&gt;&#x27;;

    $contextual_help[ $tabs[&#x27;shortcode&#x27;] ][] = &#x27;&lt;h3&gt;&#x27; . $tabs[&#x27;shortcode&#x27;] .&#x27;&lt;/h3&gt;&#x27;;
    $contextual_help[ $tabs[&#x27;shortcode&#x27;] ][] = &#x27;&lt;p&gt;&#x27; . sprintf( __( &#x27;Shortcode [wpp_feps_form form=&quot;{form_slug}&quot;] renders passed form on page. You can add it to any content including widget areas on your site. But we strongly recommend to add the current shortcode only to page\&#x27;s ( pages, posts, %s ) content to prevent different issues.&#x27;, &#x27;wpp&#x27; ), WPP_F::property_label( &#x27;plural&#x27; ) ) . &#x27;&lt;/p&gt;&#x27;;
    $contextual_help[ $tabs[&#x27;shortcode&#x27;] ][] = &#x27;&lt;h4&gt;&#x27; . __( &#x27;Available shortcode attributes&#x27;, &#x27;wpp&#x27; ) .&#x27;&lt;/h4&gt;&#x27;;
    $contextual_help[ $tabs[&#x27;shortcode&#x27;] ][] = &#x27;&lt;ul&gt;&#x27;;
    $contextual_help[ $tabs[&#x27;shortcode&#x27;] ][] = &#x27;&lt;li&gt;&lt;b&gt;form&lt;/b&gt;: &#x27; . __( &#x27;Required attribute. The slug of the FEPS form, this is required to identify which form must be displayed.&#x27;, &#x27;wpp&#x27; ) . &#x27;&lt;/li&gt;&#x27;;
    $contextual_help[ $tabs[&#x27;shortcode&#x27;] ][] = &#x27;&lt;li&gt;&lt;b&gt;property_id&lt;/b&gt;: &#x27; . sprintf( __( &#x27;Default value is not set. Use to set the parent ID of all the submitted %1$s. This works well if you want to group all the submitted %1$s under a parent. For example, if you want to allow visitors to submit condos that below to a certain neighborhood, you would create the neighborhood %1$s, then place FEPS forms into their content.&#x27;, &#x27;wpp&#x27; ), WPP_F::property_label( &#x27;plural&#x27; )) . &#x27;&lt;/li&gt;&#x27;;
    $contextual_help[ $tabs[&#x27;shortcode&#x27;] ][] = &#x27;&lt;li&gt;&lt;b&gt;detect_parent&lt;/b&gt;: &#x27; . sprintf( __( &#x27;Available values &quot;true&quot; and &quot;false&quot;. Default value is &quot;false&quot;. If set to “true”, the form will automatically detect if it is displayed on a %1$s page, and use the current %1$s as parent for newly added %2$s. If parent_id is set, detect parent does not do anything.&#x27;, &#x27;wpp&#x27; ), WPP_F::property_label(), WPP_F::property_label( &#x27;plural&#x27; ) ) . &#x27;&lt;/li&gt;&#x27;;
    $contextual_help[ $tabs[&#x27;shortcode&#x27;] ][] = &#x27;&lt;li&gt;&lt;b&gt;map_height&lt;/b&gt;: &#x27; . __( &#x27;Default value is &quot;450px&quot;. Sets the height of the address map, in pixels.&#x27;, &#x27;wpp&#x27; ) . &#x27;&lt;/li&gt;&#x27;;
    $contextual_help[ $tabs[&#x27;shortcode&#x27;] ][] = &#x27;&lt;li&gt;&lt;b&gt;not_found_text&lt;/b&gt;: &#x27; . __( &#x27;Default value is &quot;Requested FEPS form not found&quot;. This is the text to display when the form is not found, this is only needed if a form has been deleted, but shortcodes still reference it throughout your site.&#x27;, &#x27;wpp&#x27; ) . &#x27;&lt;/li&gt;&#x27;;
    $contextual_help[ $tabs[&#x27;shortcode&#x27;] ][] = &#x27;&lt;/ul&gt;&#x27;;

    $contextual_help[ $tabs[&#x27;options&#x27;] ][] = &#x27;&lt;h3&gt;&#x27; . $tabs[&#x27;options&#x27;] .&#x27;&lt;/h3&gt;&#x27;;
    $contextual_help[ $tabs[&#x27;options&#x27;] ][] = &#x27;&lt;p&gt;&#x27;.sprintf(__(&#x27;&lt;h4&gt;Sponsored Listing:&lt;/h4&gt;It enables billable %s submissions.&lt;br/&gt;&lt;a href=&quot;%s&quot;&gt;WP-Invoice&lt;/a&gt; plugin and &lt;a href=&quot;%s&quot;&gt;Single Page Checkout&lt;/a&gt; premium feature must be installed to enable this option.&#x27;, &#x27;wpp&#x27;), WPP_F::property_label(), &#x27;https://usabilitydynamics.com/products/wp-invoice/&#x27;, &#x27;https://usabilitydynamics.com/products/wp-invoice/premium-features/&#x27; ).&#x27;&lt;/p&gt;&#x27;;
    $contextual_help[ $tabs[&#x27;options&#x27;] ][] = &#x27;&lt;p&gt;&#x27;.sprintf(__(&#x27;&lt;h4&gt;%1$s Status:&lt;/h4&gt;Status to assign to new %2$s after they are submitted.&lt;br /&gt;&lt;i&gt;Note, the current option is disabled for sponsored listings. Sponsored Submission will be automatically published after successfull payment. In other case, it has pending status.&lt;/i&gt;&#x27;, &#x27;wpp&#x27;), WPP_F::property_label(), WPP_F::property_label( &#x27;plural&#x27; ) ).&#x27;&lt;/p&gt;&#x27;;
    $contextual_help[ $tabs[&#x27;options&#x27;] ][] = &#x27;&lt;p&gt;&#x27;.sprintf(__(&#x27;&lt;h4&gt;%1$s Type:&lt;/h4&gt;Default %1$s type of submitted %2$s.&#x27;, &#x27;wpp&#x27;), WPP_F::property_label(), WPP_F::property_label( &#x27;plural&#x27; ) ).&#x27;&lt;/p&gt;&#x27;;
    $contextual_help[ $tabs[&#x27;options&#x27;] ][] = &#x27;&lt;p&gt;&#x27;.sprintf(__(&#x27;&lt;h4&gt;Automatically remove FEPS of the current Form with \&#x27;Pending\&#x27; status:&lt;/h4&gt;Set a period of time in which Pending %1$s will be removed. Set 0 if you don\&#x27;t want Pending %1$s to be removed.&#x27;, &#x27;wpp&#x27;), WPP_F::property_label() ).&#x27;&lt;/p&gt;&#x27;;
    $contextual_help[ $tabs[&#x27;options&#x27;] ][] = &#x27;&lt;p&gt;&#x27;.__( &#x27;&lt;h4&gt;Preview Thumbnail Size:&lt;/h4&gt;The size of the image to be used to display the thumbnail of an uploaded image.&#x27;, &#x27;wpp&#x27;).&#x27;&lt;/p&gt;&#x27;;
    $contextual_help[ $tabs[&#x27;options&#x27;] ][] = &#x27;&lt;p&gt;&#x27;.__( &#x27;&lt;h4&gt;Image Upload Limit:&lt;/h4&gt;The maximum number of images that can be uploaded per submission.&lt;br /&gt;&lt;i&gt;Note, the current option is disabled for sponsored listings. Images limit for sponsored listings must be set for every Subscription plan separately.&lt;/i&gt;&#x27;, &#x27;wpp&#x27;).&#x27;&lt;/p&gt;&#x27;;
    $contextual_help[ $tabs[&#x27;options&#x27;] ][] = &#x27;&lt;p&gt;&#x27;.sprintf( __( &#x27;&lt;h4&gt;New User Role:&lt;/h4&gt;Role to assign to users submitting %1$s if they do not already have an account.&#x27;, &#x27;wpp&#x27;), WPP_F::property_label() ).&#x27;&lt;/p&gt;&#x27;;
    $contextual_help[ $tabs[&#x27;options&#x27;] ][] = &#x27;&lt;p&gt;&#x27;.sprintf( __( &#x27;&lt;h4&gt;Allow user to edit and remove his FEPS:&lt;/h4&gt;Whether or not to allow user to edit and delete their %1$s submitted by FEPS.&#x27;, &#x27;wpp&#x27;), WPP_F::property_label() ).&#x27;&lt;/p&gt;&#x27;;
    $contextual_help[ $tabs[&#x27;options&#x27;] ][] = &#x27;&lt;p&gt;&#x27;.__( &#x27;&lt;h4&gt;Disable new user account creation notification:&lt;/h4&gt;Whether or not to send new user notifications.&lt;br /&gt;&lt;i&gt;Note, the current option is disabled for sponsored listings.&lt;/i&gt;&#x27;, &#x27;wpp&#x27;).&#x27;&lt;/p&gt;&#x27;;

    $contextual_help[ $tabs[&#x27;plans&#x27;] ][] = &#x27;&lt;h3&gt;&#x27; . $tabs[&#x27;plans&#x27;] .&#x27;&lt;/h3&gt;&#x27;;
    $contextual_help[ $tabs[&#x27;plans&#x27;] ][] = &#x27;&lt;p&gt;&#x27; . sprintf( __( &#x27;The current functionality is available only for &lt;b&gt;sponsored listings&lt;/b&gt; ( see &quot;%s&quot; tab ) when &lt;a href=&quot;%s&quot;&gt;WP-Invoice&lt;/a&gt; plugin and &lt;a href=&quot;%s&quot;&gt;Single Page Checkout&lt;/a&gt; premium feature are installed and activated.&#x27;, &#x27;wpp&#x27; ), $tabs[&#x27;options&#x27;], &#x27;https://usabilitydynamics.com/products/wp-invoice/&#x27;, &#x27;https://usabilitydynamics.com/products/wp-invoice/premium-features/&#x27; ) . &#x27;&lt;/p&gt;&#x27;;
    $contextual_help[ $tabs[&#x27;plans&#x27;] ][] = &#x27;&lt;h4&gt;&#x27; . __( &#x27;Name&#x27;, &#x27;wpp&#x27; ) .&#x27;&lt;/h4&gt;&#x27;;
    $contextual_help[ $tabs[&#x27;plans&#x27;] ][] = &#x27;&lt;p&gt;&#x27; . __( &#x27;Just a name of Subscription plan.&#x27;, &#x27;wpp&#x27; ) .&#x27;&lt;/p&gt;&#x27;;
    $contextual_help[ $tabs[&#x27;plans&#x27;] ][] = &#x27;&lt;h4&gt;&#x27; . __( &#x27;Price&#x27;, &#x27;wpp&#x27; ) .&#x27;&lt;/h4&gt;&#x27;;
    $contextual_help[ $tabs[&#x27;plans&#x27;] ][] = &#x27;&lt;p&gt;&#x27; . __( &#x27;Currency is set via WP-Invoice settings. The exchange rate is 1 chosen currency = 1 credit.&#x27;, &#x27;wpp&#x27; ) .&#x27;&lt;/p&gt;&#x27;;
    $contextual_help[ $tabs[&#x27;plans&#x27;] ][] = &#x27;&lt;h4&gt;&#x27; . __( &#x27;Duration&#x27;, &#x27;wpp&#x27; ) .&#x27;&lt;/h4&gt;&#x27;;
    $contextual_help[ $tabs[&#x27;plans&#x27;] ][] = &#x27;&lt;p&gt;&#x27; . sprintf( __( &#x27;The published period. The expired date is based on this option and will be set after successfully payment. When expiry date is over, status of %s will be automatically set as &quot;%s&quot;.&#x27;, &#x27;wpp&#x27; ), WPP_F::property_label(), &#x27;Pending&#x27; ) .&#x27;&lt;/p&gt;&#x27;;
    $contextual_help[ $tabs[&#x27;plans&#x27;] ][] = &#x27;&lt;h4&gt;&#x27; . __( &#x27;Images Limit&#x27;, &#x27;wpp&#x27; ) .&#x27;&lt;/h4&gt;&#x27;;
    $contextual_help[ $tabs[&#x27;plans&#x27;] ][] = &#x27;&lt;p&gt;&#x27; . sprintf( __( &#x27;To enable this option, Image Upload must be set in &lt;b&gt;%s&lt;/b&gt;. The amount of images which can be uploaded to the %s with the current subscription plan. Note: limit must not be less than 1 or empty.&#x27;, &#x27;wpp&#x27; ), $tabs[&#x27;attributes&#x27;], WPP_F::property_label() ) .&#x27;&lt;/p&gt;&#x27;;
    $contextual_help[ $tabs[&#x27;plans&#x27;] ][] = &#x27;&lt;h4&gt;&#x27; . __( &#x27;Description&#x27;, &#x27;wpp&#x27; ) .&#x27;&lt;/h4&gt;&#x27;;
    $contextual_help[ $tabs[&#x27;plans&#x27;] ][] = &#x27;&lt;p&gt;&#x27; . __( &#x27;Optional. Some helpfull information about subscription plan, advertisement, offer or whatever else can be added here.&#x27;, &#x27;wpp&#x27; ) .&#x27;&lt;/p&gt;&#x27;;

    $contextual_help[ $tabs[&#x27;attributes&#x27;] ][] = &#x27;&lt;h3&gt;&#x27; . $tabs[&#x27;attributes&#x27;] .&#x27;&lt;/h3&gt;&#x27;;
    $contextual_help[ $tabs[&#x27;attributes&#x27;] ][] = &#x27;&lt;p&gt;&#x27; . sprintf( __( &#x27;The list of %s attributes fields which will be shown in FEPS form. User will be able to add/edit only the chosen attributes.&#x27;, &#x27;wpp&#x27; ), WPP_F::property_label() ) . &#x27;&lt;/p&gt;&#x27;;
    $contextual_help[ $tabs[&#x27;attributes&#x27;] ][] = &#x27;&lt;p&gt;&#x27; . sprintf( __(&#x27;Note, &lt;b&gt;%1$s type&lt;/b&gt; can be set only in %3$s. So all %2$s added via the same form will have the same %1$s type. &#x27;, &#x27;wpp&#x27; ), WPP_F::property_label(), WPP_F::property_label( &#x27;plural&#x27; ), $tabs[&#x27;options&#x27;] ) . &#x27;&lt;/p&gt;&#x27;;

    do_action(&#x27;wpp_contextual_help&#x27;, array( &#x27;contextual_help&#x27; =&gt; $contextual_help ) );

  }


  /**
   * Adds contextual help to WP-Property Settings page
   *
   * @author peshkov@UD
   */
  function contextual_help_settings( $contextual_help ) {

    $tab = __( &#x27;FEPS&#x27;, &#x27;wpp&#x27; );
    if( !isset( $contextual_help[ $tab ] ) ) {
      $contextual_help[ $tab ] = array();
    }

    $contextual_help[ $tab ][] = &#x27;&lt;h3&gt;&#x27; . sprintf( __( &#x27;Front End %s Submissions (FEPS)&#x27;, &#x27;wpp&#x27; ), WPP_F::property_label() ) .&#x27;&lt;/h3&gt;&#x27;;
    $contextual_help[ $tab ][] = &#x27;&lt;p&gt;&#x27; . sprintf( __( &#x27;Front End %1$s Submission (FEPS) allows you to create multiple forms using the interface found under %2$s -&gt; %1$s Forms. Multiple forms can be used to setup targeted pages that limit the number of images for the form, direct all submissions into a certain %1$s type, or %1$s status.&#x27;, &#x27;wpp&#x27; ), WPP_F::property_label(), WPP_F::property_label( &#x27;plural&#x27; ) );
    $contextual_help[ $tab ][] = sprintf( __( &#x27;It also allows to create forms for sponsored listings if you have installed &lt;a href=&quot;%s&quot;&gt;WP-Invoice&lt;/a&gt; plugin and &lt;a href=&quot;%s&quot;&gt;Single Page Checkout&lt;/a&gt; premium feature.&#x27;, &#x27;wpp&#x27; ), &#x27;https://usabilitydynamics.com/products/wp-invoice/&#x27;, &#x27;https://usabilitydynamics.com/products/wp-invoice/premium-features/&#x27; ) . &#x27;&lt;/p&gt;&#x27;;
    $contextual_help[ $tab ][] = &#x27;&lt;br/&gt;&#x27;;
    $contextual_help[ $tab ][] = &#x27;&lt;h4&gt;&#x27; . __( &#x27;Property Forms&#x27;, &#x27;wpp&#x27; ) .&#x27;&lt;/h4&gt;&#x27;;
    $contextual_help[ $tab ][] = &#x27;&lt;p&gt;&#x27; . sprintf( __( &#x27;Detailed information can be found on &lt;a href=&quot;%s&quot;&gt;%s Forms&lt;/a&gt; page in Help tab.&#x27;, &#x27;wpp&#x27; ), admin_url( &#x27;edit.php?post_type=property&amp;page=page_feps&#x27; ), WPP_F::property_label() ) .&#x27;&lt;/p&gt;&#x27;;
    $contextual_help[ $tab ][] = &#x27;&lt;br/&gt;&#x27;;
    $contextual_help[ $tab ][] = &#x27;&lt;h4&gt;&#x27; . __( &#x27;FEPS Menu&#x27;, &#x27;wpp&#x27; ) .&#x27;&lt;/h4&gt;&#x27;;
    $contextual_help[ $tab ][] = &#x27;&lt;p&gt;&#x27; . __( &#x27;It\&#x27;s a block menu which contains some specific information and FEPS tools for management.&#x27;, &#x27;wpp&#x27; ) .&#x27;&lt;/p&gt;&#x27;;
    $contextual_help[ $tab ][] = &#x27;&lt;p&gt;&#x27; . __( &#x27;Note, menu is shown only for logged in users.&#x27;, &#x27;wpp&#x27; ) . &#x27;&lt;/p&gt;&#x27;;
    $contextual_help[ $tab ][] = &#x27;&lt;p&gt;&#x27; . sprintf( __( &#x27;Menu can be added to frontend pages via &lt;b&gt;FEPS Menu&lt;/b&gt; widget or &lt;b&gt;%s&lt;/b&gt; shortcode&#x27;, &#x27;wpp&#x27; ), &#x27;[wpp_feps_menu]&#x27; ) .&#x27;&lt;/p&gt;&#x27;;
    $contextual_help[ $tab ][] = &#x27;&lt;p&gt;&#x27; . sprintf( __( &#x27;&lt;b&gt;%s&lt;/b&gt; shortcode has the following available attributes:&#x27;, &#x27;wpp&#x27; ), &#x27;[wpp_feps_form]&#x27; ) .&#x27;&lt;/p&gt;&#x27;;
    $contextual_help[ $tab ][] = &#x27;&lt;ul&gt;&#x27;;
    $contextual_help[ $tab ][] = &#x27;&lt;li&gt;&lt;b&gt;title&lt;/b&gt; - &#x27; . sprintf( __( &#x27;Shows title of menu if attribute is passed. Default is empty. Example, &lt;b&gt;%s&lt;/b&gt;.&#x27;, &#x27;wpp&#x27; ), &#x27;[wpp_feps_menu title=&quot;My Submissions&quot;]&#x27; ) . &#x27;&lt;/li&gt;&#x27;;
    $contextual_help[ $tab ][] = &#x27;&lt;li&gt;&lt;b&gt;filters&lt;/b&gt; - &#x27; . sprintf( __( &#x27;Shows %s overview links by %s statuses. Available values are &lt;b&gt;true&lt;/b&gt;|&lt;b&gt;false&lt;/b&gt;. Default is false. Example, &lt;b&gt;%s&lt;/b&gt;&quot;.&#x27;, &#x27;wpp&#x27; ), WPP_F::property_label(), WPP_F::property_label( &#x27;plural&#x27; ), &#x27;[wpp_feps_menu filters=&quot;true]&#x27; ) . &#x27;&lt;/li&gt;&#x27;;
    $contextual_help[ $tab ][] = &#x27;&lt;li&gt;&lt;b&gt;form_page&lt;/b&gt; - &#x27; . sprintf( __( &#x27;If set, shows the link to FEPS %s Form page. Default is empty. Example, &lt;b&gt;%s&lt;/b&gt;&quot;.&#x27;, &#x27;wpp&#x27; ), WPP_F::property_label(), &#x27;[wpp_feps_menu title=&quot;http::/example.com/my_feps_&#x27; . WPP_F::property_label() . &#x27;_form_page]&#x27; ) . &#x27;&lt;/li&gt;&#x27;;
    $contextual_help[ $tab ][] = &#x27;&lt;li&gt;&lt;b&gt;show_balance&lt;/b&gt; - &#x27; . sprintf( __( &#x27;Shows user\&#x27;s current credits balance. Available values are &lt;b&gt;true&lt;/b&gt;|&lt;b&gt;false&lt;/b&gt;. Default is true. Example, &lt;b&gt;%s&lt;/b&gt;.&#x27;, &#x27;wpp&#x27; ), &#x27;[wpp_feps_menu show_balance=&quot;false&quot;]&#x27; );
    $contextual_help[ $tab ][] = &#x27;&lt;br/&gt;&lt;b&gt;&lt;i&gt;&#x27; . __( &#x27;Note, to use this attribute, WP-Invoice plugin and Single Page Checkout premium feature must be installed.&#x27;, &#x27;wpp&#x27; ). &#x27;&lt;/i&gt;&lt;/b&gt;&lt;/li&gt;&#x27;;
    $contextual_help[ $tab ][] = &#x27;&lt;li&gt;&lt;b&gt;show_spc_link&lt;/b&gt; - &#x27; . sprintf( __( &#x27;Shows the link to Add Credits page. Available values are &lt;b&gt;true&lt;/b&gt;|&lt;b&gt;false&lt;/b&gt;. Default is true. Example, &lt;b&gt;%s&lt;/b&gt;.&#x27;, &#x27;wpp&#x27; ), &#x27;[wpp_feps_menu show_spc_link=&quot;false&quot;]&#x27; );
    $contextual_help[ $tab ][] = &#x27;&lt;br/&gt;&lt;b&gt;&lt;i&gt;&#x27; . __( &#x27;Note, to use this attribute, WP-Invoice plugin and Single Page Checkout premium feature must be installed.&#x27;, &#x27;wpp&#x27; ). &#x27;&lt;/i&gt;&lt;/b&gt;&lt;/li&gt;&#x27;;
    $contextual_help[ $tab ][] = &#x27;&lt;/ul&gt;&#x27;;
    $contextual_help[ $tab ][] = &#x27;&lt;br/&gt;&#x27;;
    $contextual_help[ $tab ][] = &#x27;&lt;h4&gt;&#x27; . __( &#x27;Specific Pages&#x27;, &#x27;wpp&#x27; ) .&#x27;&lt;/h4&gt;&#x27;;
    $contextual_help[ $tab ][] = &#x27;&lt;p&gt;&#x27; . sprintf( __( &#x27;FEPS premium feature adds specific &lt;b&gt;frontend&lt;/b&gt; user\&#x27;s pages which are created on a fly, so they are not available in your existing &lt;a href=&quot;%s&quot;&gt;Pages&lt;/a&gt;.&#x27;, &#x27;wpp&#x27; ), admin_url( &#x27;edit.php?post_type=page&#x27; ) ) .&#x27;&lt;/p&gt;&#x27;;
    $contextual_help[ $tab ][] = &#x27;&lt;p&gt;&#x27; . __( &#x27;The links to these pages are added to FEPS Menu. Note, these pages are available only for logged in users.&#x27;, &#x27;wpp&#x27; ) . &#x27;:&lt;ul&gt;&#x27;;
    $contextual_help[ $tab ][] = __( &#x27;The specific FEPS pages are the following&#x27;, &#x27;wpp&#x27; ) . &#x27;:&lt;ul&gt;&#x27;;
    $contextual_help[ $tab ][] = &#x27;&lt;li&gt;&lt;b&gt;&#x27; . __( &#x27;Overview Page&#x27;, &#x27;wpp&#x27; ) . &#x27;&lt;/b&gt; - &#x27; . sprintf( __( &#x27;The current one shows the list of already submitted via FEPS forms %1$s by current logged in user. If %2$s Form, used for submission, allows to edit %2$s, it also shows the links &quot;Edit&quot; and &quot;Remove&quot; for the current %2$s.&#x27;, &#x27;wpp&#x27; ), WPP_F::property_label( &#x27;plural&#x27; ), WPP_F::property_label() );
    $contextual_help[ $tab ][] = sprintf( __( &#x27;Also, FEPS allows to show %s on the current page by statuses. See &lt;b&gt;FEPS Menu&lt;/b&gt; and &lt;b&gt;Links&lt;/b&gt; section in the current Help tab for details.&#x27;, &#x27;wpp&#x27; ), WPP_F::property_label( &#x27;plural&#x27; ) ) . &#x27;&lt;/li&gt;&#x27;;
    $contextual_help[ $tab ][] = &#x27;&lt;li&gt;&lt;b&gt;&#x27; . __( &#x27;Add Credits Page&#x27;, &#x27;wpp&#x27; ) . &#x27;&lt;/b&gt; - &#x27; . sprintf( __( &#x27;On the current page logged in user can add credits to their FEPS balance. The current page is available only if &lt;a href=&quot;%s&quot;&gt;WP-Invoice&lt;/a&gt; plugin and &lt;a href=&quot;%s&quot;&gt;Single Page Checkout&lt;/a&gt; premium feature are installed. &lt;b&gt;&lt;i&gt;Note, user\&#x27;s credit balance can be manually edited by administrator via Edit User page (profile)&lt;/i&gt;&lt;/b&gt;.&#x27;, &#x27;wpp&#x27; ), &#x27;https://usabilitydynamics.com/products/wp-invoice/&#x27;, &#x27;https://usabilitydynamics.com/products/wp-invoice/premium-features/&#x27; ) . &#x27;&lt;/li&gt;&#x27;;
    $contextual_help[ $tab ][] = &#x27;&lt;li&gt;&lt;b&gt;&#x27; . sprintf( __( &#x27;Edit %s Page&#x27;, &#x27;wpp&#x27; ), WPP_F::property_label() ) . &#x27;&lt;/b&gt; - &#x27; . sprintf( __( &#x27;Here user can edit the %1$s added via FEPS %1$s form. There are different links for every %1$s, so the link can not be provided. Note, the form, used for submission, must exist and must be enabled option which allows to edit and remove %2$s. &#x27;, &#x27;wpp&#x27; ), WPP_F::property_label(), WPP_F::property_label( &#x27;plural&#x27; ) ) . &#x27;&lt;/li&gt;&#x27;;
    $contextual_help[ $tab ][] = &#x27;&lt;h5&gt;&#x27; . __( &#x27;Templates&#x27;, &#x27;wpp&#x27; ) .&#x27;&lt;/h5&gt;&#x27;;
    $contextual_help[ $tab ][] = &#x27;&lt;p&gt;&#x27; . sprintf( __( &#x27;You can set custom available template for FEPS pages. More information you can find &lt;a href=&quot;%s&quot;&gt;here&lt;/a&gt;.&#x27;, &#x27;wpp&#x27; ), &#x27;http://codex.wordpress.org/Pages#Page_Templates&#x27; ) . &#x27;&lt;/p&gt;&#x27;;
    $contextual_help[ $tab ][] = &#x27;&lt;h5&gt;&#x27; . __( &#x27;Links&#x27;, &#x27;wpp&#x27; ) .&#x27;&lt;/h5&gt;&#x27;;
    $contextual_help[ $tab ][] = &#x27;&lt;p&gt;&#x27; . sprintf( __( &#x27;You can use given links to FEPS pages, for example, for adding custom menu in &lt;a href=&quot;%s&quot;&gt;Menus&lt;/a&gt; or wherever else.&#x27;, &#x27;wpp&#x27; ), admin_url( &#x27;nav-menus.php&#x27; ) ) . &#x27;&lt;/p&gt;&#x27;;
    $contextual_help[ $tab ][] = &#x27;&lt;p&gt;&#x27; . __( &#x27;Note, that FEPS pages are available only for logged in users. In other case user will be redirected to home page.&#x27;, &#x27;wpp&#x27; ) .&#x27;&lt;/p&gt;&#x27;;
    $contextual_help[ $tab ][] = &#x27;&lt;br/&gt;&#x27;;
    $contextual_help[ $tab ][] = &#x27;&lt;h4&gt;&#x27; . __( &#x27;Administration&#x27;, &#x27;wpp&#x27; ) .&#x27;&lt;/h4&gt;&#x27;;
    $contextual_help[ $tab ][] = &#x27;&lt;p&gt;&#x27; . sprintf( __( &#x27;Specific column &quot;FEPS details&quot; can be added to the table on &lt;a href=&quot;%s&quot;&gt;All %s &lt;/a&gt;page.&#x27;, &#x27;wpp&#x27; ), admin_url( &#x27;edit.php?post_type=property&amp;page=all_properties&#x27; ), WPP_F::property_label( &#x27;plural&#x27; ) );
    $contextual_help[ $tab ][] = __( &#x27;To add this column, you should check the option. Column contains detailed FEPS information about the current property, which can be helpful for management.&#x27;, &#x27;wpp&#x27; ) . &#x27;&lt;/p&gt;&#x27;;
    $contextual_help[ $tab ][] = &#x27;&lt;p&gt;&#x27; . __( &#x27;Note, if the option is enabled but you don\&#x27;t see the column, you should check &quot;&lt;i&gt;Screen Option&lt;/i&gt;&quot; settings.&#x27;, &#x27;wpp&#x27; ) . &#x27;&lt;/p&gt;&#x27;;
    $contextual_help[ $tab ][] = &#x27;&lt;br/&gt;&#x27;;
    $contextual_help[ $tab ][] = &#x27;&lt;h4&gt;&#x27; . __( &#x27;Integration with other UsabilityDynamics plugins&#x27;, &#x27;wpp&#x27; ) .&#x27;&lt;/h4&gt;&#x27;;
    $contextual_help[ $tab ][] = sprintf( __( &#x27;Functionality of FEPS premium feature can increased via other following wordpress plugins developed by &lt;a href=&quot;%s&quot;&gt;UsabilityDynamics, Inc&lt;/a&gt;:&#x27;, &#x27;wpp&#x27; ), &#x27;https://usabilitydynamics.com/&#x27; ) .&#x27;&lt;ul&gt;&#x27;;
    $contextual_help[ $tab ][] = &#x27;&lt;li&gt;&#x27; . sprintf( __( &#x27;&lt;a href=&quot;%s&quot;&gt;WP-Invoice&lt;/a&gt;&#x27;, &#x27;wpp&#x27; ), &#x27;https://usabilitydynamics.com/products/wp-invoice/&#x27; ) .&#x27;&lt;/li&gt;&#x27;;
    $contextual_help[ $tab ][] = &#x27;&lt;li&gt;&#x27; . sprintf( __( &#x27;&lt;a href=&quot;%s&quot;&gt;WP-CRM&lt;/a&gt;&#x27;, &#x27;wpp&#x27; ), &#x27;https://usabilitydynamics.com/products/wp-crm/&#x27; ) .&#x27;&lt;/li&gt;&lt;/ul&gt;&#x27;;
    $contextual_help[ $tab ][] = &#x27;&lt;h5&gt;&#x27; . __( &#x27;WP-Invoice&#x27;, &#x27;wpp&#x27; ) .&#x27;&lt;/h5&gt;&#x27;;
    $contextual_help[ $tab ][] = &#x27;&lt;p&gt;&#x27; . sprintf( __( &#x27;To add aditional functionality to FEPS premium feature, &lt;a href=&quot;%s&quot;&gt;Single Page Checkout&lt;/a&gt; premium feature must be installed and activated.&#x27; ), &#x27;https://usabilitydynamics.com/products/wp-invoice/premium-features/&#x27; ) . &#x27;&lt;/p&gt;&#x27;;
    $contextual_help[ $tab ][] = &#x27;&lt;p&gt;&#x27; . sprintf( __( &#x27;It allows you to use FEPS %s Forms as billable service where users have to pay for publishing %s on your site.&#x27;, &#x27;wpp&#x27; ), WPP_F::property_label(), WPP_F::property_label( &#x27;plural&#x27; ) ) . &#x27;&lt;/p&gt;&#x27;;
    $contextual_help[ $tab ][] = &#x27;&lt;p&gt;&#x27; . sprintf( __( &#x27;Billable service is called Sponsored listings. Sponsored listings allows you to set different Subscription plans where you are able to set expired dates and images limit for submitted %s.&#x27;, &#x27;wpp&#x27; ), WPP_F::property_label( &#x27;plural&#x27; ), WPP_F::property_label() ) . &#x27;&lt;/p&gt;&#x27;;
    $contextual_help[ $tab ][] = &#x27;&lt;h5&gt;&#x27; . __( &#x27;WP-CRM&#x27;, &#x27;wpp&#x27; ) .&#x27;&lt;/h5&gt;&#x27;;
    $contextual_help[ $tab ][] = &#x27;&lt;p&gt;&#x27; . __( &#x27;If WP-Invoice plugin is installed you are able to see all user\&#x27;s completed transactions on CRM User Edit page.&#x27; ,&#x27;wpp&#x27; ) . &#x27;&lt;/p&gt;&#x27;;
    $contextual_help[ $tab ][] = &#x27;&lt;p&gt;&#x27; . __( &#x27;Also, you have ability to manage FEPS notifications using WP-CRM plugin. Go to CRM -&gt; Settings -&gt; Notifications.&#x27;, &#x27;wpp&#x27; ) . &#x27;&lt;/p&gt;&#x27;;
    $contextual_help[ $tab ][] = sprintf(__(&#x27;For your notifications on any of this Trigger actions - &lt;i&gt;FEPS: Pending Approval&lt;/i&gt;, &lt;i&gt;FEPS: %s Submitted&lt;/i&gt;, &lt;i&gt;FEPS: User Account Approved&lt;/i&gt;, &lt;i&gt;FEPS: User Account Created&lt;/i&gt; &amp;mdash; you can use the following shortcodes&#x27;, &#x27;wpp&#x27; ), WPP_F::property_label() ) . &#x27;:&#x27;;
    $contextual_help[ $tab ][] = &#x27;&lt;ul&gt;&lt;li&gt;[notification_type]&lt;/li&gt;&lt;li&gt;[user_email]&lt;/li&gt;&lt;li&gt;[display_name]&lt;/li&gt;&lt;li&gt;[site_url]&lt;/li&gt;&lt;/ul&gt;&#x27;;
    $contextual_help[ $tab ][] = &#x27;&lt;br/&gt;&#x27; . __( &#x27;For Trigger action &lt;i&gt;FEPS: Pending Approval&lt;/i&gt; - you can use the following shortcodes&#x27;, &#x27;wpp&#x27; ) . &#x27;:&#x27;;
    $contextual_help[ $tab ][] = &#x27;&lt;ul&gt;&lt;li&gt;[property_link]&lt;/li&gt;&lt;li&gt;[property_title]&lt;/li&gt;&lt;li&gt;[status]&lt;/li&gt;&lt;/ul&gt;&#x27;;
    $contextual_help[ $tab ][] = &#x27;&lt;br/&gt;&#x27; . sprintf( __( &#x27;For Trigger action &lt;i&gt;FEPS: %s Submitted&lt;/i&gt; - you can use the following shortcodes&#x27;, &#x27;wpp&#x27; ), WPP_F::property_label() ) . &#x27;:&#x27;;
    $contextual_help[ $tab ][] = &#x27;&lt;ul&gt;&lt;li&gt;[property_title]&lt;/li&gt;&lt;li&gt;[pending_url]&lt;/li&gt;&lt;li&gt;[status]&lt;/li&gt;&lt;/ul&gt;&#x27;;
    $contextual_help[ $tab ][] = &#x27;&lt;br/&gt;&#x27; . __( &#x27;For Trigger action &lt;i&gt;FEPS: User Account Approved&lt;/i&gt; - you can use the following shortcodes&#x27;, &#x27;wpp&#x27; ) . &#x27;:&#x27;;
    $contextual_help[ $tab ][] = &#x27;&lt;ul&gt;&lt;li&gt;[user_login]&lt;/li&gt;&lt;li&gt;[user_password]&lt;/li&gt;&lt;li&gt;[system_message]&lt;/li&gt;&lt;/ul&gt;&#x27;;
    $contextual_help[ $tab ][] = &#x27;&lt;br/&gt;&#x27; . __( &#x27;For Trigger action &lt;i&gt;FEPS: User Account Created&lt;/i&gt; - you can use this shortcodes&#x27;, &#x27;wpp&#x27; ) . &#x27;:&#x27;;
    $contextual_help[ $tab ][] = &#x27;&lt;ul&gt;&lt;li&gt;[user_login]&lt;/li&gt;&lt;li&gt;[user_password]&lt;/li&gt;&lt;li&gt;[system_message]&lt;/li&gt;&lt;li&gt;[property_link]&lt;/li&gt;&lt;li&gt;[property_title]&lt;/li&gt;&lt;li&gt;[activation_link]&lt;/li&gt;&lt;li&gt;[status]&lt;/li&gt;&lt;/ul&gt;&#x27;;

    return $contextual_help;

  }


  /**
   * Ajax action to delete FEPS images
   * @author korotkov@ud
   */
  function ajax_feps_image_delete() {
    //** Get data from request */
    $session  = (int)$_REQUEST[&#x27;session&#x27;];
    $filename = $_REQUEST[&#x27;filename&#x27;];

    //** File location */
    $upload_dir = wp_upload_dir();
    $feps_session_files_dir = $upload_dir[&#x27;basedir&#x27;] . &#x27;/feps_files/&#x27; . (string)$session . &#x27;/&#x27;;

    //** Try to delete file */
    if ( unlink( $feps_session_files_dir.$filename ) )
      die( json_encode( array(&#x27;success&#x27; =&gt; 1) ) );

    //** success - 0 if not deleted */
    die( json_encode( array(&#x27;success&#x27; =&gt; 0) ) );
  }


  /**
   * Initialize FEPS schedule events
   *
   * @author korotkov@ud
   */
  function feps_schedule_events() {

    if ( !wp_next_scheduled( &#x27;delete_feps_files&#x27; ) ) {
      wp_schedule_event( time(), &#x27;daily&#x27;, &#x27;delete_feps_files&#x27; );
    }
    add_action( &#x27;delete_feps_files&#x27;, array( &#x27;class_wpp_feps&#x27;, &#x27;delete_feps_files&#x27; ) );

    //** Removes old FEPS properties with &#x27;Pending&#x27; status */
    if ( !wp_next_scheduled( &#x27;feps_time_is_expired&#x27; ) ) {
      wp_schedule_event( time(), &#x27;daily&#x27;, &#x27;feps_time_is_expired&#x27; );
    }
    add_action( &#x27;feps_time_is_expired&#x27;, array( &#x27;class_wpp_feps&#x27;, &#x27;feps_time_is_expired&#x27; ) );

  }


  /**
   * Delete feps files if they are older then $seconds_old
   *
   * @param int $seconds_old
   * @return bool
   */
  function delete_feps_files( $seconds_old = 3600 ) {

    /** FEPS temp files dir */
    $uploads = wp_upload_dir();
    $feps_files_dir = $uploads[&#x27;basedir&#x27;].&#x27;/feps_files/&#x27;;

    /** Scan dir if it exists */
    if ( file_exists( $feps_files_dir ) &amp;&amp; is_dir( $feps_files_dir ) ) {

     if ( $handle = opendir( $feps_files_dir ) ) {

       while (false !== ($file = readdir($handle))) {
         if ($file != &quot;.&quot; &amp;&amp; $file != &quot;..&quot;) {

           $session_dir = $feps_files_dir.$file;
           /** If dir was modified more then 1 hour ago */
           if ( (int) (time() - filemtime( $session_dir )) &gt; $seconds_old &amp;&amp; is_dir( $session_dir ) ) {
             /** Delete it with files in it */
             WPP_F::delete_directory( $session_dir );
           }

         }
       }

       closedir($handle);
       return true;
     }

    } else {
     return false;
    }

  }


  /**
   * Renders FEPS details on Edit Property page
   *
   * @author peshkov@UD
   * @since 2.0
   */
  function post_property_form_information() {
    global $post;

    //** Determine if the current post is property */
    if( $post-&gt;post_type != &quot;property&quot; ) {
      return null;
    }

    //** Determine if the current post belongs to FEPS */
    $form = self::get_form_by_post( $post-&gt;ID );
    if( !$form ) {
      return null;
    }

    //** Determine if user has permissions for FEPS management */
    if( !current_user_can( self::$capability ) ) {
      return null;
    }

    $user = get_userdata( $post-&gt;post_author );
    $credits = get_the_author_meta( &#x27;wpp::feps::credits&#x27;, $user-&gt;ID );

    $expired_time = get_post_meta( $post-&gt;ID, FEPS_META_EXPIRED, true );
    $expired_time = !empty( $expired_time ) ? WPP_F::nice_time( $expired_time, array(&#x27;format&#x27;=&gt;&#x27;date&#x27;) ) : __( &#x27;Not set&#x27;, &#x27;wpp&#x27; );

    $sponsored = !empty( $form[ &#x27;feps_credits&#x27; ] ) &amp;&amp; $form[ &#x27;feps_credits&#x27; ] == &#x27;true&#x27; ? true : false;

    $plan = get_post_meta( $post-&gt;ID, FEPS_META_PLAN, true );
    if( !empty( $plan ) &amp;&amp; is_array( $plan ) ) {
      $plan_details = sprintf( __( &#x27;Price: &lt;b&gt;%01.2f&lt;/b&gt; credits&#x27;, &#x27;wpp&#x27; ), $plan[ &#x27;price&#x27; ] );
      $plan_details .= &#x27;, &#x27; . sprintf( __( &#x27;Duration&#x27;, &#x27;wpp&#x27; ) . &#x27;: %d %s&#x27;, $plan[&#x27;duration&#x27;][&#x27;value&#x27;], _n( $plan[&#x27;duration&#x27;][&#x27;interval&#x27;], $plan[&#x27;duration&#x27;][&#x27;interval&#x27;].&#x27;s&#x27;, $plan[&#x27;duration&#x27;][&#x27;value&#x27;], &#x27;wpp&#x27; ) );
      $plan_details .= &#x27;, &#x27; . __( &#x27;Images Limit&#x27;, &#x27;wpp&#x27; ) . &#x27;: &#x27; . ( !empty( $plan[&#x27;images_limit&#x27;] ) ? $plan[&#x27;images_limit&#x27;] : &#x27;1&#x27; );
    }

    ?&gt;
    &lt;div id=&quot;wpp_post_property_form_information&quot; class=&quot;postbox wpp_list&quot;&gt;
      &lt;div class=&quot;handlediv&quot; title=&quot;&lt;?php _e( &#x27;Click to toggle&#x27;, &#x27;wpp&#x27; ); ?&gt;&quot;&gt;&lt;br/&gt;&lt;/div&gt;
      &lt;h3 class=&quot;hndle&quot;&gt;&lt;span&gt;&lt;?php _e( &#x27;Front End Property Submission (FEPS) Details&#x27;, &#x27;wpp&#x27; ); ?&gt;&lt;/span&gt;&lt;/h3&gt;
      &lt;div class=&quot;inside&quot;&gt;
        &lt;table class=&quot;widefat&quot;&gt;
          &lt;tbody&gt;
            &lt;tr class=&quot;wpp_attribute_row_parent wpp_attribute_row&quot;&gt;
              &lt;th&gt;&lt;?php _e( &#x27;Property Form&#x27;, &#x27;wpp&#x27; ); ?&gt;&lt;/th&gt;
              &lt;td&gt;&lt;a target=&quot;_blank&quot; href=&quot;&lt;?php echo admin_url( &#x27;edit.php?post_type=property&amp;page=page_feps&#x27; ); ?&gt;&quot;&gt;&lt;?php echo $form[ &#x27;title&#x27; ]; ?&gt;&lt;/a&gt;&lt;/td&gt;
            &lt;/tr&gt;
            &lt;tr class=&quot;wpp_attribute_row_parent wpp_attribute_row&quot;&gt;
              &lt;th&gt;&lt;?php _e( &#x27;Author&#x27;, &#x27;wpp&#x27; ); ?&gt;&lt;/th&gt;
              &lt;td&gt;
              &lt;?php if ( current_user_can( &#x27;edit_users&#x27;, $user-&gt;ID ) ) : ?&gt;
                &lt;span class=&quot;value&quot;&gt;&lt;a target=&quot;_blank&quot; href=&quot;&lt;?php echo get_edit_user_link( $user-&gt;ID ); ?&gt;&quot;&gt;&lt;?php echo $user-&gt;data-&gt;display_name; ?&gt;&lt;/a&gt;&lt;/span&gt;
                &lt;span class=&quot;description&quot;&gt;( &lt;?php printf( __( &#x27;The user has &lt;b&gt;%01.2f&lt;/b&gt; credits on the balance&#x27; ), !empty( $credits ) ? $credits : 0 ); ?&gt; )&lt;/span&gt;
              &lt;?php else : ?&gt;
                &lt;span class=&quot;value&quot;&gt;&lt;?php echo $user-&gt;data-&gt;display_name; ?&gt;&lt;/span&gt;
              &lt;?php endif; ?&gt;
              &lt;/td&gt;
            &lt;/tr&gt;
            &lt;tr class=&quot;wpp_attribute_row_parent wpp_attribute_row&quot;&gt;
              &lt;th&gt;&lt;?php _e( &#x27;Sponsored&#x27;, &#x27;wpp&#x27; ); ?&gt;&lt;/th&gt;
              &lt;td&gt;&lt;?php $sponsored ? _e( &#x27;Yes&#x27;, &#x27;wpp&#x27; ) : _e( &#x27;No&#x27;, &#x27;wpp&#x27; ) ; ?&gt;&lt;/td&gt;
            &lt;/tr&gt;
            &lt;tr class=&quot;wpp_attribute_row_parent wpp_attribute_row&quot;&gt;
              &lt;th&gt;&lt;?php _e( &#x27;Expired date&#x27;, &#x27;wpp&#x27; ); ?&gt;&lt;/th&gt;
              &lt;td&gt;&lt;?php echo $expired_time; ?&gt;&lt;/td&gt;
            &lt;/tr&gt;
            &lt;?php if( $sponsored ) : ?&gt;
            &lt;tr class=&quot;wpp_attribute_row_parent wpp_attribute_row&quot;&gt;
              &lt;th&gt;&lt;?php _e( &#x27;Subscription Plan&#x27;, &#x27;wpp&#x27; ); ?&gt;&lt;/th&gt;
              &lt;td&gt;
                &lt;?php if( !empty( $plan ) &amp;&amp; is_array( $plan ) ) : ?&gt;
                  &lt;?php echo $plan[ &#x27;name&#x27; ]; ?&gt; &lt;span class=&quot;description&quot;&gt;( &lt;?php echo $plan_details; ?&gt; )&lt;/span&gt;
                &lt;?php else : ?&gt;
                  &lt;?php _e( &#x27;Not set&#x27;, &#x27;wpp&#x27; ); ?&gt;
                &lt;?php endif; ?&gt;
              &lt;/td&gt;
            &lt;/tr&gt;
            &lt;?php endif; ?&gt;
          &lt;/tbody&gt;
        &lt;/table&gt;
      &lt;/div&gt;
    &lt;/div&gt;
    &lt;?php
  }


  /**
   * Inserts  &#x27;Subscription plan&#x27; content into the &quot;Publish&quot; metabox on property pages
   *
   * @author peshkov@UD
   * @since 2.0
   */
  function post_submitbox_misc_actions() {
    global $post, $wp_properties, $wpi_settings;

    if ( $post-&gt;post_status != &#x27;publish&#x27; &amp;&amp; $form_id = get_post_meta( $post-&gt;ID, FEPS_META_FORM, true ) ) {
      $forms = $wp_properties[&#x27;configuration&#x27;][&#x27;feature_settings&#x27;][&#x27;feps&#x27;][&#x27;forms&#x27;];
      if ( !empty( $forms[$form_id] ) &amp;&amp; $forms[$form_id][&#x27;feps_credits&#x27;] == &#x27;true&#x27; &amp;&amp; !empty( $forms[$form_id][&#x27;subscription_plans&#x27;] ) ) {

        $image_field = array_filter((array)$forms[$form_id][&#x27;fields&#x27;], create_function(&#x27;$field&#x27;,&#x27;return $field[&quot;attribute&quot;]==&quot;image_upload&quot;;&#x27;));
        $form_has_images = !empty($image_field)?true:false;

        ?&gt;
        &lt;div class=&quot;misc-pub-section wpp_feps_subsc_plan&quot;&gt;
          &lt;ul&gt;
            &lt;li class=&quot;wpp-block-wrap&quot;&gt;
              &lt;span class=&quot;wpp-block-title&quot;&gt;&lt;?php _e(&#x27;FEPS Subscription Plan&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/span&gt;
              &lt;div class=&quot;wp-tab-panel&quot;&gt;
                &lt;ul&gt;
                  &lt;?php $first = true; ?&gt;
                  &lt;?php foreach( $forms[$form_id][&#x27;subscription_plans&#x27;] as $plan_key =&gt; $plan_data ): ?&gt;
                    &lt;li class=&quot;wpp_feps_plan_row&quot;&gt;
                      &lt;label&gt;
                        &lt;h3 class=&quot;wpp_feps_subscription_plan_title&quot;&gt;&lt;?php echo $plan_data[&#x27;name&#x27;]; ?&gt;&lt;/h3&gt;
                        &lt;table&gt;
                          &lt;tr&gt;
                            &lt;th class=&quot;wpp_feps_subscription_plan_radio_holder&quot;&gt;
                              &lt;input &lt;?php echo $first ? &#x27;checked=&quot;checked&quot;&#x27; : &#x27;&#x27;; ?&gt; type=&quot;radio&quot; name=&quot;feps_subscription_plan&quot; value=&quot;&lt;?php echo $plan_key; ?&gt;&quot; /&gt;
                            &lt;/th&gt;
                            &lt;td&gt;
                              &lt;ul class=&quot;wpp_feps_subscription_plan_info&quot;&gt;
                                &lt;li&gt;
                                  &lt;label&gt;&lt;?php _e(&#x27;Price:&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/label&gt;
                                  &lt;span&gt;&lt;?php printf( __( &#x27;&lt;b&gt;%01.2f&lt;/b&gt; credits&#x27;, &#x27;wpp&#x27; ), $plan_data[&#x27;price&#x27;] ); ?&gt;&lt;/span&gt;
                                &lt;/li&gt;
                                &lt;li&gt;
                                  &lt;label&gt;&lt;?php _e(&#x27;Duration:&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/label&gt;
                                  &lt;span&gt;&lt;?php echo $plan_data[&#x27;duration&#x27;][&#x27;value&#x27;].&#x27; &#x27;.$plan_data[&#x27;duration&#x27;][&#x27;interval&#x27;].&#x27;(s)&#x27;; ?&gt;&lt;/span&gt;
                                &lt;/li&gt;
                                &lt;?php if ($form_has_images): ?&gt;
                                &lt;li&gt;
                                  &lt;label&gt;&lt;?php _e(&#x27;Images:&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/label&gt;
                                  &lt;span&gt;&lt;?php echo $plan_data[&#x27;images_limit&#x27;]; ?&gt;&lt;/span&gt;
                                &lt;/li&gt;
                                &lt;?php endif; ?&gt;
                              &lt;/ul&gt;
                            &lt;/td&gt;
                          &lt;/tr&gt;
                        &lt;/table&gt;
                      &lt;/label&gt;
                    &lt;/li&gt;
                    &lt;?php $first = false; ?&gt;
                  &lt;?php endforeach; ?&gt;
                &lt;/ul&gt;
              &lt;/div&gt;
            &lt;/li&gt;
          &lt;/ul&gt;
        &lt;/div&gt;
        &lt;?php
      }
    }
  }


  /**
   * Determines if live time of FEPS is expired and change FEPS status.
   * Used by WP Cron
   *
   * @author peshkov@UD
   */
  function feps_time_is_expired() {
    global $wpdb, $wp_properties;

    $current_time = time();
    $forms = $wp_properties[&#x27;configuration&#x27;][&#x27;feature_settings&#x27;][&#x27;feps&#x27;][&#x27;forms&#x27;];

    //** STEP 1. Get all FEPS with pending */
    $feps = $wpdb-&gt;get_results(&quot;
      SELECT p.ID, p.post_status, pm1.meta_value AS expired_time, pm2.meta_value AS form_id, p.post_author
        FROM {$wpdb-&gt;posts} AS p
          JOIN {$wpdb-&gt;postmeta} AS pm1 ON pm1.post_id = p.ID AND pm1.meta_key = &#x27;&quot; . FEPS_META_EXPIRED . &quot;&#x27;
          JOIN {$wpdb-&gt;postmeta} AS pm2 ON pm2.post_id = p.ID AND pm2.meta_key = &#x27;&quot; . FEPS_META_FORM . &quot;&#x27;
        WHERE p.post_type = &#x27;property&#x27;
          AND p.post_status IN ( &#x27;pending&#x27;, &#x27;publish&#x27; )

    &quot;, ARRAY_A);

    if( empty( $feps ) ) {
      return false;
    }

    //** STEP 2. Go through all returned FEPS and set statuses using expired time information. */
    foreach ( $feps as $r ) {
      if ( !empty( $r[&#x27;expired_time&#x27;] ) &amp;&amp; $current_time &gt;= $r[&#x27;expired_time&#x27;] ) {
        switch( $r[&#x27;post_status&#x27;] ) {
          case &#x27;pending&#x27;:
            $new_status = &#x27;trash&#x27;;
            break;
          case &#x27;publish&#x27;:
            $new_status = &#x27;pending&#x27;;
            break;
          default:
            continue;
            break;
        }
        $post_id = wp_update_post( array(
          &#x27;ID&#x27; =&gt; $r[&#x27;ID&#x27;],
          &#x27;post_status&#x27; =&gt; $new_status,
        ) );
      }
    }

    return true;
  }


  /**
   * Ran after account created
   *
   * @param int $user_id
   * @param array $new_user
   * @param array $form_data
   * @author korotkov@ud
   */
  function account_created( $args = false ) {
    global $wp_post_statuses;

    extract( $args );

    if ( in_array( $form_data[&#x27;new_post_status&#x27;], self::$statuses ) ) {

      //** Do not send notification if specifically disabled */
      if($form_data[&#x27;notifications&#x27;][&#x27;user_creation&#x27;] !== &#x27;disable&#x27;) {
        update_user_meta( $user_id, &#x27;is_not_approved&#x27;, 1 );
        WPP_Mail::user_created( $user_id, $new_user );
      }
    }
  }

  /**
   * Set available property statuses
   * @param array $current
   * @return array
   * @author korotkov@ud
   */
  function property_statuses( $current ) {

    $return   = array();

    foreach( self::$statuses as $status_slug ) {
      $return[ $status_slug ] = $current[ $status_slug ];
    }

    ksort( $return );

    return $return;
  }


  /**
   * Prevent appearing &quot;property_type&quot; attribute in list Property Attributes
   * in case if someone adds &quot;property_type&quot; on Developer Tab.
   * This param is required and it alredy set in General Options.
   * @param array $available_attributes
   * @param array $general_attributes
   * @param array $other_attributes
   * @return array
   * @author odokienko@UD
   */
  function available_attributes ($available_attributes, $general_attributes, $other_attributes){

    foreach ($available_attributes as &amp;$group_attributes){
      unset($group_attributes[&quot;property_type&quot;]);
    }

    return $available_attributes;
  }


  /**
   * Removes extra attachments from post.
   * Ignores featured image.
   *
   * @author peshkov@UD
   * @since 2.0
   */
  function remove_extra_attachments( $post_id ) {

    $form = self::get_form_by_post( $post_id );
    if( !$form ) {
      return null;
    }

    //** Get information about images limit */
    $images_limit = 0;
    if( !empty( $form[ &#x27;feps_credits&#x27; ] ) &amp;&amp; $form[ &#x27;feps_credits&#x27; ] == &#x27;true&#x27; ) {
      $subsc_plan = get_post_meta( $post_ID, FEPS_META_PLAN, true );
      if( !empty( $subsc_plan ) &amp;&amp; is_array( $subsc_plan ) ) {
        $images_limit = !empty( $subsc_plan[ &#x27;images_limit&#x27; ] ) ? (int)$subsc_plan[ &#x27;images_limit&#x27; ] : 0;
      } else {
        $images_limit = 1;
      }
    } else {
      $images_limit = !empty( $form[ &#x27;images_limit&#x27; ] ) ? (int)$form[ &#x27;images_limit&#x27; ] : 0;
    }

    if( $images_limit &gt; 0 ) {
      $property = WPP_F::get_property( $post_id, array( &#x27;get_children&#x27; =&gt; &#x27;false&#x27; ) );
      if( is_array( $property[ &#x27;gallery&#x27; ] ) &amp;&amp; count( $property[ &#x27;gallery&#x27; ] ) &gt; $images_limit ) {
        //** Reverse attachents to start remove from the newest ones. */
        $attachments = array_reverse( $property[ &#x27;gallery&#x27; ] );
        foreach( $attachments as $k =&gt; $attachment ) {
          //** Ignore Featured Image removing */
          if( isset( $property[ &#x27;featured_image&#x27; ] ) &amp;&amp; $attachment[ &#x27;attachment_id&#x27; ] == $property[ &#x27;featured_image&#x27; ] ) {
            continue;
          }
          //** Try to remove extra attachment */
          if ( false !== wp_delete_attachment( $attachment[ &#x27;attachment_id&#x27; ] ) ) {
            unset( $attachments[$k] );
          }
          //** Stop removing attachments if images limit is the same or more than attachments exist */
          if( count( $attachments ) &lt;= $images_limit ) {
            break;
          }
        }
      }
    }
  }


  /**
   * Handles property actions when a property is saved
   *
   * @todo Check capabilities that current user has the authority to publish a FEPS post
   * @param type $post_ID
   * @param type $post_after
   * @param type $post_before
   */
  function post_updated($post_ID, $post_after, $post_before) {
    global $wp_properties;

    if( $post_after-&gt;post_type != &#x27;property&#x27; || !get_post_meta( $post_ID, &#x27;wpp_feps_property&#x27;, true ) ) {
      return null;
    }

    $form = self::get_form_by_post( $post_ID );

    //** Be sure that property is related to existing form */
    if( empty( $form ) ) {
      return null;
    }

    if( $post_before-&gt;post_status != $post_after-&gt;post_status ) {

      switch ( $post_after-&gt;post_status ) {

        case &#x27;pending&#x27;:
          delete_post_meta( $post_ID, FEPS_META_EXPIRED );
          //** Subscription plan must be provided only for published properties */
          delete_post_meta( $post_ID, FEPS_META_PLAN );

          //** Update expired time for pending status if it&#x27;s set for the current FEPS Form */
          if ( (int)$form[&#x27;trash_time&#x27;] &gt; 0 ) {
            $expired_time = ( (int)$form[&#x27;trash_time&#x27;] * 86400 ) + time();
            update_post_meta( $post_ID, FEPS_META_EXPIRED, $expired_time );
          }

          if ( $form[&#x27;notifications&#x27;][&#x27;on_status_updated&#x27;] == &#x27;true&#x27; ) {
            if( $post_before-&gt;post_status == &#x27;publish&#x27; ) {
              $subject = __(&#x27;Publish Time Has Expired&#x27;, &#x27;wpp&#x27;);
              $crm_log_message = __(&#x27;Publish time has expired for [property_title].&#x27;, &#x27;wpp&#x27;);
              if( !empty( $form[ &#x27;feps_credits&#x27; ] ) &amp;&amp; $form[ &#x27;feps_credits&#x27; ] == &#x27;true&#x27; ) {
                if( (int)$form[&#x27;trash_time&#x27;] &gt; 0 ) {
                  $message = sprintf(__(&#x27;Hello [display_name]%1$s%1$sPublish time for Your %3$s [property_title] has expired.%1$s%1$sYou have [days] %2$s to choose new subscription for your %3$s.%1$s%1$sClick this link to view all your [status] %4$s:%1$s[url]&#x27;, &#x27;wpp&#x27;), PHP_EOL,_n(&#x27;day&#x27;,&#x27;days&#x27;,(int)$form[&#x27;trash_time&#x27;]), WPP_F::property_label( &#x27;singular&#x27; ), WPP_F::property_label( &#x27;plural&#x27; ) );
                  $days = (int)$form[&#x27;trash_time&#x27;];
                } else {
                  $message = sprintf(__(&#x27;Hello [display_name]%1$s%1$sPublish time for Your %2$s [property_title] has expired.%1$s%1$sIf You wish you could choose new subscription for your %2$s.%1$s%1$sClick this link to view all your [status] %3$s:%1$s[url]&#x27;, &#x27;wpp&#x27;), PHP_EOL, WPP_F::property_label( &#x27;singular&#x27; ),WPP_F::property_label( &#x27;plural&#x27; ) );
                }
              } else {
                $message = sprintf(__(&#x27;Hello [display_name]%1$s%1$sYour %2$s [property_title] status has been changed from Published to Pending. Click this link to view all your [status] %3$s:%1$s[url]&#x27;, &#x27;wpp&#x27;), PHP_EOL, WPP_F::property_label( &#x27;singular&#x27; ),WPP_F::property_label( &#x27;plural&#x27; ) );
              }
            } elseif ( $post_before-&gt;post_status == &#x27;trash&#x27; ) {
              $message = sprintf( __( &#x27;Hello [display_name]%1$s%1$sYour %2$s [property_title] has been restored. The current status is [status]. Click this link to view all your [status] %3$s:%1$s[url]&#x27; , &#x27;wpp&#x27; ), PHP_EOL, WPP_F::property_label( &#x27;singular&#x27; ),WPP_F::property_label( &#x27;plural&#x27; ) );
            }

            WPP_Mail::feps_post_status_updated( $post_ID, array_filter( array(
              &#x27;subject&#x27; =&gt; !empty( $subject ) ? $subject : false,
              &#x27;message&#x27; =&gt; !empty( $message ) ? $message : false,
              &#x27;crm_log_message&#x27; =&gt; !empty( $crm_log_message ) ? $crm_log_message : false,
              &#x27;data&#x27; =&gt; array_filter( array(
                &#x27;days&#x27; =&gt; !empty( $days ) ? $days : false,
                &#x27;url&#x27; =&gt; WPP_F::base_url( FEPS_VIEW_PAGE, &quot;status={$post_after-&gt;post_status}&quot; ),
                &#x27;status&#x27; =&gt; @$wp_post_statuses[$post_after-&gt;post_status]-&gt;label,
              ) ),
            ) ) );

          }
          break;

        case &#x27;trash&#x27;:
          delete_post_meta( $post_ID, FEPS_META_EXPIRED );
          //** Subscription plan must be provided only for published properties */
          delete_post_meta( $post_ID, FEPS_META_PLAN );

          if ( $form[&#x27;notifications&#x27;][&#x27;on_status_updated&#x27;]==&#x27;true&#x27; ) {
            if( $post_before-&gt;post_status == &#x27;pending&#x27; ) {
              $message = sprintf(__(&#x27;Hello [display_name]%1$s%1$sPending time for Your %2$s [property_title] was over and it had been removed.%1$s%1$sYou still able to make a new %2$s Submission if you need. Please visit our site:%1$s[site_url]&#x27;, &#x27;wpp&#x27;), PHP_EOL,WPP_F::property_label( &#x27;singular&#x27; ) );
            } else {
              $message = sprintf(__(&#x27;Hello [display_name]%1$s%1$sYour %2$s [property_title] has been removed.%1$s%1$sYou still able to make a new %2$s Submission if you need. Please visit our site:%1$s[site_url]&#x27;, &#x27;wpp&#x27;), PHP_EOL,WPP_F::property_label( &#x27;singular&#x27; ) );
            }
            WPP_Mail::feps_post_status_updated( $post_ID, array(
              &#x27;subject&#x27; =&gt; sprintf(__(&#x27;%1$s was deleted&#x27;, &#x27;wpp&#x27;),ucfirst( WPP_F::property_label( &#x27;singular&#x27; ) ) ),
              &#x27;message&#x27; =&gt; $message,
              &#x27;crm_log_message&#x27; =&gt; sprintf(__(&#x27;%1$s [property_title] was deleted .&#x27;, &#x27;wpp&#x27;),ucfirst( WPP_F::property_label( &#x27;singular&#x27; ) ) ),
            ) );
          }
          break;

        case &#x27;publish&#x27;:
          if( $post_before-&gt;post_status == &#x27;trash&#x27; ) {
            wp_update_post( array(
              &#x27;ID&#x27; =&gt; $post_ID,
              &#x27;post_status&#x27; =&gt; &#x27;pending&#x27;,
            ) );
            break;
          } else {
            //** Subscription plan functionality is related only to Sponsored listings */
            if( !empty( $form[ &#x27;feps_credits&#x27; ] ) &amp;&amp; $form[ &#x27;feps_credits&#x27; ] == &#x27;true&#x27; ) {
              //* Determine if user has permissions to manually publish FEPS and set its subscription plan */
              if ( !empty( $_REQUEST[ &#x27;feps_subscription_plan&#x27; ] ) &amp;&amp;
                   !empty( $form[&#x27;subscription_plans&#x27;][ $_REQUEST[ &#x27;feps_subscription_plan&#x27; ] ] ) &amp;&amp;
                   current_user_can( self::$capability ) ) {
                $subscription_plan_data =  $form[&#x27;subscription_plans&#x27;][ $_REQUEST[ &#x27;feps_subscription_plan&#x27; ] ];
                update_post_meta( $post_ID, FEPS_META_PLAN, $subscription_plan_data );
              }
              //* Set Expired Time meta based on subscription plan. Note: Subscription plan should be added before wp_update_post */
              if ( $plan = get_post_meta( $post_ID, FEPS_META_PLAN, true ) ) {
                if ( !empty( $plan[&#x27;duration&#x27;][&#x27;value&#x27;] ) &amp;&amp; !empty( $plan[&#x27;duration&#x27;][&#x27;interval&#x27;] ) ) {
                  $value = (int)$plan[&#x27;duration&#x27;][&#x27;value&#x27;];
                  $interval = $plan[&#x27;duration&#x27;][&#x27;interval&#x27;] . ( $value &gt; 1 ? &quot;s&quot; : &quot;&quot; );
                  $expired_time = @strtotime( &quot;+{$value} {$interval}&quot; );
                  if ( $expired_time ) {
                    update_post_meta( $post_ID, FEPS_META_EXPIRED, $expired_time );
                  }
                }
              }
            }
            //** Action on submission approving (publishing) **/
            do_action(&#x27;wpp_feps_submission_approved&#x27;, $post_ID );
          }
          break;

        default:
          delete_post_meta( $post_ID, FEPS_META_EXPIRED );
          //** Subscription plan must be provided only for published properties */
          delete_post_meta( $post_ID, FEPS_META_PLAN );
          break;
      }
    }

    self::remove_extra_attachments( $post_ID );
  }


  /**
   * Look up e-mail address
   * @global object $current_user
   * @param string $user_email
   * @param string $user_password
   * @return array
   */
  function email_lookup($user_email, $user_password) {
    global $current_user;

    if ( !empty( $current_user-&gt;ID ) ) {
      return array(&#x27;email_exists&#x27; =&gt; &#x27;true&#x27;, &#x27;credentials_verified&#x27; =&gt; &#x27;true&#x27;);
    }

    if(!empty($user_email) &amp;&amp; $user_id = email_exists($user_email)) {

      //* If password is passed, verify */
      if(!empty($user_password)) {

      $userdata = get_user_by(&#x27;id&#x27;, $user_id);

      if(wp_check_password($user_password, $userdata-&gt;user_pass, $user_id)) {
        return array(&#x27;email_exists&#x27; =&gt; &#x27;true&#x27;, &#x27;credentials_verified&#x27; =&gt; &#x27;true&#x27;);
      } else {
        return array(&#x27;email_exists&#x27; =&gt; &#x27;true&#x27;, &#x27;invalid_credentials&#x27; =&gt; &#x27;true&#x27;);
      }

      } else {
        return array(&#x27;email_exists&#x27; =&gt; &#x27;true&#x27;);
      }

    } else {
      return array(&#x27;email_exists&#x27; =&gt; &#x27;false&#x27;);
    }

  }

  /**
   * Adds Custom capability to the current premium feature
   * @param array $capabilities
   * @author korotkov@ud
   * @return array
   */
  function add_capability($capabilities) {

    $capabilities[self::$capability] = __(&#x27;Manage FEPS&#x27;, &#x27;wpp&#x27;);

    return $capabilities;
  }


  /**
   * WPP template redirect.
   *
   * @todo Add a shortcode listener to wpp_template_redirect() in order detect if the current page has a FEPS form on it, if so, properly load the JS files. Also use wp_localize_script() so strings in fileuploader.js can be translated. - potanin@ud
   *
   * @global object $wp_query
   * @global object $post
   * @return null
   */
  function wpp_template_redirect() {
    global $wp_query, $post;

    //** STEP 1. Determine if this is My FEPS Page */
    if( isset( $wp_query-&gt;wpp_my_feps_page ) &amp;&amp; $wp_query-&gt;wpp_my_feps_page === true ) {
      do_action( &quot;wpp_my_feps_page&quot; );
    }

    //** STEP 2. Determine if this is FEPS Edit Page */
    if( isset( $wp_query-&gt;wpp_feps_edit_page ) &amp;&amp; $wp_query-&gt;wpp_feps_edit_page === true ) {
      do_action( &quot;wpp_feps_edit_page&quot; );
    }

    //** STEP 3. Determine if this is View Pending Page */
    if( isset( $_REQUEST[&#x27;wpp_front_end_action&#x27;] ) &amp;&amp;
        &#x27;wpp_view_pending&#x27; == $_REQUEST[&#x27;wpp_front_end_action&#x27;] &amp;&amp;
        $wp_query-&gt;query_vars[&#x27;p&#x27;] &amp;&amp;
        !empty($_REQUEST[&#x27;pending_hash&#x27;]) ) {

      $maybe_post = WPP_F::get_property($wp_query-&gt;query_vars[&#x27;p&#x27;]);

      if($_REQUEST[&#x27;pending_hash&#x27;] != $maybe_post[&#x27;wpp::feps::pending_hash&#x27;]) {
        return;
      }

      $post = WPP_F::array_to_object($maybe_post);

      add_action(&quot;template_redirect_single_property&quot;, array(&quot;class_wpp_feps&quot;, &quot;template_redirect_single_property&quot;));
    }

    //** STEP 4. Determine if this is FEPS Credit Adding Page */
    if( isset( $wp_query-&gt;wpp_feps_spc_page ) &amp;&amp; $wp_query-&gt;wpp_feps_spc_page === true ) {
      do_action( &quot;wpp_feps_spc_page&quot; );
    }
  }


  /**
   * Fix 404 error on pending property pages.
   *
   * @global object $query
   */
  function fix_404($query) {
    global $wp, $wp_query, $wpdb;

    $_is_404 = true;

    //** STEP 1. Determine if this is My FEPS Page */
    if( $wp-&gt;request == FEPS_VIEW_PAGE ||
        $wp-&gt;query_string == &quot;p=&quot; . FEPS_VIEW_PAGE ||
        $query-&gt;query_vars[ &#x27;pagename&#x27; ] == FEPS_VIEW_PAGE ||
        $query-&gt;query_vars[ &#x27;category_name&#x27; ] == FEPS_VIEW_PAGE
    ) {
      $wp_query-&gt;wpp_my_feps_page = true;
      $_is_404 = false;
    }

    //* STEP 2. Determine if this is View Pending Page */
    if( &#x27;wpp_view_pending&#x27; == $_REQUEST[&#x27;wpp_front_end_action&#x27;] &amp;&amp; $query-&gt;query_vars[&#x27;p&#x27;] &amp;&amp; !empty( $_REQUEST[&#x27;pending_hash&#x27;] ) ) {
      $pending_hash = $wpdb-&gt;get_var( $wpdb-&gt;prepare( &quot;
        SELECT meta_value
          FROM {$wpdb-&gt;postmeta}
          WHERE post_id = %d
            AND meta_key = &#x27;wpp::feps::pending_hash&#x27;
            AND meta_value = %s
      &quot;, $wp_query-&gt;query_vars[&#x27;p&#x27;], $_REQUEST[&#x27;pending_hash&#x27;] ) );

      if( $pending_hash ) {
        $_is_404 = false;
      }
    }

    //* STEP 3. Determine if this is FEPS Edit Page */
    if( !empty( $_REQUEST[&#x27;feps&#x27;] ) &amp;&amp; (
        $wp-&gt;request == FEPS_EDIT_PAGE ||
        $wp-&gt;query_string == &quot;p=&quot; . FEPS_EDIT_PAGE ||
        $query-&gt;query_vars[ &#x27;pagename&#x27; ] == FEPS_EDIT_PAGE ||
        $query-&gt;query_vars[ &#x27;category_name&#x27; ] == FEPS_EDIT_PAGE )
    ) {
      $property_id = $wpdb-&gt;get_var( $wpdb-&gt;prepare( &quot;SELECT ID FROM {$wpdb-&gt;posts} WHERE ID = %d&quot;, $_REQUEST[&#x27;feps&#x27;] ) );

      if( $property_id ) {
        //** Additional secure: be sure that request has hash of feps form id and it&#x27;s the same with the current property&#x27;s form */
        $form_id = get_post_meta( $property_id, FEPS_META_FORM, true );
        if( !empty( $form_id ) &amp;&amp; isset( $_REQUEST[ &#x27;wpp_feps_form&#x27; ] ) &amp;&amp; $_REQUEST[ &#x27;wpp_feps_form&#x27; ] == md5( $form_id ) ) {
          $wp_query-&gt;wpp_feps_edit_page = true;
          $_is_404 = false;
        }
      }
    }

    //* STEP 4. Go through filters */
    $_is_404 = apply_filters( &#x27;wpp::feps::fix_404&#x27;, $_is_404, $query );

    //* STEP 5. Fix 404 if we have page */
    if ( !$_is_404 ) {
      //** Set to override the 404 status */
      add_action(&#x27;wp&#x27;, create_function(&#x27;&#x27;, &#x27;status_header( 200 );&#x27;));

      //** Prevent is_404() in template files from returning true */
      add_action(&#x27;template_redirect&#x27;, create_function(&#x27;&#x27;, &#x27; global $wp_query; $wp_query-&gt;is_404 = false;&#x27;), 0, 10);
    }
  }

  /**
   * Single Property template redirect
   *
   * Add all pending-property specific hooks and filters here.
   *
   * @global object $post
   * @global object $wp_query
   */
  function template_redirect_single_property() {
    global $post, $wp_query;

    add_action(&#x27;wp_head&#x27;, create_function(&#x27;&#x27;, &quot;do_action(&#x27;wp_head_single_property&#x27;); &quot;));

    $wp_query = apply_filters( &#x27;wpp_pending_template_query&#x27;, $wp_query, $post );

    add_filter(&#x27;the_title&#x27;, array(&#x27;class_wpp_feps&#x27;, &#x27;feps_the_title&#x27;), 0, 2);

    add_action(&#x27;body_class&#x27;, array(&#x27;class_wpp_feps&#x27;, &#x27;feps_body_class&#x27;));

  }

  /**
   * Modify FEPS (unapproved property) title.
   *
   * @param string $title The current title of a property.
   * @param int $post_id The ID of the currently viewed property.
   * @return string
   */
  function feps_the_title( $title, $post_id = false) {
    global $post;

    //** Make sure only the globally displayed property */
    if($post-&gt;ID != $post_id) {
      return $title;
    }

    return $title . __(&#x27; (Pending Approval)&#x27;, &#x27;wpp&#x27;);

  }

  /**
   * Add custom body class for feps pending properties
   *
   * @param array $classes
   * @return Array
   */
  function feps_body_class( $classes = array() ) {
    global $post;

    if($post_status = $post-&gt;post_status) {
      $classes[] = &#x27;wpp_&#x27; . $post_status;
    }

    $classes[] = &#x27;feps-pending&#x27;;

    return $classes;

  }


  /**
   * Update permalink of FEPS property if it has status pending and
   * current user is author of this FEPS property
   *
   * @param array $_property
   * @author peshkov@UD
   * @since 1.4
   * @version 0.1
   */
  function get_feps_permalink( $_property = false, $_is_logged_in = true ) {
    global $property;

    if ( empty( $_property ) ) {
      if ( empty( $property ) ) return false;
      $_property = $property;
    }

    if ( $_is_logged_in ) {
      $_break = true;
      if ( is_user_logged_in() ) {
        $user = wp_get_current_user();
        if( $_property[&#x27;post_author&#x27;] == $user-&gt;ID ) {
          $_break = false;
        }
      }
      if ( $_break ) {
        return $_property[&#x27;permalink&#x27;];
      }
    }

    if ( $_property[&#x27;post_status&#x27;] == &#x27;pending&#x27; &amp;&amp;
         $_property[&#x27;wpp_feps_property&#x27;] == true &amp;&amp;
         strpos( $_property[&#x27;permalink&#x27;], &quot;pending_hash={$_property[&#x27;wpp::feps::pending_hash&#x27;]}&quot; ) === false
    ) {
      return $_property[&#x27;permalink&#x27;].&#x27;&amp;pending_hash=&#x27;.$_property[&#x27;wpp::feps::pending_hash&#x27;].&#x27;&amp;wpp_front_end_action=wpp_view_pending&#x27;;
    }

    return $_property[&#x27;permalink&#x27;];
  }


  /**
   * Returns form data belongs to the passed post_id
   *
   * @global array $wp_properties
   * @param int $post_id
   * @return array|boolean
   * @author peshkov@UD
   * @since 2.0
   */
  function get_form_by_post( $post_id ) {
    global $wp_properties;

    $form_id = get_post_meta( $post_id, FEPS_META_FORM, true );
    if( !empty( $form_id ) &amp;&amp; !empty( $wp_properties[&#x27;configuration&#x27;][&#x27;feature_settings&#x27;][&#x27;feps&#x27;][&#x27;forms&#x27;][ $form_id ] ) ) {
      return $wp_properties[&#x27;configuration&#x27;][&#x27;feature_settings&#x27;][&#x27;feps&#x27;][&#x27;forms&#x27;][ $form_id ];
    }
    return false;
  }


  /**
   * Restores form data from md5 hash
   *
   * @global array $wp_properties
   * @param string $hash
   * @param boolean $onsubmit
   * @return array
   * @author peshkov@UD
   * @since 2.0
   */
  function get_form_by_md5( $hash, $onsubmit = true ) {
    global $wp_properties;

    $form = false;
    //** Get form_ID */
    $forms = $wp_properties[&#x27;configuration&#x27;][&#x27;feature_settings&#x27;][&#x27;feps&#x27;][&#x27;forms&#x27;];
    if( is_array( $forms ) ) {
      //** Cycle through forms and match up with passed md5 hash */
      foreach( $forms as $form_id =&gt; $form_data ) {
        if( md5( $form_id ) == $hash ) {
          $form = $form_data;
          $form[ &#x27;form_id&#x27; ] = $form_id;
          break;
        }
      }
    }
    if( !empty( $form ) ) {
      //** Filter form data to be able to control the process */
      if( $onsubmit ) {
        $form = apply_filters( &#x27;wpp_feps_submit_property_form&#x27;, $form );
      } else {
        $form = apply_filters( &#x27;wpp_feps_edit_property_form&#x27;, $form );
      }
    }
    return $form;
  }


  /**
   * AJAX create/edit FEPS property
   *
   * @global array $wp_properties
   * @author peshkov@UD
   * @since 2.0
   */
  function ajax_feps_save_property() {
    global $wp_properties;

    $response = array(
      &#x27;success&#x27; =&gt; true,
      &#x27;credentials_verified&#x27; =&gt; false,
      &#x27;message&#x27; =&gt; &#x27;&#x27;,
      &#x27;callback&#x27; =&gt; false,
    );

    $event = __( &#x27;created&#x27;, &#x27;wpp&#x27; );

    try {

      $request = wp_parse_args( urldecode( $_REQUEST[ &#x27;data&#x27; ] ) );

      if( empty( $request[ &#x27;wpp_feps_data&#x27; ] ) ) {
        throw new Exception( __( &#x27;Submitting data is incorrect&#x27;, &#x27;wpp&#x27; ) );
      }

      $data = $request[ &#x27;wpp_feps_data&#x27; ];

      //** Verify nonce */
      if( !WPP_F::verify_nonce( $request[&#x27;nonce&#x27;], &#x27;submit_feps&#x27; ) ) {
        throw new Exception( sprintf( __( &#x27;%s submitting is prohibited&#x27;, &#x27;wpp&#x27; ), WPP_F::property_label() ) );
      }

      //** Create new property */
      if( empty( $request[&#x27;wpp_feps_data&#x27;][ &#x27;post&#x27; ] ) ) {

        if( is_user_logged_in() ) {
          $response[ &#x27;credentials_verified&#x27; ] = true;
          $current_user = wp_get_current_user();
          $data[ &#x27;user_id&#x27; ] = $current_user-&gt;ID;
        }

        //** Verify user credentials if they are passed */
        if( !$response[ &#x27;credentials_verified&#x27; ] &amp;&amp; $data[&#x27;user_email&#x27;] &amp;&amp; $data[&#x27;user_password&#x27;]) {
          $data[ &#x27;user_id&#x27; ] = email_exists( $data[&#x27;user_email&#x27;] );
          if( wp_check_password( $data[&#x27;user_password&#x27;], get_user_by(&#x27;email&#x27;, $data[&#x27;user_email&#x27;] )-&gt;user_pass, $data[ &#x27;user_id&#x27; ] ) ) {
            $response[ &#x27;credentials_verified&#x27; ] = true;
            do_action(&#x27;wpp_feps_credentials_verified&#x27;, $data );
          }
        }

        //** We have a new user */
        if( !$response[ &#x27;credentials_verified&#x27; ] ) {
          $form_data = self::get_form_by_md5( $data[&#x27;form_id&#x27;] );
          if( !$form_data ) {
            throw new Exception( __(&#x27;An error occurred, the form could not be found&#x27;, &#x27;wpp&#x27; ) );
          }
          $new_user[&#x27;user_login&#x27;] = $data[&#x27;user_email&#x27;];
          $new_user[&#x27;role&#x27;] = $form_data[&#x27;new_role&#x27;];
          $new_user[&#x27;user_email&#x27;] = $data[&#x27;user_email&#x27;];
          $new_user[&#x27;user_pass&#x27;] = wp_generate_password();
          $data[ &#x27;user_id&#x27; ] = wp_insert_user($new_user);
          if( is_wp_error( $data[ &#x27;user_id&#x27; ] ) ) {
            throw new Exception( sprintf( __( &#x27;Your submission was not successful: %s&#x27;, &#x27;wpp&#x27; ), $data[ &#x27;user_id&#x27; ]-&gt;get_error_message() ) );
          }
        }

        $property = self::submit_property( $data );

        //** Check for any issues on creating new property */
        if( is_wp_error( $property ) ) {
          throw new Exception( $property-&gt;get_error_message() );
        }

        if( !$response[ &#x27;credentials_verified&#x27; ] ) {
          do_action( &#x27;wpp_feps_account_created&#x27;, array(
            &#x27;user_id&#x27; =&gt; $data[ &#x27;user_id&#x27; ],
            &#x27;new_user&#x27; =&gt; $new_user,
            &#x27;form_data&#x27; =&gt; $form_data,
            &#x27;property_id&#x27; =&gt; $property
          ));
        }
      }

      //** Edit existing property */
      else {

        $event = __( &#x27;updated&#x27;, &#x27;wpp&#x27; );

        if( !is_user_logged_in() ) {
          throw new Exception( __(&#x27;You must be logged in to edit %s&#x27;, &#x27;wpp&#x27; ), WPP_F::property_label() );
        }

        $property = self::edit_property( $data );

        //** Check for any issues on creating new property */
        if( is_wp_error( $property ) ) {
          throw new Exception( $property-&gt;get_error_message() );
        }

        $response[ &#x27;credentials_verified&#x27; ] = true;

      }

    } catch (Exception $e) {
      $response[ &#x27;success&#x27; ] = false;
      $response[ &#x27;message&#x27; ] = $e-&gt;getMessage();
    }

    if( $response[ &#x27;success&#x27; ] == true ) {
      //** Do something we need after submit */
      if( $response[ &#x27;credentials_verified&#x27; ] ) {
        $response[ &#x27;message&#x27; ] = sprintf( __( &#x27;Your %s has been successfully %s.&#x27;, &#x27;wpp&#x27; ), WPP_F::property_label(), $event );
      } else {
        $response[ &#x27;message&#x27; ] = sprintf( __( &#x27;Your %s and Account have been successfully %s. Check your e-mail to activate account and log in for continuing.&#x27;, &#x27;wpp&#x27; ), WPP_F::property_label(), $event );
      }
      $response[ &#x27;callback&#x27; ] = apply_filters( &#x27;wpp::feps::save::callback&#x27;, self::get_feps_permalink( $property, false ), $property, $request );
    }

    die( json_encode( $response ) );

  }


  /**
   * Submit new property
   *
   * @author peshkov@UD
   * @since 2.0
   */
  function submit_property( $data ) {
    global $wp_properties;

    try {

      $form_data = self::get_form_by_md5( $data[&#x27;form_id&#x27;] );

      if( !$form_data ) {
        throw new Exception( __(&#x27;An error occurred, the form could not be found&#x27;, &#x27;wpp&#x27; ) );
      }

      $new_property = array(
        &#x27;post_content&#x27; =&gt; $data[&#x27;post_content&#x27;],
        &#x27;post_parent&#x27;  =&gt; $data[&#x27;parent_id&#x27;],
        // Prevent XSS. Wondered why WP did not do that inside of wp_insert_post();
        &#x27;post_title&#x27;   =&gt; htmlspecialchars( strip_tags( $data[&#x27;post_title&#x27;] ) ),
        &#x27;post_author&#x27;  =&gt; $data[ &#x27;user_id&#x27; ],
        &#x27;post_status&#x27;  =&gt; $form_data[&#x27;new_post_status&#x27;],
        &#x27;post_type&#x27;    =&gt; &#x27;property&#x27;
      );

      //** Commit basic property data to database */
      $property_id = wp_insert_post( $new_property );

      //** Check for any issues inserting property */
      if( is_wp_error($property_id) ) {
        throw new Exception( $property_id-&gt;get_error_message() );
      }

      //** Mark property as FEPS */
      update_post_meta( $property_id, &#x27;wpp_feps_property&#x27;, true );

      //** Set property type */
      update_post_meta( $property_id, &#x27;property_type&#x27;, $form_data[&#x27;property_type&#x27;] );

      //** Set pending hash */
      update_post_meta( $property_id, &#x27;wpp::feps::pending_hash&#x27;, md5($property_id.$data[ &#x27;user_id&#x27; ]) );

      //** Store form_id in property meta */
      update_post_meta( $property_id , FEPS_META_FORM, $form_data[ &#x27;form_id&#x27; ] );

      //** If FEPS has pending status, set Expired Time for it. */
      if ( &#x27;pending&#x27; == $form_data[&#x27;new_post_status&#x27;] &amp;&amp; (int)$form_data[&#x27;trash_time&#x27;] &gt; 0 ) {
        $expired_time = ( (int)$form_data[&#x27;trash_time&#x27;] * 86400 ) + time();
        update_post_meta( $property_id, FEPS_META_EXPIRED, $expired_time );
      }

      self::update_feps_data( $property_id, $data, $form_data );

      $property = WPP_F::get_property( $property_id );

      do_action( &#x27;wpp_feps_submitted&#x27;, $property_id );

    } catch (Exception $e) {
      $property = new WP_Error( &#x27;error&#x27;, $e-&gt;getMessage() );
    }

    return $property;
  }


  /**
   *
   * @global object $current_user
   * @global array $wp_properties
   * @param type $data
   */
  function edit_property( $data ) {

    try {

      $form_data = self::get_form_by_md5( $data[&#x27;form_id&#x27;], false );

      if( !$form_data ) {
        throw new Exception( __(&#x27;An error occurred, the form could not be found&#x27;, &#x27;wpp&#x27; ) );
      }

      $property_id = $data[&#x27;post&#x27;];

      $post_table = array(
        &#x27;ID&#x27;   =&gt; $property_id,
        //** Prevent XSS. Wondered why WP did not do that inside of wp_insert_post(); */
        &#x27;post_title&#x27;   =&gt; htmlspecialchars( strip_tags( $data[&#x27;post_title&#x27;] ) ),
        &#x27;post_content&#x27; =&gt; $data[&#x27;post_content&#x27;],
      );

      wp_update_post( $post_table );

      self::update_feps_data( $property_id, $data, $form_data );

      $property = WPP_F::get_property( $property_id );

    } catch (Exception $e) {
      $property = new WP_Error( &#x27;error&#x27;, $e-&gt;getMessage() );
    }

    return $property;

  }


  /**
   * Updates property&#x27;s data
   *
   * @param int $property_id
   * @param array $data
   * @param array $form_data
   * @return boolean
   * @author peshkov@UD
   * @since 2.0
   */
  function update_feps_data( $property_id, $data, $form_data ) {

    if( empty( $form_data ) || !is_array( $form_data ) ) {
      return false;
    }

    foreach( (array)$form_data[&#x27;fields&#x27;] as $attribute ) {

      //** Check if an attribute has been passed */
      $attribute_data = WPP_F::get_attribute_data($attribute[&#x27;attribute&#x27;]);

      switch( $attribute_data[&#x27;storage_type&#x27;] ) {

        case &#x27;meta_key&#x27;:
          $value = $data[$attribute[&#x27;attribute&#x27;]];
          $meta_values[$attribute[&#x27;attribute&#x27;]] = $value;
          if($attribute_data[&#x27;currency&#x27;] || $attribute_data[&#x27;numeric&#x27;]) {
            $value = str_replace(array(&quot;$&quot;, &quot;,&quot;), &#x27;&#x27;, $value);
          }
          if ( !is_array( $value ) ) {
            $value = strip_tags($value);
          }
          update_post_meta($property_id, $attribute[&#x27;attribute&#x27;], $value);
          break;

        case &#x27;post_table&#x27;:
          //** Do nothing - already added by  wp_update_post();
          break;

        case &#x27;image_upload&#x27;:
          //** Removing images that need to be removed */
          foreach ((array)$data[$attribute[&#x27;attribute&#x27;]] as $attachmentid=&gt;$action){
            if ($action==&#x27;off&#x27;){
              //** Get data from request */
              wp_delete_attachment( $attachmentid );
            }
          }
          //** Move over any uploaded images */
          $this_session = $data[&#x27;this_session&#x27;];
          $upload_dir = wp_upload_dir();
          $feps_files_dir = $upload_dir[&#x27;basedir&#x27;] . &#x27;/feps_files/&#x27; . $this_session;
          //** Check if a directory exists */
          if(is_dir($feps_files_dir)) {
            /** WordPress Image Administration API */
            require_once(ABSPATH . &#x27;wp-admin/includes/image.php&#x27;);
            /** WordPress Media Administration API */
            require_once(ABSPATH . &#x27;wp-admin/includes/media.php&#x27;);
            if ($handle = opendir($feps_files_dir)) {
              while (false !== ($file = readdir($handle))) {
                if ($file != &quot;.&quot; &amp;&amp; $file != &quot;..&quot;) {
                  if(file_is_valid_image($feps_files_dir . &#x27;/&#x27; . $file)) {
                    $moved_images[]  = class_wpp_feps::move_image($property_id, $feps_files_dir . &#x27;/&#x27; . $file);
                  }
                }
              }
              //** Delete folder */
              unlink($feps_files_dir . &#x27;/index.php&#x27;);
              rmdir($feps_files_dir);
            }
          }
          break;

        case &#x27;taxonomy&#x27;:
          //** Not yet supported - no UI for this */
          //wp_set_post_terms();
        break;

        default:
          do_action(&#x27;wpp_feps_commit_attribute&#x27;, $attribute, $property_id );
        break;

      }
    }

    return true;
  }


  /**
   * Handles FEPS upgrades
   *
   * @author peshkov@UD
   * @since 1.4
   */
  function _handle_upgrade() {
    global $wpdb,$wp_properties;

    if( version_compare( WPP_FEPS_Version, get_option( &#x27;WPP_FEPS_Version&#x27; ) ) ) {

      $messages = array( sprintf( __( &#x27;Upgraded FEPS to version %1s.&#x27;, &#x27;wpp&#x27; ), WPP_FEPS_Version ) );

      switch ( WPP_FEPS_Version ) {

        case &#x27;1.4&#x27;:

          $forms = $wp_properties[&#x27;configuration&#x27;][&#x27;feature_settings&#x27;][&#x27;feps&#x27;][&#x27;forms&#x27;];
          $types = array();
          foreach ((array)$forms as $form_id =&gt; $form_data){
            if (!in_array($form_data[&#x27;property_type&#x27;],$types)){
              $query  = &quot;
                SELECT p.ID
                  FROM {$wpdb-&gt;posts} AS p
                  JOIN {$wpdb-&gt;postmeta} AS pm ON pm.post_id = p.ID
                  JOIN {$wpdb-&gt;postmeta} AS pmt ON pmt.post_id = p.ID
                  WHERE pm.meta_key = &#x27;wpp_feps_property&#x27;
                  AND pm.meta_value = &#x27;1&#x27;
                  AND pmt.meta_key = &#x27;property_type&#x27;
                  AND pmt.meta_value = &#x27;{$form_data[&#x27;property_type&#x27;]}&#x27;
                  AND p.post_status IN (&#x27;publish&#x27;, &#x27;pending&#x27;)

              &quot;;
              $feps = $wpdb-&gt;get_results($query, ARRAY_A);
              foreach ((array)$feps as $value){
                update_post_meta($value[&#x27;ID&#x27;], FEPS_META_FORM,$form_id);
              }
              $types[] = $form_data[&#x27;property_type&#x27;];
            }
          }

          //** Updating on WPP_FEPS_failed_fepses_after_upgrade option */
          class_wpp_feps::update_failed_fepses_cnt_after_upgrade();

          $wpdb-&gt;query( &quot;UPDATE {$wpdb-&gt;postmeta} SET meta_key = &#x27;&quot; . FEPS_META_FORM . &quot;&#x27; WHERE meta_key = &#x27;wpp_feps_form_id&#x27; &quot; );
          $wpdb-&gt;query( &quot;UPDATE {$wpdb-&gt;postmeta} SET meta_key = &#x27;wpp::feps::pending_hash&#x27; WHERE meta_key = &#x27;wpp_feps_pending_hash&#x27; &quot; );
        break;

      }

      WPP_F::log( implode( &#x27; &#x27;, (array) $messages ), &#x27;FEPS&#x27; );

    }

    update_option( &#x27;WPP_FEPS_Version&#x27;, WPP_FEPS_Version );
  }


  /**
   * Trying to know a count of FEPSes which had been left without FEPS_META_FORM.
   * It can be possible if we already have FEPSes with one property_type
   * but we have no FEPS form with the same property_type;
   */
  function update_failed_fepses_cnt_after_upgrade(){
    global $wpdb;

    $query  = &quot;
      SELECT pmt.meta_value as property_type, count(p.ID) as CNT
      FROM {$wpdb-&gt;posts}  AS p
      JOIN {$wpdb-&gt;postmeta}  AS pm ON (pm.post_id = p.ID and pm.meta_key = &#x27;wpp_feps_property&#x27; and pm.meta_value = &#x27;1&#x27;)
      JOIN {$wpdb-&gt;postmeta}  AS pmt ON (pmt.post_id = pm.post_id and pmt.meta_key = &#x27;property_type&#x27;)
      left outer JOIN {$wpdb-&gt;postmeta}  AS pmf ON (pmt.post_id=pmf.post_id and pmf.meta_key = &#x27;&quot; . FEPS_META_FORM . &quot;&#x27;)
      WHERE
      p.post_status IN (&#x27;publish&#x27;, &#x27;pending&#x27;)
      and pmf.meta_value is null
      GROUP by 1
    &quot;;

    $failed_feps = $wpdb-&gt;get_results($query, ARRAY_A);

    if (!empty($failed_feps)){
      //** if had found another one than do update_option() */
      update_option( &#x27;WPP_FEPS_failed_fepses_after_upgrade&#x27;, $failed_feps );
    }else{
      //** otherwise delete this option, so this notice will never being shown */
      delete_option( &#x27;WPP_FEPS_failed_fepses_after_upgrade&#x27; );
    }

    return $failed_feps;

  }


  /**
   * Moves images from temporary directory to real folder
   *
   * @since 0.1
   */
  function move_image($post_id, $old_path, $post_data = array()) {

    require_once(ABSPATH . &#x27;wp-admin/includes/file.php&#x27;);
    require_once(ABSPATH . &#x27;wp-admin/includes/image.php&#x27;);
    require_once(ABSPATH . &#x27;wp-admin/includes/media.php&#x27;);

    $uploads = wp_upload_dir($time);

    $original_filename = basename ($old_path);

    $filename = wp_unique_filename( $uploads[&#x27;path&#x27;], $original_filename);

    $new_file = $uploads[&#x27;path&#x27;] . &quot;/$filename&quot;;

    $file_data = wp_check_filetype_and_ext($old_path, $original_filename);

    if(!rename($old_path, $new_file)) {
      return false;
    }

    // Set correct file permissions
    $stat = stat( dirname( $new_file ));
    $perms = $stat[&#x27;mode&#x27;] &amp; 0000666;
    @ chmod( $new_file, $perms );

    $moved_image = apply_filters( &#x27;wpp_handle_upload&#x27;, array(
      &#x27;file&#x27; =&gt; $new_file,
      &#x27;url&#x27; =&gt; $uploads[&#x27;url&#x27;] . &quot;/$filename&quot;,
      &#x27;type&#x27; =&gt; $file_data[&#x27;type&#x27;]
    ), &#x27;upload&#x27; );


    // use image exif/iptc data for title and caption defaults if possible
    if ( $image_meta = @wp_read_image_metadata($new_file) ) {
      if ( trim( $image_meta[&#x27;title&#x27;] ) &amp;&amp; ! is_numeric( sanitize_title( $image_meta[&#x27;title&#x27;] ) ) ) {
        $title = $image_meta[&#x27;title&#x27;];
      }
      if ( trim( $image_meta[&#x27;caption&#x27;] ) ) {
        $content = $image_meta[&#x27;caption&#x27;];
      }
    }

    if(empty($image_meta[&#x27;title&#x27;])) {
      $image_meta[&#x27;title&#x27;] = preg_replace(&#x27;/\.[^.]+$/&#x27;, &#x27;&#x27;, basename($new_file));
    }

    // Construct the attachment array
    $attachment = array_merge( array(
      &#x27;post_parent&#x27; =&gt; $post_id,
      &#x27;post_mime_type&#x27; =&gt; $file_data[&#x27;type&#x27;],
      &#x27;guid&#x27; =&gt; $moved_image[&#x27;url&#x27;],
      &#x27;post_title&#x27; =&gt; $image_meta[&#x27;title&#x27;],
      &#x27;post_content&#x27; =&gt; $image_meta[&#x27;caption&#x27;],
    ), $post_data );


    // Save the data
    $id = wp_insert_attachment($attachment, $new_file, $post_id);

    if ( !is_wp_error($id) ) {
      wp_update_attachment_metadata( $id, wp_generate_attachment_metadata( $id, $new_file ) );
    }

    return $id;

  }


  /**
   * Displays notices on pending property pages on admin
   *
   * @author peshkov@UD
   * @since 0.1
   */
  function all_admin_notices() {
    global $wp_properties, $post;

    /**  */
    if( $post-&gt;post_type == &#x27;property&#x27; &amp;&amp; $post-&gt;post_status == &#x27;pending&#x27; &amp;&amp; current_user_can( &#x27;publish_wpp_properties&#x27; ) ) {
      //** Determine if the current pending property belongs to sponsored property form. If it does, we ignore notice. */
      $forms = $wp_properties[&#x27;configuration&#x27;][&#x27;feature_settings&#x27;][&#x27;feps&#x27;][&#x27;forms&#x27;];
      $form_id = get_post_meta( $post-&gt;ID, FEPS_META_FORM, true );
      if( !empty( $form_id ) &amp;&amp; !empty( $forms[ $form_id ] ) ) {
        $form = $forms[ $form_id ];
        if( isset( $form[ &#x27;feps_credits&#x27; ] ) &amp;&amp; $form[ &#x27;feps_credits&#x27; ] == &#x27;true&#x27; ) {
          return null;
        }
      }

      ?&gt;
      &lt;script type=&quot;text/javascript&quot;&gt;
        jQuery(document).ready(function() {
          if ( jQuery(&#x27;#publish&#x27;).length &gt; 0 ) {
            jQuery( &#x27;.wrap h2&#x27; ).after( &#x27;&lt;div class=&quot;wpp_property_admin_notice widget wp-core-ui&quot;&gt;&lt;span&gt;&lt;?php _e(&#x27;This listing is pending your approval.&#x27;); ?&gt;&lt;/span&gt;&lt;/div&gt;&#x27; );
            jQuery( &#x27;.wpp_property_admin_notice span&#x27; ).append( publish_now = document.createElement(&#x27;a&#x27;) );
            jQuery( publish_now )
              .attr(&#x27;href&#x27;, &#x27;javascript:void(0);&#x27;)
              .addClass( &#x27;button button-primary button-large&#x27; )
              .text(&#x27;&lt;?php _e(&#x27;Publish Now&#x27;); ?&gt;&#x27;)
              .click(function(){
                jQuery( this ).unbind( &#x27;click&#x27; );
                jQuery( &#x27;#publish&#x27; ).trigger( &#x27;click&#x27; );
              });
          }
        });
      &lt;/script&gt;
      &lt;?php
    }

  }


  /*
    * Render FEPS Admin notices
    *
    */
  function admin_notices() {
    global $wpdb,$current_screen,$wp_properties;

    //* Notice will be shown only on FEPS forms page */
    if($current_screen-&gt;id == &quot;property_page_page_feps&quot;){
      /**
       * and only if we have non-empty option.
       * This option can be setup for the first time
       * while upgrade from old version of FEPS
       */
      $need_rebuild_list = false;
      $failed_feps = get_option( &#x27;WPP_FEPS_failed_fepses_after_upgrade&#x27; );
      if($failed_feps){

        //** get current forms */
        $forms = $wp_properties[&#x27;configuration&#x27;][&#x27;feature_settings&#x27;][&#x27;feps&#x27;][&#x27;forms&#x27;];
        $form_types = array();
        foreach ((array)$forms as $form_id =&gt; $form_data){
          if (!in_array($form_data[&#x27;property_type&#x27;],$form_types)){
            $form_types[$form_id] = $form_data[&#x27;property_type&#x27;];
          }
        }

        foreach ((array)$failed_feps as $fepses){
          //** if current failed FEPS type in list of currently present forms */
          if (in_array($fepses[&#x27;property_type&#x27;],$form_types)){
            //* move FEPSes to that form */
            $query  = &quot;
              SELECT p.ID
                FROM {$wpdb-&gt;posts} AS p
                JOIN {$wpdb-&gt;postmeta} AS pm ON pm.post_id = p.ID
                JOIN {$wpdb-&gt;postmeta} AS pmt ON pmt.post_id = p.ID
                WHERE pm.meta_key = &#x27;wpp_feps_property&#x27;
                AND pm.meta_value = &#x27;1&#x27;
                AND pmt.meta_key = &#x27;property_type&#x27;
                AND pmt.meta_value = &#x27;{$fepses[&#x27;property_type&#x27;]}&#x27;
                AND p.post_status IN (&#x27;publish&#x27;, &#x27;pending&#x27;)
            &quot;;
            $feps = $wpdb-&gt;get_results($query, ARRAY_A);
            foreach ((array)$feps as $value){
              update_post_meta($value[&#x27;ID&#x27;], FEPS_META_FORM, array_search($fepses[&#x27;property_type&#x27;], $form_types));
            }
            //** if new form were added the we must renew list of falied FEPSes */
            $need_rebuild_list = true;
            //** and exclude this property type from the Notice */
            continue;
          }
          //** Add this type to Notice table */
          $types[] = sprintf(__(&#x27;&lt;tr&gt;&lt;td&gt;%1$s&lt;/td&gt;&lt;td&gt;%2$d %3$s;&lt;/td&gt;&lt;/tr&gt;&#x27;),$wp_properties[&#x27;property_types&#x27;][$fepses[&#x27;property_type&#x27;]],(int)$fepses[&#x27;CNT&#x27;],_n(WPP_F::property_label( &#x27;singular&#x27; ),WPP_F::property_label( &#x27;plural&#x27; ),(int)$fepses[&#x27;CNT&#x27;],&#x27;wpp&#x27;));
        }

        if ($types){
          echo sprintf(__(&#x27;&lt;div class=&quot;updated&quot;&gt;After upgrade version of FEPS Premium Feature there are number of FEPS %3$s has been left out and could not be linked to any of %2$s forms. Here\&#x27;s an overview:&lt;br&gt;&lt;br&gt;&lt;table class=\&#x27;widefat\&#x27;&gt;&lt;tr&gt;&lt;th&gt;%2$s Type&lt;/th&gt;&lt;th&gt;Issues count&lt;/th&gt;&lt;/tr&gt;%1$s&lt;/table&gt;&lt;br&gt;Please, create a new %2$s form for each listed %2$s types to solve this issue. &lt;/div&gt; &#x27;),  implode(PHP_EOL, (array)$types), WPP_F::property_label( &#x27;singular&#x27; ),WPP_F::property_label( &#x27;plural&#x27; )  );
        }

        if ($need_rebuild_list){
          class_wpp_feps::update_failed_fepses_cnt_after_upgrade();
        }
      }
    }
  }


  /**
   * Checks on FEPS Form removing if there are already added FEPS properties using the current form.
   *
   * @author peshkov@UD
   * @return JSON
   */
  function ajax_can_remove_form() {
    global $wpdb;

    $response = array(
      &#x27;success&#x27; =&gt; false,
      &#x27;message&#x27; =&gt; &#x27;&#x27;,
    );

    if( !empty( $_REQUEST[&#x27;feps_form_id&#x27;] ) ) {
      $form_id = $_REQUEST[&#x27;feps_form_id&#x27;];
      $r = $wpdb-&gt;get_var( $wpdb-&gt;prepare(&quot;
        SELECT post_id
          FROM $wpdb-&gt;postmeta
          WHERE meta_key = &#x27;&quot; . FEPS_META_FORM . &quot;&#x27;
            AND meta_value = %s
          LIMIT 1
      &quot;, $form_id) );
      if ( empty( $r ) ) {
        $response[&#x27;success&#x27;] = true;
      } else {
        $response[&#x27;message&#x27;] = __(&#x27;Form can not be removed because it has Properties which were added using this form. You have to remove all related Properties before.&#x27;,&#x27;wpp&#x27;);
      }
    } else {
      $response[&#x27;message&#x27;] = __(&#x27;Form ID is undefined.&#x27;,&#x27;wpp&#x27;);
    }

    die( json_encode( $response ) );
  }


  /**
   * Handles ajax file uploads
   *
   * Uploads submitted file into a temporary directory.
   * Handles one file at a time.
   *
   * @todo consider using wp_handle_upload() for this
   * @since 0.1
   */
  function ajax_feps_image_upload() {

    $file_name = $_REQUEST[&#x27;qqfile&#x27;];
    $this_session = $_REQUEST[&#x27;this_session&#x27;];

    $upload_dir = wp_upload_dir();
    $feps_files_dir = $upload_dir[&#x27;basedir&#x27;] . &#x27;/feps_files&#x27;;
    $wpp_queue_dir = $feps_files_dir .  &#x27;/&#x27; . $this_session;
    $wpp_queue_url = $upload_dir[&#x27;baseurl&#x27;] . &#x27;/feps_files/&#x27; . $this_session;

    if(!is_dir($feps_files_dir)) {
      mkdir($feps_files_dir, 0755);
    }

    if(!is_dir($wpp_queue_dir)) {
      mkdir($wpp_queue_dir, 0755);
      fopen($wpp_queue_dir . &#x27;/index.php&#x27;, &quot;w&quot;);
    }

    $path = $wpp_queue_dir . &#x27;/&#x27;. $file_name;

    if ( empty( $_FILES ) ) {

      $temp = tmpfile();
      $input = fopen(&quot;php://input&quot;, &quot;r&quot;);
      $realSize = stream_copy_to_stream($input, $temp);
      fclose($input);
      $target = fopen($path, &quot;w&quot;);
      fseek($temp, 0, SEEK_SET);
      stream_copy_to_stream($temp, $target);
      fclose($target);

    } else {
      // for IE!!!
      move_uploaded_file($_FILES[&#x27;qqfile&#x27;][&#x27;tmp_name&#x27;], $path);
    }

    /* if it is image */
    if ( getimagesize($path) ) {

      $return[&#x27;success&#x27;] = &#x27;true&#x27;;

      //** Need to get thumb URL */
      $return[&#x27;thumb_url&#x27;] = $wpp_queue_url . &#x27;/&#x27; . $file_name;

      $return[&#x27;url&#x27;] = $wpp_queue_url . &#x27;/&#x27; . $file_name;

      die(htmlspecialchars(json_encode($return), ENT_NOQUOTES));

    } else {
      unlink($path);
    }

    die(&#x27;false&#x27;);

  }

/**
  * Adds scripts and styles to slideshow pages.
  * @since 0.1
  */
  function admin_menu() {
    $feps_page = add_submenu_page(&#x27;edit.php?post_type=property&#x27;, sprintf(__(&#x27;%1$s Forms&#x27;,&#x27;wpp&#x27;), ucfirst( WPP_F::property_label( &#x27;singular&#x27; ) )), sprintf(__(&#x27;%1$s Forms&#x27;,&#x27;wpp&#x27;), ucfirst( WPP_F::property_label( &#x27;singular&#x27; ) )), self::$capability, &#x27;page_feps&#x27;,array(&#x27;class_wpp_feps&#x27;, &#x27;page_feps&#x27;));
  }

  /**
   * Load admin scripts
   * @global object $current_screen
   */
  function admin_enqueue_scripts() {
    global $current_screen;

    // Load scripts on specific pages
    switch($current_screen-&gt;id)  {

      case &#x27;property_page_page_feps&#x27;:
        wp_enqueue_script(&#x27;wp-property-backend-global&#x27;);
        wp_enqueue_script(&#x27;jquery-ui-tabs&#x27;);
        wp_enqueue_script(&#x27;jquery-ui-resizable&#x27;);
        wp_enqueue_script(&#x27;jquery-fancybox&#x27;);
        wp_enqueue_style (&#x27;jquery-fancybox&#x27;);
        wp_enqueue_script(&#x27;jquery-ui-sortable&#x27;);
        wp_enqueue_style (&#x27;jquery-fancybox-css&#x27;);

        break;
    }

  }


  /**
   * Updates permalink of FEPS property if it has status &#x27;pending&#x27;
   *
   * @uses wpp_get_property Filter
   * @param type $property
   * @author peshkov@UD
   * @since 1.4
   * @version 0.1
   */
  function wpp_get_property ( $property ) {
    $property[&#x27;permalink&#x27;] = self::get_feps_permalink( $property );
    return $property;
  }


  /**
   * Adds filter by FEPS form on Property overview page
   *
   * @author odokienko@UD
   * @author peshkov@UD
   * @since 2.0
   */
  function wpp_get_search_filters ( $filter ){
    global $wpdb, $wp_properties;

    $feps_forms = $wpdb-&gt;get_col( &quot;
      SELECT distinct meta_value as form_id
      FROM {$wpdb-&gt;postmeta}
      WHERE meta_key = &#x27;&quot; . FEPS_META_FORM . &quot;&#x27;
    &quot; );

    $forms = $wp_properties[&#x27;configuration&#x27;][&#x27;feature_settings&#x27;][&#x27;feps&#x27;][&#x27;forms&#x27;];
    foreach ((array)$forms as $form_id=&gt;$data){
      if (in_array($form_id, $feps_forms)){
        $values[$form_id] = $data[&#x27;title&#x27;];
      }
    }

    //** show filter only if we have more than one form with FEPSes */
    if ( !empty( $values ) ) {
      $filter[ FEPS_META_FORM ] = array (
        &#x27;type&#x27; =&gt; &#x27;multi_checkbox&#x27;,
        &#x27;label&#x27; =&gt; sprintf(__(&#x27;%1$s Forms&#x27;,&#x27;wpp&#x27;), ucfirst( WPP_F::property_label( &#x27;singular&#x27; ) )),
        &#x27;values&#x27; =&gt; (array)$values
      );
    }

    return $filter;
  }


  function wpp_overview_columns($columns) {
    global  $wp_properties;
    if ( $wp_properties[ &#x27;configuration&#x27; ][ &#x27;property_overview&#x27; ][ &#x27;show_feps_column&#x27; ] ==&#x27;true&#x27; ){
      $columns[ FEPS_META_FORM ] =  sprintf(__(&#x27;%1$s Form&#x27;,&#x27;wpp&#x27;), ucfirst( WPP_F::property_label( &#x27;singular&#x27; ) ));
    }
    return $columns;
  }

  function wpp_settings_overview_bottom($wp_properties){
    ?&gt;
    &lt;div&gt;&lt;?php echo WPP_F::checkbox( &#x27;name=wpp_settings[configuration][property_overview][show_feps_column]&amp;label=&#x27; . sprintf(__( &#x27;Show &lt;span title=&quot;Front End %2$s Submissions&quot;&gt;FEPS&lt;/span&gt; column in All %1$s Page.&#x27;,&#x27;wpp&#x27; ), ucfirst( WPP_F::property_label( &#x27;plural&#x27; ) ),ucfirst( WPP_F::property_label( &#x27;plural&#x27; ) ) ), $wp_properties[ &#x27;configuration&#x27; ][ &#x27;property_overview&#x27; ][ &#x27;show_feps_column&#x27; ] ) ; ?&gt;&lt;/div&gt;
    &lt;?php
  }


  /**
   *
   * @global array $wp_properties
   * @param type $value
   * @param type $column
   * @return type
   */
  function wpp_attribute_filter($value, $column){
    global $wp_properties;

    if ( $column== FEPS_META_FORM ){
      $forms = $wp_properties[&#x27;configuration&#x27;][&#x27;feature_settings&#x27;][&#x27;feps&#x27;][&#x27;forms&#x27;];
      $value = (!empty($forms[$value]) ? $forms[$value][&#x27;title&#x27;] : &#x27;&#x27;);
    }
    return $value;
  }


  /**
   * Shortcode FEPS Menu
   * Renders FEPS menu
   *
   * @param mixed $atts
   */
  function wpp_feps_menu( $atts = &#x27;&#x27; ) {
    global $wp_properties, $wpdb;

    //** STEP 1. Process args */

    $args = shortcode_atts( array(
      &#x27;before&#x27; =&gt; &#x27;&#x27;,
      &#x27;after&#x27; =&gt; &#x27;&#x27;,
      &#x27;title&#x27; =&gt; &#x27;&#x27;,
      &#x27;show_balance&#x27; =&gt; &#x27;true&#x27;,
      &#x27;show_spc_link&#x27; =&gt; &#x27;true&#x27;,
      &#x27;filters&#x27; =&gt; &#x27;false&#x27;,
      &#x27;form_page&#x27; =&gt; &#x27;&#x27;, // URL to FEPS form page
    ), $atts );
    extract( $args );

    $add_credits = __( &quot;Add Credits to Balance&quot;, &#x27;wpp&#x27; );
    if( !empty( $wp_properties[&#x27;configuration&#x27;][&#x27;feps&#x27;][&#x27;menu&#x27;][&#x27;add_credits_label&#x27;] ) ) {
      $add_credits = $wp_properties[&#x27;configuration&#x27;][&#x27;feps&#x27;][&#x27;menu&#x27;][&#x27;add_credits_label&#x27;];
    }

    $add_property = sprintf( __( &quot;Add New %s&quot;, &#x27;wpp&#x27; ), WPP_F::property_label() );
    if( !empty( $wp_properties[&#x27;configuration&#x27;][&#x27;feps&#x27;][&#x27;menu&#x27;][&#x27;add_property_label&#x27;] ) ) {
      $add_property = $wp_properties[&#x27;configuration&#x27;][&#x27;feps&#x27;][&#x27;menu&#x27;][&#x27;add_property_label&#x27;];
    }

    //* STEP 2. Check all permissions and conditions */

    //** Determine if user is logged in */
    if ( !is_user_logged_in() ) {
      return false;
    }

    $user = wp_get_current_user();

    //** Determine if user has any FEP submission already. */
    $feps = $wpdb-&gt;get_results(&quot;
      SELECT p.post_status, count(p.post_status) as amount
        FROM {$wpdb-&gt;posts} AS p
        JOIN {$wpdb-&gt;postmeta} AS pm ON pm.post_id = p.ID
        WHERE pm.meta_key = &#x27;wpp_feps_property&#x27;
          AND p.post_author = &#x27;{$user-&gt;ID}&#x27;
          AND p.post_status IN (&#x27;publish&#x27;, &#x27;pending&#x27;)
          GROUP BY p.post_status
    &quot;, ARRAY_A);

    //** Determine if user has any funds on his FEPS balance */
    $balance = $user-&gt;get(&#x27;wpp::feps::credits&#x27;);
    $balance = (float)$balance;

    //** Determine if it&#x27;s enabled to show menu when there are no properties and no credits on balance */
    if( isset( $wp_properties[&#x27;configuration&#x27;][&#x27;feps&#x27;][&#x27;menu&#x27;][&#x27;disable_if_no_properties&#x27;] ) &amp;&amp;
        $wp_properties[&#x27;configuration&#x27;][&#x27;feps&#x27;][&#x27;menu&#x27;][&#x27;disable_if_no_properties&#x27;] == &#x27;true&#x27; ) {

      if( empty( $feps ) || empty( $balance ) ) {
        return false;
      }

    }

    $feps_amount = 0;
    foreach( $feps as $f ) {
      $feps_amount = $feps_amount + $f[&#x27;amount&#x27;];
    }

    //* STEP 3. Render Menu */

    ob_start();

    echo $before;

    ?&gt;
    &lt;div class=&quot;wpp_feps_user_menu wpp_shortcode_feps_menu wpp_shortcode&quot;&gt;
      &lt;?php if( !empty( $title ) ) : ?&gt;
        &lt;h5&gt;&lt;?php echo $title; ?&gt;&lt;/h5&gt;
      &lt;?php endif; ?&gt;
      &lt;ul&gt;
        &lt;?php if ( class_exists( &#x27;wpi_spc&#x27; ) ) : ?&gt;
          &lt;?php if ( $show_balance == &#x27;true&#x27; ) : ?&gt;
          &lt;li class=&quot;wpp_feps_balance&quot;&gt;
            &lt;span class=&quot;title&quot;&gt;&lt;?php _e(&quot;My Balance&quot;, &#x27;wpp&#x27;); ?&gt;&lt;/span&gt;
            &lt;span class=&quot;doubledot&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;value&quot;&gt;&lt;b&gt;&lt;?php echo $balance; ?&gt;&lt;/b&gt; &lt;?php echo $balance == 1 ? __(&quot;credit&quot;, &#x27;wpp&#x27;) : __(&quot;credits&quot;, &#x27;wpp&#x27;); ?&gt;&lt;/span&gt;
          &lt;/li&gt;
          &lt;?php endif; ?&gt;
          &lt;?php if ( $show_spc_link == &#x27;true&#x27; ) : ?&gt;
          &lt;li class=&quot;wpp_feps_spc_link&quot;&gt;
            &lt;a href=&quot;&lt;?php echo  WPP_F::base_url( FEPS_SPC_PAGE ); ?&gt;&quot;&gt;&lt;?php echo $add_credits; ?&gt;&lt;/a&gt;
          &lt;/li&gt;
          &lt;?php endif; ?&gt;
        &lt;?php endif; ?&gt;
        &lt;?php if( !empty( $form_page ) ): ?&gt;
          &lt;li class=&quot;wpp_feps_form_page_link&quot;&gt;
            &lt;a href=&quot;&lt;?php echo $form_page; ?&gt;&quot;&gt;&lt;?php echo $add_property; ?&gt;&lt;/a&gt;
          &lt;/li&gt;
        &lt;?php endif; ?&gt;
        &lt;?php if ( $filters == &#x27;true&#x27; ) : ?&gt;
          &lt;li class=&quot;wpp_feps_filter&quot;&gt;
            &lt;h5&gt;&lt;?php printf( __(&quot;My %s&quot;, &#x27;wpp&#x27;), WPP_F::property_label( &#x27;plural&#x27; ) ); ?&gt;&lt;span class=&quot;doubledot&quot;&gt;:&lt;/span&gt;&lt;/h5&gt;
            &lt;ul&gt;
              &lt;li&gt;
                &lt;a href=&quot;&lt;?php echo  WPP_F::base_url( FEPS_VIEW_PAGE, &quot;status=all&quot; ); ?&gt;&quot;&gt;&lt;?php _e(&quot;All&quot;, &#x27;wpp&#x27;); ?&gt; (&lt;?php echo $feps_amount; ?&gt;)&lt;/a&gt;
              &lt;/li&gt;
              &lt;?php foreach ( $feps as $f ) : ?&gt;
              &lt;li&gt;
                &lt;a href=&quot;&lt;?php echo  WPP_F::base_url( FEPS_VIEW_PAGE, &quot;status={$f[&#x27;post_status&#x27;]}&quot; ); ?&gt;&quot;&gt;&lt;?php echo WPP_F::clear_post_status( $f[&#x27;post_status&#x27;] ); ?&gt; (&lt;?php echo $f[&#x27;amount&#x27;]; ?&gt;)&lt;/a&gt;
              &lt;/li&gt;
              &lt;?php endforeach; ?&gt;
            &lt;/ul&gt;
          &lt;/li&gt;
        &lt;?php else : ?&gt;
          &lt;li class=&quot;wpp_feps_all_listings&quot;&gt;
            &lt;a href=&quot;&lt;?php echo  WPP_F::base_url( FEPS_VIEW_PAGE ); ?&gt;&quot;&gt;&lt;?php printf( __(&quot;My %s&quot;, &#x27;wpp&#x27;), WPP_F::property_label( &#x27;plural&#x27; ) ); ?&gt;&lt;/a&gt;
          &lt;/li&gt;
        &lt;?php endif; ?&gt;
      &lt;/ul&gt;

    &lt;/div&gt;
    &lt;?php

    echo $after;

    $content = ob_get_clean();

    return $content;
  }


  /**
   * Used for returning the FEPS form via shortcode
   *
   * @since 0.1
   */
  function wpp_feps_form( $atts = &#x27;&#x27; ) {
    global $post_id, $wp_properties, $post;

    //** Process args */
    $args = shortcode_atts( array(
      &#x27;detect_parent&#x27; =&gt; &#x27;true&#x27;,
      &#x27;parent_id&#x27; =&gt; &#x27;&#x27;,
      &#x27;map_height&#x27; =&gt; &#x27;400&#x27;,
      &#x27;not_found_text&#x27; =&gt; __(&#x27;Requested FEPS form not found.&#x27;,&#x27;wpp&#x27;),
      &#x27;form&#x27; =&gt; &#x27;&#x27;,
      &#x27;property_id&#x27; =&gt; false, //398,
    ), $atts );

    //** Hook something and get control */
    $hook = apply_filters( &#x27;wpp_feps_form_filter&#x27;, false, $args );
    if ( $hook ) return $hook;

    //** Get forms */
    $forms = $wp_properties[&#x27;configuration&#x27;][&#x27;feature_settings&#x27;][&#x27;feps&#x27;][&#x27;forms&#x27;];

    //** If no forms - return */
    if(!is_array($forms)) {
      return;
    }

    //** Remove empty args */
    foreach($args as $arg =&gt; $arg_v) {
      if(empty($arg_v)) {
        unset($args[$arg]);
      }
    }

    //** Check if requested form exists */
    foreach($forms as $form_id =&gt; $form) {
      if($form[&#x27;slug&#x27;] == $args[&#x27;form&#x27;]) {
        $args[&#x27;the_form&#x27;] = $form;
        $args[&#x27;form_id&#x27;] = $form_id;
        break;
      }
    }

    //** Do nothing if requested form is not found */
    if(!$args[&#x27;the_form&#x27;]) {
      if(current_user_can(&#x27;administrator&#x27;)) {
        return $args[&#x27;not_found_text&#x27;];
      } else {
        return;
      }
    }

    //** If there are no fields */
    if( !is_array($args[&#x27;the_form&#x27;][&#x27;fields&#x27;]) &amp;&amp; !is_array($args[&#x27;the_form&#x27;][&#x27;required&#x27;]) ) {
      if(current_user_can(&#x27;administrator&#x27;)) {
        return __(&#x27;The requested form does not have any fields.&#x27;,&#x27;wpp&#x27;);
      } else {
        return;
      }
    }

    if(empty($args[&#x27;parent_id&#x27;]) &amp;&amp; $args[&#x27;detect_parent&#x27;] == &#x27;true&#x27; &amp;&amp; $post-&gt;post_type == &#x27;property&#x27;) {
      $args[&#x27;parent_id&#x27;] = $post-&gt;ID;
    }

    //** Unset arguments that are not needed later */
    unset($args[&#x27;detect_parent&#x27;]);

    //** Flush vars */
    $contents = &#x27;&#x27;;

    //** If we have wpp_front_end_action in request - we know that it is some of the next steps */
    $wpp_front_end_action = !empty( $_REQUEST[&#x27;wpp_front_end_action&#x27;] ) ? $_REQUEST[&#x27;wpp_front_end_action&#x27;] : &#x27;&#x27;;

    $_REQUEST[&#x27;wpp_front_end_action&#x27;] = !empty( $_REQUEST[&#x27;wpp_front_end_action&#x27;] ) ? $_REQUEST[&#x27;wpp_front_end_action&#x27;] : &#x27;edit&#x27;;

    do_action( &#x27;wpp::feps::shortcode&#x27;, $args );

    //** Determine step */
    switch( $_REQUEST[&#x27;wpp_front_end_action&#x27;] ) {

      //** Step 2 */
      case &#x27;subscription_plan&#x27;:

        do_action( &#x27;wpp::feps::shortcode::subscription_plan&#x27;, $args );

        //** Load specific scripts */
        wp_enqueue_script( &#x27;wpp-feps-subscription&#x27;, WPP_URL. &#x27;js/wpp.feps.subscription.js&#x27;, array( &#x27;jquery&#x27;, &#x27;wpp-localization&#x27; ) );

        $contents = self::sponsored_listing_sub_plan();
        break;

      //** Step 3 */
      case &#x27;checkout&#x27;:

        do_action( &#x27;wpp::feps::shortcode::checkout&#x27;, $args );

        //** Load specific scripts */
        wp_enqueue_script( &#x27;wpp-feps-checkout&#x27;, WPP_URL. &#x27;js/wpp.feps.checkout.js&#x27;, array( &#x27;jquery&#x27;, &#x27;wpp-localization&#x27; ) );

        $contents = self::sponsored_listing_purchase();
        break;

      //** Step 1 */
      case &#x27;edit&#x27;:

        do_action( &#x27;wpp::feps::shortcode::edit&#x27;, $args );

        //** Load specific scripts */
        wp_enqueue_script( &#x27;wpp-feps-submit&#x27;, WPP_URL. &#x27;js/wpp.feps.submit.js&#x27;, array(
          &#x27;jquery&#x27;,
          &#x27;wpp-localization&#x27;,
          &#x27;wpp-jquery-gmaps&#x27;,
          &#x27;wp-property-global&#x27;,
          &#x27;wpp-jquery-number-format&#x27;,
          &#x27;wpp-jquery-ajaxupload&#x27;,
          &#x27;wpp-jquery-validate&#x27;,
        ) );

        $user_can_publish_properties = &#x27;false&#x27;;
        $form_id                     = rand(99, 9999999);
        $this_session                = rand(99, 9999999);
        $current_user                = wp_get_current_user();
        $nonce                       = WPP_F::generate_nonce(&#x27;submit_feps&#x27;);
        $thumbnail_size              = WPP_F::image_sizes($args[&#x27;the_form&#x27;][&#x27;thumbnail_size&#x27;]);
        $property_type               = $args[&#x27;the_form&#x27;][&#x27;property_type&#x27;];
        $images_limit                = ($args[&#x27;the_form&#x27;][&#x27;feps_credits&#x27;]==&#x27;true&#x27;) ? 1 : $args[&#x27;the_form&#x27;][&#x27;images_limit&#x27;];

        if(!empty($args[&#x27;parent_id&#x27;])) {
          $parent_id = $args[&#x27;parent_id&#x27;];
          $parent_property = get_property($parent_id);

          //** Get inherted data */
          if(is_array($wp_properties[&#x27;property_inheritance&#x27;][$property_type])) {

            foreach($wp_properties[&#x27;property_inheritance&#x27;][$property_type] as $attribute) {
              $property[$attribute] = $parent_property[$attribute];
            }
          }
        }

        if( is_user_logged_in() ) {
          $user_logged_in = true;
        }

        if ( user_can( $current_user, &#x27;publish_wpp_properties&#x27; ) ) {
          $user_can_publish_properties = &#x27;true&#x27;;
        }

        /** Check if we have Edit FEPS */
        if ($user_logged_in &amp;&amp; $args[&#x27;property_id&#x27;]){

          $property = array_merge_recursive((array)$property,get_property($args[&#x27;property_id&#x27;]));

          if( empty($property) ){
            return (current_user_can(&#x27;administrator&#x27;)) ? sprintf(__(&#x27;Requested %1$s not found.&#x27;,&#x27;wpp&#x27;), ucfirst(WPP_F::property_label(&#x27;singular&#x27;))) : null;
          }

          if ( empty($property[&#x27;wpp_feps_property&#x27;]) ){
            return (current_user_can(&#x27;administrator&#x27;)) ? sprintf(__(&#x27;It\&#x27;s not FEPS\&#x27;s %1$s&#x27;,&#x27;wpp&#x27;), ucfirst(WPP_F::property_label(&#x27;singular&#x27;))) : null;
          }

          /** check if property belongs to current user */
          if( $current_user-&gt;data-&gt;ID != $property[&#x27;post_author&#x27;] ){
            return (current_user_can(&#x27;administrator&#x27;)) ? sprintf(__(&quot;It&#x27;s not your %1$s&quot;,&#x27;wpp&#x27;), WPP_F::property_label(&#x27;singular&#x27;) ) : null;
          }

          if ( empty($property[ FEPS_META_FORM ]) || $wp_properties[&#x27;configuration&#x27;][&#x27;feature_settings&#x27;][&#x27;feps&#x27;][&#x27;forms&#x27;][$property[ FEPS_META_FORM ]][&#x27;slug&#x27;]!=$args[&#x27;form&#x27;] ){
            return (current_user_can(&#x27;administrator&#x27;)) ? __(&quot;Wrong FEPS form used&quot;,&#x27;wpp&#x27;) : null;
          }

          /** check option  &quot;Allow user to edit and remove his FEPS&quot;. */
          if ( empty( $args[&#x27;the_form&#x27;][&#x27;can_manage_feps&#x27;] ) || $args[&#x27;the_form&#x27;][&#x27;can_manage_feps&#x27;] != &#x27;true&#x27; ) {
            return (current_user_can(&#x27;administrator&#x27;)) ? sprintf(__(&quot;Managing of %1$s are not allowed&quot;,&#x27;wpp&#x27;), WPP_F::property_label(&#x27;singular&#x27;) ) : null;
          }

          /** we should pass all conditions to leave template with tabs */
          if ( !($property[&#x27;post_status&#x27;] == &#x27;pending&#x27; &amp;&amp;
              !empty($property[ FEPS_META_FORM ]) &amp;&amp;
              ($wp_properties[&#x27;configuration&#x27;][&#x27;feature_settings&#x27;][&#x27;feps&#x27;][&#x27;forms&#x27;][$property[ FEPS_META_FORM ]][&quot;feps_credits&quot;]==&#x27;true&#x27;))  ){
            remove_filter(&#x27;wpp_feps_form_output&#x27;, array(__CLASS__, &#x27;feps_output_filter&#x27;));
          }

          $plan = maybe_unserialize($property[FEPS_META_PLAN]);
          $images_limit = (is_array($plan)) ? $plan[&#x27;images_limit&#x27;] : 1;

        }

        /** Build element array from required fields. */
        if(is_array($args[&#x27;the_form&#x27;][&#x27;required&#x27;])) {
          foreach($args[&#x27;the_form&#x27;][&#x27;required&#x27;] as $attribute_data) {
            $this_field = WPP_F::get_attribute_data( $attribute_data[&#x27;attribute&#x27;] );
            $this_field[&#x27;required&#x27;] = &#x27;on&#x27;;
            $this_field[&#x27;description&#x27;] = $attribute_data[&#x27;description&#x27;];
            $this_field[&#x27;title&#x27;] = $attribute_data[&#x27;title&#x27;];
            $this_field[&#x27;value&#x27;] = ( (!empty($property[$attribute_data[&#x27;attribute&#x27;]])) ? $property[$attribute_data[&#x27;attribute&#x27;]] : &#x27;&#x27; ) ;

            $form_fields[rand(99,9999999)] = $this_field;
          }
        }

        /** Build element array from regular fields. */
        if(is_array($args[&#x27;the_form&#x27;][&#x27;fields&#x27;])) {
          foreach($args[&#x27;the_form&#x27;][&#x27;fields&#x27;] as $attribute_data) {
            $this_field = WPP_F::get_attribute_data($attribute_data[&#x27;attribute&#x27;]);
            $this_field[&#x27;required&#x27;] = $attribute_data[&#x27;required&#x27;];
            $this_field[&#x27;description&#x27;] = $attribute_data[&#x27;description&#x27;];
            $this_field[&#x27;title&#x27;] = $attribute_data[&#x27;title&#x27;];
            $this_field[&#x27;value&#x27;] = ($property[$attribute_data[&#x27;attribute&#x27;]] ? $property[$attribute_data[&#x27;attribute&#x27;]] : false);

            $form_fields[rand(99,9999999)] = $this_field;
          }
        }

        $form_fields = stripslashes_deep($form_fields);

        //** Find template */
        $content_template_found = WPP_F::get_template_part( array(
          &quot;feps-submit-template&quot;
        ), array( WPP_Templates ) );

        ob_start();
        include $content_template_found;
        $contents = ob_get_clean();
        break;
    }

    return apply_filters(&#x27;wpp_feps_form_output&#x27;, $contents, $args);

  }


  /**
   * Renders the UI for form creation
   *
   * @since 0.1
   */
  function page_feps() {
    global $wp_properties, $wp_post_statuses;

    $wp_post_statuses = apply_filters( &#x27;wpp_feps_property_statuses&#x27;, $wp_post_statuses );

    if( empty($wp_properties[&#x27;configuration&#x27;][&#x27;feature_settings&#x27;][&#x27;feps&#x27;]) ) {
      //** Load default settings into global variable */
      class_wpp_feps::load_defaults();
    }

    if(isset($_REQUEST[&#x27;message&#x27;])) {

      switch($_REQUEST[&#x27;message&#x27;]) {

        case &#x27;updated&#x27;:
        $wp_messages[&#x27;notice&#x27;][] = __(&quot;FEPS forms updated.&quot;, &#x27;wpp&#x27;);
        break;
      }
    }

    $feps_forms = $wp_properties[&#x27;configuration&#x27;][&#x27;feature_settings&#x27;][&#x27;feps&#x27;][&#x27;forms&#x27;];

    $general_attributes[&#x27;General&#x27;][&#x27;post_content&#x27;] = sprintf(__(&#x27;%1$s Content&#x27;, &#x27;wpp&#x27;), ucfirst(WPP_F::property_label(&#x27;singular&#x27;)));

    $other_attributes = WPP_F::get_total_attribute_array(&#x27;use_optgroups=true&#x27;, array(
      &#x27;image_upload&#x27; =&gt; __(&#x27;Image Upload&#x27;, &#x27;wpp&#x27;)
     ));

    $available_attributes = $general_attributes + $other_attributes;

    $available_attributes = apply_filters(&#x27;wpp_feps_available_attributes&#x27;,$available_attributes, $general_attributes, $other_attributes);

    ?&gt;

    &lt;script type=&quot;text/javascript&quot;&gt;

    jQuery(document).ready(function() {

      var new_tab_href_id = 0;

      var index = jQuery(&#x27;#save_form&#x27;).attr(&#x27;action&#x27;).indexOf(&quot;#&quot;);
      var url   = jQuery(&#x27;#save_form&#x27;).attr(&#x27;action&#x27;).substring(0, index);

      jQuery(&quot;.wpp_feps_tabs&quot;).bind( &quot;tabsselect&quot;, function(event, ui) {
        index = jQuery(&#x27;#save_form&#x27;).attr(&#x27;action&#x27;).indexOf(&quot;#&quot;);
        url   = jQuery(&#x27;#save_form&#x27;).attr(&#x27;action&#x27;).substring(0, index);
        jQuery(&#x27;#save_form&#x27;).attr( &#x27;action&#x27;, url+&#x27;#feps_form_&#x27;+jQuery( ui.panel ).attr(&#x27;feps_form_id&#x27;) );
      });

      jQuery(&quot;.wpp_feps_tabs&quot;).bind( &quot;tabscreate&quot;, function(event, ui) {
        jQuery(&#x27;#save_form&#x27;).attr( &#x27;action&#x27;, url+window.location.hash );
      });

      if( wpp.version_compare( jQuery.ui.version, &#x27;1.10&#x27;, &#x27;&gt;=&#x27; ) ) {
        jQuery(&quot;.wpp_feps_tabs&quot;).tabs();
      } else {
        jQuery(&quot;.wpp_feps_tabs&quot;).tabs({
          add: function(event, ui) {
            jQuery(ui.panel).addClass(&#x27;wpp_feps_form&#x27;).attr(&#x27;feps_form_id&#x27;, new_tab_href_id);
            jQuery(ui.tab).parent().attr(&#x27;feps_form_id&#x27;, new_tab_href_id);
            jQuery(&#x27;.wpp_feps_form table:first&#x27;).clone().appendTo( ui.panel );
            feps_init_close_btn();
            feps_set_default_field_values( ui.panel );
            jQuery( &#x27;input[name*=&quot;wpp_feps[forms]&quot;], select[name*=&quot;wpp_feps[forms]&quot;], textarea[name*=&quot;wpp_feps[forms]&quot;]&#x27;, ui.panel ).each(function(key, value){
              jQuery( value ).attr( &#x27;name&#x27;, String(jQuery( value ).attr(&#x27;name&#x27;)).replace(/wpp_feps\[forms\]\[\d.+?\]/, &#x27;wpp_feps[forms][&#x27;+new_tab_href_id+&#x27;]&#x27;) );
            });
            feps_update_dom();
          }
        });
      }

      feps_init_close_btn();

      jQuery(&quot;.wpp_add_tab&quot;).click(function() {
        new_tab_href_id = parseInt(Math.random()*1000000);

        if( wpp.version_compare( jQuery.ui.version, &#x27;1.10&#x27;, &#x27;&gt;=&#x27; ) ) {
          var tabs = jQuery(&quot;.wpp_feps_tabs&quot;),
            ul = tabs.find( &quot;&gt;ul&quot; ),
            index = tabs.find( &#x27;&gt;ul &gt;li&#x27;).size(),
            panel = jQuery( &#x27;&lt;div id=&quot;feps_form_&#x27; + new_tab_href_id + &#x27;&quot; class=&quot;wpp_feps_form&quot; feps_form_id=&quot;&#x27; + new_tab_href_id + &#x27;&quot;&gt;&lt;/div&gt;&#x27; );

          jQuery( &quot;&lt;li&gt;&lt;a href=&#x27;#feps_form_&quot; + new_tab_href_id + &quot;&#x27;&gt;&lt;span&gt;&lt;?php _e(&#x27;Unnamed Form&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;&quot; ).appendTo( ul );
          jQuery(&#x27;.wpp_feps_form table:first&#x27;).clone().appendTo( panel );
          panel.appendTo( tabs );
          tabs.tabs( &quot;refresh&quot; );

          var tab = jQuery( &#x27;&gt;li:last&#x27;, ul );

          tab.attr(&#x27;feps_form_id&#x27;, new_tab_href_id );
          feps_init_close_btn();
          feps_set_default_field_values( panel );
          jQuery( &#x27;input[name*=&quot;wpp_feps[forms]&quot;], select[name*=&quot;wpp_feps[forms]&quot;], textarea[name*=&quot;wpp_feps[forms]&quot;]&#x27;, panel ).each( function(key, value){
            jQuery( value ).attr( &#x27;name&#x27;, String(jQuery( value ).attr(&#x27;name&#x27;)).replace(/wpp_feps\[forms\]\[\d.+?\]/, &#x27;wpp_feps[forms][&#x27;+new_tab_href_id+&#x27;]&#x27;) );
          });
          feps_update_dom();
          tabs.tabs( &quot;option&quot;, &quot;active&quot;, index );
        } else {
          jQuery(&quot;.wpp_feps_tabs&quot;).tabs( &quot;add&quot;, &quot;#feps_form_&quot;+new_tab_href_id, &quot;&lt;?php _e(&#x27;Unnamed Form&#x27;, &#x27;wpp&#x27;); ?&gt;&quot; );
          jQuery(&quot;.wpp_feps_tabs&quot;).tabs( &quot;active&quot;, jQuery(&quot;.wpp_feps_tabs&quot;).tabs( &#x27;length&#x27; )-1 );
        }
      });

      jQuery(&quot;.wpp_dynamic_table_row&quot;).each(function() {
        /* A bit of  hack, but we want users to be able to change rows around as much as they need */
        jQuery(this).attr(&quot;new_row&quot;, &quot;true&quot;);
      });

      jQuery(&quot;.wpp_feps_new_attribute&quot;).live(&quot;change&quot;, function() {
        var parent = jQuery(this).parents(&quot;.wpp_dynamic_table_row&quot;);
        var title = jQuery(&quot;option:selected&quot;, this).text();
        jQuery(&quot;input.title&quot;, parent).val(title);

      });

      /* On form name change */
      jQuery(&quot;.wpp_feps_form .form_title&quot;).live(&quot;change&quot;, function() {
        var title = jQuery(this).val();

        if(title == &quot;&quot;) {
          return;
        }

        var slug = wpp_create_slug(title);
        var this_form = jQuery(this).parents(&quot;.wpp_feps_form&quot;);
        var form_id = jQuery(this_form).attr(&quot;feps_form_id&quot;);

        /* Update tab title */
        jQuery(&quot;.wpp_feps_tabs .tabs li[feps_form_id=&quot;+form_id+&quot;] a span&quot;).text(title);
        /* Update shortcode */
        jQuery(&quot;input.shortcode&quot;, this_form).val(&quot;[wpp_feps_form form=&quot; + slug + &quot;]&quot;);
        /* Update Slug */
        jQuery(&quot;input.slug&quot;, this_form).val(slug);

      });

      jQuery(&quot;a.wpp_forms_remove_attribute&quot;).live(&#x27;click&#x27;, function(){
        var row_to_be_removed = jQuery(this).attr(&quot;row&quot;);
        var context           = jQuery(this).parents(&quot;div.wpp_feps_form .ud_ui_dynamic_table&quot;);
        var rows              = jQuery(&quot;tr.wpp_dynamic_table_row&quot;, context);
        if ( rows.length &gt; 2 ) {
          rows.each(function(k, v){
            if ( jQuery(v).attr(&quot;random_row_id&quot;) == row_to_be_removed ) {
              jQuery(v).remove();
            }
          });
        }
        feps_update_dom();
      });

      jQuery(&quot;select.wpp_feps_new_attribute&quot;).live(&#x27;change&#x27;, function(){
        feps_update_dom();
      });

      jQuery(&quot;input.imageslimit&quot;).live(&#x27;change&#x27;, function(){
        if ( jQuery(this).val() &lt; 1 ) jQuery(this).val(1);
      });

      feps_update_dom();

    });

    /** Render Close button on tabs */
    function feps_init_close_btn(){

      // Add remove button for tabs
      jQuery(&#x27;ul.tabs li.ui-state-default:not(:first):not(:has(a.remove-tab))&#x27;)
        .append(&#x27;&lt;a href=&quot;javascript:void(0);&quot; class=&quot;remove-tab&quot;&gt;x&lt;/a&gt;&#x27;)
        .mouseenter(function(){
          jQuery(&#x27;a.remove-tab&#x27;, this).show(&#x27;fast&#x27;);
        })
        .mouseleave(function(){
          jQuery(&#x27;a.remove-tab&#x27;, this).hide(&#x27;fast&#x27;);
        });

      // On remove tab button click
      jQuery(&#x27;ul.tabs li a.remove-tab&#x27;).unbind(&#x27;click&#x27;);
      jQuery(&#x27;ul.tabs li a.remove-tab&#x27;).click(function(e){
        var feps_form_id = jQuery(e.target).closest(&#x27;li&#x27;).attr(&#x27;feps_form_id&#x27;);
        if ( feps_form_id ) {
          //* Check if form can be removed */
          jQuery.ajax({
            url: &#x27;&lt;?php echo admin_url(&#x27;admin-ajax.php&#x27;); ?&gt;&#x27;,
            async: false,
            data: {
              action: &#x27;wpp_feps_can_remove_form&#x27;,
              feps_form_id: feps_form_id
            },
            success: function(response){
              var data = eval(&#x27;(&#x27; + response + &#x27;)&#x27;);
              if( data.success ) {
                if( wpp.version_compare( jQuery.ui.version, &#x27;1.10&#x27;, &#x27;&gt;=&#x27; ) ) {
                  // Remove the tab
                  var tab = jQuery( &quot;.wpp_feps_tabs&quot; ).find( &quot;.ui-tabs-nav li[feps_form_id=&#x27;&quot; + feps_form_id + &quot;&#x27;]&quot; ).remove();
                  // Find the id of the associated panel
                  var panelId = tab.attr( &quot;aria-controls&quot; );
                  // Remove the panel
                  jQuery( &quot;#&quot; + panelId ).remove();
                  // Refresh the tabs widget
                  jQuery( &quot;.wpp_feps_tabs&quot; ).tabs( &quot;refresh&quot; );
                } else {
                  jQuery(&quot;.wpp_feps_tabs&quot;).tabs(&#x27;remove&#x27;, jQuery(this).parent().index());
                }
              } else {
                alert( data.message );
              }
            },
            error: function() {
              alert( &#x27;&lt;?php _e(&#x27;Form could not be removed because of some server error.&#x27;, &#x27;wpp&#x27;); ?&gt;&#x27; );
            }
          });
        } else {
          alert( &#x27;&lt;?php _e(&#x27;Form could not be removed because form ID is undefined.&#x27;, &#x27;wpp&#x27;); ?&gt;&#x27; );
        }
      });

    }

    /** Set default field values after adding new tab */
    function feps_set_default_field_values( context ) {
      jQuery(&quot;input.form_title&quot;, context).val(&#x27;Unnamed Form&#x27;).trigger(&#x27;change&#x27;);
      jQuery(&quot;input.shortcode&quot;, context).val(&#x27;[wpp_feps_form form=&#x27;+wpp_create_slug(&#x27;Unnamed Form &#x27;+jQuery(context).attr(&#x27;feps_form_id&#x27;))+&#x27;]&#x27;);
      jQuery(&quot;input.slug&quot;, context).val(wpp_create_slug(&#x27;Unnamed Form &#x27;+jQuery(context).attr(&#x27;feps_form_id&#x27;)));
      jQuery(&quot;.ud_ui_dynamic_table&quot;).each(function(){
        jQuery(&quot;tr.wpp_dynamic_table_row&quot;, jQuery(this)).find(&quot;textarea.description&quot;).val(&#x27;&#x27;);
        jQuery(&quot;tr.wpp_dynamic_table_row:not(.required):not(:first)&quot;, jQuery(this)).remove();
      });
    }

    /** Update dom after changes */
    function feps_update_dom() {
      jQuery(&quot;.wpp_feps_sortable tbody&quot;).sortable( { items: &#x27;tr.wpp_dynamic_table_row:not(.required)&#x27; } );

      jQuery(&quot;.wpp_feps_sortable tr.wpp_dynamic_table_row&quot;).live(&quot;mouseover&quot;, function() {
        jQuery(this).addClass(&quot;wpp_draggable_handle_show&quot;);
      });

      jQuery(&quot;.wpp_feps_sortable tr.wpp_dynamic_table_row&quot;).live(&quot;mouseout&quot;, function() {
        jQuery(this).removeClass(&quot;wpp_draggable_handle_show&quot;);
      });

      jQuery(&quot;.wpp_feps_sortable tr.wpp_dynamic_table_row&quot;).each(function(k, v){
        var random_row_id = jQuery(v).attr(&quot;random_row_id&quot;);
        jQuery(v).find(&quot;a.wpp_forms_remove_attribute&quot;).attr(&quot;row&quot;, random_row_id);
      });

      //* Determine if form allows to upload images and show/hide images settings */
      jQuery(&quot;.ui-tabs-panel&quot;).each(function(k,v){
        var image_upload = false,
            plan_images_col = jQuery(&#x27;.wpp_plan_images_limit_col&#x27;, v),
            feps_credits = jQuery(&#x27;input.feps_credits&#x27;, v);
        jQuery(&quot;select.wpp_feps_new_attribute option:selected&quot;, v).each(function(i, e){
          if ( jQuery(e).val() == &#x27;image_upload&#x27; ) {
            image_upload = true;
            return false;
          }
        });
        if( image_upload ) {
          if ( !feps_credits.length &gt; 0 || ( feps_credits.length &gt; 0 &amp;&amp; !feps_credits.is(&#x27;:checked&#x27;) ) ) {
            jQuery(&#x27;input.imageslimit&#x27;, v).parent().show();
          }
          if( plan_images_col.length &gt; 0 ) {
            plan_images_col.show();
          }
        } else {
          jQuery(&#x27;input.imageslimit&#x27;, v).parent().hide();
          if( plan_images_col.length &gt; 0 ) {
            plan_images_col.hide();
          }
        }
      });
    }

    /* Ran after a row is added */
    function wpp_feps_added_row(added_row) {
      /* Set the title */
      feps_update_dom();
    }
    &lt;/script&gt;

    &lt;div class=&quot;wrap wpp_feps_wrapper wpp_settings_page&quot;&gt;
      &lt;h2&gt;&lt;?php echo sprintf(__(&#x27;Front End %1$s Submissions&#x27;, &#x27;wpp&#x27;), ucfirst(WPP_F::property_label(&#x27;singular&#x27;))); ?&gt;
      &lt;span class=&quot;wpp_add_tab add-new-h2&quot;&gt;&lt;?php _e(&#x27;Add New&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/span&gt;
      &lt;/h2&gt;

      &lt;?php if(isset($wp_messages[&#x27;error&#x27;]) &amp;&amp; $wp_messages[&#x27;error&#x27;]): ?&gt;
      &lt;div class=&quot;error&quot;&gt;
        &lt;?php foreach($wp_messages[&#x27;error&#x27;] as $error_message): ?&gt;
          &lt;p&gt;&lt;?php echo $error_message; ?&gt;
        &lt;?php endforeach; ?&gt;
      &lt;/div&gt;
      &lt;?php endif; ?&gt;

      &lt;?php if(isset($wp_messages[&#x27;notice&#x27;]) &amp;&amp; $wp_messages[&#x27;notice&#x27;]): ?&gt;
      &lt;div class=&quot;updated fade&quot;&gt;
        &lt;?php foreach($wp_messages[&#x27;notice&#x27;] as $notice_message): ?&gt;
          &lt;p&gt;&lt;?php echo $notice_message; ?&gt;
        &lt;?php endforeach; ?&gt;
      &lt;/div&gt;
      &lt;?php endif; ?&gt;

      &lt;form id=&quot;save_form&quot; action=&quot;&lt;?php echo admin_url(&#x27;edit.php?post_type=property&amp;page=page_feps&amp;message=updated&#x27;); ?&gt;&quot; method=&quot;POST&quot;&gt;
        &lt;input type=&quot;hidden&quot; name=&quot;_wpnonce&quot; value=&quot;&lt;?php echo wp_create_nonce(&#x27;wpp_save_feps_page&#x27;); ?&gt;&quot; /&gt;
        &lt;input class=&quot;current_tab&quot; type=&quot;hidden&quot; name=&quot;current_tab&quot; value=&quot;&quot; /&gt;

      &lt;div class=&quot;wpp_feps_tabs wpp_tabs&quot;&gt;

        &lt;ul class=&quot;tabs&quot;&gt;
          &lt;?php foreach($feps_forms as $form_id =&gt; $form) { ?&gt;
            &lt;li feps_form_id=&quot;&lt;?php echo esc_attr($form_id); ?&gt;&quot;&gt;&lt;a href=&quot;#feps_form_&lt;?php echo $form_id; ?&gt;&quot;&gt;&lt;span&gt;&lt;?php echo $form[&#x27;title&#x27;]; ?&gt;&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;
          &lt;?php } ?&gt;
        &lt;/ul&gt;
        &lt;?php foreach($feps_forms as $form_id =&gt; $form) {
          // Fill out one default field if &#x27;fields&#x27; is empty
          if ( empty( $form[&#x27;fields&#x27;] ) ) {
            $form[&#x27;fields&#x27;] = class_wpp_feps::load_default_field();
          }
        ?&gt;
        &lt;div id=&quot;feps_form_&lt;?php echo $form_id; ?&gt;&quot; class=&quot;wpp_feps_form ui-tabs-panel&quot; feps_form_id=&quot;&lt;?php echo esc_attr($form_id); ?&gt;&quot;&gt;

          &lt;!-- Settings form table --&gt;
          &lt;table class=&quot;form-table wpp_option_table&quot;&gt;
            &lt;tr&gt;
              &lt;th&gt;
                &lt;p&gt;&lt;strong&gt;&lt;?php _e(&#x27;Form Name:&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/strong&gt;&lt;/p&gt;
              &lt;/th&gt;
              &lt;td&gt;
                &lt;input size=&quot;60&quot; class=&quot;form_title&quot; type=&quot;text&quot; name=&quot;wpp_feps[forms][&lt;?php echo $form_id; ?&gt;][title]&quot; value=&quot;&lt;?php echo esc_attr($form[&#x27;title&#x27;]); ?&gt;&quot; /&gt;
                &lt;br/&gt;&lt;span class=&quot;description&quot;&gt;
                  &lt;?php _e(&#x27;Enter form name. Form slug will be generated using form name. Note that Form Name is used for internal reference.&#x27;, &#x27;wpp&#x27;); ?&gt;
                &lt;/span&gt;
                &lt;input type=&quot;hidden&quot; class=&quot;slug&quot; name=&quot;wpp_feps[forms][&lt;?php echo $form_id; ?&gt;][slug]&quot; value=&quot;&lt;?php echo esc_attr($form[&#x27;slug&#x27;]); ?&gt;&quot; /&gt;
              &lt;/td&gt;
            &lt;/tr&gt;
            &lt;tr&gt;
              &lt;th&gt;
                &lt;p&gt;&lt;strong&gt;&lt;?php _e(&#x27;Shortcode:&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/strong&gt;&lt;/p&gt;
              &lt;/th&gt;
              &lt;td&gt;
                &lt;input size=&quot;60&quot; class=&quot;shortcode&quot; type=&quot;text&quot; readonly=&quot;true&quot; value=&quot;[wpp_feps_form form=&lt;?php echo esc_attr($form[&#x27;slug&#x27;]); ?&gt;]&quot; /&gt;
                &lt;br/&gt;&lt;span class=&quot;description&quot;&gt;
                  &lt;?php _e(&#x27;Copy and paste this shortcode into any page or post to display the form&#x27;, &#x27;wpp&#x27;); ?&gt;
                &lt;/span&gt;
              &lt;/td&gt;
            &lt;/tr&gt;
            &lt;?php do_action(&#x27;wpp_feps_form_settings_before_general&#x27;, array(&#x27;form&#x27;=&gt;$form, &#x27;form_id&#x27;=&gt;$form_id)); ?&gt;
            &lt;tr&gt;
              &lt;th&gt;
                &lt;p&gt;&lt;strong&gt;&lt;?php _e(&#x27;General Options:&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/strong&gt;&lt;/p&gt;
                &lt;div class=&quot;description&quot;&gt;&lt;p&gt;&lt;/p&gt;&lt;/div&gt;
              &lt;/th&gt;
              &lt;td&gt;
                &lt;?php $hidden = ( (class_exists(&#x27;wpi_spc&#x27;) &amp;&amp; !empty( $form[&#x27;feps_credits&#x27;] ) &amp;&amp; $form[&#x27;feps_credits&#x27;] == &#x27;true&#x27; ) ? &#x27;style=&quot;display:none;&quot;&#x27; : &#x27;&#x27; ); ?&gt;
                &lt;ul&gt;
                  &lt;?php do_action(&#x27;wpp_feps_form_settings_general_top&#x27;, array(&#x27;form&#x27;=&gt;$form, &#x27;form_id&#x27;=&gt;$form_id)); ?&gt;
                  &lt;li &lt;?php echo $hidden; ?&gt;&gt;
                    &lt;?php echo sprintf(__(&#x27;%1$s Status:&#x27;, &#x27;wpp&#x27;), ucfirst(WPP_F::property_label(&#x27;singular&#x27;))); ?&gt;
                    &lt;select name=&quot;wpp_feps[forms][&lt;?php echo $form_id; ?&gt;][new_post_status]&quot;&gt;
                    &lt;?php foreach($wp_post_statuses as $post_status =&gt; $post_status_data) { ?&gt;
                      &lt;option &lt;?php selected($post_status, $form[&#x27;new_post_status&#x27;]); ?&gt; value=&quot;&lt;?php echo esc_attr($post_status); ?&gt;&quot;&gt;&lt;?php echo $post_status_data-&gt;label; ?&gt;&lt;/option&gt;
                    &lt;?php } ?&gt;
                    &lt;/select&gt;
                  &lt;/li&gt;
                  &lt;li&gt;
                    &lt;?php echo sprintf(__(&#x27;%1$s Type:&#x27;, &#x27;wpp&#x27;), ucfirst(WPP_F::property_label(&#x27;singular&#x27;))); ?&gt;
                    &lt;select name=&quot;wpp_feps[forms][&lt;?php echo $form_id; ?&gt;][property_type]&quot;&gt;
                    &lt;?php foreach($wp_properties[&#x27;property_types&#x27;] as $pt_slug =&gt; $pt_label) {  ?&gt;
                      &lt;option &lt;?php selected($pt_slug, $form[&#x27;property_type&#x27;]); ?&gt; value=&quot;&lt;?php echo esc_attr($pt_slug); ?&gt;&quot;&gt;&lt;?php echo $pt_label; ?&gt;&lt;/option&gt;
                    &lt;?php } ?&gt;
                    &lt;/select&gt;
                  &lt;/li&gt;
                  &lt;li&gt;
                    &lt;?php _e(&#x27;Automatically remove FEPS of the currrent Form with \&#x27;Pending\&#x27; status to trash in&#x27;, &#x27;wpp&#x27;); ?&gt;
                    &lt;input class=&quot;wpp_number&quot; name=&quot;wpp_feps[forms][&lt;?php echo $form_id; ?&gt;][trash_time]&quot; type=&quot;text&quot; value=&quot;&lt;?php echo esc_attr(abs((int)$form[&#x27;trash_time&#x27;])); ?&gt;&quot; /&gt;
                    &lt;?php _e(&#x27;days.&#x27;, &#x27;wpp&#x27;); ?&gt;
                    &lt;span class=&quot;description&quot;&gt;&lt;?php _e(&#x27;Note: If value is 0 or empty, FEPS will not be removed.&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/span&gt;
                  &lt;/li&gt;
                  &lt;li&gt;
                    &lt;?php _e(&#x27;Preview Thumbnail Size:&#x27;, &#x27;wpp&#x27;); ?&gt;
                    &lt;?php WPP_F::image_sizes_dropdown(&quot;name=wpp_feps[forms][{$form_id}][thumbnail_size]&amp;selected={$form[&#x27;thumbnail_size&#x27;]}&quot;); ?&gt;
                  &lt;/li&gt;
                  &lt;li &lt;?php echo $hidden; ?&gt;&gt;
                    &lt;?php _e(&#x27;Image Upload Limit:&#x27;, &#x27;wpp&#x27;); ?&gt;
                    &lt;input class=&quot;imageslimit wpp_number&quot; name=&quot;wpp_feps[forms][&lt;?php echo $form_id; ?&gt;][images_limit]&quot; type=&quot;text&quot; value=&quot;&lt;?php echo esc_attr(abs((int)$form[&#x27;images_limit&#x27;])); ?&gt;&quot; /&gt;
                  &lt;/li&gt;
                  &lt;li&gt;
                    &lt;?php _e(&#x27;New User Role:&#x27;, &#x27;wpp&#x27;); ?&gt;
                    &lt;select class=&quot;wp_crm_role&quot; name=&quot;wpp_feps[forms][&lt;?php echo $form_id; ?&gt;][new_role]&quot;&gt;
                      &lt;option value=&quot;&quot;&gt;&lt;/option&gt;
                      &lt;?php wp_dropdown_roles($form[&#x27;new_role&#x27;]); ?&gt;
                    &lt;/select&gt;
                  &lt;/li&gt;
                  &lt;li&gt;
                    &lt;input type=&quot;checkbox&quot; name=&quot;wpp_feps[forms][&lt;?php echo $form_id; ?&gt;][can_manage_feps]&quot; &lt;?php checked(&#x27;true&#x27;, $form[&#x27;can_manage_feps&#x27;]); ?&gt; value=&quot;true&quot; /&gt;
                    &lt;?php _e(&#x27;Allow user to edit and remove his FEPS.&#x27;, &#x27;wpp&#x27;); ?&gt;
                    &lt;span class=&quot;description&quot;&gt;&lt;?php _e(&#x27;Note: on remove FEPS will be just moved to trash.&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/span&gt;
                  &lt;/li&gt;
                  &lt;li &lt;?php echo $hidden; ?&gt;&gt;
                    &lt;input type=&quot;checkbox&quot; name=&quot;wpp_feps[forms][&lt;?php echo $form_id; ?&gt;][notifications][user_creation]&quot; &lt;?php checked(&#x27;disable&#x27;, $form[&#x27;notifications&#x27;][&#x27;user_creation&#x27;]); ?&gt; value=&quot;disable&quot; /&gt;
                    &lt;?php _e(&#x27;Disable new user account creation notification.&#x27;, &#x27;wpp&#x27;); ?&gt;
                  &lt;/li&gt;
                  &lt;li&gt;
                    &lt;input type=&quot;checkbox&quot; name=&quot;wpp_feps[forms][&lt;?php echo $form_id; ?&gt;][notifications][on_status_updated]&quot; &lt;?php checked(&#x27;true&#x27;, $form[&#x27;notifications&#x27;][&#x27;on_status_updated&#x27;]); ?&gt; value=&quot;true&quot; /&gt;
                    &lt;?php _e(&#x27;Notify user on update status of his FEPS.&#x27;, &#x27;wpp&#x27;); ?&gt;
                  &lt;/li&gt;
                &lt;/ul&gt;
              &lt;/td&gt;
            &lt;/tr&gt;
            &lt;?php do_action(&#x27;wpp_feps_form_settings_after_general&#x27;, array(&#x27;form&#x27;=&gt;$form, &#x27;form_id&#x27;=&gt;$form_id)); ?&gt;
            &lt;tr&gt;
              &lt;th colspan=&quot;2&quot;&gt;
                &lt;h3 style=&quot;float:left;&quot;&gt;&lt;?php echo sprintf(__( &#x27;%1$s Attributes&#x27;, &#x27;wpp&#x27; ), ucfirst(WPP_F::property_label(&#x27;singular&#x27;))); ?&gt;&lt;/h3&gt;
                &lt;table class=&quot;ud_ui_dynamic_table widefat wpp_feps_sortable&quot; use_random_row_id=&quot;true&quot;&gt;
                  &lt;thead&gt;
                    &lt;tr&gt;
                      &lt;th class=&quot;wpp_draggable_handle&quot;&gt;&lt;/th&gt;
                      &lt;th&gt;&lt;?php _e(&#x27;Main&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/th&gt;
                      &lt;th&gt;&lt;?php _e(&#x27;Description&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/th&gt;
                    &lt;/tr&gt;
                  &lt;/thead&gt;
                  &lt;tbody&gt;
                    &lt;tr class=&quot;wpp_dynamic_table_row required&quot; random_row_id=&quot;post_title&quot;&gt;
                      &lt;td class=&quot;wpp_draggable_handle&quot;&gt;&lt;/td&gt;
                      &lt;td class=&quot;main_feps&quot;&gt;
                        &lt;ul&gt;
                          &lt;li&gt;
                            &lt;label&gt;&lt;?php _e(&#x27;Attribute&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/label&gt;
                            &lt;input type=&quot;hidden&quot; name=&quot;wpp_feps[forms][&lt;?php echo $form_id; ?&gt;][required][post_title][attribute]&quot; value=&quot;post_title&quot; /&gt;
                            &lt;select disabled=&quot;disabled&quot; class=&quot;wpp_feps_new_attribute&quot;&gt;
                              &lt;option&gt;&lt;?php echo sprintf(__(&#x27;%1$s Title&#x27;, &#x27;wpp&#x27;), ucfirst(WPP_F::property_label(&#x27;singular&#x27;))); ?&gt;&lt;/option&gt;
                            &lt;/select&gt;
                          &lt;/li&gt;
                          &lt;li class=&quot;wpp_development_advanced_option&quot;&gt;
                            &lt;label&gt;&lt;?php _e(&#x27;Title&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/label&gt;
                            &lt;input type=&quot;text&quot; class=&quot;title&quot; name=&quot;wpp_feps[forms][&lt;?php echo $form_id; ?&gt;][required][post_title][title]&quot; value=&quot;&lt;?php echo $form[&#x27;required&#x27;][&#x27;post_title&#x27;][&#x27;title&#x27;] ?&gt;&quot; /&gt;
                          &lt;/li&gt;
                          &lt;li&gt;
                            &lt;span class=&quot;wpp_show_advanced&quot;&gt;&lt;?php _e(&#x27;Toggle Advanced Settings&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/span&gt;
                          &lt;/li&gt;
                        &lt;/ul&gt;
                      &lt;/td&gt;
                      &lt;td&gt;
                        &lt;textarea class=&quot;description wpp_full_width&quot; name=&quot;wpp_feps[forms][&lt;?php echo $form_id; ?&gt;][required][post_title][description]&quot;&gt;&lt;?php echo $form[&#x27;required&#x27;][&#x27;post_title&#x27;][&#x27;description&#x27;] ?&gt;&lt;/textarea&gt;
                      &lt;/td&gt;
                    &lt;/tr&gt;
                    &lt;?php
                      if ( !empty( $form[&#x27;fields&#x27;] ) ) {
                        foreach($form[&#x27;fields&#x27;] as $row_id =&gt; $field_data) {
                          $field_data = stripslashes_deep($field_data);
                    ?&gt;
                    &lt;tr class=&quot;wpp_dynamic_table_row&quot; random_row_id=&quot;&lt;?php echo $row_id; ?&gt;&quot;&gt;
                      &lt;td class=&quot;wpp_draggable_handle&quot;&gt;&lt;/td&gt;
                      &lt;td class=&quot;main_feps&quot;&gt;
                        &lt;ul&gt;
                          &lt;li&gt;
                            &lt;label&gt;&lt;?php _e(&#x27;Attribute&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/label&gt;
                            &lt;select  name=&quot;wpp_feps[forms][&lt;?php echo $form_id; ?&gt;][fields][&lt;?php echo $row_id; ?&gt;][attribute]&quot;  class=&quot;wpp_feps_new_attribute&quot;&gt;
                              &lt;option&gt;&lt;/option&gt;
                              &lt;?php foreach($available_attributes as $group_label =&gt; $opt_group) { ?&gt;
                                &lt;optgroup label=&quot;&lt;?php echo esc_attr($group_label); ?&gt;&quot;&gt;
                                &lt;?php foreach($opt_group as $attribute =&gt; $label) { ?&gt;
                                &lt;option &lt;?php selected($field_data[&#x27;attribute&#x27;], $attribute); ?&gt; value=&quot;&lt;?php echo esc_attr($attribute); ?&gt;&quot;&gt;&lt;?php echo esc_attr($label); ?&gt;&lt;/option&gt;
                                &lt;?php } ?&gt;
                                &lt;/optgroup&gt;
                              &lt;?php } ?&gt;
                            &lt;/select&gt;
                          &lt;/li&gt;
                          &lt;li class=&quot;wpp_development_advanced_option&quot;&gt;
                            &lt;label&gt;&lt;?php _e(&#x27;Title&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/label&gt;
                            &lt;input type=&quot;text&quot; class=&quot;title&quot; name=&quot;wpp_feps[forms][&lt;?php echo $form_id; ?&gt;][fields][&lt;?php echo $row_id; ?&gt;][title]&quot; value=&quot;&lt;?php echo $field_data[&#x27;title&#x27;]; ?&gt;&quot; /&gt;
                          &lt;/li&gt;
                          &lt;li class=&quot;wpp_development_advanced_option&quot;&gt;
                            &lt;input type=&quot;checkbox&quot; name=&quot;wpp_feps[forms][&lt;?php echo $form_id; ?&gt;][fields][&lt;?php echo $row_id; ?&gt;][required]&quot; &lt;?php checked(&#x27;on&#x27;, $field_data[&#x27;required&#x27;]); ?&gt; /&gt;
                            &lt;label&gt;&lt;?php _e(&#x27;Required&#x27;); ?&gt;&lt;/label&gt;
                          &lt;/li&gt;
                          &lt;li class=&quot;wpp_development_advanced_option&quot;&gt;
                            &lt;a class=&quot;wpp_forms_remove_attribute&quot; row=&quot;&lt;?php echo $row_id; ?&gt;&quot; href=&quot;javascript:void(0);&quot;&gt;Remove attribute&lt;/a&gt;
                          &lt;/li&gt;
                          &lt;li&gt;
                            &lt;span class=&quot;wpp_show_advanced&quot;&gt;&lt;?php _e(&#x27;Toggle Advanced Settings&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/span&gt;
                          &lt;/li&gt;
                        &lt;/ul&gt;
                      &lt;/td&gt;
                      &lt;td&gt;
                        &lt;textarea class=&quot;description wpp_full_width&quot; name=&quot;wpp_feps[forms][&lt;?php echo $form_id; ?&gt;][fields][&lt;?php echo $row_id; ?&gt;][description]&quot;&gt;&lt;?php echo $field_data[&#x27;description&#x27;]; ?&gt;&lt;/textarea&gt;
                      &lt;/td&gt;
                    &lt;/tr&gt;
                    &lt;?php
                        }
                      }
                    ?&gt;
                  &lt;/tbody&gt;
                  &lt;tfoot&gt;
                    &lt;tr&gt;
                      &lt;td colspan=&quot;3&quot;&gt;
                        &lt;input type=&quot;button&quot; callback_function=&quot;wpp_feps_added_row&quot; class=&quot;wpp_add_row button-secondary&quot; value=&quot;&lt;?php _e(&#x27;Add Row&#x27;,&#x27;wpp&#x27;) ?&gt;&quot; /&gt;
                      &lt;/td&gt;
                    &lt;/tr&gt;
                  &lt;/tfoot&gt;
                &lt;/table&gt;
              &lt;/th&gt;
            &lt;/tr&gt;
            &lt;?php do_action(&#x27;wpp_feps_form_settings_right&#x27;, array(&#x27;form&#x27;=&gt;$form, &#x27;form_id&#x27;=&gt;$form_id)); ?&gt;
          &lt;/table&gt;
          &lt;!-- EO Settings form table --&gt;

        &lt;/div&gt;
        &lt;div class=&quot;clear&quot;&gt;&lt;/div&gt;
        &lt;?php } ?&gt;
      &lt;/div&gt;
      &lt;br class=&quot;cb&quot; /&gt;
      &lt;p class=&quot;wpp_save_changes_row&quot;&gt;
        &lt;input type=&quot;submit&quot;  value=&quot;&lt;?php _e(&#x27;Save Changes&#x27;,&#x27;wpp&#x27;);?&gt;&quot; class=&quot;button-primary btn&quot; name=&quot;Submit&quot; /&gt;
      &lt;/p&gt;

    &lt;/div&gt;

    &lt;?php
  }


  /**
   * Loads &#x27;My FEPS Listings&#x27; page
   *
   * @author peshkov@UD
   * @since 2.0
   * @version 0.1
   */
  function my_feps_page_load() {
    global $wpdb, $wp_query, $wp_properties;

    //** STEP 1. Check permissions */

    //** Determine if user is logged in */
    if ( !is_user_logged_in() ) {
      die( wp_redirect( site_url(&#x27;&#x27;) ) );
    }
    $user = wp_get_current_user();

    //** STEP 2. Determine if feps should be removed, check permissions, remove it and reload page */
    //** Determine if user has any FEP submission already. */
    $feps = $wpdb-&gt;get_col(&quot;
      SELECT p.ID FROM {$wpdb-&gt;posts} AS p
        JOIN {$wpdb-&gt;postmeta} AS pm ON pm.post_id = p.ID
        WHERE pm.meta_key = &#x27;wpp_feps_property&#x27;
          AND p.post_author = &#x27;{$user-&gt;ID}&#x27;
    &quot;);

    if( !empty( $_REQUEST[&#x27;feps&#x27;] ) &amp;&amp;
        !empty( $_REQUEST[&#x27;action&#x27;] ) &amp;&amp;
        !empty( $_REQUEST[&#x27;hash&#x27;] ) &amp;&amp;
        $_REQUEST[&#x27;action&#x27;] == &#x27;remove&#x27; &amp;&amp;
        in_array( $_REQUEST[&#x27;feps&#x27;], $feps )
    ) {
      $post_id = (int)$_REQUEST[&#x27;feps&#x27;];
      //** Check if hash is correct and move FEPS to trash */
      if ( $_REQUEST[&#x27;hash&#x27;] == get_post_meta( $post_id, &#x27;wpp::feps::pending_hash&#x27;, true ) ) {
        $form_id = get_post_meta( $post_id, FEPS_META_FORM, true );
        $forms = $wp_properties[&#x27;configuration&#x27;][&#x27;feature_settings&#x27;][&#x27;feps&#x27;][&#x27;forms&#x27;];
        if ( $form_id &amp;&amp; !empty( $forms[$form_id][&#x27;can_manage_feps&#x27;] ) &amp;&amp; $forms[$form_id][&#x27;can_manage_feps&#x27;] == &#x27;true&#x27; ) {
          //** Move FEPS to trash */
          wp_trash_post($post_id);
        }
      }
      die( wp_redirect( WPP_F::base_url( FEPS_VIEW_PAGE ) ) );
    }

    //** STEP 3. Try to get templates */

    $template = $wp_properties[&#x27;configuration&#x27;][&#x27;feps&#x27;][&#x27;templates&#x27;][&#x27;overview_page&#x27;];
    $template = str_replace( &#x27;.php&#x27;, &#x27;&#x27;, $template );

    //** Load the first found general template */
    $template_found = WPP_F::get_template_part( array_filter( array(
      $template,
      &#x27;page&#x27;,
      &#x27;single&#x27;,
    ) ) );

    //* Determine if all necessary templates are loaded and finish loading. */
    if( $template_found ) {

      //* Set filter data */
      $status = &#x27;publish,pending&#x27;;
      $additional_title = &#x27;&#x27;;
      if ( !empty( $_REQUEST[&#x27;status&#x27;] ) &amp;&amp; in_array( $_REQUEST[&#x27;status&#x27;], array(&#x27;publish&#x27;,&#x27;pending&#x27;, &#x27;all&#x27;) ) ) {
        if ( $_REQUEST[&#x27;status&#x27;] == &#x27;all&#x27; ) {
          $additional_title = &quot;(&quot; . __(&#x27;All&#x27;, &#x27;wpp&#x27;) . &quot;)&quot;;
        } else {
          $additional_title = &quot;(&quot; . WPP_F::clear_post_status( $_REQUEST[&#x27;status&#x27;] ) . &quot;)&quot;;
          $status = $_REQUEST[&#x27;status&#x27;];
        }
      }

      //** Create a fake WP Listings / Search Page */
      $wp_query-&gt;is_404 = false;
      $wp_query-&gt;post_count = 1;
      $wp_query-&gt;posts[0] = (object) array(
        &#x27;ID&#x27; =&gt; &#x27;999999&#x27;,
        &#x27;post_title&#x27; =&gt; ( __(&#x27;My FEPS Listings&#x27;, &#x27;wpp&#x27;) . &quot; &quot; . $additional_title ),
        &#x27;post_content&#x27; =&gt; &quot;[property_overview post_author={$user-&gt;ID} wpp_feps_property=true post_status={$status} template=my-feps]&quot;,
        &#x27;post_name&#x27; =&gt; &#x27;my_feps&#x27;,
        &#x27;post_type&#x27; =&gt; &#x27;page&#x27;,
        &#x27;post_status&#x27; =&gt; &#x27;publish&#x27;,
        &#x27;post_author&#x27; =&gt;  $user-&gt;ID
      );

      die( load_template( $template_found ) );

    } else {

      WPP_F::console_log( &#x27;Could not find MY FEPS template.&#x27; );

      $wp_query-&gt;is_404 = true;

    }

  }


  /**
   * Loads &#x27;FEPS Edit Listing&#x27; page
   *
   * @author peshkov@UD
   * @since 1.4
   * @version 0.1
   */
  function feps_edit_page_load() {
    global $wpdb, $wp_query, $property, $wp_properties;

    //** STEP 1. Check property and permissions */

    //** Determine if user is logged in */
    if ( !is_user_logged_in() || !isset($_REQUEST[&#x27;feps&#x27;]) || !(int)$_REQUEST[&#x27;feps&#x27;] &gt; 0 ) {
      die( wp_redirect( site_url(&#x27;&#x27;) ) );
    }
    $user = wp_get_current_user();

    $property = WPP_F::get_property( (int)$_REQUEST[&#x27;feps&#x27;] );

    //** Check property */
    if( !$property ||
        $property[&#x27;ID&#x27;] != $_REQUEST[&#x27;feps&#x27;] ||
        empty( $property[ FEPS_META_FORM ] ) ||
        empty( $wp_properties[&#x27;configuration&#x27;][&#x27;feature_settings&#x27;][&#x27;feps&#x27;][&#x27;forms&#x27;][$property[ FEPS_META_FORM ]] ) ||
        $property[&#x27;wpp_feps_property&#x27;] != true ||
        $user-&gt;ID != $property[&#x27;post_author&#x27;]
    ) {
      die( wp_redirect( site_url(&#x27;&#x27;) ) );
    }

    $feps_form = $wp_properties[&#x27;configuration&#x27;][&#x27;feature_settings&#x27;][&#x27;feps&#x27;][&#x27;forms&#x27;][$property[ FEPS_META_FORM ]][&#x27;slug&#x27;];

    //* STEP 2. Try to get and load template */

    //** Load the first found default template */
    $template_found = WPP_F::get_template_part( array(
      &#x27;page&#x27;,
      &#x27;single&#x27;,
    ) );

    //* STEP 3. */

    $post_content = &quot;[wpp_feps_form form={$feps_form} property_id={$property[&#x27;ID&#x27;]} action=edit]&quot;;

    //* Determine if template is found and finish loading. */
    if( $template_found ) {

      //** Create a fake Page */
      $wp_query-&gt;is_404 = false;
      $wp_query-&gt;post_count = 1;
      $wp_query-&gt;posts[0] = (object) array(
        &#x27;ID&#x27; =&gt; $property[&#x27;ID&#x27;],
        &#x27;post_title&#x27; =&gt; $property[&#x27;post_title&#x27;] . &quot; &quot; . __(&#x27;Editing&#x27;, &#x27;wpp&#x27;),
        &#x27;post_content&#x27; =&gt; WPP_F::minify_js($post_content),
        &#x27;post_name&#x27; =&gt; $property[&#x27;post_name&#x27;],
        &#x27;post_type&#x27; =&gt; &#x27;page&#x27;,
        &#x27;post_status&#x27; =&gt; &#x27;publish&#x27;,
        &#x27;post_author&#x27; =&gt;  $user-&gt;ID
      );

      die( load_template( $template_found ) );

    } else {

      WPP_F::console_log( &#x27;Could not find template for FEPS Edit page.&#x27; );

      $wp_query-&gt;is_404 = true;

    }
  }


  /**
   * Save USP settings
   *
   * @since 0.1
   */
  function save_feps_settings($settings) {
    global $wp_properties;

    if ( !empty( $settings[&#x27;forms&#x27;] ) ) {
      foreach( $settings[&#x27;forms&#x27;] as $form_k =&gt; $form ) {

        if ( !empty( $form[ &#x27;fields&#x27; ] ) &amp;&amp; is_array( $form[ &#x27;fields&#x27; ] ) ) {
          foreach ( $form[ &#x27;fields&#x27; ] as $k =&gt; $v ) {
            if ( empty( $v[ &#x27;attribute&#x27; ] ) ) {
              unset( $settings[ &#x27;forms&#x27; ][$form_k][ &#x27;fields&#x27; ][$k] );
            }
          }
        }

        //** Duration value, Images Limit and price must be at least 1 and higher. */
        if( !empty( $form[ &#x27;subscription_plans&#x27; ] ) &amp;&amp; is_array( $form[ &#x27;subscription_plans&#x27; ] ) ) {
          foreach ( $form[ &#x27;subscription_plans&#x27; ] as $k =&gt; $v ) {
            if( empty( $v[ &#x27;price&#x27; ] ) || !(float)$v[ &#x27;price&#x27; ] &gt; 0 ) {
              $settings[&#x27;forms&#x27;][ $form_k ][ &#x27;subscription_plans&#x27; ][ $k ][ &#x27;price&#x27; ] = &#x27;1&#x27;;
            }
            if( empty( $v[ &#x27;images_limit&#x27; ] ) || !(int)$v[ &#x27;images_limit&#x27; ] &gt; 0 ) {
              $settings[&#x27;forms&#x27;][ $form_k ][ &#x27;subscription_plans&#x27; ][ $k ][ &#x27;images_limit&#x27; ] = &#x27;1&#x27;;
            }
            if( is_array( $v[ &#x27;duration&#x27; ] ) &amp;&amp;  ( empty( $v[ &#x27;duration&#x27; ][ &#x27;value&#x27; ] ) || !(int)$v[ &#x27;duration&#x27; ][ &#x27;value&#x27; ] &gt; 0 ) ) {
              $settings[&#x27;forms&#x27;][ $form_k ][ &#x27;subscription_plans&#x27; ][ $k ][ &#x27;duration&#x27; ][ &#x27;value&#x27; ] = &#x27;1&#x27;;
            }
          }
        }
      }
    }

    $wp_properties[&#x27;configuration&#x27;][&#x27;feature_settings&#x27;][&#x27;feps&#x27;] = $settings;
    update_option(&#x27;wpp_settings&#x27;, $wp_properties);
    return $wp_properties;
  }


  /**
   * Modifies the way input fields are renderd
   *
   * $data array includes:
   * - this_session - FEPS form settings
   * - att_data - data about the attribute
   * - row_id - unique ID of row
   * - args - FEPS form settings
   * - property - array of property data (if exists)
   *
   * $data[&#x27;att_data&#x27;] includes:
   * - slug
   * - value
   * - required
   * - ui_class
   * - title
   * - description
   * - input_type
   * - storage_type
   * - is_meta
   *
   * @since 0.1
   *
   */
  function wpp_feps_input( $data ) {
    global $wp_properties;

    $data = wp_parse_args( $data, array(
      &#x27;this_session&#x27; =&gt; false,
      &#x27;form_dom_id&#x27; =&gt; &#x27;&#x27;,
      &#x27;att_data&#x27; =&gt; &#x27;&#x27;,
      &#x27;row_id&#x27; =&gt; &#x27;&#x27;,
      &#x27;args&#x27; =&gt; array(),
      &#x27;property&#x27; =&gt; false,
      &#x27;images_limit&#x27; =&gt; 0,
      &#x27;return&#x27; =&gt; false
    ));

    extract( $data );

    $styled = &#x27;&#x27;;

    /** Use this only for FEPS with Denali installed */
    if ( strstr(get_option(&#x27;template&#x27;), &#x27;denali&#x27;) ) {
      $styled = &#x27; styled&#x27;;
    }

    //** Try to get data input type first, then user regular (search) input type */
    $input_type = ($att_data[&#x27;data_input_type&#x27;] ? $att_data[&#x27;data_input_type&#x27;]: $att_data[&#x27;input_type&#x27;]);

    //** If dropdown, load predefined values */
    if($input_type == &#x27;dropdown&#x27;) {

      if ( !empty( $att_data[&#x27;predefined_values&#x27;] ) ) {
        $values = explode(&#x27;,&#x27;, $att_data[&#x27;predefined_values&#x27;]);
      } else {
        $values = array();
      }

    }

    $att_data[&#x27;ui_class&#x27;] .= $att_data[&#x27;required&#x27;] == &#x27;on&#x27; ? &#x27; required&#x27; : &#x27;&#x27;;

    ob_start();

    switch($input_type) {

      case &#x27;dropdown&#x27;: ?&gt;
        &lt;select class=&quot;&lt;?php echo $att_data[&#x27;ui_class&#x27;] . $styled; ?&gt;&quot; tabindex=&quot;&lt;?php echo $att_data[&#x27;tabindex&#x27;] ?&gt;&quot; id=&quot;wpp_&lt;?php echo $row_id; ?&gt;_select&quot; name=&quot;wpp_feps_data[&lt;?php echo $att_data[&#x27;slug&#x27;]; ?&gt;]&quot;&gt;
            &lt;option value=&quot;&quot;&gt;&lt;/option&gt;
          &lt;?php foreach( $values as $value ) { ?&gt;
            &lt;option value=&quot;&lt;?php echo $value; ?&gt;&quot;&lt;?php echo (($data[&#x27;property&#x27;][$att_data[&#x27;slug&#x27;]]==$value) ? &#x27; selected=&quot;selected&quot;&#x27; : &#x27;&#x27; )?&gt;&gt;&lt;?php echo  apply_filters(&#x27;wpp_stat_filter_&#x27; . $att_data[&#x27;slug&#x27;], $value); ?&gt;&lt;/option&gt;
          &lt;?php } ?&gt;
        &lt;/select&gt;
        &lt;?php
      break;

      case &#x27;checkbox&#x27;: ?&gt;
        &lt;input tabindex=&quot;&lt;?php echo $att_data[&#x27;tabindex&#x27;] ?&gt;&quot; type=&quot;checkbox&quot; id=&quot;wpp_&lt;?php echo $row_id; ?&gt;_input&quot;  name=&quot;wpp_feps_data[&lt;?php echo $att_data[&#x27;slug&#x27;]; ?&gt;]&quot; class=&quot;&lt;?php echo $att_data[&#x27;required&#x27;]==&#x27;on&#x27;?&#x27;required &#x27;:&#x27; &#x27;; echo $att_data[&#x27;ui_class&#x27;].$styled; ?&gt;&quot; value=&quot;true&quot; &lt;?php echo (($data[&#x27;property&#x27;][$att_data[&#x27;slug&#x27;]]==true) ? &#x27; checked=&quot;checked&quot;&#x27; : &#x27;&#x27; )?&gt; /&gt;
      &lt;?php
      break;

      case &#x27;textarea&#x27;:
        ?&gt;
        &lt;textarea tabindex=&quot;&lt;?php echo $att_data[&#x27;tabindex&#x27;] ?&gt;&quot;  id=&quot;wpp_&lt;?php echo $row_id; ?&gt;_input&quot; name=&quot;wpp_feps_data[&lt;?php echo $att_data[&#x27;slug&#x27;]; ?&gt;]&quot; class=&quot;&lt;?php echo $att_data[&#x27;ui_class&#x27;]; ?&gt;&quot;&gt;&lt;?php echo (!empty($data[&#x27;property&#x27;][$att_data[&#x27;slug&#x27;]])?$data[&#x27;property&#x27;][$att_data[&#x27;slug&#x27;]]:&#x27;&#x27;);?&gt;&lt;/textarea&gt;
      &lt;?php
      break;

      case &#x27;image_upload&#x27;:
        ?&gt;
        &lt;img class=&quot;wpp_feps_images_loading&quot; src=&quot;&lt;?php echo WPP_URL . &#x27;images/ajax_loader.gif&#x27; ?&gt;&quot; style=&quot;visibility:hidden;&quot; /&gt;
        &lt;div class=&quot;wpp_image_upload&quot;&gt;
          &lt;div class=&quot;ajax_uploader&quot;&gt;&lt;?php _e(&#x27;Upload Image&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/div&gt;
          &lt;span id=&quot;status&quot;&gt;&lt;/span&gt;
          &lt;ul id=&quot;files&quot;&gt;
            &lt;?php foreach ((array)$data[&#x27;property&#x27;][&#x27;gallery&#x27;] as $imkey=&gt;$im_data): ?&gt;
            &lt;li class=&quot;qq-old-images&quot;&gt;&lt;img src=&quot;&lt;?php echo $im_data[&#x27;thumbnail&#x27;]; ?&gt;&quot; class=&quot;wpp_feps_existing_thumb&quot; session=&quot;&lt;?php echo $this_session; ?&gt;&quot; filename=&quot;&lt;?php echo $im_data[&#x27;post_title&#x27;]; ?&gt;&quot; title=&quot;Click to Remove&quot;&gt;&lt;/li&gt;
            &lt;?php endforeach; ?&gt;
          &lt;/ul&gt;
          &lt;?php foreach ((array)$data[&#x27;property&#x27;][&#x27;gallery&#x27;] as $imkey=&gt;$im_data):?&gt;
          &lt;input type=&quot;hidden&quot; name=&quot;wpp_feps_data[&lt;?php echo $att_data[&#x27;slug&#x27;]; ?&gt;][&lt;?php echo $im_data[&#x27;attachment_id&#x27;]; ?&gt;]&quot; id=&quot;&lt;?php echo $im_data[&#x27;post_title&#x27;]; ?&gt;&quot; value=&quot;on&quot; /&gt;
          &lt;?php endforeach; ?&gt;
        &lt;/div&gt;
        &lt;?php if($images_limit &gt; 0) { ?&gt;
        &lt;span class=&quot;images_limit&quot;&gt;&lt;?php printf(__(&#x27;No more than %1d image(s). Click image to delete it.&#x27;, &#x27;wpp&#x27;), $images_limit); ?&gt;&lt;/span&gt;
        &lt;?php } ?&gt;

        &lt;?php ob_start(); ?&gt;
        &lt;script type=&quot;text/javascript&quot;&gt;
          jQuery(document).ready(function() {
            //** Remove image handler - korotkov@ud */
            jQuery(&#x27;img.wpp_feps_preview_thumb&#x27;).live(&#x27;click&#x27;, function(){
              //** turn on loader */
              jQuery(&#x27;.wpp_feps_images_loading&#x27;).css({&#x27;visibility&#x27;:&#x27;visible&#x27;});
              //** init request data */
              var image = jQuery(this);
              var data = {
                action: &#x27;wpp_feps_image_delete&#x27;,
                session: image.attr(&#x27;session&#x27;),
                filename: image.attr(&#x27;filename&#x27;)
              };
              //** send  */
              jQuery.post(
                &#x27;&lt;?php echo admin_url(&#x27;admin-ajax.php&#x27;); ?&gt;&#x27;,
                data,
                function(response) {
                  //** turn off loader */
                  jQuery(&#x27;.wpp_feps_images_loading&#x27;).css({&#x27;visibility&#x27;:&#x27;hidden&#x27;});
                  //** if image removed */
                  if ( response.success ) {
                    //** remove image (not it&#x27;s parent li - important) from page */
                    image.remove();
                    //** increase images count and check if we can upload more images */
                    if ( ++max_images &gt; 0 ) {
                      jQuery(&#x27;div.qq-upload-drop-area&#x27;).show();
                      jQuery(&#x27;div.qq-upload-button input&#x27;).show();
                      jQuery(&#x27;div.qq-upload-button&#x27;).css({&#x27;visibility&#x27;:&#x27;visible&#x27;});
                    }
                  }
                },
                &#x27;json&#x27;
              );
            });

            jQuery(&#x27;img.wpp_feps_existing_thumb&#x27;).live(&#x27;click&#x27;, function(){
              //** turn on loader */
              jQuery(&#x27;.wpp_feps_images_loading&#x27;).css({&#x27;visibility&#x27;:&#x27;visible&#x27;});
              //** init request data */
              jQuery(this).closest(&#x27;li.qq-old-images&#x27;).remove();
              jQuery(&#x27;input#&#x27;+jQuery(this).attr(&#x27;filename&#x27;)).attr(&#x27;value&#x27;,&#x27;off&#x27;);
              ++max_images;

              if ( ++max_images &gt; 0 ) {
                jQuery(&#x27;div.qq-upload-drop-area&#x27;).show();
                jQuery(&#x27;div.qq-upload-button input&#x27;).show();
                jQuery(&#x27;div.qq-upload-button&#x27;).css({&#x27;visibility&#x27;:&#x27;visible&#x27;});
              }
              jQuery(&#x27;.wpp_feps_images_loading&#x27;).css({&#x27;visibility&#x27;:&#x27;hidden&#x27;});
            });

            if(typeof(qq) == &#x27;undefined&#x27;) {
              return;
            }

            var max_images = &lt;?php echo $images_limit - count((array)$data[&#x27;property&#x27;][&#x27;gallery&#x27;]); ?&gt;;

            var this_form = jQuery(&quot;#&lt;?php echo $form_dom_id; ?&gt;&quot;);

            var uploader = new qq.FileUploader({
              element: jQuery(&#x27;.wpp_image_upload .ajax_uploader&#x27;, this_form)[0],
              action: &#x27;&lt;?php echo admin_url(&#x27;admin-ajax.php&#x27;); ?&gt;&#x27;,
              params: {
                  action: &#x27;wpp_feps_image_upload&#x27;,
                  this_session: &#x27;&lt;?php echo $this_session; ?&gt;&#x27;
              },
              name: &#x27;wpp_feps_files&#x27;,
              onComplete: function(id, fileName, responseJSON){
                if ( responseJSON ) {
                  max_images--;
                  if ( max_images &lt;= 0 ) {
                    jQuery(&#x27;div.qq-upload-drop-area&#x27;).hide();
                    jQuery(&#x27;div.qq-upload-button input&#x27;).hide();
                    jQuery(&#x27;div.qq-upload-button&#x27;).css({&#x27;visibility&#x27;:&#x27;hidden&#x27;});
                  }
                  var thumb_url = responseJSON.thumb_url;
                  if ( jQuery.browser.msie || jQuery.browser.opera ) {
                    id = String(id).substring(String(id).length, String(id).length-1);
                  }
                  jQuery( jQuery(&quot;ul.qq-upload-list li&quot;).get(id) ).html(&#x27;&lt;img title=&quot;Click to Remove&quot; filename=&quot;&#x27;+fileName+&#x27;&quot; session=&quot;&lt;?php echo $this_session; ?&gt;&quot; class=&quot;wpp_feps_preview_thumb&quot; src=&quot;&#x27; + thumb_url + &#x27;&quot;/&gt;&#x27;);
                }
              }
            });

            if ( max_images &lt;= 0 ) {
              jQuery(&#x27;div.qq-upload-drop-area&#x27;).hide();
              jQuery(&#x27;div.qq-upload-button input&#x27;).hide();
              jQuery(&#x27;div.qq-upload-button&#x27;).css({&#x27;visibility&#x27;:&#x27;hidden&#x27;});
            }

          });
        &lt;/script&gt;
        &lt;?php
          $output_js = ob_get_contents();
          ob_end_clean();
          echo WPP_F::minify_js($output_js);

      break;

      default:
        ?&gt;
        &lt;input tabindex=&quot;&lt;?php echo $att_data[&#x27;tabindex&#x27;]; ?&gt;&quot;  id=&quot;wpp_&lt;?php echo $row_id; ?&gt;_input&quot;  name=&quot;wpp_feps_data[&lt;?php echo $att_data[&#x27;slug&#x27;]; ?&gt;]&quot; value=&quot;&lt;?php echo (!empty($data[&#x27;property&#x27;][$att_data[&#x27;slug&#x27;]])?$data[&#x27;property&#x27;][$att_data[&#x27;slug&#x27;]]:$att_data[&#x27;value&#x27;]);?&gt;&quot; type=&quot;text&quot; class=&quot;&lt;?php echo $att_data[&#x27;ui_class&#x27;]; ?&gt;&quot; /&gt;
        &lt;?php
      break;
    }

    if($att_data[&#x27;is_address_attribute&#x27;] &amp;&amp; empty($att_data[&#x27;property&#x27;][$att_data[&#x27;slug&#x27;]])) {

      //** Load coordinates from existing property (parent) or default */
      if(!empty($data[&#x27;property&#x27;][&#x27;latitude&#x27;]) &amp;&amp; !empty($data[&#x27;property&#x27;][&#x27;longitude&#x27;])) {
        $map_coords[&#x27;latitude&#x27;] = $data[&#x27;property&#x27;][&#x27;latitude&#x27;];
        $map_coords[&#x27;longitude&#x27;] = $data[&#x27;property&#x27;][&#x27;longitude&#x27;];
      } else {
        $map_coords = WPP_F::get_default_coordinates();
      }

      self::render_location_map_input( $row_id, $map_coords, $data[&#x27;args&#x27;] );
    }

    $content = ob_get_contents();
    ob_end_clean();

    $content = apply_filters( &#x27;wpp_feps_input&#x27;, $content, $data );

    if( $return ) {
      return $content;
    } else {
      echo $content;
    }

  }


  /**
   * Adds meta data to attributes
   *
   * @since 0.1
   */
  function add_attribute_data($data) {

    switch ($data[&#x27;slug&#x27;]) {

      case &#x27;post_content&#x27;:
        $data[&#x27;input_type&#x27;] = &#x27;textarea&#x27;;
        $data[&#x27;data_input_type&#x27;] = &#x27;textarea&#x27;;
        $data[&#x27;is_wp_core&#x27;] = true;;
        return $data;
      break;

      case &#x27;image_upload&#x27;:
        $data[&#x27;label&#x27;] = __(&#x27;Image Upload&#x27;, &#x27;wpp&#x27;);
        $data[&#x27;is_wp_core&#x27;] = true;
        $data[&#x27;input_type&#x27;] = &#x27;image_upload&#x27;;
        $data[&#x27;data_input_type&#x27;] = &#x27;image_upload&#x27;;
        $data[&#x27;storage_type&#x27;] = &#x27;image_upload&#x27;;
        return $data;

      break;
    }

    return $data;

  }

  /**
   * Load default settings
   * @global array $wp_properties
   */
  function load_defaults() {
    global $wp_properties;

    $random_id = rand(99, 9999999);
    $row_id    = rand(99, 9999999);

    $defaults[&#x27;forms&#x27;][$random_id][&#x27;title&#x27;] = &#x27;Sample Form&#x27;;
    $defaults[&#x27;forms&#x27;][$random_id][&#x27;new_role&#x27;] = &#x27;subscriber&#x27;;
    $defaults[&#x27;forms&#x27;][$random_id][&#x27;slug&#x27;] = &#x27;sample_form&#x27;;
    $defaults[&#x27;forms&#x27;][$random_id][&#x27;new_post_status&#x27;] = &#x27;pending&#x27;;
    $defaults[&#x27;forms&#x27;][$random_id][&#x27;images_limit&#x27;] = 6;

    $defaults[&#x27;forms&#x27;][$random_id][&#x27;required&#x27;][&#x27;post_title&#x27;][&#x27;title&#x27;] = &#x27;Property Title&#x27;;
    $defaults[&#x27;forms&#x27;][$random_id][&#x27;required&#x27;][&#x27;post_title&#x27;][&#x27;attribute&#x27;] = &#x27;post_title&#x27;;

    /*$defaults[&#x27;forms&#x27;][$random_id][&#x27;fields&#x27;][$row_id][&#x27;title&#x27;] = &#x27;Bedrooms&#x27;;
    $defaults[&#x27;forms&#x27;][$random_id][&#x27;fields&#x27;][$row_id][&#x27;attribute&#x27;] = &#x27;bedrooms&#x27;;
    $defaults[&#x27;forms&#x27;][$random_id][&#x27;fields&#x27;][$row_id][&#x27;required&#x27;] = &#x27;true&#x27;;*/

    $wp_properties[&#x27;configuration&#x27;][&#x27;feature_settings&#x27;][&#x27;feps&#x27;] = $defaults;

  }

  /**
   * Load default (first) field if there is no any fields
   * @global array $wp_properties
   * @author Anton Korotkov
   * @return array
   */
  function load_default_field() {
    global $wp_properties;

    if ( !empty( $wp_properties[&#x27;property_stats&#x27;] ) ) {
      $attribute = key( $wp_properties[&#x27;property_stats&#x27;] );

      $field = array();
      $row_id = rand(99,9999999);

      $field[$row_id][&#x27;title&#x27;] = $wp_properties[&#x27;property_stats&#x27;][ $attribute ];
      $field[$row_id][&#x27;attribute&#x27;] = $attribute;
      $field[$row_id][&#x27;required&#x27;] = &#x27;false&#x27;;
    } else {
      $field[$row_id][&#x27;title&#x27;] = &#x27;&#x27;;
      $field[$row_id][&#x27;attribute&#x27;] = &#x27;&#x27;;
      $field[$row_id][&#x27;required&#x27;] = &#x27;false&#x27;;
    }

    return $field;

  }

  /**
   * Handle adding post meta value
   * @global array $wp_properties
   * @param int $meta_id
   * @param int $object_id
   * @param string $meta_key
   * @author Anton Korotkov
   * @param string $meta_value
   */
  function handle_post_meta( $meta_id, $object_id, $meta_key, $meta_value ) {
    global $wp_properties;

    switch( $meta_key ) {

      default: break;

      case $wp_properties[&#x27;configuration&#x27;][&#x27;address_attribute&#x27;]:

        $geo_data = WPP_F::geo_locate_address($meta_value, $wp_properties[&#x27;configuration&#x27;][&#x27;google_maps_localization&#x27;], true);

        if(!empty($geo_data-&gt;formatted_address)) {
          update_post_meta($object_id, &#x27;address_is_formatted&#x27;, true);

          if(!empty($wp_properties[&#x27;configuration&#x27;][&#x27;address_attribute&#x27;])) {
            update_post_meta($object_id, $wp_properties[&#x27;configuration&#x27;][&#x27;address_attribute&#x27;], WPP_F::encode_mysql_input( $geo_data-&gt;formatted_address, $wp_properties[&#x27;configuration&#x27;][&#x27;address_attribute&#x27;]));
          }

          foreach($geo_data as $geo_type =&gt; $this_data) {
            update_post_meta($object_id, $geo_type, WPP_F::encode_mysql_input( $this_data, $geo_type));
          }

        } else {
          // Try to figure out why it failed
          update_post_meta($object_id, &#x27;address_is_formatted&#x27;, false);
        }

        break;

    }

  }

  /**
   * Filter CRM actions list
   * @param array $current
   * @author Anton Korotkov
   * @return array
   */
  function crm_custom_notification($current) {

    foreach( self::$crm_notification_actions as $action_key =&gt; $action_name ) {
      $current[$action_key] = str_replace (
              array(
                &#x27;property&#x27;,
                &#x27;Property&#x27;,
                &#x27;properties&#x27;,
                &#x27;Properties&#x27;
              ),
              array(
                WPP_F::property_label( &#x27;singular&#x27; ),
                ucfirst( WPP_F::property_label( &#x27;singular&#x27; ) ),
                WPP_F::property_label( &#x27;plural&#x27; ),
                ucfirst( WPP_F::property_label( &#x27;plural&#x27; ) )
              ),
              $action_name);
    }

    return $current;
  }

  /**
   * Filter query to allow view of pending posts
   * @param object $wp_query
   * @param object $post
   * @author korotkov@ud
   * @return object
   */
  function wpp_query_filter( $wp_query, $post ) {

    $post-&gt;ancestors = !empty( $post-&gt;ancestors ) &amp;&amp; is_array( $post-&gt;ancestors ) ? $post-&gt;ancestors : get_post_ancestors( $post );

    $wp_query-&gt;is_404 = false;
    $wp_query-&gt;is_single = 1;
    $wp_query-&gt;is_preview = 1;
    $wp_query-&gt;is_singular = 1;
    $wp_query-&gt;post_count = 1;
    $wp_query-&gt;posts[0] = $post;
    $wp_query-&gt;post = $post;

    return $wp_query;
  }

  /**
   * Adds FEPS specific queryable keys for property_overview shortcode
   *
   * @param array $keys
   * @author peshkov@UD
   * @since 1.4
   * @version 0.1
   */
  function queryable_keys( $keys ) {
    $keys[] = &#x27;wpp_feps_property&#x27;;
    $keys[] = &#x27;post_status&#x27;;
    return $keys;
  }

  /**
   * Prevent auth of inactive user
   * @param unknown $nothing
   * @param string $username
   * @param string $password
   * @author Anton Korotkov
   * @return WP_Error || null
   */
  function authenticate( $nothing, $username, $password ) {

    $user = get_userdatabylogin( $username );
    if ( !empty( $user-&gt;is_not_approved ) ) {
      $user_error = new WP_Error(&#x27;authentication_failed&#x27;, __(&#x27;&lt;strong&gt;ERROR&lt;/strong&gt;: Account is not approved.&#x27;, &#x27;wpp&#x27;));
      return $user_error;
    }
    return $nothing;

  }

  /**
   * Renders location input map
   *
   * @param int $row_id
   * @param array $default_coords
   * @param array $args
   * @author korotkov@ud
   */
  function render_location_map_input( $row_id, $default_coords, $args ) {?&gt;

      &lt;div id=&quot;wpp_feps_map_&lt;?php echo $row_id; ?&gt;&quot; class=&quot;wpp_feps_map&quot; style=&quot;width: 100%; height: &lt;?php echo $args[&#x27;map_height&#x27;]; ?&gt;px;&quot;&gt;&lt;?php _e(&#x27;There is a JavaScript error on this page preventing it from displaying the dynamic map.&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/div&gt;

      &lt;?php ob_start(); ?&gt;
      &lt;script type=&quot;text/javascript&quot;&gt;

        function empty( mixed_var ) {
          return ( mixed_var === &quot;&quot; || mixed_var === 0   || mixed_var === &quot;0&quot; || mixed_var === null  || mixed_var === false );
        }

        jQuery(document).ready(function() {

          /* Check if Google Maps is loaded */
          if(typeof google == &#x27;undefined&#x27; || typeof google.maps == &#x27;undefined&#x27; || typeof qq == &#x27;undefined&#x27;) {
            return;
          }

          jQuery(&#x27;#wpp_feps_map_&lt;?php echo $row_id; ?&gt;&#x27;).gmap({&#x27;zoom&#x27;:10, &#x27;center&#x27;: new google.maps.LatLng(&lt;?php echo $default_coords[&#x27;latitude&#x27;] ?&gt;,&lt;?php echo $default_coords[&#x27;longitude&#x27;] ?&gt;)});
          jQuery(&quot;&lt;?php echo &quot;#wpp_{$row_id}_input&quot;; ?&gt;&quot;).change(function() {
            var location_string = jQuery.trim( jQuery(this).val() );
            jQuery(&#x27;div.location_result_&lt;?php echo $row_id; ?&gt;&#x27;).hide();
            if ( !empty(location_string) ) {
              jQuery(&#x27;#wpp_feps_map_&lt;?php echo $row_id; ?&gt;&#x27;).gmap(&#x27;search&#x27;, { &#x27;address&#x27;: location_string  }, function(isFound,results) {
                if (isFound){
                  jQuery(&#x27;#wpp_feps_map_&lt;?php echo $row_id; ?&gt;&#x27;).gmap(&#x27;getMap&#x27;).panTo(results[0].geometry.location);
                  jQuery(&#x27;#wpp_feps_map_&lt;?php echo $row_id; ?&gt;&#x27;).gmap({&#x27;zoom&#x27;:14});
                  jQuery(&#x27;#wpp_feps_map_&lt;?php echo $row_id; ?&gt;&#x27;).gmap(&#x27;clearMarkers&#x27;);
                  jQuery(&#x27;#wpp_feps_map_&lt;?php echo $row_id; ?&gt;&#x27;).gmap(&#x27;addMarker&#x27;, {&#x27;title&#x27;:results[0].formatted_address, &#x27;position&#x27;: new google.maps.LatLng(results[0].geometry.location.lat(), results[0].geometry.location.lng()) } );
                  jQuery(&quot;#wpp_feps_map_&lt;?php echo $row_id; ?&gt;&quot;).show();
                  jQuery(&#x27;div.location_result_&lt;?php echo $row_id; ?&gt;&#x27;).text(&quot;&lt;?php _e(&#x27;Your location has been successfully found by Google Maps.&#x27;, &#x27;wpp&#x27;); ?&gt;&quot;).addClass(&#x27;wpp_feps_loc_found&#x27;).removeClass(&#x27;wpp_feps_loc_not_found&#x27;).show();
                } else {
                  jQuery(&quot;&lt;?php echo &quot;#wpp_{$row_id}_input&quot;; ?&gt;&quot;).val(&#x27;&#x27;);
                  jQuery(&#x27;div.location_result_&lt;?php echo $row_id; ?&gt;&#x27;).text(&quot;&lt;?php _e(&#x27;Your address could not be found, please try again.&#x27;, &#x27;wpp&#x27;); ?&gt;&quot;).addClass(&#x27;wpp_feps_loc_not_found&#x27;).removeClass(&#x27;wpp_feps_loc_found&#x27;).show();
                }
              });
            }
          }).change();
        });
      &lt;/script&gt;
    &lt;?php $output_js = ob_get_contents(); ob_end_clean(); echo $output_js; ?&gt;
    &lt;div class=&quot;location_result_&lt;?php echo $row_id; ?&gt;&quot;&gt;&lt;/div&gt;
    &lt;?php
  }


  /**
   * Called only if WPI SPC exists
   *
   * @uses class_wpp_feps::fix_404()
   * @global object $wp
   * @param boolean $_is_404
   * @param object $query
   * @return boolean
   * @author peshkov@UD
   */
  function spc_fix_404 ( $_is_404, $query ) {
    global $wp, $wp_query;

    //* STEP 3. Determine if this is FEPS Credits Adding Page */
    if( is_user_logged_in() &amp;&amp; (
        $wp-&gt;request == FEPS_SPC_PAGE ||
        $wp-&gt;query_string == &quot;p=&quot; . FEPS_SPC_PAGE ||
        $query-&gt;query_vars[ &#x27;pagename&#x27; ] == FEPS_SPC_PAGE ||
        $query-&gt;query_vars[ &#x27;category_name&#x27; ] == FEPS_SPC_PAGE )
    ) {
      $wp_query-&gt;wpp_feps_spc_page = true;
      $_is_404 = false;
    }

    return $_is_404;
  }


  /**
   * Loads &#x27;FEPS Credit Adding&#x27; page
   *
   * @author peshkov@UD
   * @since 1.4
   * @version 0.1
   */
  function spc_page_load () {
    global $wpdb, $wp_query, $property, $wp_properties;

    $template = $wp_properties[&#x27;configuration&#x27;][&#x27;feps&#x27;][&#x27;templates&#x27;][&#x27;add_credits_page&#x27;];
    $template = str_replace( &#x27;.php&#x27;, &#x27;&#x27;, $template );

    $template_found = WPP_F::get_template_part( array_filter( array(
      $template,
      &#x27;page&#x27;,
      &#x27;single&#x27;,
    ) ) );

    //* Determine if template is found and finish loading. */
    if( $template_found ) {

      wp_enqueue_script( &#x27;wpp-feps-spc&#x27;, WPP_URL. &#x27;js/wpp.feps.spc.js&#x27;, array( &#x27;jquery&#x27;, &#x27;wpp-localization&#x27; ) );

      //** Create a fake Page */
      $wp_query-&gt;is_404 = false;
      $wp_query-&gt;post_count = 1;
      $wp_query-&gt;posts[0] = (object) array(
        &#x27;ID&#x27; =&gt; &#x27;999999998&#x27;,
        &#x27;post_title&#x27; =&gt; __( &#x27;Add Credits to Balance&#x27;, &#x27;wpp&#x27; ),
        &#x27;post_content&#x27; =&gt; &quot;[wpi_checkout custom_amount=&#x27;true&#x27; callback_function=&#x27;wpi_add_feps_credits&#x27; template=&#x27;feps&#x27;]&quot;,
        &#x27;post_name&#x27; =&gt; FEPS_SPC_PAGE,
        &#x27;post_type&#x27; =&gt; &#x27;page&#x27;,
        &#x27;post_status&#x27; =&gt; &#x27;publish&#x27;,
        &#x27;post_author&#x27; =&gt;  $user-&gt;ID
      );

      die( load_template( $template_found ) );

    } else {

      WPP_F::console_log( &#x27;Could not find template for FEPS Credits Adding page.&#x27; );

      $wp_query-&gt;is_404 = true;

    }
  }


  /**
   * WPI SPC integration
   *
   * @param type $args
   */
  function spc_options( $args = &#x27;&#x27; ) {
    global $wpi_settings;

    $defaults = array(
      &#x27;intervals&#x27;=&gt;array(
        &#x27;day&#x27;=&gt;__(&#x27;Days&#x27;,&#x27;wpp&#x27;),
        &#x27;week&#x27;=&gt;__(&#x27;Weeks&#x27;,&#x27;wpp&#x27;),
        &#x27;month&#x27;=&gt;__(&#x27;Months&#x27;,&#x27;wpp&#x27;),
        &#x27;year&#x27;=&gt;__(&#x27;Years&#x27;,&#x27;wpp&#x27;),
        ),
      &#x27;plans_default_fields&#x27; =&gt; array(
        &#x27;name&#x27; =&gt; __(&#x27;Basic&#x27;,&#x27;wpp&#x27;),
        &#x27;price&#x27;=&gt;&#x27;1&#x27;,
        &#x27;duration&#x27;=&gt;array(&#x27;value&#x27;=&gt;&#x27;1&#x27;,&#x27;interval&#x27;=&gt;&#x27;day&#x27;),
        &#x27;images_limit&#x27;=&gt;&#x27;1&#x27;,
        &#x27;description&#x27;=&gt;__(&#x27;Default One-Day Subscription Plan&#x27;,&#x27;wpp&#x27;)
      )
    );

    extract( wp_parse_args( $args, $defaults ), EXTR_SKIP );

    if (empty($form[&#x27;subscription_plans&#x27;])){
      $default_data = true;
      $form[&#x27;subscription_plans&#x27;][WPP_F::create_slug($plans_default_fields[&#x27;name&#x27;])] = $plans_default_fields;
    }

    ?&gt;
    &lt;tr class=&quot;wpp_feps_plan_row&quot; style=&quot;&lt;?php echo (class_exists(&#x27;wpi_spc&#x27;) &amp;&amp; empty( $form[&#x27;feps_credits&#x27;] ) || $form[&#x27;feps_credits&#x27;] != &#x27;true&#x27; ) ? &#x27;display:none;&#x27; : &#x27;&#x27;; ?&gt;&quot;&gt;
      &lt;th colspan=&quot;2&quot; style=&quot;padding-top:10px;&quot;&gt;
        &lt;h3 style=&quot;float:left;&quot;&gt;&lt;?php _e( &#x27;Subscription Plans&#x27;, &#x27;wpp&#x27; ); ?&gt;&lt;/h3&gt;
          &lt;table class=&quot;ud_ui_dynamic_table widefat wpp_feps_sortable&quot; use_random_row_id=&quot;true&quot;&gt;
            &lt;thead&gt;
              &lt;tr&gt;
                &lt;th class=&quot;wpp_draggable_handle&quot;&gt;&lt;/th&gt;
                &lt;th class=&quot;wpp_plan_name_col&quot;&gt;&lt;?php _e(&#x27;Name&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/th&gt;
                &lt;th class=&quot;wpp_plan_price_col&quot;&gt;&lt;?php _e(&#x27;Price&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/th&gt;
                &lt;th class=&quot;wpp_plan_duration_col&quot;&gt;&lt;?php _e(&#x27;Duration&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/th&gt;
                &lt;th class=&quot;wpp_plan_images_limit_col&quot;&gt;&lt;?php _e(&#x27;Images Limit&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/th&gt;
                &lt;th class=&quot;wpp_plan_description_col&quot;&gt;&lt;?php _e(&#x27;Description&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/th&gt;
                &lt;th class=&quot;wpp_plan_action_col&quot;&gt;&lt;?php _e( &#x27;Actions&#x27;,&#x27;wpp&#x27; ) ?&gt;&lt;/th&gt;
              &lt;/tr&gt;
            &lt;/thead&gt;
            &lt;tbody&gt;
              &lt;?php
                reset($form[&#x27;subscription_plans&#x27;]);
                $first_element  = key($form[&#x27;subscription_plans&#x27;]);
                foreach((array)$form[&#x27;subscription_plans&#x27;] as $slug =&gt; $plan_data): ?&gt;
                &lt;tr class=&quot;wpp_dynamic_table_row&quot; slug=&quot;&lt;?php echo $slug; ?&gt;&quot; new_row=&quot;&lt;?php echo($default_data ? &#x27;true&#x27; : &#x27;false&#x27;); ?&gt;&quot;&gt;
                  &lt;td class=&quot;wpp_draggable_handle&quot;&gt;&amp;nbsp;&lt;/td&gt;
                  &lt;td class=&quot;wpp_plan_name_col&quot;&gt;&lt;input class=&quot;slug_setter&quot; type=&quot;text&quot; name=&quot;wpp_feps[forms][&lt;?php echo $form_id; ?&gt;][subscription_plans][&lt;?php echo $slug; ?&gt;][name]&quot; value=&quot;&lt;?php echo $plan_data[&#x27;name&#x27;]; ?&gt;&quot; /&gt;&lt;/td&gt;

                  &lt;td class=&quot;wpp_plan_price_col&quot;&gt;&lt;input type=&quot;text&quot; name=&quot;wpp_feps[forms][&lt;?php echo $form_id; ?&gt;][subscription_plans][&lt;?php echo $slug; ?&gt;][price]&quot; value=&quot;&lt;?php echo $plan_data[&#x27;price&#x27;]; ?&gt;&quot; /&gt;&lt;?php echo &#x27;&amp;nbsp;&#x27;.(($wpi_settings[&#x27;currency&#x27;][&#x27;default_currency_code&#x27;])?$wpi_settings[&#x27;currency&#x27;][&#x27;default_currency_code&#x27;]:&#x27;$&#x27;); ?&gt;&lt;/td&gt;
                  &lt;td class=&quot;wpp_plan_duration_col&quot;&gt;
                    &lt;input type=&quot;text&quot; name=&quot;wpp_feps[forms][&lt;?php echo $form_id; ?&gt;][subscription_plans][&lt;?php echo $slug; ?&gt;][duration][value]&quot; value=&quot;&lt;?php echo $plan_data[&#x27;duration&#x27;][&#x27;value&#x27;]; ?&gt;&quot; /&gt;
                    &lt;select class=&quot;subscription_intervals&quot; name=&quot;wpp_feps[forms][&lt;?php echo $form_id; ?&gt;][subscription_plans][&lt;?php echo $slug; ?&gt;][duration][interval]&quot;&gt;
                      &lt;?php foreach ($intervals as $i_slug=&gt;$i_name) : ?&gt;
                      &lt;option value=&quot;&lt;?php echo $i_slug;?&gt;&quot;&lt;?php echo ($plan_data[&#x27;duration&#x27;][&#x27;interval&#x27;]==$i_slug)?&#x27; selected=&quot;selected&quot;&#x27;:&#x27;&#x27; ?&gt;&gt;&lt;?php echo $i_name;?&gt;&lt;/option&gt;
                      &lt;?php endforeach;?&gt;
                    &lt;/select&gt;
                  &lt;/td&gt;
                  &lt;td class=&quot;wpp_plan_images_limit_col&quot;&gt;&lt;input type=&quot;text&quot; name=&quot;wpp_feps[forms][&lt;?php echo $form_id; ?&gt;][subscription_plans][&lt;?php echo $slug; ?&gt;][images_limit]&quot; value=&quot;&lt;?php echo $plan_data[&#x27;images_limit&#x27;]; ?&gt;&quot; /&gt;&lt;/td&gt;
                  &lt;td class=&quot;wpp_plan_description_col&quot;&gt;&lt;textarea type=&quot;text&quot; name=&quot;wpp_feps[forms][&lt;?php echo $form_id; ?&gt;][subscription_plans][&lt;?php echo $slug; ?&gt;][description]&quot;&gt;&lt;?php echo $plan_data[&#x27;description&#x27;]; ?&gt;&lt;/textarea&gt;&lt;/td&gt;

                  &lt;td&gt;&lt;span class=&quot;wpp_delete_row wpp_link&quot;&gt;&lt;?php _e(&#x27;Delete&#x27;, &#x27;wpp&#x27;) ?&gt;&lt;/span&gt;&lt;/td&gt;
                &lt;/tr&gt;
              &lt;?php endforeach;?&gt;
            &lt;/tbody&gt;
            &lt;tfoot&gt;
              &lt;tr&gt;
                &lt;td colspan=&quot;7&quot;&gt;
                  &lt;input type=&quot;button&quot; callback_function=&quot;wpp_feps_added_row&quot; class=&quot;wpp_add_row button-secondary&quot; value=&quot;&lt;?php _e(&#x27;Add Subscription Plan&#x27;,&#x27;wpp&#x27;) ?&gt;&quot; /&gt;
                &lt;/td&gt;
              &lt;/tr&gt;
            &lt;/tfoot&gt;
          &lt;/table&gt;
        &lt;/th&gt;
    &lt;/tr&gt;


  &lt;?php
  }


  /**
   * SPC integration
   *
   * @param type $args
   */
  function spc_options_general( $args = &#x27;&#x27; ) {
    $defaults = array();

    extract( wp_parse_args( $args, $defaults ), EXTR_SKIP );

    ?&gt;
    &lt;li&gt;
      &lt;?php ob_start(); ?&gt;
      &lt;script type=&quot;text/javascript&quot;&gt;
        jQuery(document).ready(function() {
          jQuery(&quot;input[name*=&#x27;feps_credits&#x27;]&quot;).bind( &quot;change&quot;, function(event, ui) {
            extra_objects = jQuery(&quot;input[name*=&#x27;user_creation&#x27;], select[name*=&#x27;new_post_status&#x27;], input[name*=&#x27;images_limit&#x27;]&quot;, jQuery(this).parents(&#x27;.wpp_feps_form&#x27;).find(&#x27;.wpp_option_table ul&#x27;)).closest(&#x27;li&#x27;);
            plan_table = jQuery(&#x27;.wpp_feps_plan_row&#x27;, jQuery(this).parents(&#x27;.wpp_feps_form&#x27;));
            if (jQuery(this).attr(&#x27;checked&#x27;)){
              extra_objects.hide();
              plan_table.show();
            }else{
              extra_objects.each(function(i,e){
                //* Check if the current object is image option and determine if form has image upload attribute before show option. */
                if ( jQuery(&#x27;input.imageslimit&#x27;, e).length &gt; 0 ) {
                  var show_option = false;
                  jQuery(&quot;select.wpp_feps_new_attribute option:selected&quot;, jQuery(e).closest(&#x27;.ui-tabs-panel&#x27;)).each(function(k, p){
                    if ( jQuery(p).val() == &#x27;image_upload&#x27; ) {
                      show_option = true;
                      return false;
                    }
                  });
                  if(show_option) {
                    jQuery(e).show();
                  }
                } else {
                  jQuery(e).show();
                }
              });
              plan_table.hide();
            }
          });
        });
      &lt;/script&gt;
      &lt;?php $output_js = ob_get_contents(); ob_end_clean(); echo WPP_F::minify_js($output_js); ?&gt;
      &lt;input type=&quot;checkbox&quot; name=&quot;wpp_feps[forms][&lt;?php echo $form_id; ?&gt;][feps_credits]&quot; &lt;?php checked(&#x27;true&#x27;, $form[&#x27;feps_credits&#x27;]); ?&gt; class=&quot;wpp_show_advanced feps_credits&quot; advanced_option_class=&quot;wpp_advanced_option&quot; value=&quot;true&quot; /&gt;
      &lt;?php _e(&#x27;This is Sponsored Listing&#x27;, &#x27;wpp&#x27;); ?&gt;
    &lt;/li&gt;
  &lt;?php
  }

  /**
   * SPC integration
   *
   * @param type $args
   */
  function spc_options_general_miss( $args = &#x27;&#x27; ) {
    $defaults = array();

    extract( wp_parse_args( $args, $defaults ), EXTR_SKIP );

    ?&gt;
    &lt;li&gt;
      &lt;input type=&quot;checkbox&quot; disabled=&quot;disabled&quot; /&gt;
      &lt;?php _e(&#x27;This is Sponsored Listing&#x27;, &#x27;wpp&#x27;); ?&gt;.
      &amp;nbsp;&lt;span class=&quot;description&quot;&gt;Get &lt;a href=&quot;https://usabilitydynamics.com/products/wp-invoice/premium-features/&quot;&gt;Single Page Checkout (SPC) premium feature&lt;/a&gt; for &lt;a class=&quot;small&quot; href=&quot;&lt;?php echo admin_url(&#x27;plugin-install.php?tab=search&amp;amp;type=term&amp;amp;s=wp-invoice+billing+andypotanin&#x27;);?&gt;&quot;&gt;WP-Invoice&lt;/a&gt; to use FEPS for Sponsored Listings.&lt;/span&gt;
    &lt;/li&gt;
  &lt;?php
  }


  /**
   * Adds wp-property templates path for WP-Invoice Single Page Checkout template.
   *
   * @param $pathes
   * @return array
   * @author peshkov@UD
   * @since 2.0
   */
  function wpi_spc_template( $pathes ) {

    if( !is_array( $pathes ) ) {
      $pathes = (array)$pathes;
    }

    $pathes[] = WPP_Templates;

    return $pathes;
  }


  /**
   * Callback ( redirect url ) after Sponsored listing is submitted
   *
   * @global array $wp_properties
   * @param type $_property
   * @param type $request
   * @author korotkov@ud
   * @author peshkov@UD
   */
  function save_property_callback( $callback, $_property, $request ) {
    $form_data = self::get_form_by_md5( $request[ &#x27;wpp_feps_data&#x27; ][&#x27;form_id&#x27;] );
    //** Do this only if for is Sponsored Listing */
    if ( $form_data &amp;&amp; !empty( $form_data[&#x27;feps_credits&#x27;] ) &amp;&amp; $form_data[&#x27;feps_credits&#x27;] == &#x27;true&#x27; &amp;&amp; $_property[&#x27;post_status&#x27;] == &#x27;pending&#x27; &amp;&amp; is_user_logged_in() ) {
      $callback = self::get_edit_feps_permalink( $_property[ &#x27;ID&#x27; ], &#x27;subscription_plan&#x27; );
    }
    return $callback;
  }


  /**
   * Returns permalink to edit FEPS page ( specific tab )
   *
   * @author peshkov@UD
   * @since 2.0
   */
  function get_edit_feps_permalink( $id, $action = &#x27;edit&#x27;, $mail = false ) {

    $form_id = get_post_meta( $id, FEPS_META_FORM, true );

    return WPP_F::base_url( FEPS_EDIT_PAGE, array_filter( array(
      &#x27;feps&#x27; =&gt; $id,
      &#x27;wpp_front_end_action&#x27; =&gt; $action,
      &#x27;wpp_feps_form&#x27; =&gt; md5( $form_id ),
    ) ) );

  }


  /**
   * Filter form data before inserting the post
   *
   * @param array $current
   * @return string
   * @author korotkov@ud
   */
  function filter_form_data( $current ) {
    if ( !empty( $current[&#x27;feps_credits&#x27;] ) &amp;&amp; $current[&#x27;feps_credits&#x27;] == &#x27;true&#x27; ) {
    $current[&#x27;new_post_status&#x27;] = &#x27;pending&#x27;;
    }
    return $current;
  }

  /**
   * Second feps step
   *
   * @global array $wp_properties
   * @return type
   * @author korotkov@ud
   */
  function sponsored_listing_sub_plan() {
    global $wp_properties, $post;

    //** Get forms */
    $forms = $wp_properties[&#x27;configuration&#x27;][&#x27;feature_settings&#x27;][&#x27;feps&#x27;][&#x27;forms&#x27;];

    //** Cycle through forms and match up with passed md5 hash */
    $found = false;
    foreach($forms as $form_id =&gt; $form_data) {
      if( md5( $form_id ) == $_REQUEST[&#x27;wpp_feps_form&#x27;] ||
          $form_id == $_REQUEST[&#x27;wpp_feps_form&#x27;] ) {
        $found = true;
        break;
      }
    }

    //** If form found */
    if ( $found ) {
      $content_template_found = WPP_F::get_template_part( array(
        &#x27;feps-subplans-template&#x27;
      ), array( WPP_Templates ) );

      $subscription_plans = $form_data[&#x27;subscription_plans&#x27;];

      $image_field = array_filter((array)$form_data[&#x27;fields&#x27;], create_function(&#x27;$field&#x27;,&#x27;return $field[&quot;attribute&quot;]==&quot;image_upload&quot;;&#x27;));
      $form_has_images = !empty($image_field)?true:false;

      ob_start();
      include $content_template_found;
      $html = ob_get_clean();
      return $html;
    }
  }


  /**
   * Purchase listing step
   *
   * @global array $wp_properties
   * @return type
   * @author korotkov@ud
   */
  function sponsored_listing_purchase() {
    global $wp_properties, $current_user, $wpi_settings;

    if ( !wp_verify_nonce($_REQUEST[&#x27;_wpnonce&#x27;], &#x27;feps_select_subscription_plan&#x27;) ) return false;
    if ( empty( $_REQUEST[&#x27;subscription_plan&#x27;] ) ) return false;
    if ( empty( $_REQUEST[&#x27;feps&#x27;] ) ) return false;
    if ( empty( $_REQUEST[&#x27;wpp_feps_form&#x27;] ) ) return false;

    //** Get forms */
    $forms = $wp_properties[&#x27;configuration&#x27;][&#x27;feature_settings&#x27;][&#x27;feps&#x27;][&#x27;forms&#x27;];

    //** Cycle through forms and match up with passed md5 hash */
    $found = false;
    foreach($forms as $form_id =&gt; $form_data) {
      if( md5( $form_id ) == $_REQUEST[&#x27;wpp_feps_form&#x27;] ) {
        $found = true;
        break;
      }
    }

    //** if plan does not exists - return */feps_subscription_plan
    if ( !is_user_logged_in() || !$found || !key_exists($_REQUEST[&#x27;subscription_plan&#x27;], $form_data[&#x27;subscription_plans&#x27;]) ) return false;

    $content_template_found = WPP_F::get_template_part( array(
      &#x27;feps-purchase-template&#x27;
    ), array( WPP_Templates ) );

    $html = &#x27;&#x27;;
    if( !empty( $content_template_found ) ) {
      $property_id = $_REQUEST[&#x27;feps&#x27;];
      $plan_slug   = $_REQUEST[&#x27;subscription_plan&#x27;];
      $plan        = $form_data[&#x27;subscription_plans&#x27;][$_REQUEST[&#x27;subscription_plan&#x27;]];
      $property = get_property( $property_id );
      $feps_user_email = $current_user-&gt;get(&#x27;user_email&#x27;);
      $credits = is_user_logged_in() ? (float)$current_user-&gt;get(&#x27;wpp::feps::credits&#x27;) : 0;
      $price   = (float)$plan[&#x27;price&#x27;];
      $image_field = array_filter( (array)$form_data[&#x27;fields&#x27;], create_function( &#x27;$field&#x27;,&#x27;return $field[&quot;attribute&quot;]==&quot;image_upload&quot;;&#x27; ) );
      $form_has_images = !empty( $image_field ) ? true : false;

      ob_start();
      include $content_template_found;
      $html = ob_get_clean();
    }

    return $html;
  }

  /**
   * Filter output
   *
   * @param type $current
   * @param type $args
   * @return type
   * @author korotkov@ud
   */
  function feps_output_filter( $current, $args ) {

    if ( empty( $args[&#x27;the_form&#x27;][&#x27;feps_credits&#x27;] ) || $args[&#x27;the_form&#x27;][&#x27;feps_credits&#x27;] !== &#x27;true&#x27; ) return $current;

    $content_template_found = WPP_F::get_template_part( array(
      &#x27;feps-tabs-template&#x27;
    ), array( WPP_Templates ) );

    ob_start();
    include $content_template_found;
    $html = ob_get_clean();

    return $html;
  }

  /**
   * Login user automaticaly
   *
   * @param type $creds
   * @author korotkov@ud
   */
  function credentials_verified_action( $creds ) {
    global $current_user;
    $user = get_user_by(&#x27;email&#x27;, $creds[&#x27;user_email&#x27;]);
    if ( $user ) {
      $current_user = wp_signon(array(
        &#x27;user_login&#x27;    =&gt; $user-&gt;data-&gt;user_login,
        &#x27;user_password&#x27; =&gt; $creds[&#x27;user_password&#x27;],
        &#x27;remember&#x27;      =&gt; true
      ));
    }
  }

  /**
   * User activation
   *
   * @return type
   * @author korotkov@ud
   */
  function feps_user_activation() {
    if ( empty( $_REQUEST[&#x27;wpp_user_activation&#x27;] ) || empty( $_REQUEST[&#x27;wpp_user&#x27;] ) ) return;
    $user = new WP_User($_REQUEST[&#x27;wpp_user&#x27;]);
    $is_not_approved = get_user_meta($user-&gt;ID, &#x27;is_not_approved&#x27;, 1);
    if ( $is_not_approved &amp;&amp; md5($user-&gt;ID.$user-&gt;data-&gt;user_email.SECURE_AUTH_SALT) == $_REQUEST[&#x27;wpp_user_activation&#x27;] ) {
      delete_user_meta($user-&gt;ID, &#x27;is_not_approved&#x27;);

      $notification[&#x27;data&#x27;][&#x27;notification_type&#x27;] = __(&#x27;User Account Approved&#x27;, &#x27;wpp&#x27;);
      $notification[&#x27;data&#x27;][&#x27;user_email&#x27;] = $user-&gt;data-&gt;user_email;
      $notification[&#x27;data&#x27;][&#x27;display_name&#x27;] = $user-&gt;data-&gt;display_name;
      $notification[&#x27;data&#x27;][&#x27;user_login&#x27;] = $user-&gt;data-&gt;user_login;
      $notification[&#x27;data&#x27;][&#x27;user_password&#x27;] = $user-&gt;data-&gt;user_pass;
      $notification[&#x27;data&#x27;][&#x27;site_url&#x27;]     = site_url();
      $notification[&#x27;trigger_action&#x27;] = &#x27;pending_account_approved&#x27;;
      $notification[&#x27;user&#x27;] = $user;
      $notification[&#x27;subject&#x27;] = __(&#x27;Account Approved&#x27;, &#x27;wpp&#x27;);
      $notification[&#x27;message&#x27;] = sprintf(__(&#x27;Hello [display_name]%1$s%1$sYour account on [site_url] has been approved.%1$s%1$sClick this link to visit site:%1$s[site_url]&#x27;, &#x27;wpp&#x27;), PHP_EOL);
      $notification[&#x27;data&#x27;][&#x27;system_message&#x27;] = $notification[&#x27;message&#x27;];
      $notification[&#x27;crm_log_message&#x27;] = __(&#x27;User Account Approved.&#x27;, &#x27;wpp&#x27;);
      UD_API::send_notification($notification);

      wp_die( sprintf( __(&#x27;Thank you! Your account has been activated. &lt;a href=&quot;%s&quot;&gt;Back to the site!&lt;/a&gt;&#x27;, &#x27;wpp&#x27;), get_bloginfo(&#x27;home&#x27;) ), __(&#x27;Account has been activated&#x27;, &#x27;wpp&#x27;));
    } else {
      wp_redirect(get_bloginfo(&#x27;home&#x27;));die();
    }
  }

  /**
   * Action after credits added. Publish and charge balance
   *
   * @param type $args
   */
  function after_add_credits( $args ) {

    //** Extract args */
    $defaults = array(
      &#x27;credits&#x27; =&gt; 0,
      &#x27;data&#x27; =&gt; array()
    );

    extract( wp_parse_args( $args, $defaults ) );

    //** If no credits or property ID is not specified - exit */
    if ( !$credits || empty( $data[&#x27;post_data&#x27;][&#x27;wpp::feps::property_id&#x27;] ) ) {
      return null;
    }

    //** Get subscription plan data */
    $property_id = $data[&#x27;post_data&#x27;][&#x27;wpp::feps::property_id&#x27;][0];
    $current_subscription_plan = get_post_meta( $property_id, FEPS_META_PLAN, 1 );

    $credits = (float)$credits;
    $price   = (float)$current_subscription_plan[&#x27;price&#x27;];

    if ( $credits &gt;= $price ) {
      if ( wp_update_post( array( &#x27;ID&#x27; =&gt; $property_id, &#x27;post_status&#x27; =&gt; &#x27;publish&#x27; ) ) ) {
        $credits -= $price;
        update_user_meta($data[&#x27;user_data&#x27;][&#x27;ID&#x27;], &#x27;wpp::feps::credits&#x27;, $credits);
      }
    }

  }


  /**
   * AJAX processor for Pay Now button
   */
  function feps_pay_now() {

    //** Check nonce */
    if ( wp_verify_nonce($_REQUEST[&#x27;_wpnonce&#x27;], &#x27;wpp_feps_pay_now&#x27;) ) {

      //** User should be logged in */
      if ( is_user_logged_in() ) {

        //** Extract args */
        $defaults = array(
          &#x27;amount&#x27;      =&gt; 0,
          &#x27;property_id&#x27; =&gt; 0,
          &#x27;subscription_plan&#x27; =&gt; &#x27;&#x27;
        );
        extract( wp_parse_args( $_REQUEST, $defaults ) );

        //** Load user */
        $user    = new WP_User( get_current_user_id() );
        $credits = (float)$user-&gt;get(&#x27;wpp::feps::credits&#x27;);

        if ( !$property_id ) {
          die( json_encode( array( &#x27;success&#x27; =&gt; 0, &#x27;message&#x27; =&gt; __(&#x27;Something went wrong. Please, try again later. [Error 001]&#x27;, &#x27;wpp&#x27;) ) ) );
        }

        $form_id = get_post_meta( $property_id, FEPS_META_FORM, 1 );
        if ( !$form_id ) {
          die( json_encode( array( &#x27;success&#x27; =&gt; 0, &#x27;message&#x27; =&gt; __(&#x27;Something went wrong. Please, try again later. [Error 002]&#x27;, &#x27;wpp&#x27;) ) ) );
        }

        global $wp_properties;
        $subscription_plan_data = $wp_properties[&#x27;configuration&#x27;][&#x27;feature_settings&#x27;][&#x27;feps&#x27;][&#x27;forms&#x27;][$form_id][&#x27;subscription_plans&#x27;][$subscription_plan];
        if ( !is_array( $subscription_plan_data ) ) {
          die( json_encode( array( &#x27;success&#x27; =&gt; 0, &#x27;message&#x27; =&gt; __(&#x27;Something went wrong. Please, try again later. [Error 003]&#x27;, &#x27;wpp&#x27;) ) ) );
        }

        if ( !update_post_meta( $property_id, FEPS_META_PLAN, $subscription_plan_data ) ) {
          die( json_encode( array( &#x27;success&#x27; =&gt; 0, &#x27;message&#x27; =&gt; __(&#x27;Something went wrong. Please, try again later. [Error 004]&#x27;, &#x27;wpp&#x27;) ) ) );
        }

        //** If really enough credits */
        if ( $credits &gt;= $amount ) {

          //** Try to update post */
          if ( wp_update_post( array( &#x27;ID&#x27; =&gt; $property_id, &#x27;post_status&#x27; =&gt; &#x27;publish&#x27; ) ) ) {
            $credits -= $amount;

            //** Try to decrease balance */
            if ( update_user_meta($user-&gt;ID, &#x27;wpp::feps::credits&#x27;, $credits) ) {
              //** Success */
              $m = __( &#x27;Thank you! Your payment has been successfully made.&#x27;, &#x27;wpp&#x27; );
              if( is_user_logged_in() ) {
                $m .= &#x27; &#x27; . sprintf( __( &#x27;&lt;a href=&quot;%s&quot;&gt;View %s&lt;/a&gt;&#x27;, &#x27;wpp&#x27; ), WPP_F::base_url( FEPS_VIEW_PAGE ), WPP_F::property_label( &#x27;plural&#x27; ) );
              }
              die( json_encode( array( &#x27;success&#x27; =&gt; 1, &#x27;message&#x27; =&gt; $m ) ) );
            }
          }
          //** Error */
          die( json_encode( array( &#x27;success&#x27; =&gt; 0, &#x27;message&#x27; =&gt; __(&#x27;Something went wrong. Please, try again. [Error 005]&#x27;, &#x27;wpp&#x27;) ) ) );
        }
        //** Error */
        die( json_encode( array( &#x27;success&#x27; =&gt; 0, &#x27;message&#x27; =&gt; __(&#x27;Not enough credits.&#x27;, &#x27;wpp&#x27;) ) ) );

      }
      //** Error */
      die( json_encode( array( &#x27;success&#x27; =&gt; 0, &#x27;message&#x27; =&gt; __(&#x27;You must be logged in to be able to do this action.&#x27;, &#x27;wpp&#x27;) ) ) );
    }

    //** Error */
    die( json_encode( array( &#x27;success&#x27; =&gt; 0, &#x27;message&#x27; =&gt; __(&#x27;Something went wrong. Please, try again. [Error 006]&#x27;, &#x27;wpp&#x27;) ) ) );
  }


  /**
   * Adds specific user FEPS fields to user&#x27;s profile ( edit user page ).
   *
   * @param type $user_id
   * @author peshkov@UD
   * @since 2.0
   */
  function user_profile_fields( $user ) {
    global $wpi_settings;

    if( current_user_can( &#x27;edit_user&#x27;, $user-&gt;ID ) ) {
      ?&gt;
      &lt;h3&gt;&lt;?php _e( &#x27;Front End Property Submissions (FEPS).&#x27;, &#x27;wpp&#x27; ); ?&gt;&lt;/h3&gt;
      &lt;table class=&quot;form-table&quot;&gt;
        &lt;tbody&gt;
          &lt;tr&gt;
            &lt;th&gt;&lt;?php _e( &#x27;Available Credits (Balance)&#x27;, &#x27;wpp&#x27; ); ?&gt;&lt;/th&gt;
            &lt;td&gt;
            &lt;?php if( current_user_can( self::$capability ) ) : ?&gt;
              &lt;input type=&quot;text&quot; name=&quot;wpp::feps::credits&quot; value=&quot;&lt;?php echo esc_attr( get_the_author_meta( &#x27;wpp::feps::credits&#x27;, $user-&gt;ID ) ); ?&gt;&quot; /&gt;
            &lt;?php else : ?&gt;
              &lt;input type=&quot;text&quot; disabled=&quot;disabled&quot; value=&quot;&lt;?php echo esc_attr( get_the_author_meta( &#x27;wpp::feps::credits&#x27;, $user-&gt;ID ) ); ?&gt;&quot; class=&quot;disabled&quot; /&gt;
            &lt;?php endif; ?&gt;
            &lt;?php if( isset( $wpi_settings[&#x27;currency&#x27;][&#x27;symbol&#x27;] ) &amp;&amp; isset( $wpi_settings[&#x27;currency&#x27;][&#x27;default_currency_code&#x27;] ) ) : ?&gt;
              &lt;span class=&quot;description&quot;&gt;&lt;?php printf( __( &#x27;%s%01.2f = %01.2f credit&#x27;, &#x27;wpp&#x27; ), $wpi_settings[&#x27;currency&#x27;][&#x27;symbol&#x27;][$wpi_settings[&#x27;currency&#x27;][&#x27;default_currency_code&#x27;]], 1, 1 ); ?&gt;&lt;/span&gt;
            &lt;?php endif; ?&gt;
            &lt;/td&gt;
          &lt;/tr&gt;
        &lt;/tbody&gt;
      &lt;/table&gt;
      &lt;?php
    }
  }


  /**
   * Updates user credits balance using user edit page ( or profile ).
   *
   * @param type $user_id
   * @author peshkov@UD
   * @since 2.0
   */
  function update_user_fields( $user_id ) {
    if ( current_user_can( self::$capability ) &amp;&amp; current_user_can( &#x27;edit_user&#x27;, $user_id ) &amp;&amp; isset( $_POST[&#x27;wpp::feps::credits&#x27;] ) ) {
      update_user_meta( $user_id, &#x27;wpp::feps::credits&#x27;, (float)$_POST[&#x27;wpp::feps::credits&#x27;] );
    }
  }


  /**
   * Adds speicific strings to javascript localization
   *
   * @param array $l10n
   * @return array
   * @author peshkov@UD
   * @since 2.0
   */
  function js_localization( $l10n ) {

    $l10n = array_merge( $l10n, array(
      &#x27;validation_error&#x27; =&gt; __( &#x27;Validation error. Check form fields&#x27;, &#x27;wpp&#x27; ),
      &#x27;type_email&#x27; =&gt; __(&#x27;Please type in your e-mail address.&#x27;, &#x27;wpp&#x27;),
      &#x27;checking_account&#x27; =&gt; __(&#x27;Checking if account exists.&#x27;, &#x27;wpp&#x27;),
      &#x27;checking_credentials&#x27; =&gt; __(&#x27;Checking your credentials.&#x27;, &#x27;wpp&#x27;),
      &#x27;credentials_verified&#x27; =&gt; __(&#x27;Your credentials have been verified.&#x27;, &#x27;wpp&#x27;),
      &#x27;credentials_incorrect&#x27; =&gt; __(&#x27;Your login credentials are not correct.&#x27;, &#x27;wpp&#x27;),
      &#x27;account_found_type_password&#x27; =&gt; __(&#x27;Account found, please type in your password.&#x27;, &#x27;wpp&#x27;),
      &#x27;account_created_check_email&#x27; =&gt; __(&#x27;Your account has been created. Check your e-mail to activate account.&#x27;, &#x27;wpp&#x27;),

      //** Custom variables */
      &#x27;ajaxurl&#x27; =&gt; admin_url(&#x27;admin-ajax.php&#x27;),
      &#x27;user_logged_in&#x27; =&gt; is_user_logged_in() ? &#x27;true&#x27; : &#x27;false&#x27;,
    ) );

    return $l10n;
  }


  /**
   * Returns all the list of pages which contains [wpp_feps_form] shortcode
   *
   * @author peshkov@UD
   * @since 2.0
   */
  function get_all_form_pages() {
    global $wpdb;

    $form_pages = array();

    if( $cache = wp_cache_get( &#x27;wpp::feps::all_form_pages&#x27; )) {
      return $cache;
    }

    $results = $wpdb-&gt;get_results( &quot;
      SELECT ID, post_title, post_content
        FROM $wpdb-&gt;posts
          WHERE post_type = &#x27;page&#x27;
          AND post_content LIKE &#x27;%wpp_feps_form%&#x27;;
    &quot;, ARRAY_A );

    if( !empty( $results ) &amp;&amp; !is_wp_error( $results ) ) {
      foreach( $results as $result ) {
        preg_match( &#x27;/(\[)(\s*wpp_feps_form.*)(\])/&#x27;, $result[ &#x27;post_content&#x27; ], $matches );
        if( $matches ) {
          array_push( $form_pages, array(
            &#x27;ID&#x27; =&gt; $result[ &#x27;ID&#x27; ],
            &#x27;post_title&#x27; =&gt; $result[ &#x27;post_title&#x27; ],
          ) );
        }
      }
    }

    wp_cache_add( &#x27;wpp::feps::all_form_pages&#x27;, $form_pages );

    return $form_pages;
  }


  /**
   * Returns label for button&#x27;s submit form
   * Used in feps-submit-template
   *
   * @author peshkov@UD
   */
  function filter_submit_button( $btn_label, $property, $form ) {
    global $wp_properties;

    switch (1){
      case
        /** If new FEPS with feps_credits */
        ( class_exists(&#x27;wpi_spc&#x27;) &amp;&amp; (
          (empty($property) &amp;&amp; !empty( $form[&#x27;feps_credits&#x27;] ) &amp;&amp; $form[&#x27;feps_credits&#x27;] == &#x27;true&#x27; ) ||
        /** Case edit of pending property and form with credits */
          ( !empty($property) &amp;&amp; $property[&#x27;post_status&#x27;] == &#x27;pending&#x27; &amp;&amp; !empty($property[ FEPS_META_FORM ]) &amp;&amp; ($wp_properties[&#x27;configuration&#x27;][&#x27;feature_settings&#x27;][&#x27;feps&#x27;][&#x27;forms&#x27;][$property[ FEPS_META_FORM ]][&quot;feps_credits&quot;]==&#x27;true&#x27;)))
        ):
        $btn_label = __(&#x27;Next&#x27;, &#x27;wpp&#x27;);
        break;

      case (!empty($property) &amp;&amp; $property[&#x27;post_status&#x27;] == &#x27;publish&#x27;):
        $btn_label = __(&#x27;Update&#x27;, &#x27;wpp&#x27;);
        break;

      default:
        $btn_label = ($user_can_publish_properties==&#x27;true&#x27;)?__(&#x27;Publish&#x27;, &#x27;wpp&#x27;):__(&#x27;Submit&#x27;, &#x27;wpp&#x27;);
    }

    return $btn_label;

  }

}

/**
 * MyFepsWidget Class
 */
class MyFepsWidget extends WP_Widget {

  function __construct() {
    parent::__construct( false, $name = __( &#x27;FEPS Menu&#x27; ), array( &#x27;description&#x27; =&gt; __( &#x27;Show FEPS Menu. It\&#x27;s available only for logged in users&#x27;, &#x27;wpp&#x27; ) ) );
  }

  function widget($args, $instance) {
    extract( $args );

    $instance[&#x27;before&#x27;] = $before_widget;
    $widget_title = apply_filters(&#x27;widget_title&#x27;, $instance[&#x27;title&#x27;]);
    if ( $widget_title ) {
      $instance[&#x27;before&#x27;] .= $before_title . $widget_title . $after_title;
    }

    $instance[&#x27;after&#x27;] = $after_widget;

    $instance[&#x27;title&#x27;] = false;

    echo class_wpp_feps::wpp_feps_menu( $instance );
  }

  function update( $new_instance, $old_instance ) {
    return $new_instance;
  }

  function form( $instance ) {
    global $wp_properties;

    $form_pages = class_wpp_feps::get_all_form_pages();

    $title = esc_attr( $instance[&#x27;title&#x27;] );
    $show_balance = $instance[&#x27;show_balance&#x27;];
    $show_spc_link = $instance[&#x27;show_spc_link&#x27;];
    $filters = $instance[&#x27;filters&#x27;];
    $form_page = $instance[&#x27;form_page&#x27;];
    ?&gt;
    &lt;p&gt;
      &lt;label for=&quot;&lt;?php echo $this-&gt;get_field_id(&#x27;title&#x27;); ?&gt;&quot;&gt;&lt;?php _e(&#x27;Title:&#x27;); ?&gt;&lt;/label&gt;
      &lt;input class=&quot;widefat&quot; id=&quot;&lt;?php echo $this-&gt;get_field_id(&#x27;title&#x27;); ?&gt;&quot; name=&quot;&lt;?php echo $this-&gt;get_field_name(&#x27;title&#x27;); ?&gt;&quot; type=&quot;text&quot; value=&quot;&lt;?php echo $title; ?&gt;&quot; /&gt;
    &lt;/p&gt;
    &lt;?php if ( class_exists( &#x27;wpi_spc&#x27; ) ) : ?&gt;
    &lt;p&gt;
      &lt;label for=&quot;&lt;?php echo $this-&gt;get_field_id(&#x27;show_balance&#x27;); ?&gt;&quot;&gt;
        &lt;input id=&quot;&lt;?php echo $this-&gt;get_field_id(&#x27;show_balance&#x27;); ?&gt;&quot; name=&quot;&lt;?php echo $this-&gt;get_field_name(&#x27;show_balance&#x27;); ?&gt;&quot; type=&quot;checkbox&quot; value=&quot;false&quot; &lt;?php if($show_balance==&#x27;false&#x27;) echo &quot; checked=&#x27;checked&#x27;;&quot;; ?&gt; /&gt;
        &lt;?php _e(&#x27;Don\&#x27;t show Funds Balance&#x27;,&#x27;wpp&#x27;); ?&gt;
      &lt;/label&gt;
    &lt;/p&gt;
    &lt;p&gt;
      &lt;label for=&quot;&lt;?php echo $this-&gt;get_field_id(&#x27;show_spc_link&#x27;); ?&gt;&quot;&gt;
        &lt;input id=&quot;&lt;?php echo $this-&gt;get_field_id(&#x27;show_spc_link&#x27;); ?&gt;&quot; name=&quot;&lt;?php echo $this-&gt;get_field_name(&#x27;show_spc_link&#x27;); ?&gt;&quot; type=&quot;checkbox&quot; value=&quot;false&quot; &lt;?php if($show_spc_link==&#x27;false&#x27;) echo &quot; checked=&#x27;checked&#x27;;&quot;; ?&gt; /&gt;
        &lt;?php _e(&#x27;Don\&#x27;t show \&#x27;Add Credits to Balance\&#x27; link &#x27;,&#x27;wpp&#x27;); ?&gt;
      &lt;/label&gt;
    &lt;/p&gt;
    &lt;?php endif; ?&gt;
    &lt;p&gt;
      &lt;label for=&quot;&lt;?php echo $this-&gt;get_field_id(&#x27;filters&#x27;); ?&gt;&quot;&gt;
        &lt;input id=&quot;&lt;?php echo $this-&gt;get_field_id(&#x27;filters&#x27;); ?&gt;&quot; name=&quot;&lt;?php echo $this-&gt;get_field_name(&#x27;filters&#x27;); ?&gt;&quot; type=&quot;checkbox&quot; value=&quot;true&quot; &lt;?php if($filters==&#x27;true&#x27;) echo &quot; checked=&#x27;checked&#x27;;&quot;; ?&gt; /&gt;
        &lt;?php printf( __( &#x27;Show Filter by Statuses instead of default link to \&#x27;My %s\&#x27; page&#x27;, &#x27;wpp&#x27; ), WPP_F::property_label( &#x27;plural&#x27; ) ); ?&gt;
      &lt;/label&gt;
    &lt;/p&gt;
    &lt;?php if( !empty( $form_pages ) &amp;&amp; is_array( $form_pages ) ) : ?&gt;
    &lt;p&gt;
      &lt;label for=&quot;&lt;?php echo $this-&gt;get_field_id(&#x27;form_page&#x27;); ?&gt;&quot;&gt;&lt;?php printf( __(&#x27;\&#x27;Add New %s\&#x27; link to page:&#x27;,&#x27;wpp&#x27;), WPP_F::property_label() ); ?&gt;&lt;br/&gt;
        &lt;select id=&quot;&lt;?php echo $this-&gt;get_field_name(&#x27;form_page&#x27;); ?&gt;&quot; name=&quot;&lt;?php echo $this-&gt;get_field_name(&#x27;form_page&#x27;); ?&gt;&quot; class=&quot;widefat&quot; &gt;
          &lt;option value=&quot;&quot;&gt;-&lt;/option&gt;
          &lt;?php foreach( $form_pages as $fp ) : ?&gt;
          &lt;option value=&quot;&lt;?php echo WPP_F::base_url( $fp[ &#x27;ID&#x27; ] ); ?&gt;&quot; &lt;?php echo $form_page == WPP_F::base_url( $fp[ &#x27;ID&#x27; ] ) ? &#x27;selected=&quot;selected&quot;&#x27; : &#x27;&#x27;; ?&gt;&gt;&lt;?php echo $fp[ &#x27;post_title&#x27; ]; ?&gt;&lt;/option&gt;
          &lt;?php endforeach; ?&gt;
        &lt;/select&gt;
      &lt;/label&gt;
    &lt;/p&gt;
    &lt;?php endif; ?&gt;
    &lt;?php
  }
} // end class MyFepsWidget

/**
 * External function for FEPS Credits
 *
 * @param array $data
 * @return array
 * @author korotkov@ud
 */
function wpi_add_feps_credits( $data ) {

  $feps_credits_meta_key = &#x27;wpp::feps::credits&#x27;;

  //** If we have required data */
  if ( !empty( $data[&#x27;user_data&#x27;][&#x27;ID&#x27;] ) &amp;&amp; !empty( $data[&#x27;other_meta&#x27;][&#x27;charge_amount&#x27;] ) ) {

    //** Get existing FEPS credits */
    $existing_feps_credits = (float)get_user_meta((int)$data[&#x27;user_data&#x27;][&#x27;ID&#x27;], $feps_credits_meta_key, 1);

    //** Sum with new credits */
    $existing_feps_credits += (float)$data[&#x27;other_meta&#x27;][&#x27;charge_amount&#x27;];

    //** Update credits meta with new amount */
    update_user_meta((int)$data[&#x27;user_data&#x27;][&#x27;ID&#x27;], $feps_credits_meta_key, $existing_feps_credits);
  }

  do_action( &#x27;wpp_feps_add_feps_credits&#x27;, array( &#x27;data&#x27; =&gt; $data, &#x27;credits&#x27; =&gt; $existing_feps_credits ) );

  return $data;
}
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
