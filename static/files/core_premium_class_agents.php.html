<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>core/premium/class_agents.php - WP-Property</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="http://a3d72a45d111006ec192-ec5b80a12b0b09b4d52373336afb4254.r80.cf1.rackcdn.com/usability-dynamics.png" title="WP-Property"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 1.38.2</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/wpp.html">wpp</a></li>
            
                <li><a href="../classes/wpp.overview.html">wpp.overview</a></li>
            
                <li><a href="../classes/wpp.xmli.html">wpp.xmli</a></li>
            
                <li><a href="../classes/WPP_RETS.html">WPP_RETS</a></li>
            
                <li><a href="../classes/WPP_UI.html">WPP_UI</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: core/premium/class_agents.php</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&lt;?php
/*
Name: Real Astate Agents
Class: class_agents
Feature ID: 7
Minimum Core Version: 1.38.2
Version: 1.9.6
Description: Allows managing real estate agents.
Screen ID: property_page_show_agents
*/

add_action(&#x27;wpp_init&#x27;, array(&#x27;class_agents&#x27;, &#x27;init&#x27;));
add_action(&#x27;wpp_pre_init&#x27;, array(&#x27;class_agents&#x27;, &#x27;pre_init&#x27;));
add_action(&#x27;widgets_init&#x27;, create_function(&#x27;&#x27;, &#x27;return register_widget(&quot;AgentWidget&quot;);&#x27;));

/**
 * class_agents Class
 *
 * Allows managing real estate agents.
 *
 * Documentation
 *  Information about special issues regarding this plugin.
 *  1. Adding images to real estate agents
 *     - the user may add as many images to the profile of an agent as he wants to.
 *     - when clicking the &quot;Add Image&quot; button the following happens:
 *       - a certain value is added to the session
 *       - the user is redirected to the upload form of the media library
 *       - as soon as the user uploaded an image he will be redirected back to the
 *         edit screen of the agent he was working on
 *       - the value is removed from the session
 *
 * Copyright 2012 Usability Dynamics, Inc.  &lt;info@usabilitydynamics.com&gt;
 *
 * @version 1.0
 * @author Usability Dynamics, Inc. &lt;info@usabilitydynamics.com&gt;
 * @package WP-Property
 * @subpackage Agents
 */
class class_agents {

  /*
   * (custom) Capability to manage the current feature
   */
  static protected $capability = &quot;manage_wpp_agents&quot;;

  /**
   * Special functions that must be called prior to init
   *
   */
  function pre_init() {
    // Add role
    add_role(&#x27;agent&#x27;, &#x27;Real Estate Agent&#x27;, self::get_agent_capabilities());
    add_filter(&#x27;wpp_role_description_agent&#x27;, array(&#x27;class_agents&#x27;, &quot;role_description&quot;));

    /* Add capability */
    add_filter(&#x27;wpp_capabilities&#x27;, array(&#x27;class_agents&#x27;, &quot;add_capability&quot;));

    //* Add (remove) role Agent to Administrator */
    add_filter(&#x27;wpp_settings_save&#x27;, array(&#x27;class_agents&#x27;,&#x27;add_role_agent_to_admin&#x27;));

    add_filter(&#x27;wpp_feps_submitted&#x27;, array(&#x27;class_agents&#x27;,&#x27;assign_agent_to_new_feps_listing&#x27;));
  }

  /**
   *
   *
   */
  static function init() {

    if(current_user_can(self::$capability)) {
      // Add settings page
      add_filter(&#x27;wpp_settings_nav&#x27;, array(&#x27;class_agents&#x27;, &#x27;settings_nav&#x27;));
      add_action(&#x27;wpp_settings_content_agents&#x27;, array(&#x27;class_agents&#x27;, &#x27;settings_page&#x27;));

      // Posts
      add_action(&#x27;wpp_publish_box_options&#x27;, array(&#x27;class_agents&#x27;, &#x27;publish_box_options&#x27;));
    }

    add_action(&#x27;save_property&#x27;, array(&#x27;class_agents&#x27;, &#x27;save_property&#x27;), 0, 3);

    add_action(&#x27;admin_init&#x27;, array(&#x27;class_agents&#x27;, &#x27;admin_init&#x27;));
    add_action(&#x27;admin_enqueue_scripts&#x27;, array(&#x27;class_agents&#x27;, &#x27;admin_enqueue_scripts&#x27;));

    add_filter(&#x27;wpp_agent_widget_field_agent_image&#x27;, array(&#x27;class_agents&#x27;, &#x27;wpp_agent_widget_field_agent_image&#x27;),0,4);

    // User
    add_action(&#x27;edit_agent_profile&#x27;, array(&#x27;class_agents&#x27;, &#x27;show_profile_fields&#x27;), 10 );
    add_action(&#x27;edit_agent_profile_update&#x27;, array(&#x27;class_agents&#x27;, &#x27;save_profile_basic&#x27;), 10 );
    add_action(&#x27;edit_agent_profile_update&#x27;, array(&#x27;class_agents&#x27;, &#x27;save_profile_fields&#x27;), 11 );
    add_action(&#x27;edit_agent_profile_update&#x27;, array(&#x27;class_agents&#x27;, &#x27;redirect_agent_page&#x27;), 12 );

    //* Upload files (markers) */
    add_action(&#x27;wp_ajax_wpp_agent_image_upload&#x27;, array(&#x27;class_agents&#x27;,&#x27;ajax_image_upload&#x27;));

    add_action(&#x27;init&#x27;, array(&#x27;class_agents&#x27;, &#x27;remove_agent_image&#x27;), 4 );

    // Agent(s) column to overview page
    add_filter(&#x27;wpp_admin_overview_columns&#x27;, array(&#x27;class_agents&#x27;, &#x27;wpp_admin_overview_columns&#x27;));

    //** Add correct views to agent overview page */
    add_filter(&#x27;views_property_page_show_agents&#x27;, array(&#x27;class_agents&#x27;, &#x27;overview_view&#x27;));

    add_filter(&#x27;wpp_get_property&#x27;, array(&#x27;class_agents&#x27;, &#x27;wpp_get_property&#x27;));
    add_filter(&#x27;wpp_list_table_can_edit_post&#x27;, array(&#x27;class_agents&#x27;, &#x27;can_edit_post&#x27;));
    add_filter(&#x27;wpp_list_table_can_delete_post&#x27;, array(&#x27;class_agents&#x27;, &#x27;can_edit_post&#x27;));

    add_filter(&quot;manage_users_custom_column&quot;, array(&#x27;class_agents&#x27;, &#x27;manage_users_custom_column&#x27;), 0, 3);

    add_filter(&quot;wpp_get_search_filters&quot;, array(&#x27;class_agents&#x27;, &#x27;filter_get_search_filters&#x27;));
    add_filter(&quot;wpp_get_property_month_periods&quot;, array(&#x27;class_agents&#x27;, &#x27;filter_month_periods_filter&#x27;));
    add_filter(&quot;wpp_get_users_of_post_type&quot;, array(&#x27;class_agents&#x27;, &#x27;filter_users_filter&#x27;));
    add_filter(&quot;wpp_get_properties_quantity&quot;, array(&#x27;class_agents&#x27;, &#x27;filter_properties_quantity&#x27;), 10, 2);
    add_filter(&quot;wpp_prefill_meta&quot;, array(&#x27;class_agents&#x27;, &#x27;filter_property_filter&#x27;), 10, 2);
    // Add entry in nav menu
    add_action(&#x27;admin_menu&#x27;, array(&#x27;class_agents&#x27;, &#x27;admin_menu&#x27;));

    // Media Upload
    add_action(&#x27;media_upload_wpp_agent_image&#x27;, array(&#x27;class_agents&#x27;, &#x27;media_upload_wpp_agent_image&#x27;));
    add_action(&#x27;wpp_flyer_middle_column&#x27;, array(&#x27;class_agents&#x27;, &#x27;pdf_flyer_insert&#x27;), 20, 2);
    add_action(&#x27;wpp_flyer_settings_table_bottom&#x27;, array(&#x27;class_agents&#x27;, &#x27;flyer_settings&#x27;), 20, 2);

    // Agent cart
    add_shortcode(&#x27;agent_card&#x27;, array(&#x27;class_agents&#x27;, &#x27;shortcode_agent_card&#x27;));

    // Add action for Denali-specific coments
    add_action(&#x27;wpp_insert_property_comment&#x27;, array(&#x27;class_agents&#x27;, &#x27;handle_comments&#x27;));

    add_action(&#x27;wpp_import_advanced_options&#x27;, array(&#x27;class_agents&#x27;, &#x27;wpp_import_advanced_options&#x27;));

    //* Add filter for wpp_search ( used by WPP_List_Table class for &#x27;All Properties&#x27; page ) */
    add_filter(&#x27;prepare_wpp_properties_search&#x27;, array(&#x27;class_agents&#x27;, &#x27;prepare_wpp_properties_search&#x27;));

    //* Hack. Used to avoid issues of some WPP capabilities */
    add_filter(&#x27;current_screen&#x27;, array(&#x27;class_agents&#x27;, &#x27;current_screen&#x27;));

    //* Apply custom &#x27;wpp_agents&#x27; queryable key (used in property_overview shortcode) */
    add_filter(&#x27;get_queryable_keys&#x27;, array(&#x27;class_agents&#x27;, &#x27;get_queryable_keys&#x27;));

    //** Agents page load handler */
    add_action(&#x27;load-property_page_show_agents&#x27;, array(&#x27;class_agents&#x27;, &#x27;property_page_show_agents_load&#x27;));
  }

  /**
   * Agent Settings page load handler
   * @author korotkov@ud
   */
  function property_page_show_agents_load() {
    global $wp_properties;


    /** Screen Options */
    add_screen_option(&#x27;layout_columns&#x27;, array(&#x27;max&#x27; =&gt; 2, &#x27;default&#x27; =&gt; 2) );

    $contextual_help[&#x27;Agent Shortcodes&#x27;][] = &#x27;&lt;h3&gt;&#x27;. __(&quot;Agent Shortcodes&quot;, &quot;wpp&quot;) . &#x27;&lt;/h3&gt;&#x27;;
    $contextual_help[&#x27;Agent Shortcodes&#x27;][] = &#x27;&lt;p&gt;&#x27; . __(&quot;Show agent information:&quot;, &quot;wpp&quot;) . &#x27; [agent_card agent_id=1]&#x27; . __(&quot;, or you can specify which fields to show:&quot;, &quot;wpp&quot;) . &#x27; [agent_card agent_id=1 fields=display_name,email]&lt;/p&gt;&#x27;;
    $contextual_help[&#x27;Agent Shortcodes&#x27;][] = &#x27;&lt;p&gt;&#x27; . __(&quot;To query agent properties:&quot;, &quot;wpp&quot;) . &#x27;  [property_overview wpp_agents=1]&lt;/p&gt;&#x27;;

    $contextual_help[&#x27;Shortcode Attributes&#x27;][] = &#x27;&lt;h3&gt;&#x27; . __(&quot;Shortcode Attribute Fields&quot;, &quot;wpp&quot;) . &#x27;&lt;/h3&gt;&#x27;;
    $contextual_help[&#x27;Shortcode Attributes&#x27;][] = &#x27;&lt;p&gt;&#x27;.__(&#x27;The following attributes can be used in the [agent_card] shortcode.&#x27;, &#x27;wpp&#x27;).&#x27;&lt;/p&gt;&#x27;;
    $fields = array();
    $fields[&#x27;agent_image&#x27;] = array(&#x27;name&#x27; =&gt; &#x27;Agent Image&#x27;);
    $fields[&#x27;display_name&#x27;] = array(&#x27;name&#x27; =&gt; &#x27;Display Name&#x27;);
    $fields[&#x27;user_email&#x27;] = array(&#x27;name&#x27; =&gt; &#x27;Email Address&#x27;);
    $fields[&#x27;widget_bio&#x27;] = array(&#x27;name&#x27; =&gt; &#x27;Widget Bio&#x27;);
    $fields[&#x27;full_bio&#x27;] = array(&#x27;name&#x27; =&gt; &#x27;Full Bio&#x27;);
    $fields[&#x27;flyer_content&#x27;] = array(&#x27;name&#x27; =&gt; &#x27;Flyer Writeup&#x27;);

    $fields = array_merge($fields, self::clean_array( $wp_properties[&#x27;configuration&#x27;][&#x27;feature_settings&#x27;][&#x27;agents&#x27;][&#x27;agent_fields&#x27;] ));

    $contextual_help[&#x27;Shortcode Attributes&#x27;][] = &#x27;&lt;ul&gt;&#x27;;
    foreach($fields as $key =&gt; $label) {
      $all_agent_fields[] = $key;
      $contextual_help[&#x27;Shortcode Attributes&#x27;][] = &quot;&lt;li&gt;{$label[name]} - $key &lt;/li&gt;&quot;;
    }
    $contextual_help[&#x27;Shortcode Attributes&#x27;][] = &#x27;&lt;/ul&gt;&#x27;;

    $contextual_help[&#x27;Examples&#x27;][] = &#x27;&lt;h3&gt;&#x27; . __(&quot;Example Using All Available Fields&quot;, &quot;wpp&quot;) . &#x27;&lt;/h3&gt;&#x27;;

    $contextual_help[&#x27;Examples&#x27;][] = &#x27;[agent_card agent_id=1 fields=&#x27; . implode(&#x27;,&#x27;,$all_agent_fields) . &#x27;]&#x27;;

    //** Hook this is you need to add some helps to Agents Settings page */
    $contextual_help = apply_filters(&#x27;property_page_show_agents_help&#x27;, $contextual_help);

    do_action(&#x27;wpp_contextual_help&#x27;, array(&#x27;contextual_help&#x27;=&gt;$contextual_help));

  }

  /**
   *
   *
   */
  function admin_init() {
    global $current_screen, $wp_properties, $plugin_page;

    if ($_GET[&#x27;page&#x27;] == &#x27;show_agents&#x27; &amp;&amp; isset($_REQUEST[&#x27;action&#x27;]) &amp;&amp;  $_REQUEST[&#x27;action&#x27;] == &#x27;update&#x27; ) {
      do_action(&#x27;edit_agent_profile_update&#x27;, $_POST[&#x27;user_id&#x27;]);
    }
  }

  /*
   * Adds Custom capability to the current premium feature
   */
  function add_capability($capabilities) {

    $capabilities[self::$capability] = __(&#x27;Manage Real Estate Agents&#x27;,&#x27;wpp&#x27;);

    return $capabilities;
  }

  /**
  * Display user role selection on agent page if more than one role are allowed to be agents.
  *
  * Copyright 2011 Usability Dynamics, Inc. &lt;info@usabilitydynamics.com&gt;
  */
  function overview_view($views) {
    global $wp_properties, $wp_roles;

    //* Making sure that old data gets removed and that there&#x27;s at least one row */
    $agent_roles = $wp_properties[&#x27;configuration&#x27;][&#x27;feature_settings&#x27;][&#x27;agents&#x27;][&#x27;agent_roles&#x27;];

    //** Do nothing if less than 2 rules */
    if(!is_array($agent_roles) || count($agent_roles) &lt; 2) {
      return false;
    }

    $url = &#x27;edit.php?post_type=property&amp;page=show_agents&#x27;;
    $users_of_blog = count_users();
    $total_users = $users_of_blog[&#x27;total_users&#x27;];
    $avail_roles =&amp; $users_of_blog[&#x27;avail_roles&#x27;];
    $role_names = $wp_roles-&gt;role_names;

    foreach($agent_roles as $role) {

      if(!$avail_roles[$role]) {
        continue;
      }

      $role_object = get_role($role);

      $name = $role_names[$role_object-&gt;name];

      if ( $role == $_REQUEST[&#x27;role&#x27;] ) {
        $current_role = $role;
        $class = &#x27; class=&quot;current&quot;&#x27;;
      } else {
        $class = &#x27;&#x27;;
      }


      $name = translate_user_role( $name );

      $name = sprintf( __(&#x27;%1$s &lt;span class=&quot;count&quot;&gt;(%2$s)&lt;/span&gt;&#x27;), $name, $avail_roles[$role] );
      $role_links[$role] = &quot;&lt;a href=&#x27;&quot; . esc_url( add_query_arg( &#x27;role&#x27;, $role, $url ) ) . &quot;&#x27;$class&gt;$name&lt;/a&gt;&quot;;

    }

    return $role_links;
  }


  /**
  * Add extra options to XML Importer
  *
  * Copyright 2011 Usability Dynamics, Inc. &lt;info@usabilitydynamics.com&gt;
  */
  function wpp_import_advanced_options($current_settings = false) {
    global $wp_properties;

    $agent_fields[&#x27;display_name&#x27;] = &#x27;Display Name&#x27;;
    $agent_fields[&#x27;user_email&#x27;] = &#x27;Email Address&#x27;;

    if(is_array($wp_properties[&#x27;configuration&#x27;][&#x27;feature_settings&#x27;][&#x27;agents&#x27;][&#x27;agent_fields&#x27;])) {
      foreach($wp_properties[&#x27;configuration&#x27;][&#x27;feature_settings&#x27;][&#x27;agents&#x27;][&#x27;agent_fields&#x27;] as $meta_key =&gt; $meta_data) {
        $agent_fields[$meta_key] = $meta_data[&#x27;name&#x27;];
      }
    }
  ?&gt;
      &lt;li&gt;
        &lt;label class=&quot;description&quot;&gt;&lt;?php echo __(&#x27;Match the &quot;Property Agent&quot; attribute to &#x27;,&#x27;wpp&#x27;);?&gt;&lt;/label&gt;
        &lt;select  name=&quot;wpp_property_import[wpp_agent_attribute_match]&quot;&gt;
        &lt;?php foreach($agent_fields as $field_slug =&gt; $field_title) { ?&gt;
          &lt;option value=&quot;&lt;?php echo esc_attr($field_slug); ?&gt;&quot; &lt;?php selected($field_slug,$current_settings[&#x27;wpp_agent_attribute_match&#x27;]); ?&gt;&gt;&lt;?php echo $field_title; ?&gt;&lt;/option&gt;
        &lt;?php } ?&gt;
        &lt;/select&gt;
        &lt;label  class=&quot;description&quot;&gt;&lt;?php echo __(&#x27; field, when it is found, and associate with agent.&#x27;,&#x27;wpp&#x27;);?&gt;&lt;/label&gt;
    &lt;/li&gt;
  &lt;?php

  }

  /**
  * Sends notification to an agent.
  *
  * Copyright 2011 Usability Dynamics, Inc. &lt;info@usabilitydynamics.com&gt;
  */
  function send_agent_notification($agent_id, $subject = &#x27;Notification&#x27;, $message = &#x27;&#x27;, $headers=&#x27;&#x27;) {

    if(!is_numeric($agent_id))
      return;

    $agent_data = get_userdata($agent_id);

    if(wp_mail($agent_data-&gt;user_email, $subject, $message, $headers))
      return true;

    return false;

  }

  /**
  * Adds agent IDs in array format to the property object
  *
  * Copyright 2011 Usability Dynamics, Inc. &lt;info@usabilitydynamics.com&gt;
  */
  function wpp_get_property($property) {
    global $wpdb;
    $wpp_agents = get_post_meta($property[&#x27;ID&#x27;], &#x27;wpp_agents&#x27;);
    $property[&#x27;wpp_agents&#x27;] = $wpp_agents;
    return $property;
  }

  /**
  * Called after a comment is inserted on a property
  *
  * @todo Complete sending agent specific notifications
  *
  * Copyright 2011 Usability Dynamics, Inc. &lt;info@usabilitydynamics.com&gt;
  */
  function handle_comments($comment) {

  $property_id = $comment-&gt;comment_post_ID;

  //Does the property have agents
  $wpp_agents = get_post_meta($property_id, &#x27;wpp_agents&#x27;);

  if(empty($wpp_agents))
    return;
  // We have agents
  }

  /**
  * Adds agent-specific settings to flyer page
  *
  *
  * Copyright 2011 Usability Dynamics, Inc. &lt;info@usabilitydynamics.com&gt;
  */
  function flyer_settings($wpp_pdf_flyer) {
  ?&gt;
    &lt;tr&gt;
      &lt;th&gt;&lt;?php _e(&quot;Agent Image Size&quot;, &#x27;wpp&#x27;); ?&gt;&lt;/th&gt;
      &lt;td&gt;
           &lt;?php WPP_F::image_sizes_dropdown(&quot;name=wpp_settings[configuration][feature_settings][wpp_pdf_flyer][agent_photo_size]&amp;selected={$wpp_pdf_flyer[&#x27;agent_photo_size&#x27;]}&quot;); ?&gt;
      &lt;/td&gt;
   &lt;/tr&gt;
  &lt;?php
  }

  /**
  * Insert agent data into PDF flyer
  *
  *
  * Copyright 2011 Usability Dynamics, Inc. &lt;info@usabilitydynamics.com&gt;
  */
  function pdf_flyer_insert( $property, $wpp_pdf_flyer) {
    global $wp_properties;

    if(!is_array($property[&#x27;wpp_agents&#x27;])){
      $property[&#x27;wpp_agents&#x27;] = get_post_meta($property[&#x27;ID&#x27;], &#x27;wpp_agents&#x27;);
    }

    if(!empty($wpp_pdf_flyer[&#x27;pr_agent_info&#x27;]) &amp;&amp; !empty($property[&#x27;wpp_agents&#x27;])) {
      $agent_photo_size = $wpp_pdf_flyer[&#x27;agent_photo_size&#x27;];
      $agent_photo_width = $wpp_pdf_flyer[&#x27;agent_photo_width&#x27;];
        ?&gt;
        &lt;tr&gt;
            &lt;td&gt;&lt;div class=&quot;heading_text&quot;&gt;&lt;?php echo __(&#x27;Agent Information&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/div&gt;
            &lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
            &lt;td&gt;&lt;br/&gt;
        &lt;?php
        foreach($property[&#x27;wpp_agents&#x27;] as $agent_id) {
          if($agent_photo_size){
            $agent_images = class_agents::get_agent_images($agent_id, $agent_photo_size);
          }
          ?&gt;
            &lt;table cellspacing=&quot;0&quot; cellpadding=&quot;0&quot; border=&quot;0&quot;&gt;
              &lt;tr&gt;
                &lt;?php if(!empty($agent_images[0][&#x27;src&#x27;])) : ?&gt;
                &lt;td width=&quot;&lt;?php echo $agent_photo_width; ?&gt;&quot;&gt;&lt;?php
                  /** Make sure image exists */
                  if(@getimagesize($agent_images[0][&#x27;src&#x27;])) { ?&gt;&lt;table cellspacing=&quot;0&quot; cellpadding=&quot;10&quot; border=&quot;0&quot; class=&quot;bg-section&quot;&gt;
                    &lt;tr&gt;
                        &lt;td&gt;&lt;img width=&quot;&lt;?php echo ($agent_photo_width - 20); ?&gt;&quot; src=&quot;&lt;?php echo $agent_images[0][&#x27;src&#x27;]; ?&gt;&quot; alt=&quot;&quot;/&gt;
                        &lt;/td&gt;
                    &lt;/tr&gt;
                    &lt;/table&gt;
                  &lt;?php } ?&gt;
                &lt;/td&gt;
                &lt;td width=&quot;10&quot;&gt;&lt;/td&gt;
                &lt;?php endif; ?&gt;
                &lt;td width=&quot;&quot; class=&quot;pdf-text&quot;&gt;&lt;?php echo nl2br(get_user_meta($agent_id, &#x27;flyer_content&#x27;, true)); ?&gt;
                &lt;/td&gt;
              &lt;/tr&gt;
              &lt;tr&gt;
                &lt;td colspan=&quot;3&quot; height=&quot;15&quot;&gt;&amp;nbsp;
                &lt;/td&gt;
              &lt;/tr&gt;
            &lt;/table&gt;
         &lt;?php
        }
        ?&gt;
            &lt;/td&gt;
        &lt;/tr&gt;
        &lt;?php
    }
  }

  /**
  * Adds a colum to the overview table
  *
  * Copyright 2011 TwinCitiesTech.com, Inc.
  */
  function wpp_admin_overview_columns($columns) {
    $columns[&#x27;wpp_agents&#x27;] =  __(&#x27;Agent&#x27;,&#x27;wpp&#x27;);
    return $columns;
  }


  function manage_users_custom_column($nothing, $column_name, $user_id) {
    global $wpdb;

    $user_data  = get_userdata($user_id);

    switch($column_name) {

      case &#x27;id&#x27;:
        return $user_id;
      break;

      case &#x27;display_name&#x27;:
        $display_name = stripslashes($user_data-&gt;display_name);
        ob_start();
        ?&gt;
        &lt;strong&gt;&lt;a href=&quot;&lt;?php echo self::get_link_edit($user_id); ?&gt;&quot;&gt;&lt;?php echo $display_name; ?&gt;&lt;/a&gt;&lt;/strong&gt;&lt;br&gt;
        &lt;div class=&quot;row-actions&quot;&gt;
        &lt;span class=&quot;edit&quot;&gt;&lt;a href=&quot;&lt;?php echo self::get_link_edit($user_id); ?&gt;&quot;&gt;&lt;?php _e(&#x27;Edit&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/a&gt; | &lt;/span&gt;
        &lt;span class=&quot;delete&quot;&gt;&lt;a href=&quot;&lt;?php echo self::get_link_delete($user_id); ?&gt;&quot; class=&quot;submitdelete&quot;&gt;&lt;?php _e(&#x27;Delete&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/a&gt;&lt;/span&gt;
        &lt;/div&gt;
        &lt;?php
        $content = ob_get_contents();
        ob_end_clean();
        return $content;
      break;

      case &#x27;user_email&#x27;;
        return $user_data-&gt;user_email;
      break;

      case &#x27;related_properties&#x27;:
        $agent_properties = $wpdb-&gt;get_var(&quot;SELECT count(meta_value) FROM {$wpdb-&gt;postmeta} WHERE meta_key = &#x27;wpp_agents&#x27; AND meta_value = &#x27;{$user_id}&#x27;&quot;);
        return $agent_properties;
      break;

      default:

        return get_user_meta($user_id, $column_name, true);
      break;
    }
  }



  function manage_property_page_show_agents_columns($columns) {
    global $wp_properties;

    $agent_fields = $wp_properties[&#x27;configuration&#x27;][&#x27;feature_settings&#x27;][&#x27;agents&#x27;][&#x27;agent_fields&#x27;];
    $columns[&#x27;id&#x27;] = &quot;ID&quot;;
    $columns[&#x27;display_name&#x27;] = &quot;Display Name&quot;;
    $columns[&#x27;user_email&#x27;] = &quot;Email&quot;;

    if(!empty($agent_fields))
      foreach($agent_fields as $slug =&gt; $data)
        $columns[$slug] = $data[&#x27;name&#x27;];

    $columns[&#x27;related_properties&#x27;] = &quot;Properties&quot;;

    return $columns;
  }

  function wpp_agent_widget_field_agent_image($text, $display_fields, $slug, $this_field) {
    global $wp_properties;
    $images =  class_agents::get_agent_images($this_field, apply_filters(&#x27;wpp_agent_widget_image_size&#x27;, &#x27;thumbnail&#x27;));

    if ($images){
      $return[] = &quot;&lt;li class=&#x27;wpp_agent_stats_{$slug}&#x27;&gt;&quot;;
      $return[] =&#x27;&lt;div class=&quot;wpp_agent_images&quot;&gt;&#x27;;
      foreach ($images as $image){
        $return[] =&#x27;&lt;img width=&quot;&#x27;.$image[&#x27;width&#x27;].&#x27;&quot; height=&quot;&#x27;.$image[&#x27;height&#x27;].&#x27;&quot; src=&quot;&#x27;.$image[&#x27;src&#x27;].&#x27;&quot;/&gt;&#x27;;
      }
      $return[] =&#x27;&lt;/div&gt;&#x27;;
      $return[] =&quot;&lt;/li&gt;&quot;;
    }

    if(is_array($return))
      return implode(&#x27;&#x27;,$return);
  }

  /**
   *
   * @param $user
   *
   */
  function metabox_related_properties($user) {
    global $wpdb;

    /* get properties */
    $related = $wpdb-&gt;get_results(&quot;SELECT DISTINCT(post_title), post_id, post_status FROM {$wpdb-&gt;postmeta} pm LEFT JOIN {$wpdb-&gt;posts} p on pm.post_id = p.ID WHERE meta_key = &#x27;wpp_agents&#x27; AND meta_value=&#x27;{$user-&gt;ID}&#x27; &quot;);

    if(empty($related)) {
       _e(&#x27;No Properties.&#x27;, &#x27;wpp&#x27;);
       return;
    }

    echo &quot;&lt;ul class=&#x27;wpp_agents_related_properties wp-tab-panel&#x27;&gt;&quot;;
    foreach($related as $row) {
      echo &quot;&lt;li class=&#x27;wpp_post_status_{$row-&gt;post_status}&#x27;&gt;&lt;a href=&#x27;&quot;.get_edit_post_link($row-&gt;post_id).&quot;&#x27;&gt;{$row-&gt;post_title}&lt;/a&gt;&lt;/li&gt;&quot;;
    }
    echo &quot;&lt;/ul&gt;&quot;;
  }

  /**
   *
   * @param $user
   */
  function metabox_save($user) {
     ?&gt;
    &lt;input type=&quot;hidden&quot; value=&quot;update&quot; name=&quot;action&quot;&gt;
    &lt;input type=&quot;hidden&quot; value=&quot;&lt;?php echo $user-&gt;ID; ?&gt;&quot; id=&quot;user_id&quot; name=&quot;user_id&quot;&gt;

    &lt;div id=&quot;major-publishing-actions&quot;&gt;
      &lt;div id=&quot;publishing-action&quot;&gt;
        &lt;input type=&quot;submit&quot; id=&quot;publish&quot; value=&quot;&lt;?php if (isset($user-&gt;new_user) &amp;&amp; $user-&gt;new_user) _e(&#x27;Create Agent&#x27;, &#x27;wpp&#x27;); else _e(&#x27;Update Agent&#x27;, &#x27;wpp&#x27;); ?&gt;&quot; class=&quot;button-primary btn&quot; id=&quot;submit&quot; name=&quot;submit&quot; /&gt;
      &lt;/div&gt;
    &lt;/div&gt;
    &lt;?php
  }


  /**
   * Renders Agents options ( fields )
   *
   * @param $user
   */
  function metabox_primary_info($user) {
    ?&gt;
    &lt;table class=&quot;form-table&quot;&gt;
      &lt;tbody&gt;

        &lt;tr class=&#x27;column-display_name&#x27;&gt;
          &lt;th&gt;&lt;label for=&quot;display_name&quot;&gt;&lt;?php _e(&#x27;Display Name&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/label&gt;&lt;/th&gt;
          &lt;td&gt;&lt;input type=&quot;text&quot; style=&quot;width: 300px; font-size: 1.5em;&quot; class=&quot;regular-text&quot; value=&quot;&lt;?php print esc_attr($user-&gt;display_name); ?&gt;&quot; id=&quot;display_name&quot; name=&quot;display_name&quot;&gt;&lt;/td&gt;
        &lt;/tr&gt;

        &lt;tr&gt;
          &lt;th&gt;&lt;label for=&quot;user_login&quot;&gt;&lt;?php _e(&#x27;Username&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/label&gt;&lt;/th&gt;
          &lt;td&gt;
            &lt;input type=&quot;text&quot; class=&quot;regular-text&quot; &lt;?php if (!isset($user-&gt;new_user)) echo &#x27; disabled=&quot;disabled&quot;&#x27;; ?&gt;value=&quot;&lt;?php echo esc_attr($user-&gt;user_login); ?&gt;&quot; id=&quot;user_login&quot; name=&quot;user_login&quot;&gt;
            &lt;div class=&quot;description&quot;&gt;&lt;?php _e(&#x27;Usernames cannot be changed.&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/div&gt;
          &lt;/td&gt;
        &lt;/tr&gt;

        &lt;tr class=&#x27;column-user_email&#x27;&gt;
          &lt;th&gt;&lt;label for=&quot;email&quot;&gt;&lt;?php _e(&#x27;E-Mail&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/label&gt;&lt;/th&gt;
          &lt;td&gt;&lt;input type=&quot;text&quot; class=&quot;regular-text&quot; value=&quot;&lt;?php echo $user-&gt;user_email; ?&gt;&quot; id=&quot;email&quot; name=&quot;email&quot;&gt;&lt;/td&gt;
        &lt;/tr&gt;

        &lt;tr&gt;
          &lt;th&gt;&lt;label for=&quot;widget_bio&quot;&gt;&lt;?php _e(&#x27;Widget Bio&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/label&gt;&lt;/th&gt;
          &lt;td&gt;
            &lt;ul&gt;
              &lt;li&gt;&lt;textarea   class=&quot;code&quot; id=&quot;widget_bio&quot; name=&quot;agent_fields[widget_bio]&quot; style=&quot;width:300px;&quot;&gt;&lt;?php echo $user-&gt;widget_bio; ?&gt;&lt;/textarea&gt;&lt;/li&gt;
              &lt;li&gt;&lt;span class=&quot;description&quot;&gt;&lt;?php _e(&#x27;Content that is displayed in the agent widget.&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/span&gt;&lt;/li&gt;
            &lt;/ul&gt;
          &lt;/td&gt;
        &lt;/tr&gt;

        &lt;tr class=&quot;wpp_agent_options hidden&quot;&gt;
          &lt;th&gt;&lt;label&gt;&lt;?php _e(&#x27;Options&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/label&gt;&lt;/th&gt;
          &lt;td&gt;
            &lt;?php $options = apply_filters( &#x27;wpp::agents::agent::options&#x27;, array(), $user ); ?&gt;
            &lt;?php if( !empty( $options ) ) : ?&gt;
              &lt;ul class=&quot;wpp_agents_agent_options&quot; &gt;
              &lt;?php foreach( $options as $option ) : ?&gt;
                &lt;li&gt;&lt;?php echo $option; ?&gt;&lt;/li&gt;
              &lt;?php endforeach; ?&gt;
              &lt;/ul&gt;
            &lt;?php endif; ?&gt;
            &lt;div class=&quot;wpp_agents_agent_options&quot;&gt;&lt;?php do_action(&#x27;wpp_agents_agent_options&#x27;, $user); ?&gt;&lt;/div&gt;
          &lt;/td&gt;
        &lt;/tr&gt;

        &lt;tr&gt;
          &lt;th&gt;&lt;label for=&quot;full_bio&quot;&gt;&lt;?php _e(&#x27;Full Bio&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/label&gt;&lt;/th&gt;
          &lt;td&gt;
            &lt;ul&gt;
              &lt;li&gt;&lt;textarea   class=&quot;code&quot; id=&quot;full_bio&quot; name=&quot;agent_fields[full_bio]&quot; style=&quot;width:300px;&quot;&gt;&lt;?php echo $user-&gt;full_bio; ?&gt;&lt;/textarea&gt;&lt;/li&gt;
              &lt;li&gt;&lt;span class=&quot;description&quot;&gt;&lt;?php _e(&#x27;Content that can be displayed in the shortcode.&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/span&gt;&lt;/li&gt;
            &lt;/ul&gt;
          &lt;/td&gt;
        &lt;/tr&gt;

      &lt;/tbody&gt;
    &lt;/table&gt;
    &lt;?php do_action(&#x27;edit_agent_profile&#x27;, $user); ?&gt;
    &lt;?php do_action(&#x27;edit_agent_profile_extra&#x27;, $user); ?&gt;
    &lt;?php
  }


  function admin_enqueue_scripts() {
    global $current_screen, $wp_properties;

    if(!isset($current_screen-&gt;id)) {
      return;
    }

    if($current_screen-&gt;id == &#x27;property_page_show_agents&#x27; &amp;&amp; (isset($_REQUEST[&#x27;action&#x27;]) &amp;&amp; $_REQUEST[&#x27;action&#x27;] == &#x27;edit&#x27;)) {
      wp_enqueue_script(&#x27;post&#x27;);
      wp_enqueue_script(&#x27;postbox&#x27;);
      wp_enqueue_script(&#x27;wpp-jquery-ajaxupload&#x27;);
      wp_enqueue_script(&#x27;wpp-edit-agent&#x27;, WPP_URL . &#x27;js/wp-property-admin-agent.js&#x27;, array( &#x27;jquery&#x27;, &#x27;wpp-localization&#x27; ), WPP_Version );

      add_meta_box(&#x27;metabox_primary_info&#x27;, __(&#x27;Primary&#x27;), array(&#x27;class_agents&#x27;,&#x27;metabox_primary_info&#x27;), &#x27;property_page_show_agents&#x27;, &#x27;normal&#x27;, &#x27;core&#x27;);
      add_meta_box(&#x27;metabox_save&#x27;, __(&#x27;Save&#x27;), array(&#x27;class_agents&#x27;,&#x27;metabox_save&#x27;), &#x27;property_page_show_agents&#x27;, &#x27;side&#x27;, &#x27;core&#x27;);
      add_meta_box(&#x27;metabox_related_properties&#x27;, __(&#x27;Associated Properties&#x27;), array(&#x27;class_agents&#x27;,&#x27;metabox_related_properties&#x27;), &#x27;property_page_show_agents&#x27;, &#x27;side&#x27;, &#x27;core&#x27;);
      add_meta_box(&#x27;metabox_profile_images&#x27;, __(&#x27;Images&#x27;), array(&#x27;class_agents&#x27;,&#x27;metabox_profile_images&#x27;), &#x27;property_page_show_agents&#x27;, &#x27;side&#x27;, &#x27;core&#x27;);
    }

    if($current_screen-&gt;id == &#x27;property_page_show_agents&#x27;) {
      wp_enqueue_script(&#x27;wp-property-backend-global&#x27;);
      wp_enqueue_script(&#x27;wp-property-global&#x27;);

      //** Only do on agent overview page */
      if(!isset($_REQUEST[&#x27;action&#x27;])) {
        /* add_screen_option( &#x27;per_page&#x27;, array(&#x27;label&#x27; =&gt; _x( &#x27;Users&#x27;, &#x27;users per page (screen options)&#x27; )) ); */
        add_filter(&quot;manage_property_page_show_agents_columns&quot;, array(&#x27;class_agents&#x27;, &#x27;manage_property_page_show_agents_columns&#x27;));
      }
    }
  }

  /**
   * Adds menu to settings page navigation
   */
  function settings_nav($tabs) {
    $tabs[&#x27;agents&#x27;] = array(
      &#x27;slug&#x27; =&gt; &#x27;agents&#x27;,
      &#x27;title&#x27; =&gt; __(&#x27;Agents&#x27;,&#x27;wpp&#x27;)
    );
    return $tabs;
  }

  /**
   * Displays advanced management page
   */
  function settings_page() {
    global $wpdb, $wp_properties, $wp_roles;

    //* Making sure that old data gets removed and that there&#x27;s at least one row */
    $agent_data = $wp_properties[&#x27;configuration&#x27;][&#x27;feature_settings&#x27;][&#x27;agents&#x27;];

    $agent_roles = $agent_data[&#x27;agent_roles&#x27;];

    $agent_fields = stripslashes_deep(self::clean_array($agent_data[&#x27;agent_fields&#x27;]));

    //** Force at lest one role to always be associated */
    if ( empty($agent_roles) ) {
      $agent_roles =  array(&#x27;agent&#x27;);
    }

    //** if no agent-meta secists, load in default data, and set $default_data to true so first row is treated as new and canbe edited */
    if ( empty($agent_fields) ) {
      $default_data = true;
      $agent_fields = array(
        &#x27;phone_number&#x27; =&gt; array(&#x27;name&#x27; =&gt; &#x27;Phone Number&#x27;)
      );
    }

    ?&gt;

  &lt;script type=&#x27;text/javascript&#x27;&gt;
    jQuery(document).ready(function() {});
  &lt;/script&gt;
  &lt;table class=&quot;form-table&quot;&gt;
    &lt;tr&gt;
      &lt;th&gt;
        &lt;?php _e(&#x27;Agent Roles&#x27;,&#x27;wpp&#x27;); ?&gt;
        &lt;div class=&quot;description&quot;&gt;&lt;?php _e(&#x27;User roles that can be associated with properties as agents.&#x27;,&#x27;wpp&#x27;); ?&gt;&lt;/div&gt;
        &lt;/th&gt;
      &lt;td&gt;
        &lt;ul class=&quot;wp-tab-panel &quot;&gt;

          &lt;?php foreach($wp_roles-&gt;roles as $role_slug =&gt; $role_data){ ?&gt;
            &lt;li&gt;
              &lt;input id=&quot;wpp_settings_configuration_feature_settings_agents_agent_roles_&lt;?php echo $role_slug; ?&gt;&quot; type=&quot;checkbox&quot; name=&quot;wpp_settings[configuration][feature_settings][agents][agent_roles][]&quot; value=&quot;&lt;?php echo esc_attr($role_slug); ?&gt;&quot; &lt;?php echo (in_array($role_slug, $agent_roles) ? &#x27; checked=&quot;true&quot; &#x27; : &#x27;&#x27;); ?&gt;/&gt;
              &lt;label for=&quot;wpp_settings_configuration_feature_settings_agents_agent_roles_&lt;?php echo $role_slug; ?&gt;&quot;&gt;&lt;?php echo $role_data[&#x27;name&#x27;]; ?&gt;&lt;/label&gt;
            &lt;/li&gt;
          &lt;?php } ?&gt;
      &lt;/ul&gt;

      &lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;th&gt;
        &lt;?php _e(&#x27;Agent Fields&#x27;,&#x27;wpp&#x27;); ?&gt;
        &lt;div class=&quot;description&quot;&gt;&lt;?php _e(&#x27;Extra data fields to be used for agent profiles.&#x27;,&#x27;wpp&#x27;); ?&gt;&lt;/div&gt;
      &lt;/th&gt;
      &lt;td&gt;
        &lt;p&gt;&lt;?php _e(&#x27;Custom fields may be used to adapt the information about agents to suit your needs.&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/p&gt;

        &lt;table id=&quot;wpp_agent_fields&quot; class=&quot;ud_ui_dynamic_table widefat&quot; allow_random_slug=&quot;true&quot;&gt;
          &lt;thead&gt;
            &lt;tr&gt;
              &lt;th&gt;&lt;?php _e(&#x27;Field name&#x27;, &#x27;wpp&#x27;) ?&gt;&lt;/th&gt;
              &lt;th style=&quot;width:50px;&quot;&gt;&lt;?php _e(&#x27;Slug&#x27;, &#x27;wpp&#x27;) ?&gt;&lt;/th&gt;
              &lt;th&gt;&amp;nbsp;&lt;/th&gt;
            &lt;/tr&gt;
          &lt;/thead&gt;
          &lt;tbody&gt;
            &lt;?php foreach($agent_fields as $slug =&gt; $field) { ?&gt;
              &lt;tr class=&quot;wpp_dynamic_table_row&quot; slug=&quot;&lt;?php echo $slug; ?&gt;&quot; new_row=&quot;&lt;?php echo($default_data ? &#x27;true&#x27; : &#x27;false&#x27;); ?&gt;&quot;&gt;
                &lt;td&gt;&lt;input class=&quot;slug_setter&quot; type=&quot;text&quot; name=&quot;wpp_settings[configuration][feature_settings][agents][agent_fields][&lt;?php echo $slug; ?&gt;][name]&quot; value=&quot;&lt;?php echo $field[&#x27;name&#x27;]; ?&gt;&quot; /&gt;&lt;/td&gt;
                &lt;td&gt;&lt;input type=&quot;text&quot; value=&quot;&lt;?php echo $slug; ?&gt;&quot; readonly=&quot;readonly&quot; class=&quot;slug&quot; /&gt;&lt;/td&gt;
                &lt;td&gt;&lt;span class=&quot;wpp_delete_row wpp_link&quot;&gt;&lt;?php _e(&#x27;Delete&#x27;, &#x27;wpp&#x27;) ?&gt;&lt;/span&gt;&lt;/td&gt;
              &lt;/tr&gt;
            &lt;?php }  ?&gt;
          &lt;/tbody&gt;
          &lt;tfoot&gt;
            &lt;tr&gt;
              &lt;td colspan=&quot;3&quot;&gt;&lt;input type=&quot;button&quot; class=&quot;wpp_add_row button-secondary&quot; value=&quot;&lt;?php _e(&#x27;Add Row&#x27;, &#x27;wpp&#x27;) ?&gt;&quot; /&gt;&lt;/td&gt;
            &lt;/tr&gt;
          &lt;/tfoot&gt;
        &lt;/table&gt;
      &lt;/td&gt;
    &lt;/tr&gt;
  &lt;/table&gt;
&lt;?php
  }

  /*
   * Hack.
   * Determine if the current page is post editor and current user is Agent and the current post
   * is not assigned to him or user is not author of post and has no capabilities for edit it
   * we redirect user to general &#x27;All Properties&#x27; (overview) page
   *
   * @param object $screen
   * @return object $screen
   * @author peshkov@UD
   */
  function current_screen($screen){
    if($screen-&gt;base == &quot;post&quot; &amp;&amp; $screen-&gt;post_type == &quot;property&quot;) {
      if(!empty($_REQUEST[&#x27;post&#x27;])) {
        $id = (int)$_REQUEST[&#x27;post&#x27;];
        $post = get_post($id);
        if(empty($post)) {
          return $screen;
        }
        $current_user = wp_get_current_user();
        $roles = (array)$current_user-&gt;roles;

        if(in_array(&#x27;agent&#x27;, $roles) &amp;&amp; !in_array(&#x27;administrator&#x27;, $roles)) {
          $agents = (array)get_post_meta($id, &#x27;wpp_agents&#x27;);
          $post_type_object = get_post_type_object( $post-&gt;post_type );
          if(!in_array($current_user-&gt;ID , $agents) ||
            $post-&gt;post_author != $current_user-&gt;ID &amp;&amp;
            !current_user_can($post_type_object-&gt;cap-&gt;edit_others_posts)) {
            wp_redirect(&#x27;edit.php?post_type=property&amp;page=all_properties&#x27;);
            exit();
          }
        }
      }
    }

    return $screen;
  }

  /*
   * Determine if Administrator can have Agent role
   * and Add/Remove Agent role to/from Administrator
   *
   * @param array $wpp_settings
   * @return array $wpp_settings
   * @author Maxim Peshkov
   */
  function add_role_agent_to_admin($wpp_settings) {
    global $wp_roles;

    //* Determine if Agent role exists at all */
    if(!array_key_exists(&#x27;agent&#x27;, $wp_roles-&gt;role_names)) {
      return $wpp_settings;
    }

    //* Gel all Administrators */
    $users = get_users(array(
      &#x27;role&#x27; =&gt; &#x27;administrator&#x27;
    ));

    //* Get option from WPP settings which allows administrator to be an agent */
    $add_role_to_admin = $wpp_settings[&#x27;configuration&#x27;][&#x27;feature_settings&#x27;][&#x27;agents&#x27;][&#x27;add_role_to_admin&#x27;];

    //* Add or Remove Agent role depending on option */
    foreach($users as $u) {
      $user = new WP_User( $u-&gt;ID );
      if(!empty($add_role_to_admin) &amp;&amp; $add_role_to_admin == &#x27;true&#x27;) {
        $user-&gt;add_role(&#x27;agent&#x27;);
      } else {
        $user-&gt;remove_role(&#x27;agent&#x27;);
      }
    }

    return $wpp_settings;
  }

  /**
   * Add menu to WP&#x27;s navigation
   */
  function admin_menu() {
    global $wp_properties;


    if(!empty($wp_properties[&#x27;labels&#x27;][&#x27;agents&#x27;][&#x27;plural&#x27;])) {
      $label = $wp_properties[&#x27;labels&#x27;][&#x27;agents&#x27;][&#x27;plural&#x27;];
    } else {
     $label = __(&#x27;Agents&#x27;, &#x27;wpp&#x27;);
   }

    add_submenu_page(&#x27;edit.php?post_type=property&#x27;,$label,$label, self::$capability, &#x27;show_agents&#x27;, array(&#x27;class_agents&#x27;, &#x27;show_agents&#x27;));
  }


  /**
   * Helper functions
   */
  function get_link_edit($user_id, $amp = true) {
    $del = $amp ? &#x27;&amp;amp;&#x27; : &#x27;&amp;&#x27;;
    return &#x27;edit.php?post_type=property&#x27;.$del.&#x27;page=show_agents&#x27;.$del.&#x27;user_id=&#x27;.$user_id.$del.&#x27;action=edit&#x27;;
  }
  function get_link_delete($user_id) {
    return self::get_link_edit($user_id) . &#x27;&amp;amp;action=delete&#x27;;
  }


  /**
   * Displays a list of agents.
   */
  function show_agents() {
    global $wpdb, $wp_messages;

    if(isset($_REQUEST[&#x27;action&#x27;]) &amp;&amp; $_REQUEST[&#x27;action&#x27;] == &#x27;edit&#x27; ) {
      self::edit_agent( $_REQUEST[&#x27;user_id&#x27;] );
      return;
    }

    if(!isset($_REQUEST[&#x27;role&#x27;])) {
      $_REQUEST[&#x27;role&#x27;] = &#x27;agent&#x27;;
    }

    ?&gt;
    &lt;style type=&quot;text/css&quot;&gt;
      th.column-id {width: 18px;}
    &lt;/style&gt;
    &lt;div class=&quot;wrap&quot;&gt;
    &lt;div class=&quot;icon32&quot; id=&quot;icon-users&quot;&gt;&lt;br/&gt;&lt;/div&gt;
    &lt;h2&gt;&lt;?php _e(&#x27;Agents&#x27;, &#x27;wpp&#x27;); ?&gt; &lt;a class=&quot;button add-new-h2&quot; href=&quot;&lt;?php echo self::get_link_edit(-1); ?&gt;&quot;&gt;&lt;?php _e(&#x27;Add New&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/a&gt;&lt;/h2&gt;


    &lt;?php if(isset($wp_messages[&#x27;error&#x27;]) &amp;&amp; $wp_messages[&#x27;error&#x27;]): ?&gt;
    &lt;div class=&quot;error&quot;&gt;
      &lt;?php foreach($wp_messages[&#x27;error&#x27;] as $error_message): ?&gt;
        &lt;p&gt;&lt;?php echo $error_message; ?&gt;
      &lt;?php endforeach; ?&gt;
    &lt;/div&gt;
    &lt;?php endif; ?&gt;

    &lt;?php if(isset($wp_messages[&#x27;notice&#x27;]) &amp;&amp; $wp_messages[&#x27;notice&#x27;]): ?&gt;
    &lt;div class=&quot;updated fade&quot;&gt;
      &lt;?php foreach($wp_messages[&#x27;notice&#x27;] as $notice_message): ?&gt;
        &lt;p&gt;&lt;?php echo $notice_message; ?&gt;
      &lt;?php endforeach; ?&gt;
    &lt;/div&gt;
    &lt;?php endif; ?&gt;


    &lt;?php if (isset($_REQUEST[&#x27;action&#x27;]) &amp;&amp;  $_REQUEST[&#x27;action&#x27;] == &#x27;delete&#x27; ) : ?&gt;
      &lt;?php self::delete_agent( $_REQUEST[&#x27;user_id&#x27;] ); ?&gt;
      &lt;div class=&quot;updated fade&quot; id=&quot;message&quot;&gt;&lt;p&gt;&lt;?php _e(&#x27;User removed.&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/p&gt;&lt;/div&gt;
    &lt;?php endif; ?&gt;
    &lt;?php
      $wpp_agents_list_table = _get_list_table(&#x27;WP_Users_List_Table&#x27;);
      $wpp_agents_list_table-&gt;prepare_items();

      ?&gt;
      &lt;div class=&quot;tablenav &lt;?php echo esc_attr( $which ); ?&gt;&quot;&gt;

    &lt;?php
    $wpp_agents_list_table-&gt;pagination( &#x27;top&#x27; );
    $wpp_agents_list_table-&gt;views( );
    ?&gt;
    &lt;br class=&quot;clear&quot; /&gt;
    &lt;/div&gt;
    &lt;?php
    $wpp_agents_list_table-&gt;display();
    ?&gt;
    &lt;br class=&quot;clear&quot;&gt;
    &lt;/div&gt;
    &lt;script type=&quot;text/javascript&quot;&gt;
      jQuery(&#x27;.tablenav.top&#x27;).css(&#x27;display&#x27;,&#x27;none&#x27;);
      jQuery(&#x27;.tablenav.bottom&#x27;).css(&#x27;display&#x27;,&#x27;none&#x27;);
    &lt;/script&gt;
    &lt;?php
  }

  /**
   * Displays a list of agents.
   */
  function edit_agent($userId) {
    global $wp_messages, $screen_layout_columns;

    $newUser = $userId == -1 ? true : false;
    # create new user
    if ( $newUser ) {
      $user = new stdClass();
      $user-&gt;ID = $userId;
      $user-&gt;new_user = true;
    }
    # update existing user
    else {
      $user = get_userdata($userId);
    }

    $use = stripslashes_deep($user);
?&gt;
    &lt;script type=&quot;text/javascript&quot;&gt;
      jQuery(document).ready(function() {

        jQuery(&quot;#your-profile&quot;).submit(function() {

          if(jQuery(&quot;input#display_name&quot;).val() == &#x27;&#x27;) {
            jQuery(&quot;input#display_name&quot;).focus();
            return false;
          }

          if(jQuery(&quot;input#user_login&quot;).val() == &#x27;&#x27;) {
            jQuery(&quot;input#user_login&quot;).focus();
            return false;
          }

          if(!wpp_validate_email(jQuery(&quot;input#email&quot;).val())) {
            jQuery(&quot;input#email&quot;).focus();
            jQuery(&#x27;.wpp_agent_email_nag&#x27;).remove();
            jQuery(&quot;&lt;div class=&#x27;wpp_agent_email_nag description&#x27;&gt;&lt;?php _e(&#x27;Please enter a valid e-mail.&#x27;); ?&gt;&lt;/div&gt;&quot;).insertAfter( jQuery(&quot;input#email&quot;));
            return false;
          }

        });
      });
    &lt;/script&gt;
    &lt;div id=&quot;profile-page&quot; class=&quot;wpp_agent_page wrap&quot;&gt;
      &lt;div class=&quot;icon32&quot; id=&quot;icon-users&quot;&gt;&lt;br/&gt;&lt;/div&gt;
      &lt;?php if (isset($_REQUEST[&#x27;status&#x27;]) &amp;&amp;  $_REQUEST[&#x27;status&#x27;] == &#x27;update&#x27; ) : ?&gt;
        &lt;div class=&quot;updated fade&quot; id=&quot;message&quot;&gt;&lt;p&gt;&lt;?php _e(&#x27;Agent updated.&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/p&gt;&lt;/div&gt;
      &lt;?php endif; ?&gt;
      &lt;?php if (isset($_REQUEST[&#x27;status&#x27;]) &amp;&amp;  $_REQUEST[&#x27;status&#x27;] == &#x27;create&#x27; ) : ?&gt;
        &lt;div class=&quot;updated fade&quot; id=&quot;message&quot;&gt;&lt;p&gt;&lt;?php _e(&#x27;Agent created.&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/p&gt;&lt;/div&gt;
      &lt;?php endif; ?&gt;

      &lt;h2&gt;&lt;?php _e(&#x27;Edit Agent&#x27;, &#x27;wpp&#x27;); ?&gt; &lt;?php echo $user-&gt;display_name; ?&gt;&lt;/h2&gt;

      &lt;?php if(isset($_REQUEST[&#x27;error&#x27;]) &amp;&amp; $_REQUEST[&#x27;error&#x27;]): ?&gt;
      &lt;div class=&quot;error&quot;&gt;
          &lt;p&gt;&lt;?php echo $_REQUEST[&#x27;error&#x27;]; ?&gt;&lt;/p&gt;
      &lt;/div&gt;
      &lt;?php endif; ?&gt;

      &lt;?php if(isset($wp_messages[&#x27;notice&#x27;]) &amp;&amp; $wp_messages[&#x27;notice&#x27;]): ?&gt;
      &lt;div class=&quot;updated fade&quot;&gt;
        &lt;?php foreach($wp_messages[&#x27;notice&#x27;] as $notice_message): ?&gt;
          &lt;p&gt;&lt;?php echo $notice_message; ?&gt;
        &lt;?php endforeach; ?&gt;
      &lt;/div&gt;
      &lt;?php endif; ?&gt;

      &lt;form method=&quot;post&quot; action=&quot;&quot; id=&quot;your-profile&quot;&gt;
        &lt;input type=&quot;hidden&quot; name=&quot;_wpnonce&quot; value=&quot;&lt;?php echo wp_create_nonce(&#x27;wpp_edit_agent&#x27;); ?&gt;&quot; /&gt;
        &lt;?php if(!WPP_F::is_older_wp_version(&#x27;3.4&#x27;)) : ?&gt;
        &lt;div id=&quot;poststuff&quot; class=&quot;crm-wp-v34&quot;&gt;
          &lt;div id=&quot;post-body&quot; class=&quot;metabox-holder &lt;?php echo 2 == $screen_layout_columns ? &#x27;columns-2&#x27; : &#x27;columns-1&#x27;; ?&gt;&quot;&gt;
            &lt;div id=&quot;postbox-container-1&quot; class=&quot;postbox-container&quot;&gt;
              &lt;div id=&quot;side-sortables&quot; class=&quot;meta-box-sortables ui-sortable&quot;&gt;
                &lt;?php do_meta_boxes( &#x27;property_page_show_agents&#x27;, &#x27;side&#x27;, $user ); ?&gt;
              &lt;/div&gt;
            &lt;/div&gt;
            &lt;div id=&quot;postbox-container-2&quot; class=&quot;postbox-container&quot;&gt;
              &lt;div id=&quot;normal-sortables&quot; class=&quot;meta-box-sortables ui-sortable&quot;&gt;
                &lt;?php do_meta_boxes( &#x27;property_page_show_agents&#x27;, &#x27;normal&#x27;, $user ); ?&gt;
              &lt;/div&gt;
              &lt;div id=&quot;advanced-sortables&quot; class=&quot;meta-box-sortables ui-sortable&quot;&gt;
                &lt;?php do_meta_boxes( &#x27;property_page_show_agents&#x27;, &#x27;advanced&#x27;, $user ); ?&gt;
              &lt;/div&gt;
            &lt;/div&gt;
          &lt;/div&gt;
        &lt;/div&gt;&lt;!-- /poststuff --&gt;
        &lt;?php else : ?&gt;
        &lt;div id=&quot;poststuff&quot; class=&quot;metabox-holder &lt;?php echo 2 == $screen_layout_columns ? &#x27;has-right-sidebar&#x27; : &#x27;&#x27;; ?&gt;&quot;&gt;
          &lt;div id=&quot;side-info-column&quot; class=&quot;inner-sidebar&quot;&gt;
            &lt;?php do_meta_boxes( &#x27;property_page_show_agents&#x27;, &#x27;side&#x27;, $user ); ?&gt;
          &lt;/div&gt;

          &lt;div id=&quot;post-body&quot;&gt;
            &lt;div id=&quot;post-body-content&quot;&gt;
              &lt;?php do_meta_boxes( &#x27;property_page_show_agents&#x27;, &#x27;normal&#x27;, $user ); ?&gt;
              &lt;?php do_meta_boxes( &#x27;property_page_show_agents&#x27;, &#x27;advanced&#x27;, $user ); ?&gt;
            &lt;/div&gt;
          &lt;/div&gt;
        &lt;/div&gt;
        &lt;?php endif; ?&gt;
      &lt;/form&gt;
    &lt;/div&gt;
    &lt;?php
  }

  /**
   * Inserts content into the &quot;Publish&quot; metabox on property pages
   */
  function publish_box_options() {
    /* Do not show if there are no agetns */
    $agents = self::get_agents();

    if ( empty($agents) ) {
      return;
    }

    $agents_meta = self::get_agents_postmeta();?&gt;

    &lt;li class=&quot;wpp_agent_select_wrap&quot;&gt;
      &lt;span class=&quot;wpp_agent_selector_title&quot;&gt;&lt;?php _e(&#x27;Associated Agents&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/span&gt;
      &lt;div class=&quot;wpp_agent_selector wp-tab-panel&quot;&gt;
      &lt;ul&gt;
      &lt;?php foreach ( $agents as $agent ) : $agent = stripslashes_deep($agent); ?&gt;
        &lt;li&gt;
          &lt;input type=&quot;checkbox&quot; name=&quot;wpp_agents[]&quot;  id=&quot;wpp_agent_&lt;?php echo $agent-&gt;ID; ?&gt;&quot; value=&quot;&lt;?php echo $agent-&gt;ID; ?&gt;&quot; &lt;?php echo (in_array($agent-&gt;ID, $agents_meta) ? &#x27;checked=checked&#x27; : &#x27;&#x27;); ?&gt; /&gt;
          &lt;label for=&quot;wpp_agent_&lt;?php echo $agent-&gt;ID; ?&gt;&quot;&gt;&lt;a href=&quot;&lt;?php echo self::get_link_edit($agent-&gt;ID); ?&gt;&quot;&gt; &lt;?php echo $agent-&gt;display_name; ?&gt; &lt;/a&gt;&lt;/label&gt;
        &lt;/li&gt;
      &lt;?php endforeach; ?&gt;
      &lt;/ul&gt;
      &lt;/div&gt;

    &lt;/li&gt;
  &lt;?php
  }

  /**
   *  Stores data when saving a property.
   */
  function save_property($post_id, $_request, $geo_data) {
    global $wpdb;

    if(current_user_can(self::$capability)) {
      // Delete all old agents
      delete_post_meta($post_id, &#x27;wpp_agents&#x27;);

      if($_request[&#x27;wpp_agents&#x27;]) {
        foreach($_request[&#x27;wpp_agents&#x27;] as $agent_id) {
          add_post_meta($post_id, &#x27;wpp_agents&#x27;, $agent_id);
        }
      }
    }

    /*
     * Determine if the current user is Agent
     * If so, user will be assigned to the post as agent
     */
    $current_user = wp_get_current_user();
    $roles = $current_user-&gt;roles;
    if(in_array(&#x27;agent&#x27;, $roles) &amp;&amp; !in_array(&#x27;administrator&#x27;, $roles)) {
      $agents = self::get_agents_postmeta();
      if(!in_array($current_user-&gt;ID, $agents)) {
        add_post_meta($post_id, &#x27;wpp_agents&#x27;, $current_user-&gt;ID);
      }
    }
  }

  /**
   * Adds section to user edit screen
   */
  function show_profile_fields($user) {
    global $wp_properties;
    $fields = self::clean_array( $wp_properties[&#x27;configuration&#x27;][&#x27;feature_settings&#x27;][&#x27;agents&#x27;][&#x27;agent_fields&#x27;] );
    ?&gt;
    &lt;table class=&quot;form-table&quot;&gt;
      &lt;?php if ( is_array($fields) and !empty($fields) ) : ?&gt;
        &lt;?php foreach($fields as $key =&gt; $field) : ?&gt;
          &lt;tr class=&#x27;column-&lt;?php echo $key; ?&gt;&#x27;&gt;
            &lt;th&gt;&lt;label&gt;&lt;?php echo $field[&#x27;name&#x27;]; ?&gt;&lt;/label&gt;&lt;/th&gt;
            &lt;td&gt;
              &lt;input type=&quot;text&quot; class=&quot;regular-text&quot; name=&quot;agent_fields[&lt;?php echo $key; ?&gt;]&quot; value=&quot;&lt;?php echo esc_attr( $user-&gt;{$key}); ?&gt;&quot; /&gt;
            &lt;/td&gt;
          &lt;/tr&gt;
        &lt;?php endforeach; ?&gt;
      &lt;?php else: ?&gt;
        &lt;tr&gt;&lt;td colspan=&quot;2&quot;&gt;&lt;?php printf(__(&#x27;You can add fields on the &lt;a href=&quot;%s&quot;&gt;settings page&lt;/a&gt;.&#x27;, &#x27;wpp&#x27;), &#x27;edit.php?post_type=property&amp;page=property_settings#tab_agents&#x27;); ?&gt;&lt;/td&gt;&lt;/tr&gt;
      &lt;?php endif; ?&gt;

      &lt;?php if ( class_exists(&#x27;class_wpp_pdf_flyer&#x27;) ) : ?&gt;
        &lt;tr&gt;
          &lt;th&gt;&lt;label for=&quot;flyerwriteup&quot;&gt;&lt;?php _e(&#x27;Flyer Writeup&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/label&gt;&lt;/th&gt;
          &lt;td&gt;
            &lt;textarea cols=&quot;30&quot; rows=&quot;5&quot; id=&quot;flyerwriteup&quot; name=&quot;agent_fields[flyer_content]&quot; style=&quot;width:300px;&quot;&gt;&lt;?php echo esc_attr( $user-&gt;flyer_content); ?&gt;&lt;/textarea&gt;&lt;br/&gt;
            &lt;span class=&quot;description&quot;&gt;&lt;?php _e(&#x27;Please enter a writeup for flyers.&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/span&gt;
          &lt;/td&gt;
        &lt;/tr&gt;
      &lt;?php endif; ?&gt;
    &lt;/table&gt;
    &lt;?php
  }

  /**
   * Saves user data.
   */
  function save_profile_basic($user_id) {
    if ( $user_id == -1 )
      self::create_agent($_POST[&#x27;user_login&#x27;], $_POST[&#x27;display_name&#x27;], $_POST[&#x27;email&#x27;]);
    else
      self::update_agent($user_id, $_POST[&#x27;display_name&#x27;], $_POST[&#x27;email&#x27;]);
  }

  /**
   * Saves user fields.
   */
  function save_profile_fields($user_id) {
    # In case user was just created
    if ($user_id == -1)
      $user_id = $GLOBALS[&#x27;wpp_agent_user_id&#x27;];

    # Custom fields
    if ( is_array($_POST[&#x27;agent_fields&#x27;]) )
      foreach ($_POST[&#x27;agent_fields&#x27;] as $key =&gt; $agent_field){
        update_user_meta($user_id, $key, $agent_field);
      }
  }
  /**
   * Redirect to edit page.
   */
  function redirect_agent_page($user_id){
    # In case user was just created
    global $wp_messages;
    if (isset($wp_messages[&#x27;wp_agent_error&#x27;]) &amp;&amp; $wp_messages[&#x27;wp_agent_error&#x27;] != &#x27;&#x27;){
      $wp_agent_error = $wp_messages[&#x27;wp_agent_error&#x27;];
      wp_redirect(&#x27;edit.php?post_type=property&amp;page=show_agents&amp;user_id=&#x27;.$user_id.&#x27;&amp;action=edit&amp;error=&#x27;.urlencode($wp_agent_error));
      die();
    }

    if ($user_id == -1){
      $user_id = $GLOBALS[&#x27;wpp_agent_user_id&#x27;];
      wp_redirect(&#x27;edit.php?post_type=property&amp;page=show_agents&amp;user_id=&#x27;.$user_id.&#x27;&amp;action=edit&amp;status=create&#x27;);
      die();
    }
    wp_redirect(&#x27;edit.php?post_type=property&amp;page=show_agents&amp;user_id=&#x27;.$user_id.&#x27;&amp;action=edit&amp;status=update&#x27;);
    die();
  }

  /**
   * Ajax File (Image) Uploader
   *
   * @return string JSON
   * @author peshkov@UD
   */
  function ajax_image_upload() {
    global $wp_properties;

    $return = array();
    $file_name = $_REQUEST[&#x27;qqfile&#x27;];
    $agent_id = $_REQUEST[&#x27;agentId&#x27;];
    /** Available Extensions */
    $exts = array(&#x27;jpg&#x27;,&#x27;jpeg&#x27;,&#x27;png&#x27;,&#x27;gif&#x27;,&#x27;bmp&#x27;);
    $ext = pathinfo($file_name, PATHINFO_EXTENSION);

    if(!in_array($ext, $exts)) {
      $return[&#x27;error&#x27;] = __(&#x27;File should be an image&#x27;,&#x27;wpp&#x27;);
    } elseif(empty($agent_id) || (int)$agent_id == 0){
      $return[&#x27;error&#x27;] = __(&#x27;Agent ID is not set&#x27;,&#x27;wpp&#x27;);
    } else {
      $upload_dir = wp_upload_dir();
      $files_dir = $upload_dir[&#x27;basedir&#x27;] . &#x27;/wpp_agents&#x27;;
      $files_url = $upload_dir[&#x27;baseurl&#x27;] . &#x27;/wpp_agents&#x27;;
      /** Create DIR if it doesn&#x27;t exist */
      if(!is_dir($files_dir)) {
        mkdir($files_dir, 0755);
        fopen($files_dir . &#x27;/index.php&#x27;, &quot;w&quot;);
      }
      $file_name = wp_unique_filename($files_dir, $file_name);
      $path = $files_dir . &#x27;/&#x27;. $file_name;
      $url = $files_url . &#x27;/&#x27;. $file_name;

      /** Try to upload file */
      if ( empty( $_FILES ) ) {
        $temp = tmpfile();
        $input = fopen(&quot;php://input&quot;, &quot;r&quot;);
        $realSize = stream_copy_to_stream($input, $temp);
        fclose($input);
        $target = fopen($path, &quot;w&quot;);
        fseek($temp, 0, SEEK_SET);
        stream_copy_to_stream($temp, $target);
        fclose($target);
      } else {
        /** for IE!!! */
        move_uploaded_file($_FILES[&#x27;qqfile&#x27;][&#x27;tmp_name&#x27;], $path);
      }

      /* Checks if the image has been uploaded, and adds it to user postmeta */
      if(!file_exists($path)) {
        $return[&#x27;error&#x27;] = __(&#x27;Looks like, Image can not be uploaded.&#x27;, &#x27;wpp&#x27;);
      } else {
        /* Save image as attachment */
        $attachment = array(
          &#x27;post_title&#x27; =&gt; __(&#x27;Image of Real Estate Agent #&#x27;, &#x27;wpp&#x27;) . $agent_id,
          &#x27;post_content&#x27; =&gt; __(&#x27;Image for User #&#x27;, &#x27;wpp&#x27;) . $agent_id,
          &#x27;post_type&#x27; =&gt; &quot;attachment&quot;,
          &#x27;post_date&#x27; =&gt;  current_time(&#x27;mysql&#x27;),
          &#x27;post_mime_type&#x27; =&gt; &quot;image/{$ext}&quot;,
          &#x27;guid&#x27; =&gt; $url
        );
        $attachment_id = wp_insert_attachment($attachment);
        update_attached_file( $attachment_id, $path );

        /* Retrieve existing images */
        $image_ids = get_user_meta($agent_id, &#x27;agent_images&#x27;, false);
        if ( empty($image_ids) ) {
          $image_ids = array();
        } else {
          $image_ids = $image_ids[0];
        }
        /* Add currently added attachment */
        $image_ids[] = intval($attachment_id);
        /* Update user meta */
        update_user_meta($agent_id, &#x27;agent_images&#x27;, $image_ids);

        $return[&#x27;success&#x27;] = &#x27;true&#x27;;
        $return[&#x27;url&#x27;] = wpp_get_image_link($attachment_id , &#x27;thumbnail&#x27;) . &#x27;?&#x27; . (rand(0,100));
        $return[&#x27;filename&#x27;] = $file_name;
        $return[&#x27;attachment_id&#x27;] = $attachment_id;
      }
    }

    die(htmlspecialchars(json_encode($return), ENT_NOQUOTES));
  }

  /**
   * Adds section to user edit screen
   */
  function metabox_profile_images($user) {
    if ($user-&gt;ID == -1){
      echo &#x27;&lt;p class=&quot;pad10&quot;&gt;&#x27; .__(&#x27;Please save first to add images.&#x27;, &#x27;wpp&#x27;) . &#x27;&lt;/p&gt;&#x27;;
      return;
    }
    $images = self::get_agent_images($user-&gt;ID);
    ?&gt;
    &lt;ul id=&quot;wpp_agent_image_gallery&quot;&gt;
    &lt;?php if ( empty($images) ) : ?&gt;
      &lt;li class=&quot;wpp_agent_single_image wpp_no_agent_images&quot;&gt;&lt;?php _e(&#x27;No images found.&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/li&gt;
    &lt;?php else : ?&gt;
    &lt;?php foreach ($images as $image) : ?&gt;
      &lt;li class=&#x27;wpp_agent_single_image&#x27;&gt;
        &lt;table&gt;
          &lt;tr&gt;&lt;td&gt;
          &lt;img src=&quot;&lt;?php echo $image[&#x27;src&#x27;]; ?&gt;&quot; alt=&quot;&quot; /&gt;
          &lt;/td&gt;&lt;/tr&gt;
        &lt;/table&gt;
        &lt;div class=&#x27;delete_image&#x27;&gt;
          &lt;a href=&quot;&lt;?php echo self::get_link_edit($user-&gt;ID).&#x27;&amp;amp;remove_agent_image=&#x27;.$image[&#x27;id&#x27;]; ?&gt;&quot;&gt;&lt;?php _e(&#x27;Remove&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/a&gt;
        &lt;/div&gt;
      &lt;/li&gt;
    &lt;?php endforeach; ?&gt;
    &lt;?php endif; ?&gt;
    &lt;/ul&gt;
    &lt;div class=&quot;clear&quot;&gt;&lt;/div&gt;
    &lt;div id=&quot;wpp_ajax_uploader&quot;&gt;&lt;/div&gt;
    &lt;noscript&gt;
      &lt;p&gt;&lt;?php _e(&#x27;Please enable JavaScript to use file uploader&#x27;,&#x27;wpp&#x27;); ?&gt;&lt;/p&gt;
    &lt;/noscript&gt;
    &lt;div class=&quot;wpp_widget_action&quot;&gt;
      &lt;div class=&quot;wpp_agent_image_wrapper&quot;&gt;
        &lt;a title=&quot;Add an Image&quot; class=&quot;button&quot; href=&quot;javascript:;&quot; id=&quot;wpp_add_agent_image&quot;&gt;&lt;?php _e(&#x27;Add Image&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/a&gt;
      &lt;/div&gt;
      &lt;div class=&quot;wpp_ajax_loader&quot;&gt;&lt;/div&gt;
      &lt;div class=&quot;clear&quot;&gt;&lt;/div&gt;
    &lt;/div&gt;
    &lt;script type=&quot;text/javascript&quot;&gt;
      jQuery(document).ready(function() {
        if(typeof(qq) == &#x27;undefined&#x27;) {
          return;
        }
        var uploader = new qq.FileUploader({
          element: jQuery(&#x27;#wpp_ajax_uploader&#x27;)[0],
          action: &#x27;&lt;?php echo admin_url(&#x27;admin-ajax.php&#x27;); ?&gt;&#x27;,
          params: {
            action: &#x27;wpp_agent_image_upload&#x27;,
            agentId: &lt;?php echo $user-&gt;ID; ?&gt;
          },
          button: jQuery(&#x27;#wpp_add_agent_image&#x27;)[0],
          allowedExtensions: [&#x27;jpg&#x27;, &#x27;jpeg&#x27;, &#x27;png&#x27;, &#x27;gif&#x27;],
          onSubmit: function(id, fileName){
            jQuery(&quot;.wpp_ajax_loader&quot;).show();
          },
          onComplete: function(id, fileName, responseJSON){
            jQuery(&quot;.wpp_ajax_loader&quot;).hide();
            if ( responseJSON ) {
              if(jQuery(&#x27;#wpp_agent_image_gallery .wpp_no_agent_images&#x27;).length &gt; 0) {
                jQuery(&#x27;#wpp_agent_image_gallery .wpp_no_agent_images&#x27;).remove();
              }
              var url = responseJSON.url;
              var image_id = responseJSON.attachment_id;
              var html = &quot;&lt;li class=\&quot;wpp_agent_single_image\&quot;&gt;&quot;;
              html += &quot;&lt;table&gt;&lt;tr&gt;&lt;td&gt;&lt;img src=\&quot;&quot;+url+&quot;\&quot; alt=\&quot;\&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&quot;;
              html += &quot;&lt;div class=\&quot;delete_image\&quot;&gt;&quot;;
              html += &quot;&lt;a href=\&quot;&lt;?php echo self::get_link_edit($user-&gt;ID)?&gt;&amp;amp;remove_agent_image=&quot;+image_id+&quot;\&quot;&gt;&lt;?php _e(&#x27;Remove&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/a&gt;&quot;;
              html += &quot;&lt;/div&gt;&lt;/li&gt;&quot;;
              jQuery(&#x27;#wpp_agent_image_gallery&#x27;).append(html);
            }
           }
        });
      });
    &lt;/script&gt;
    &lt;?php
  }

  /**
   * Removes the given image
   * and cleans up the user meta
   *
   */
  function remove_agent_image() {
    if(!isset($_REQUEST[&#x27;remove_agent_image&#x27;]) &amp;&amp; !isset($_REQUEST[&#x27;user_id&#x27;])) {
      return;
    }
    $attachment_id = $_REQUEST[&#x27;remove_agent_image&#x27;];
    $user_id = $_REQUEST[&#x27;user_id&#x27;];
    if ( !is_numeric($attachment_id) || !is_numeric($user_id) ) return;
    /** Remove attachment id from user meta */
    $agent_images = get_user_meta($user_id, &#x27;agent_images&#x27;, true);
    if(!in_array($attachment_id, (array)$agent_images)) return;
    foreach($agent_images as $i =&gt; $id) {
      if($id == $attachment_id || $id == 0) {
        unset($agent_images[$i]);
      }
    }
    /** Update user meta */
    update_user_meta($user_id, &#x27;agent_images&#x27;, $agent_images);
    /** Try to remove attachment */
    wp_delete_attachment($attachment_id);
  }

  /**
   * Returns a list of users with the real estate agent role.
   */
  function get_agents() {
    global $blog_id, $wp_properties;

    $agent_roles = $wp_properties[&#x27;configuration&#x27;][&#x27;feature_settings&#x27;][&#x27;agents&#x27;][&#x27;agent_roles&#x27;];

    if(empty($agent_roles)) {
      $agent_roles = array(&#x27;agent&#x27;);
    }

    $agent_users = array();

    foreach($agent_roles as $agent_role) {

      if($found_agents = get_users(array(&#x27;blog_id&#x27; =&gt; $blog_id, &#x27;role&#x27; =&gt; $agent_role))) {
        $agent_users = array_merge($agent_users, $found_agents);
      }

    }

    if(count($agent_users)) {
      return $agent_users;
    }

    return false;

  }


  /**
   * Create a user.
   */
  function create_agent($user_login, $display_name, $email) {
    global $wp_messages;

    if ($user_login == &#x27;&#x27; || $display_name == &#x27;&#x27; || $email == &#x27;&#x27;){
      $wp_messages[&#x27;wp_agent_error&#x27;] = &quot;Display name, User name and Email address is required field! Please reinput required field.&quot;;
      return;
    }

    $user_id = username_exists($user_login);
    if ( empty($user_id) == false ){
      $wp_messages[&#x27;wp_agent_error&#x27;] = &quot;User already exist!&quot;;
      return;
    }

    $user_id = email_exists($email);
    if ( empty($user_id) == false ){
      $wp_messages[&#x27;wp_agent_error&#x27;] = &#x27;Email already exist!&#x27;;
      return;
    }

    # Create user
    $random_password = wp_generate_password(12, false);
    $user_id = wp_create_user($user_login, $random_password, $email);

    //NOTIFY NEW USER (AGENT) BY MAIL: wp_new_user_notification( $user_id, $random_password );
    //wp_new_user_notification( $user_id, $random_password );

    # Role
    global $wpdb;
    update_user_meta($user_id, $wpdb-&gt;prefix.&#x27;capabilities&#x27;, array(&#x27;agent&#x27; =&gt; 1));

    # Basics
    self::update_agent($user_id, $display_name, $email);

    # Other
    $GLOBALS[&#x27;wpp_agent_user_id&#x27;] = $user_id;

    return $user_id;
  }


  /**
   * Update a user.
   */
  function update_agent($user_id, $display_name, $email) {
    if ( empty($user_id) ) return;

    global $wp_messages;

    $check_user_id = email_exists($email);
    if ( empty($check_user_id) == false &amp;&amp; $check_user_id != $user_id){
      $wp_messages[&#x27;wp_agent_error&#x27;] = &#x27;Email already exist!&#x27;;
      return;
    }

    global $wpdb;

    $wpdb-&gt;query( $wpdb-&gt;prepare(&#x27;UPDATE &#x27;.$wpdb-&gt;users.&#x27; SET user_email = &quot;%s&quot; WHERE ID = %d&#x27;, array($email, $user_id)) );
    $wpdb-&gt;query( $wpdb-&gt;prepare(&#x27;UPDATE &#x27;.$wpdb-&gt;users.&#x27; SET user_nicename = &quot;%s&quot; WHERE ID = %d&#x27;, array($display_name, $user_id)) );
    $wpdb-&gt;query( $wpdb-&gt;prepare(&#x27;UPDATE &#x27;.$wpdb-&gt;users.&#x27; SET display_name = &quot;%s&quot; WHERE ID = %d&#x27;, array($display_name, $user_id)) );
  }


  /**
   * Removes user with given ID.
   */
  function delete_agent($user_id) {
    if ( !is_numeric($user_id) ) return;
    global $wpdb;
    $wpdb-&gt;query( $wpdb-&gt;prepare(&#x27;DELETE FROM &#x27;.$wpdb-&gt;users.&#x27; WHERE ID = %d&#x27;, array($user_id) )  );
    $wpdb-&gt;query( $wpdb-&gt;prepare(&#x27;DELETE FROM &#x27;.$wpdb-&gt;usermeta.&#x27; WHERE user_id = %d&#x27;, array($user_id) ) );
  }


  /**
   * Returns agents associated with current post.
   */
  function get_agents_postmeta() {
    global $post;
    $agents = get_post_meta($post-&gt;ID, &#x27;wpp_agents&#x27;);
    if ( empty($agents) or !is_array($agents) ) return array();
    return $agents;
  }


  /**
   * Returns images linked to an agent.
   */
  function get_agent_images($user_id, $size = &#x27;thumbnail&#x27;, $args = array()) {
    if ( !is_numeric($user_id) and intval($user_id) &gt; 0 ) return array();

    $image_ids = get_user_meta($user_id, &#x27;agent_images&#x27;, false);
    if ( empty($image_ids) ) return array();
    else $image_ids = $image_ids[0];

    //** Optional arguments */
    $defaults = array(
      &#x27;return&#x27; =&gt; &#x27;array&#x27;
    );
    $args = wp_parse_args( $args, $defaults );

    $images = array();
    foreach ($image_ids as $image_id) {
      $image = wpp_get_image_link($image_id, $size, $args);
      /*
      if ($type == &#x27;src&#x27;) {
        $image = wp_get_attachment_image_src($image_id, $size);
        if ( !empty($image) )
          $image[&#x27;id&#x27;] = $image_id;
      } else {
        $image = wp_get_attachment_image($image_id, $size);
      }
      //*/
      if ( empty($image) ) continue;
      $image[&#x27;id&#x27;] = $image_id;
      $images[] = $image;
    }

    return $images;
  }


  /**
   * Returns true in case the given agent is in the given array, otherwise false.
   */
  function contains_agent(array $agents, $agent) {
    if ( empty($agents) or !is_array($agents))
      return false;
    foreach ($agents as $a)
      if ($a == $agent) return true;
    return false;
  }


  /**
   * Returns the default capabilites for agents.
   */
  function get_agent_capabilities() {
    global $wp_properties;
    $editor_role = get_role(&#x27;author&#x27;);
    $agent_capabilities = ( empty($wp_properties[&#x27;agent_capabilities&#x27;]) ) ? $editor_role-&gt;capabilities : $wp_properties[&#x27;agent_capabilities&#x27;];
    #$agent_capabilities = $editor_role-&gt;capabilities; # TODO restore to default
    return $agent_capabilities;
  }


  /**
   * Returns an array with nice descriptions for capabilities.
   */
  function get_capabilities_pretty() {
    // Hint: Only a subset of all capabilities, mostly the ones for an editor
    return array(&#x27;moderate_comments&#x27; =&gt; __(&#x27;Moderate comments&#x27;, &#x27;wpp&#x27;),
     &#x27;manage_categories&#x27; =&gt; __(&#x27;Manage categories&#x27;, &#x27;wpp&#x27;),
     &#x27;manage_links&#x27; =&gt; __(&#x27;Manage links&#x27;, &#x27;wpp&#x27;),
     &#x27;upload_files&#x27; =&gt; __(&#x27;Upload files&#x27;, &#x27;wpp&#x27;),
     &#x27;edit_posts&#x27; =&gt; __(&#x27;Edit posts&#x27;, &#x27;wpp&#x27;),
     &#x27;edit_others_posts&#x27; =&gt; __(&quot;Edit other&#x27;s posts&quot;, &#x27;wpp&#x27;),
     &#x27;edit_published_posts&#x27; =&gt; __(&#x27;Edit published posts&#x27;, &#x27;wpp&#x27;),
     &#x27;publish_posts&#x27; =&gt; __(&#x27;Publish posts&#x27;, &#x27;wpp&#x27;),
     &#x27;edit_pages&#x27; =&gt; __(&#x27;Edit pages&#x27;, &#x27;wpp&#x27;),
     &#x27;read&#x27; =&gt; __(&#x27;Read&#x27;, &#x27;wpp&#x27;),
     &#x27;edit_others_pages&#x27; =&gt; __(&quot;Edit other&#x27;s pages&quot;, &#x27;wpp&#x27;),
     &#x27;edit_published_pages&#x27; =&gt; __(&#x27;Edit published pages&#x27;, &#x27;wpp&#x27;),
     &#x27;publish_pages&#x27; =&gt; __(&#x27;Publish pages&#x27;, &#x27;wpp&#x27;),
     &#x27;delete_pages&#x27; =&gt; __(&#x27;Delete pages&#x27;, &#x27;wpp&#x27;),
     &#x27;delete_others_pages&#x27; =&gt; __(&quot;Delete other&#x27;s pages&quot;, &#x27;wpp&#x27;),
     &#x27;delete_published_pages&#x27; =&gt; __(&#x27;Delete published pages&#x27;, &#x27;wpp&#x27;),
     &#x27;delete_posts&#x27; =&gt; __(&#x27;Delete posts&#x27;, &#x27;wpp&#x27;),
     &#x27;delete_others_posts&#x27; =&gt; __(&quot;Delete other&#x27;s posts&quot;, &#x27;wpp&#x27;),
     &#x27;delete_published_posts&#x27; =&gt; __(&#x27;Delete published posts&#x27;, &#x27;wpp&#x27;),
     &#x27;delete_private_posts&#x27; =&gt; __(&#x27;Delete private posts&#x27;, &#x27;wpp&#x27;),
     &#x27;edit_private_posts&#x27; =&gt; __(&#x27;Edit private posts&#x27;, &#x27;wpp&#x27;),
     &#x27;read_private_posts&#x27; =&gt; __(&#x27;Read private posts&#x27;, &#x27;wpp&#x27;),
     &#x27;delete_private_pages&#x27; =&gt; __(&#x27;Delete private pages&#x27;, &#x27;wpp&#x27;),
     &#x27;edit_private_pages&#x27; =&gt; __(&#x27;Edit private pages&#x27;, &#x27;wpp&#x27;),
     &#x27;read_private_pages&#x27; =&gt; __(&#x27;Read private pages&#x27;, &#x27;wpp&#x27;));
  }


  /**
   * Utility function that removes empty elements from the given array.
   */
  function clean_array($array) {
    if ( empty($array) or !is_array($array) )
      return array();

    $newArray = array();
    foreach ($array as $key =&gt; $value) {
      if ( empty($value) ) continue;

      # Special case for agent fields
      if ( empty($value[&#x27;name&#x27;]) ) continue;

      $newArray[$key] = $value;
    }
    return $newArray;
  }



  /**
  * Display agent card via shortcode
  *
  * @todo Complete sending agent specific notifications
  *
  * Copyright 2011 Usability Dynamics, Inc. &lt;info@usabilitydynamics.com&gt;
  */
  function shortcode_agent_card($atts) {
    global $property;

    $this_property = (object) $property;

    $user_id = $atts[&#x27;user_id&#x27;];

    if(empty($user_id)) {
      $user_id = $atts[&#x27;agent_id&#x27;];
    }

    if(empty($user_id)) {
      $user_id = $atts[&#x27;agent&#x27;];
    }

    $fields = &#x27;&#x27;;

    extract( shortcode_atts( array(
      &#x27;fields&#x27; =&gt; &#x27;display_name,agent_image,full_bio&#x27;
    ), $atts ) );

    $class = $atts[&#x27;class&#x27;];

    $class[] = &#x27;wpp_agents_content_agent_card&#x27;;

    if(empty($user_id)) {

      $wpp_agents = $this_property-&gt;wpp_agents;

      if(is_array($wpp_agents)) {
        foreach($wpp_agents as $agent_id) {
          $return[] = &#x27;&lt;div class=&quot;&#x27;. implode(&#x27;&#x27;, $class) .&#x27;&quot;&gt;&#x27; . class_agents::display_agent_card($agent_id, &quot;fields=$fields&quot;) .&#x27;&lt;/div&gt;&#x27;;
        }
      }

    } else {
      $return[] = &#x27;&lt;div class=&quot;&#x27;. implode(&#x27;&#x27;, $class) .&#x27;&quot;&gt;&#x27; . class_agents::display_agent_card($user_id, &quot;fields=$fields&quot;) .&#x27;&lt;/div&gt;&#x27;;
    }

    if(is_array($return)) {
      return implode(&quot;&quot;, $return);
    }


  }


  /**
  * Displays standardized agent information.
  *
  * @todo Complete sending agent specific notifications
  *
  * Copyright 2011 Usability Dynamics, Inc. &lt;info@usabilitydynamics.com&gt;
  */
  function display_agent_card($agent_id, $args = &#x27;&#x27;) {
    global $wp_properties;

    $defaults = array(
      &#x27;fields&#x27; =&gt; &#x27;display_name,agent_image,full_bio&#x27;,
      &#x27;return&#x27; =&gt; &#x27;true&#x27;
    );

    $args = wp_parse_args( $args, $defaults );

    $fields = explode(&#x27;,&#x27;,$args[&#x27;fields&#x27;]);

     // Load all titles
    if(!empty($wp_properties[&#x27;configuration&#x27;][&#x27;feature_settings&#x27;][&#x27;agents&#x27;][&#x27;agent_fields&#x27;]))
      foreach($wp_properties[&#x27;configuration&#x27;][&#x27;feature_settings&#x27;][&#x27;agents&#x27;][&#x27;agent_fields&#x27;] as $slug =&gt; $attr_data)
        $display_fields[$slug] = $attr_data[&#x27;name&#x27;];

    // Setup manual titles (not dynamic attributes)
    $display_fields[&#x27;user_email&#x27;] = __(&#x27;Email&#x27;, &#x27;wpp&#x27;);
    $display_fields[&#x27;display_name&#x27;] =  __(&#x27;Name&#x27;, &#x27;wpp&#x27;);
    $display_fields[&#x27;widget_bio&#x27;] = &quot;&quot;;
    $display_fields[&#x27;full_bio&#x27;] = &quot;&quot;;

    $no_label_items = apply_filters(&#x27;wpp_agent_no_label_items&#x27;, array(&#x27;display_name&#x27;, &#x27;agent_image&#x27;, &#x27;widget_bio&#x27;,&#x27;full_bio&#x27;,&#x27;agent_bio&#x27;,&#x27;flyer_content&#x27;));

    $user_data = get_userdata($agent_id);
    $user_data = stripslashes_deep($user_data);

    if(!$user_data) {
      return false;
    }

    ob_start();
    ?&gt;
    &lt;div class=&#x27;wpp_agent_info_single_wrapper&#x27;&gt;

        &lt;?php
          foreach($fields as $slug):

          if(empty($slug))
            continue;

            if(!in_array(trim($slug), $no_label_items))
              continue;

            $this_field = nl2br($user_data-&gt;$slug);

            $this_field = do_shortcode($this_field);

            $ul_print_rows[] = apply_filters(&#x27;wpp_agent_widget_field_&#x27; . $slug, &quot;&lt;li class=&#x27;wpp_agent_stats_{$slug}&#x27;&gt;&lt;p&gt;{$this_field}&lt;/p&gt;&lt;/li&gt;&quot;, $display_fields, $slug, $user_data-&gt;ID);
          endforeach;
        ?&gt;


      &lt;?php if($ul_print_rows): ?&gt;
      &lt;ul class=&quot;wpp_agent_info_list&quot;&gt;&lt;?php echo implode(&#x27;&#x27;, $ul_print_rows); ?&gt;&lt;/ul&gt;
      &lt;?php endif; ?&gt;


        &lt;?php
        if($fields)
        foreach($fields as $slug):

           if(empty($slug))
            continue;

             // Skip if this attribute is a no label attribute
          if(in_array(trim($slug), $no_label_items))
            continue;

          if($slug)
            $this_field = nl2br($user_data-&gt;$slug);

          if(empty($this_field))
            continue;

          $dt_element = &quot;&lt;dt class=&#x27;wpp_agent_stats_{$slug}&#x27;&gt;{$display_fields[$slug]}:&lt;/dt&gt;&quot;;

          // Make link
          if(WPP_F::isURL($this_field)) {
            $this_field = &quot;&lt;a class=&#x27;wpp_agent_attribute_link&#x27; href=&#x27;{$this_field}&#x27; title=&#x27;{$this_field}&#x27;&gt;{$display_fields[$slug]}&lt;/a&gt;&quot;;
            $dt_element = &quot;&lt;dt class=&#x27;wpp_agent_stats_{$slug}&#x27;&gt;&lt;/dt&gt;&quot;;
          }

          $this_field = do_shortcode($this_field);

          $dl_print_fields[] = apply_filters(&#x27;wpp_agent_widget_field_&#x27; . $slug, &quot;{$dt_element}&lt;dd class=&#x27;wpp_agent_stats_{$slug}&#x27;&gt;{$this_field}&lt;/dd&gt;&quot;, $display_fields, $slug, $user_data-&gt;ID);

      endforeach;
        ?&gt;

      &lt;?php if($dl_print_fields): ?&gt;
      &lt;dl class=&quot;wpp_agent_info_list&quot;&gt;&lt;?php echo implode(&#x27;&#x27;, $dl_print_fields); ?&gt;&lt;/dl&gt;
      &lt;?php endif; ?&gt;

    &lt;/div&gt;

    &lt;?php
    $content = ob_get_contents();
    ob_end_clean();

    return $content;
  }

  /*
   * Applies custom &#x27;wpp_agents&#x27; queryable key
   * Used by property_overview shortcode for wpp_query
   *
   * @param array $keys Queryable keys
   * @return array $keys
   * @author Maxim Peshkov
   */
  function get_queryable_keys($keys) {

    $keys[] = &#x27;wpp_agents&#x27;;

    return $keys;
  }

  /*
   * Get Role description
   * used by another premium feature &#x27;WPP Capabilities&#x27;.
   *
   * @author Maxim Peshkov
   */
  function role_description($description) {

    $description = __(&#x27;Agent can see only the properties which are assigned to him. Agent will be automaticly assigned to the property which he will create.&#x27;, &#x27;wpp&#x27;);

    return $description;
  }

  /*
   * Modify wpp_seacrh for prepare_items() of WPP_List_Table class
   * Agent should can edit only the properties which are assigned to him
   *
   * @param array $wpp_search
   * @return array $wpp_search
   * @author Maxim Peshkov
   */
  function prepare_wpp_properties_search($wpp_search) {
    /*
     * Determine if current user is agent
     * if so, we modify $wpp_search
     */
    $current_user = wp_get_current_user();
    $roles = $current_user-&gt;roles;
    if(in_array(&#x27;agent&#x27;, $roles) &amp;&amp; !in_array(&#x27;administrator&#x27;, $roles)) {
      if(!is_array($wpp_search)) {
        $wpp_search = array();
      }
      $wpp_search[&#x27;wpp_agents&#x27;] = $current_user-&gt;ID;
    }

    return $wpp_search;
  }

  /**
   * Filters properties filter array
   * @global object $wpdb
   * @param array $prefill_meta
   * @param string $slug
   * @return array
   */
  function filter_property_filter( $prefill_meta, $slug ) {
    global $wpdb;

    // Non post_meta fields
    $non_post_meta = array(
      &#x27;post_title&#x27;,
      &#x27;post_status&#x27;,
      &#x27;post_author&#x27;
    );

    // Simple sanitizing
    $prefill_meta = array_unique( $prefill_meta );
    foreach( $prefill_meta as $key =&gt; $meta ) {
      if ( empty( $meta ) ) unset( $prefill_meta[ $key ] );
    }

    $current_user = wp_get_current_user();
    $roles = $current_user-&gt;roles;

    // Process meta fields
    if ( !in_array( $slug, $non_post_meta ) ) {

      if(in_array(&#x27;agent&#x27;, $roles) &amp;&amp; !in_array(&#x27;administrator&#x27;, $roles)) {
        $meta_ids = $wpdb-&gt;get_col(&quot;
            SELECT post_id FROM {$wpdb-&gt;prefix}postmeta
            WHERE meta_key = &#x27;wpp_agents&#x27;
              AND meta_value = &#x27;{$current_user-&gt;ID}&#x27;;
        &quot;);
        $prefill_meta = $wpdb-&gt;get_col(&quot;
            SELECT meta_value FROM {$wpdb-&gt;prefix}postmeta
            WHERE post_id IN (&quot;.implode(&quot;,&quot;, $meta_ids).&quot;)
            AND meta_value IN (&#x27;&quot;.implode(&quot;&#x27;,&#x27;&quot;, $prefill_meta).&quot;&#x27;)
        &quot;);
      }

      $prefill_meta = array_unique( $prefill_meta );

    }
    // Process NON meta fields
    else {

      if(in_array(&#x27;agent&#x27;, $roles) &amp;&amp; !in_array(&#x27;administrator&#x27;, $roles)) {
        $meta_ids = $wpdb-&gt;get_col(&quot;
            SELECT post_id FROM {$wpdb-&gt;prefix}postmeta
            WHERE meta_key = &#x27;wpp_agents&#x27;
              AND meta_value = &#x27;{$current_user-&gt;ID}&#x27;;
        &quot;);
        $prefill_meta = $wpdb-&gt;get_col(&quot;
            SELECT $slug FROM {$wpdb-&gt;posts}
            WHERE ID IN (&quot;.implode(&quot;,&quot;, $meta_ids).&quot;)
              AND post_type = &#x27;property&#x27;
        &quot;);

      }

      $prefill_meta = array_unique( $prefill_meta );

    }

    return $prefill_meta;

  }

  /**
   * Filters quantity of properties from wpp
   * @global object $wpdb
   * @param array $results
   * @param array $post_status
   * @return array
   */
  function filter_properties_quantity( $results, $post_status ) {
    global $wpdb;

    $current_user = wp_get_current_user();
    $roles = $current_user-&gt;roles;

    if(in_array(&#x27;agent&#x27;, $roles) &amp;&amp; !in_array(&#x27;administrator&#x27;, $roles)) {

      $results = $wpdb-&gt;get_col(&quot;
        SELECT p.ID FROM {$wpdb-&gt;prefix}posts AS p
          LEFT JOIN {$wpdb-&gt;prefix}postmeta AS pm
          ON p.ID = pm.post_id
          WHERE pm.meta_key = &#x27;wpp_agents&#x27;
            AND pm.meta_value = &#x27;{$current_user-&gt;ID}&#x27;
            AND p.post_status IN (&#x27;&quot;. implode( &quot;&#x27;,&#x27;&quot;, $post_status ) .&quot;&#x27;)
            AND p.post_type = &#x27;property&#x27;
        &quot;);

    }

    return $results;

  }

  /**
   * Filters available users from wpp
   * @param array $users
   * @return array
   */
  function filter_users_filter( $users ) {

    if ( !current_user_can( &#x27;edit_others_wpp_properties&#x27; ) ) {
      $users = array();
    }

    return $users;

  }

  /**
   * Filters wpp months periods
   * @global object $wpdb
   * @param array $months
   * @return array
   */
  function filter_month_periods_filter( $months ) {
    global $wpdb;

    $current_user = wp_get_current_user();
    $roles = $current_user-&gt;roles;

    if(in_array(&#x27;agent&#x27;, $roles) &amp;&amp; !in_array(&#x27;administrator&#x27;, $roles)) {

      $months = $wpdb-&gt;get_results(&quot;
        SELECT DISTINCT YEAR( p.post_date ) AS year, MONTH( p.post_date ) AS month
        FROM $wpdb-&gt;posts AS p
        JOIN {$wpdb-&gt;prefix}postmeta AS pm
          ON p.ID = pm.post_id
        WHERE p.post_type = &#x27;property&#x27;
          AND p.post_status != &#x27;auto-draft&#x27;
          AND pm.meta_key = &#x27;wpp_agents&#x27;
          AND pm.meta_value = &#x27;{$current_user-&gt;ID}&#x27;
        ORDER BY post_date DESC
      &quot;);

    }

    return $months;

  }

  /**
   * Filters wpp search options
   * @param array $filters
   */
  function filter_get_search_filters( $filters ) {

    $filter_fields = array(
      &#x27;default&#x27; =&gt; &#x27;0&#x27;,
      &#x27;type&#x27;    =&gt; &#x27;dropdown&#x27;,
      &#x27;label&#x27;   =&gt; __(&#x27;Agent&#x27;, &#x27;wpp&#x27;)
    );

    $agents = self::get_agents();

    if(is_array($agents)) {
      $filter_fields[&#x27;values&#x27;][0] = __(&#x27;Any&#x27;, &#x27;wpp&#x27;);
      foreach( $agents as $agent ) {
        $filter_fields[&#x27;values&#x27;][$agent-&gt;ID] = $agent-&gt;display_name;
      }
    }

    //* Determine if agents are added (exist) to filter */
    if(count($filter_fields[&#x27;values&#x27;]) &lt;= 1) {
      return $filters;
    }

    $current_user = wp_get_current_user();
    $roles = $current_user-&gt;roles;

    if(in_array(&#x27;administrator&#x27;, $roles) &amp;&amp; !in_array(&#x27;agent&#x27;, $roles)) {
      $filters[&#x27;wpp_agents&#x27;] = $filter_fields;
    }

    return $filters;


  }

  /**
   * Assigns the submittor as an agent, if their role permits
   *
   *
   *
   * @param array $return
   * @param array $data - array of user_id, return, property_id and form_id
   *
   */
  function assign_agent_to_new_feps_listing( $property_id ) {
    global $wpdb, $wp_properties, $wp_roles;

    $_property = WPP_F::get_property( $post_id, array( &#x27;get_children&#x27; =&gt; &#x27;false&#x27; ) );

    $user_id = $_property[ &#x27;post_author&#x27; ];
    $user_data = get_userdata($user_id);

    $user_roles = $user_data-&gt;roles;

    $allowed_roles = $wp_properties[&#x27;configuration&#x27;][&#x27;feature_settings&#x27;][&#x27;agents&#x27;][&#x27;agent_roles&#x27;];

    if( $property_id &amp;&amp; is_array($user_roles) &amp;&amp; is_array($allowed_roles) &amp;&amp; array_intersect($user_roles, $allowed_roles)) {

      //** Just in case */
      delete_post_meta( $property_id, &#x27;wpp_agents&#x27; );

      //** Add the new user as an agent */
      add_post_meta( $property_id, &#x27;wpp_agents&#x27;, $user_id );

    }

    return true;

  }

  /**
   * Determine if the current user can edit the current property
   *
   * @global type $post
   * @param type $value
   * @return type $value
   * @author peshkov@UD
   */
  function can_edit_post ($value) {
    global $post, $current_user;

    if( $post-&gt;post_type ) {
      $roles = (array)$current_user-&gt;roles;
      if(in_array(&#x27;agent&#x27;, $roles) &amp;&amp; !in_array(&#x27;administrator&#x27;, $roles)) {
        $agents = (array)get_post_meta($post-&gt;ID, &#x27;wpp_agents&#x27;);
        $post_type_object = get_post_type_object( $post-&gt;post_type );
        if(!in_array($current_user-&gt;ID , $agents) ||
          $post-&gt;post_author != $current_user-&gt;ID &amp;&amp;
          !current_user_can($post_type_object-&gt;cap-&gt;edit_others_posts)) {
          return false;
        }
      }
    }

    return $value;
  }

} // end class_agents


/**
 * Compatibility pre WP 3.1
 */
if (!function_exists(&#x27;get_users&#x27;)) {
  function get_users() {
    return array();
  }
}


/**
 * AgentWidget Class
 */
class AgentWidget extends WP_Widget {

  function AgentWidget() {
    parent::WP_Widget(false, $name = &#x27;Property Agents&#x27;);
  }

  function widget($args, $instance) {
    global $post, $property, $wp_properties;
    $before_widget = $after_widget = $after_title = $before_title = &#x27;&#x27;;

    extract( $args );

    $saved_fields = $instance[&#x27;saved_fields&#x27;];
    $widget_title = apply_filters(&#x27;widget_title&#x27;, $instance[&#x27;title&#x27;]);

    $agents = ($post-&gt;wpp_agents)?$post-&gt;wpp_agents:$property[&#x27;wpp_agents&#x27;];

    if(!is_array($agents)) {
      return;
    }

    if(empty($saved_fields)) {
      return;
    }


    foreach($agents as $agent_id) {
      $this_agent = class_agents::display_agent_card($agent_id,&quot;fields=&quot; . implode(&#x27;,&#x27;,$saved_fields));

      if(!empty($this_agent)) {
        $agent_data[] = $this_agent;
      }
    }

    if(empty($agent_data)) {
      return;
    }

    echo $before_widget;

    if ( $widget_title ) {
      echo $before_title . $widget_title . $after_title;
    }

    echo &quot;&lt;div class=&#x27;wpp_agent_widget_wrapper &quot; . (empty($widget_title)  ? &#x27;wpp_no_widget_title&#x27; : &#x27; wpp_has_widget_title &#x27;) . &quot;&#x27;&gt;&quot;;
    echo implode($agent_data);
    echo &quot;&lt;/div&gt;&quot;;

    echo $after_widget;

  }

  function update($new_instance, $old_instance) {
    return $new_instance;
  }

  function form($instance) {
    global $wp_properties;
    $title = esc_attr($instance[&#x27;title&#x27;]);
    $saved_fields = $instance[&#x27;saved_fields&#x27;];

    $display_fields[&#x27;display_name&#x27;] = __(&#x27;Display Name&#x27;, &#x27;wpp&#x27;);
    $display_fields[&#x27;agent_image&#x27;] = __(&#x27;Image&#x27;, &#x27;wpp&#x27;);
    $display_fields[&#x27;widget_bio&#x27;] = __(&#x27;Widget Text&#x27;, &#x27;wpp&#x27;);
    $display_fields[&#x27;full_bio&#x27;] = __(&#x27;Full Bio&#x27;, &#x27;wpp&#x27;);

    if(!empty($wp_properties[&#x27;configuration&#x27;][&#x27;feature_settings&#x27;][&#x27;agents&#x27;][&#x27;agent_fields&#x27;]))
      foreach($wp_properties[&#x27;configuration&#x27;][&#x27;feature_settings&#x27;][&#x27;agents&#x27;][&#x27;agent_fields&#x27;] as $slug =&gt; $attr_data)
        $display_fields[$slug] = $attr_data[&#x27;name&#x27;];

    $display_fields[&#x27;user_email&#x27;] = __(&#x27;Email Address&#x27;, &#x27;wpp&#x27;);
  ?&gt;
  &lt;p&gt;
    &lt;label for=&quot;&lt;?php echo $this-&gt;get_field_id(&#x27;title&#x27;); ?&gt;&quot;&gt;&lt;?php _e(&#x27;Title:&#x27;); ?&gt;&lt;/label&gt;
    &lt;input class=&quot;widefat&quot; id=&quot;&lt;?php echo $this-&gt;get_field_id(&#x27;title&#x27;); ?&gt;&quot; name=&quot;&lt;?php echo $this-&gt;get_field_name(&#x27;title&#x27;); ?&gt;&quot; type=&quot;text&quot; value=&quot;&lt;?php echo $title; ?&gt;&quot; /&gt;
  &lt;/p&gt;

  &lt;div class=&quot;wp-tab-panel&quot;&gt;
    &lt;ul&gt;
    &lt;?php foreach($display_fields as $stat =&gt; $label): if(empty($label)) continue; ?&gt;
      &lt;li&gt;
        &lt;input id=&quot;&lt;?php echo $this-&gt;get_field_id(&#x27;saved_fields&#x27;); ?&gt;_&lt;?php echo $stat; ?&gt;&quot; name=&quot;&lt;?php echo $this-&gt;get_field_name(&#x27;saved_fields&#x27;); ?&gt;[]&quot; type=&quot;checkbox&quot; value=&quot;&lt;?php echo $stat; ?&gt;&quot;
        &lt;?php if(is_array($saved_fields) &amp;&amp; in_array($stat, $saved_fields)) echo &quot; checked &quot;; ?&gt;    /&gt;
        &lt;label for=&quot;&lt;?php echo $this-&gt;get_field_id(&#x27;saved_fields&#x27;); ?&gt;_&lt;?php echo $stat; ?&gt;&quot;&gt;&lt;?php echo $label;?&gt;&lt;/label&gt;
      &lt;/li&gt;
      &lt;?php  ?&gt;

    &lt;?php endforeach; ?&gt;
    &lt;/ul&gt;

  &lt;/div&gt;
  &lt;?php
  }
} // end class AgentWidget

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
