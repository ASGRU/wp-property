<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>core/premium/class_wpp_pdf_flyer.php - WP-Property</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="http://a3d72a45d111006ec192-ec5b80a12b0b09b4d52373336afb4254.r80.cf1.rackcdn.com/usability-dynamics.png" title="WP-Property"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 1.38.2</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/wpp.html">wpp</a></li>
            
                <li><a href="../classes/wpp.overview.html">wpp.overview</a></li>
            
                <li><a href="../classes/wpp.xmli.html">wpp.xmli</a></li>
            
                <li><a href="../classes/WPP_RETS.html">WPP_RETS</a></li>
            
                <li><a href="../classes/WPP_UI.html">WPP_UI</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: core/premium/class_wpp_pdf_flyer.php</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&lt;?php
/*
Name: PDF Flyer
Feature ID: 6
Version: 2.1.6
Minimum Core Version: 1.37.6
Internal Slug: property_pdf
JS Slug: wpp_property_pdf
Global Variable: wpp_pdf_flyer
Class: class_wpp_pdf_flyer
Description: Create flyers for properties on the fly.
*/

/** Class including moved into functions in which it is really required. korotkov@ud */
/** @include_once(WPP_Path.&#x27;third-party/tcpdf/tcpdf.php&#x27;); */

add_action(&#x27;wpp_init&#x27;, array(&#x27;class_wpp_pdf_flyer&#x27;, &#x27;init&#x27;));
add_action(&#x27;wpp_pre_init&#x27;, array(&#x27;class_wpp_pdf_flyer&#x27;, &#x27;pre_init&#x27;));

/* Any front-end Functions */
add_action(&#x27;template_redirect&#x27;, array(&#x27;class_wpp_pdf_flyer&#x27;, &#x27;template_redirect&#x27;));

class class_wpp_pdf_flyer {

  /*
   * (custom) Capability to manage the current feature
   */
  static protected $capability = &quot;manage_wpp_pdfflyer&quot;;

  /**
  * Special functions that must be called prior to init
  *
  * Copyright Usability Dynamics, Inc. &lt;http://usabilitydynamics.com&gt;
  */
  function pre_init() {

    /* Preserve PDF List settings */
    add_filter(&#x27;wpp_settings_save&#x27;, array(&#x27;class_wpp_pdf_flyer&#x27;, &#x27;wpp_settings_save&#x27;), 0, 2);
    /* Determine, check and open PDF List file in query (request) */
    add_action(&quot;parse_request&quot;, array(&#x27;class_wpp_pdf_flyer&#x27;, &#x27;parse_request_for_pdf_list&#x27;), 11);
    add_filter(&quot;query_vars&quot;, array(&#x27;class_wpp_pdf_flyer&#x27;, &quot;add_pdf_query_vars&quot;));

    /* Add capability */
    add_filter(&#x27;wpp_capabilities&#x27;, array(&#x27;class_wpp_pdf_flyer&#x27;, &quot;add_capability&quot;));
  }

  /**
  * Called at end of WPP init hook, in WP init hook
  *
  * Run-time settings are stored in $wpp_property_pdf[&#x27;runtime&#x27;]
  *
  * Copyright Usability Dynamics, Inc. &lt;http://usabilitydynamics.com&gt;
  */
  function init() {
    global $wpp_pdf_flyer, $wp_properties;

    if(current_user_can(self::$capability)) {
      /* Add to settings page nav */
      add_filter(&#x27;wpp_settings_nav&#x27;, array(&#x27;class_wpp_pdf_flyer&#x27;, &#x27;settings_nav&#x27;));
      /* Add Settings Page */
      add_action(&#x27;wpp_settings_content_pdf_flyer&#x27;, array(&#x27;class_wpp_pdf_flyer&#x27;, &#x27;settings_page&#x27;));

      //For Admin panel
      add_action(&#x27;add_meta_boxes&#x27;, array(&#x27;class_wpp_pdf_flyer&#x27;,&#x27;add_metabox&#x27;));
      add_action(&#x27;save_post&#x27;, array(&#x27;class_wpp_pdf_flyer&#x27;,&#x27;save_post&#x27;));
    }

    //** Load settings */
    $wpp_pdf_flyer = (array)$wp_properties[&#x27;configuration&#x27;][&#x27;feature_settings&#x27;][&#x27;wpp_pdf_flyer&#x27;];

    //** Add shortcode */
    add_shortcode(&#x27;property_flyer&#x27;, array(&#x27;class_wpp_pdf_flyer&#x27;, &#x27;shortcode_pdf_flyer&#x27;));
    add_shortcode(&#x27;wpp_pdf_list&#x27;, array(&#x27;class_wpp_pdf_flyer&#x27;, &#x27;shortcode_pdf_list&#x27;));

    /* Creates the PDF on the fly when a property is saved */

    $callback = ( isset( $wpp_pdf_flyer[&#x27;generate_flyers_on_the_fly&#x27;] ) &amp;&amp; $wpp_pdf_flyer[ &#x27;generate_flyers_on_the_fly&#x27; ] == &#x27;on&#x27; ) ? &#x27;check_flyer_pdf&#x27; : &#x27;create_flyer_pdf&#x27;;
    add_action(&#x27;save_property&#x27;, array(&#x27;class_wpp_pdf_flyer&#x27;, $callback ));

    /* Add &quot;View Flyer&quot; message to overview page actions */
    add_filter(&#x27;page_row_actions&#x27;, array(&#x27;class_wpp_pdf_flyer&#x27;, &#x27;page_row_actions&#x27;),0,2);

    /* Testing actions from the flyer. Should be in functions.php */
    add_action(&#x27;wpp_flyer_left_column&#x27;, array(&#x27;class_wpp_pdf_flyer&#x27;, &#x27;flyer_left_column&#x27;), 10, 2);
    add_action(&#x27;wpp_flyer_middle_column&#x27;, array(&#x27;class_wpp_pdf_flyer&#x27;, &#x27;flyer_middle_column&#x27;), 10, 2);
    add_action(&#x27;wpp_flyer_right_column&#x27;, array(&#x27;class_wpp_pdf_flyer&#x27;, &#x27;flyer_right_column&#x27;), 10, 2);

    add_action(&#x27;wpp_settings_help_tab&#x27;, array(&#x27;class_wpp_pdf_flyer&#x27;, &#x27;wpp_settings_help_tab&#x27;));

    add_action(&#x27;admin_menu&#x27;, array(&#x27;class_wpp_pdf_flyer&#x27;, &#x27;admin_menu&#x27;));

    add_filter(&#x27;wpp_flyer_description&#x27;, array(&#x27;class_wpp_pdf_flyer&#x27;, &#x27;flyer_description&#x27;), 0, 2);

    /* AJAX */
    add_action(&#x27;wp_ajax_wpp_get_property_ids&#x27;, array(&#x27;class_wpp_pdf_flyer&#x27;, &#x27;ajax_get_properties&#x27;));
    add_action(&#x27;wp_ajax_wpp_generate_pdf_flyer&#x27;, array(&#x27;class_wpp_pdf_flyer&#x27;, &#x27;ajax_generate_pdf_flyer&#x27;));
    add_action(&#x27;wp_ajax_wpp_generate_pdf_list&#x27;, array(&#x27;class_wpp_pdf_flyer&#x27;, &#x27;ajax_generate_pdf_list&#x27;));

    /* Add &quot;View Flyer&quot; message to update message after a property is saved */
    add_filter(&#x27;wpp_updated_messages&#x27;, array(&#x27;class_wpp_pdf_flyer&#x27;, &#x27;wpp_updated_messages&#x27;));

    // Load admin header scripts
    add_action(&#x27;admin_enqueue_scripts&#x27;, array(&#x27;class_wpp_pdf_flyer&#x27;, &#x27;admin_enqueue_scripts&#x27;));
  }

  /*
   * Adds Custom capability to the current premium feature
   */
  function add_capability($capabilities) {

    $capabilities[self::$capability] = __(&#x27;Manage PDF Flyer&#x27;,&#x27;wpp&#x27;);

    return $capabilities;
  }

  /**
   * Enqueue scripts on PDF pages, and print content into head
   *
   *
   * @uses $current_screen global variable
   * Copyright Usability Dynamics, Inc. &lt;http://usabilitydynamics.com&gt;
   */
  function admin_enqueue_scripts($hook) {
    global $current_screen;

    //** Property Overview Page */
    if($current_screen-&gt;id == &#x27;property_page_wpp_property_pdf_lists&#x27;) {
      wp_enqueue_script( &#x27;wp-property-backend-global&#x27; );
      wp_enqueue_script(&#x27;jquery&#x27;);
      wp_enqueue_script(&#x27;wpp-jquery-colorpicker&#x27;);
      wp_enqueue_style(&#x27;wpp-jquery-colorpicker-css&#x27;);
    }
  }

  /**
   * Settings page load handler
   * @author korotkov@ud
   */
  function wpp_flyer_pdf_list_page_load() {

    //** Default help items */
    $contextual_help[&#x27;General Settings&#x27;][] = &#x27;&lt;h3&gt;&#x27; . __(&#x27;General Settings&#x27;, &#x27;wpp&#x27;) . &#x27;&lt;/h3&gt;&#x27;;
    $contextual_help[&#x27;General Settings&#x27;][] .= &#x27;&lt;p&gt;&#x27; . __(&#x27;Unless &lt;b&gt;Don\&#x27;t make accessible for public&lt;/b&gt; is checked for a list, it will be accessible by anybody who visits your website, provided they have a link to the list.  The lists are stored in your uploads folder, but to the users they appear to be below your main &lt;b&gt;Property Page&lt;/b&gt;.  In other words, if your default property page is \&#x27;all-properties\&#x27;, all your lists will have urls that will go something like: http://website.com/all-properties/the-list-filename.pdf&#x27;, &#x27;wpp&#x27;) . &#x27;&lt;/p&gt;&#x27;;
    $contextual_help[&#x27;General Settings&#x27;][] .= &#x27;&lt;p&gt;&#x27; . __(&#x27;By default, the PDF lists are generated every time you save this page, and when any property is updated or created.  You may select &lt;b&gt;Regenerate list every time it is opened&lt;/b&gt; to have the list generated every time it is opened in a browser, however, this may cause some unnecessary strain on your server.&#x27;, &#x27;wpp&#x27;) . &#x27;&lt;/p&gt;&#x27;;
    $contextual_help[&#x27;Advanced Query&#x27;][] .= &#x27;&lt;h3&gt;&#x27; . __(&#x27;Advanced Query&#x27;, &#x27;wpp&#x27;) . &#x27;&lt;/h3&gt;&#x27;;
    $contextual_help[&#x27;Advanced Query&#x27;][] .= &#x27;&lt;p&gt;&#x27; . __(&#x27;The advanced query can be used just like the [property_overview] shortcode. For example, if you wanted the list to only show two bedroom properties, your query would simply be: &lt;b&gt;[property_overview bedrooms=2]&lt;/b&gt;.&#x27;, &#x27;wpp&#x27;) . &#x27;&lt;/p&gt;&#x27;;
    $contextual_help[&#x27;Advanced Query&#x27;][] .= &#x27;&lt;p&gt;&#x27; . __(&#x27;You could make these as complex as you would like. If you wanted to query all apartments between $400 and $700 dollars in St. Paul, you would use: &lt;b&gt;[property_overview property_type=apartment price=400-700 city=\&#x27;St. Paul\&#x27; sort_by=route limit_query=10]&lt;/b&gt;.&#x27;, &#x27;wpp&#x27;) . &#x27;&lt;/p&gt;&#x27;;
    $contextual_help[&#x27;List Creation&#x27;][] .= &#x27;&lt;h3&gt;&#x27; . __(&#x27;List Creation&#x27;, &#x27;wpp&#x27;) . &#x27;&lt;/h3&gt;&#x27;;
    $contextual_help[&#x27;List Creation&#x27;][] .= &#x27;&lt;p&gt;&#x27; . __(&#x27;PDF Lists are deleted every time a change is made to this page, and may either be regenerated by clicking the Regenerate button below, or by trying to open the list on the front-end.&#x27;, &#x27;wpp&#x27;) . &#x27;&lt;/p&gt;&#x27;;
    $contextual_help[&#x27;List Creation&#x27;][] .= &#x27;&lt;p&gt;&#x27; . __(&#x27;When a single property is updated, the list(s) it is included on are deleted as well.  It is up to you if you want to regenerate the lists manually, or wait for a visitor to attempt to open a list, at which point it will be regenerated automatically.&#x27;, &#x27;wpp&#x27;) . &#x27;&lt;/p&gt;&#x27;;

    //** Hook this action is you want to add info */
    $contextual_help = apply_filters(&#x27;wpp_flyer_pdf_list_page_help&#x27;, $contextual_help);

    do_action(&#x27;wpp_contextual_help&#x27;, array(&#x27;contextual_help&#x27;=&gt;$contextual_help));

  }

  /**
   * Adds Metabox on Property Editing Form
   *
   * Copyright Usability Dynamics, Inc. &lt;http://usabilitydynamics.com&gt;
   */
  function add_metabox(){
    add_meta_box( &#x27;wpp_pdf_flyer&#x27;, __( &#x27;PDF Flyer Options&#x27;, &#x27;wpp&#x27; ),
    array(&#x27;class_wpp_pdf_flyer&#x27;,&#x27;metabox_options&#x27;), &#x27;property&#x27;, &#x27;side&#x27; );
  }

  /**
   * Renders Metabox&#x27;s Settings on Property Editing Form
   *
   * Copyright Usability Dynamics, Inc. &lt;http://usabilitydynamics.com&gt;
   */
  function metabox_options(){
    global $post_id;
    $disableExclude = get_post_meta($post_id, &#x27;exclude_from_pdf_lists&#x27;, true);
    $text = __(&#x27;Exclude property from PDF Lists&#x27;,&#x27;wpp&#x27;);
    echo WPP_F::checkbox(&quot;name=exclude_from_pdf_lists&amp;id=exclude_from_pdf_lists&amp;label=$text&quot;, $disableExclude);
  }

  /**
   * Updates property PDF postmeta
   * Remove PDF Lists which contain the current post (They will generated again)
   * @param int $post_id. ID
   *
   * Copyright Usability Dynamics, Inc. &lt;http://usabilitydynamics.com&gt;
   */
  function save_post($post_id){
    global $post;

    if($post-&gt;post_type == &#x27;property&#x27;) {
      if(isset($_POST[&#x27;exclude_from_pdf_lists&#x27;])) {
        update_post_meta($post_id, &#x27;exclude_from_pdf_lists&#x27;, $_POST[&#x27;exclude_from_pdf_lists&#x27;]);
      }

      // Get PDF Lists data
      $pdf_lists_info = get_option(&#x27;pdf_lists_info&#x27;);

      // Get PDF List Dir
      $uploads = wp_upload_dir();
      $pdf_list_dir = $uploads[&#x27;basedir&#x27;].&#x27;/wpp-files/&#x27;;
      if(is_array($pdf_lists_info)) {
        // Remove all PDF Lists which contain the current post (They will generate again)
        foreach ($pdf_lists_info as $slug =&gt; $data) {
          $key = array_search($post_id, $data);
          if($key !== false) {
            if(class_wpp_pdf_flyer::pdf_list_exists($slug)) {
              unlink($pdf_list_dir.$slug.&#x27;.pdf&#x27;);
            }
          }
        }
      }
    }
  }

  /**
  * Preserve PDF Flyer settings from being overwritten during settings page saving.
  *
  * Copyright Usability Dynamics, Inc. &lt;http://usabilitydynamics.com&gt;
  */
  function wpp_settings_save($new_settings, $old_settings) {
    $preserved_settings = $old_settings[&#x27;configuration&#x27;][&#x27;feature_settings&#x27;][&#x27;wpp_pdf_flyer&#x27;][&#x27;pdf_lists&#x27;];
    $new_settings[&#x27;configuration&#x27;][&#x27;feature_settings&#x27;][&#x27;wpp_pdf_flyer&#x27;][&#x27;pdf_lists&#x27;] = $preserved_settings;
    return $new_settings;
  }

  /**
  * Render PDF list in browser
  *
  *
  * @todo Update error handling so warnings (such as bad images) can be caught and saved in a log.
  *
  * Copyright Usability Dynamics, Inc. &lt;http://usabilitydynamics.com&gt;
  */
  function render_pdf_list($list_id, $args = &#x27;&#x27;) {
    //** Error Silencer */
    ob_start();

    //** Include TCPDF here to avoid double class declaration. korotkov@ud */
    @include_once(WPP_Path.&#x27;third-party/tcpdf/tcpdf.php&#x27;);
    //** Include extended TCPDF class TCPDF_List */
    @include_once(WPP_Path.&#x27;third-party/tcpdf/tcpdf_list.php&#x27;);

    global $wp_properties;

    set_time_limit(600);

    $defaults = array(
      &#x27;display&#x27; =&gt; &#x27;true&#x27;,
      &#x27;force_generate&#x27; =&gt; &#x27;false&#x27;
    );

    $args = wp_parse_args( $args, $defaults );

    $list_data = $wp_properties[&#x27;configuration&#x27;][&#x27;feature_settings&#x27;][&#x27;wpp_pdf_flyer&#x27;][&#x27;pdf_lists&#x27;][$list_id];

    $uploads = wp_upload_dir();

    //** Create PDF list
    if(!class_wpp_pdf_flyer::pdf_list_exists($list_id) || $args[&#x27;force_generate&#x27;] == &#x27;true&#x27;) {
      //** Check the uploads directory
      if(!file_exists($uploads[&#x27;basedir&#x27;].&#x27;/wpp-files&#x27;)) {
        mkdir($uploads[&#x27;basedir&#x27;].&#x27;/wpp-files&#x27;);
      }

      //** Checks if filename doesn&#x27;t exists, we set it
      if(empty($list_data[&#x27;filename&#x27;])) {
        $list_data[&#x27;filename&#x27;] = $list_id . &#x27;.pdf&#x27;;
      }

      //** Update atrributes of list data: adds values
      if( !empty( $list_data[&#x27;attributes&#x27;] ) &amp;&amp; is_array( $list_data[&#x27;attributes&#x27;] ) ) {
        $available_atts = class_wpp_pdf_flyer::get_pdf_list_attributes();
        $tmp_atts = array();
        foreach ($list_data[&#x27;attributes&#x27;] as $value) {
          $tmp_atts[$value] = $available_atts[$value];
        }
        $list_data[&#x27;attributes&#x27;] = $tmp_atts;
        unset($tmp_atts);
      } else {
        $list_data[&#x27;attributes&#x27;] = array();
      }

      //** Set Backgound Color to avoid bugs on PDF generation
      if(empty($list_data[&#x27;background&#x27;])) {
        $list_data[&#x27;background&#x27;] = &#x27;#737788&#x27;;
      }

      //** Set Query Attributes
      $atts = array();
      if(!empty($list_data[&#x27;advanced_query&#x27;])) {
        //** Check shortcode and get attributes from it
        $advanced_query_content = $list_data[&#x27;advanced_query&#x27;];
        $pattern = get_shortcode_regex();
        preg_match(&#x27;/&#x27;.$pattern.&#x27;/s&#x27;, $advanced_query_content, $matches);
        if(!empty($matches) &amp;&amp; $matches[2] == &#x27;property_overview&#x27;) {
          $atts = shortcode_parse_atts( $matches[3] );
        }
      }

      //** Get property IDs
      $properties = WPP_F::get_properties($atts);

      //** Check properties array for structure */
      if(isset($properties[&#x27;results&#x27;]) &amp;&amp; isset($properties[&#x27;total&#x27;])) {
        $property_ids = $properties[&#x27;results&#x27;];
      } else {
        $property_ids = $properties;
      }

      //** Determine if Group by is set and get values */
      if(!empty($list_data[&#x27;group_by&#x27;])) {
        $group_by_key = $list_data[&#x27;group_by&#x27;];
        $group_by_values = WPP_F::get_all_attribute_values($list_data[&#x27;group_by&#x27;]);
      }

      //** Get Property Items and clean them using PDF List settings */
      $tmp_properties = array();
      if( !empty( $property_ids ) &amp;&amp; is_array( $property_ids ) ) {
        //** Determine if Child Properties are allowed */
        $child_properties = false;
        if(is_array($list_data[&#x27;options&#x27;])) {
          $key = array_search(&#x27;show_child_properties&#x27;, $list_data[&#x27;options&#x27;]);
          if($key !== false) {
            $child_properties = true;
          }
        }

        foreach ($property_ids as $key =&gt; $id) {
          if($key !== &#x27;total&#x27;) {
            $property = prepare_property_for_display( $id , array(&#x27;scope&#x27; =&gt; &#x27;pdf&#x27;));

            //** Determine if child properties are not allowed */
            if(!$child_properties &amp;&amp; !empty($property[&#x27;is_child&#x27;])) {
              continue;
            }

            //** Determine if property is excluded from PDF Lists */
            if(!empty($property[&#x27;exclude_from_pdf_lists&#x27;])) {
              continue;
            }

            if(!empty($group_by_values)) {
              $key = sanitize_title($property[$group_by_key]);
              if(empty($list_data[&#x27;properties&#x27;][$key][&#x27;label&#x27;])) {
                $tmp_properties[$key][&#x27;label&#x27;] = $property[$group_by_key]; // !!!!!!!!!!!
              }
              $tmp_properties[$key][&#x27;items&#x27;][$id] = $property;
            } else {
              $tmp_properties[$id] = $property;
            }

          }
        }
      }

      $properties = $tmp_properties;

      //** Set Attributes for Header and Footer */
      $atts = array(
        &#x27;background&#x27; =&gt; $list_data[&#x27;background&#x27;],
        &#x27;text_color&#x27; =&gt; $list_data[&#x27;header_text_color&#x27;],
        &#x27;default_text_color&#x27; =&gt; $list_data[&#x27;text_color&#x27;],
        &#x27;title&#x27; =&gt; $list_data[&#x27;title&#x27;],
        &#x27;tagline&#x27; =&gt; $list_data[&#x27;tagline&#x27;],
        &#x27;contact_info&#x27; =&gt; $list_data[&#x27;contact_info&#x27;],
        &#x27;setfont&#x27; =&gt; !empty($list_data[&#x27;setfont&#x27;]) ? $list_data[&#x27;setfont&#x27;] : &#x27;helvetica&#x27;
        );

      ini_set(&#x27;memory_limit&#x27;, &#x27;608M&#x27;);

      //** Create new PDF List */
      $pdf = new TCPDF_List(&#x27;L&#x27;, PDF_UNIT, PDF_PAGE_FORMAT, true, &#x27;UTF-8&#x27;, false, $atts);

      //** set margins */
      $pdf-&gt;SetMargins(0, 10, 0);
      $pdf-&gt;SetHeaderMargin(5);
      $pdf-&gt;SetFooterMargin(5);

      //** set auto page breaks */
      $pdf-&gt;SetAutoPageBreak(TRUE, 8);

      $pdf-&gt;setFontSubsetting(true);
      if ($atts[&#x27;setfont&#x27;]){
        $pdf-&gt;SetFont($atts[&#x27;setfont&#x27;]);
      }

      $pdf-&gt;SetCreator(&quot;WP-Property&quot;);
      $pdf-&gt;SetAuthor(&quot;WP-Property&quot;);
      $pdf-&gt;SetTitle($list_data[&#x27;title&#x27;]);

      $hr = &#x27;&lt;table cellspacing=&quot;0&quot; cellpadding=&quot;0&quot; width=&quot;100%&quot;&gt;&lt;tr&gt;&#x27;;
      $hr .= &#x27;&lt;td width=&quot;2%&quot; style=&quot;font-size:1px;height:1px;line-height:1px;&quot;&gt;$nbsp;&lt;/td&gt;&#x27;;
      $hr .= &#x27;&lt;td width=&quot;96%&quot; style=&quot;font-size:1px;height:1px;line-height:1px;background-color:&#x27; . $list_data[&#x27;background&#x27;] . &#x27;&quot;&gt;$nbsp;&lt;/td&gt;&#x27;;
      $hr .= &#x27;&lt;td width=&quot;2%&quot; style=&quot;font-size:1px;height:1px;line-height:1px;&quot;&gt;$nbsp;&lt;/td&gt;&#x27;;
      $hr .= &#x27;&lt;/tr&gt;&lt;/table&gt;&#x27;;

      try {

        //** Generates HTML */
        if ( !empty( $properties ) &amp;&amp; is_array( $properties ) ) {
          //** Set How many properties will be shown per page */
          $per_page = (!empty($list_data[&#x27;per_page&#x27;])) ? $list_data[&#x27;per_page&#x27;] : 4;
          $count = 0;
          $html = &#x27;&#x27;;
          $pdf-&gt;AddPage();
          if (!empty($list_data[&#x27;group_by&#x27;])) {
            //** Generate Grouped List */
            foreach($properties as $group) {
              if( !empty( $group[&#x27;items&#x27;] ) &amp;&amp; is_array( $group[&#x27;items&#x27;] ) ) {
                if($count != 0 &amp;&amp; ($count%$per_page == 0)) {
                  @$pdf-&gt;writeHTML( $html, true, false, true, false, &#x27;&#x27; );
                  $html = &#x27;&#x27;;
                  $pdf-&gt;AddPage();
                  $ignore = true;
                }
                if($html == &#x27;&#x27;) {
                  $html .= &#x27;&lt;br/&gt;&lt;br/&gt;&#x27;;
                }

                //** Render Label of Group */
                $html .= &#x27;&lt;table border=&quot;0&quot; cellspacing=&quot;0&quot; cellpadding=&quot;0&quot; width=&quot;100%&quot;&gt;&lt;tr&gt;&#x27;;
                $html .= &#x27;&lt;td width=&quot;2%&quot;&gt;$nbsp;&lt;/td&gt;&#x27;;
                $html .= &#x27;&lt;td width=&quot;98%&quot; align=&quot;left&quot; valign=&quot;middle&quot;&gt;&#x27;;
                $html .= &#x27;&lt;b style=&quot;font-size:1.1em;color:&#x27;. $list_data[&#x27;background&#x27;] .&#x27;&quot;&gt;&#x27;. WPP_F::de_slug($group_by_key) .&#x27;: &#x27;. WPP_F::de_slug($group[&#x27;label&#x27;]) . &#x27;&lt;/b&gt;&#x27;;
                $html .= &#x27;&lt;table cellspacing=&quot;0&quot; cellpadding=&quot;5&quot; width=&quot;100%&quot;&gt;&lt;tr&gt;&lt;td&gt;&#x27;;
                $html .= &#x27;&lt;div style=&quot;font-size:5px;height:5px;line-height:5px;&quot;&gt;$nbsp;&lt;/div&gt;&#x27;. $hr;
                $html .= &#x27;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&#x27;;
                $html .= &#x27;&lt;/td&gt;&#x27;;
                $html .= &#x27;&lt;/tr&gt;&lt;/table&gt;&#x27;;

                $current = 0;
                foreach($group[&#x27;items&#x27;] as $property) {
                  if($count != 0 &amp;&amp; ($count%$per_page == 0) &amp;&amp; !$ignore) {
                    @$pdf-&gt;writeHTML( $html, true, false, true, false, &#x27;&#x27; );
                    $html = &#x27;&#x27;;
                    $pdf-&gt;AddPage();

                  }
                  $html .= class_wpp_pdf_flyer::pdf_list_template($property, $list_data);
                  $count++;
                  if(++$current &lt; count($group[&#x27;items&#x27;]) &amp;&amp; $count%$per_page != 0) {
                    $html .= $hr;
                  }
                  $ignore = false;
                }
              }
            }
          } else {
            //** Generate non Grouped List */
            $current = 0;
            foreach($properties as $property) {
              if($count != 0 &amp;&amp; ($count%$per_page == 0)) {
                @$pdf-&gt;writeHTML( $html, true, false, true, false, &#x27;&#x27; );
                $html = &#x27;&#x27;;
                $pdf-&gt;AddPage();
              }
              $html .= class_wpp_pdf_flyer::pdf_list_template($property, $list_data);
              $count++;
              if(++$current &lt; count($properties) &amp;&amp; $count%$per_page != 0) {
                $html .= $hr;
              }
            }
          }

        }

        @$pdf-&gt;writeHTML( $html, true, false, true, false, &#x27;&#x27; );


      } catch (ErrorException $e) {

      }


      $pdf-&gt;Output($uploads[&#x27;basedir&#x27;].&#x27;/wpp-files/&#x27;.$list_data[&#x27;filename&#x27;], &#x27;F&#x27;);

      //** Update statistic about Property IDs for PDF Lists */
      //** And Clean Up Files and Data */
      if(!empty($property_ids)) {
        //** Remove &#x27;total&#x27; from array to avoid bugs in future */
        if(!empty($property_ids[&#x27;total&#x27;])) {
          unset($property_ids[&#x27;total&#x27;]);
        }
        //** Get PDF Lists data */
        $pdf_lists_info = get_option(&#x27;pdf_lists_info&#x27;);
        //** If Option doesn&#x27;t exist or no array, init it */
        if(!is_array($pdf_lists_info)) {
          $pdf_lists_info = array();
        }
        //** Update (set) the current PDF List data (property IDs) */
        $pdf_lists_info[$list_id] = $property_ids;
        //** Get Dir Path */
        $uploads = wp_upload_dir();
        $pdf_list_dir = $uploads[&#x27;basedir&#x27;].&#x27;/wpp-files/&#x27;;
        //** Clean Up Files and Data */
        foreach($pdf_lists_info as $slug =&gt; $data) {
          //** Remove PDF List&#x27;s File if the List doesn&#x27;t exist */
          if(!isset($wp_properties[&#x27;configuration&#x27;][&#x27;feature_settings&#x27;][&#x27;wpp_pdf_flyer&#x27;][&#x27;pdf_lists&#x27;][$slug])) {
            if(class_wpp_pdf_flyer::pdf_list_exists($slug)) {
              unlink($pdf_list_dir.$slug.&#x27;.pdf&#x27;);
            }
          }
          //** Remove PDF List data if file doesn&#x27;t exist */
          if(!class_wpp_pdf_flyer::pdf_list_exists($slug)) {
            unset($pdf_lists_info[$slug]);
          }
        }
        //** Update PDF Lists Option */
        update_option(&#x27;pdf_lists_info&#x27;, $pdf_lists_info);
      }

    }
    //** Error Silencer */
    ob_end_clean();

    if($args[&#x27;display&#x27;] == &#x27;true&#x27;) {
      //** We&#x27;ll be outputting a PDF */
      header(&#x27;Content-type: application/pdf&#x27;);
      //** It will be called downloaded.pdf */
      header(&#x27;Content-Disposition: attachment; filename=&quot;&#x27;.$list_data[&#x27;filename&#x27;].&#x27;&quot;&#x27;);
      //** The PDF source is in original.pdf */
      readfile($uploads[&#x27;basedir&#x27;].&#x27;/wpp-files/&#x27;.$list_data[&#x27;filename&#x27;]);
      die();
    }
  }

  /**
  * Determine if PDF list exists
  *
  * @param string $slug Slug of the PDF List
  * Copyright Usability Dynamics, Inc. &lt;http://usabilitydynamics.com&gt;
  */
  function pdf_list_exists($slug) {
    global $wp_properties;

    $uploads = wp_upload_dir();

    if(file_exists($uploads[&#x27;basedir&#x27;].&#x27;/wpp-files/&#x27;.$slug.&#x27;.pdf&#x27;)) {
      return true;
    }

    return false;

  }


  /**
   * Add all the variables that we want to have parsed by the WP core.
   * This is the callback that we&#x27;ve registered for the &quot;query_vars&quot;
   * filter. &quot;Our&quot; variables will be used by the &quot;parse_request&quot; action
   * callback.
   *
   * @param array $qvars The array containing all query variables
   * @return The modified array
   */
  public function add_pdf_query_vars ($qvars) {
    $qvars[] = &quot;pdf_list&quot;;
    return $qvars;
  }

  /**
  * Determine if the current request is the PDF List link
  * Check request and PDF List options and Open PDF
  *
  * @param object $wp Request Object
  * Copyright Usability Dynamics, Inc. &lt;http://usabilitydynamics.com&gt;
  */
  function parse_request_for_pdf_list ($wp) {
    global $wp_query, $wp_properties, $wpdb;

    ob_start();
    //** Determine if Base Slug exists */
    if(empty($wp_properties[&#x27;configuration&#x27;][&#x27;base_slug&#x27;])){
      return $wp;
    }

    //** If request is empty we try to parse Query Vars */
    if(empty($wp-&gt;request)) {
      if(!empty($wp-&gt;query_vars[&#x27;p&#x27;]) &amp;&amp; !empty($wp-&gt;query_vars[&#x27;pdf_list&#x27;])){
        if($wp-&gt;query_vars[&#x27;p&#x27;] != $wp_properties[&#x27;configuration&#x27;][&#x27;base_slug&#x27;]) {
          return $wp;
        }
      } elseif (!empty($wp-&gt;query_vars[&#x27;page_id&#x27;]) &amp;&amp; !empty($wp-&gt;query_vars[&#x27;pdf_list&#x27;])) {
        $post = get_post($wp-&gt;query_vars[&#x27;page_id&#x27;]);
        if($post-&gt;post_name != $wp_properties[&#x27;configuration&#x27;][&#x27;base_slug&#x27;]) {
          return $wp;
        }
      } else {
        return $wp;
      }
      $filename = $wp-&gt;query_vars[&#x27;pdf_list&#x27;];
    } else {
      //** Check Request for necessary request attributes */
      preg_match(&#x27;/&#x27;.$wp_properties[&#x27;configuration&#x27;][&#x27;base_slug&#x27;].&#x27;/&#x27;, $wp-&gt;request, $bs_m);
      if(empty($bs_m)) {
        return $wp;
      }
      //** Determine if Query var &#x27;name&#x27; exists */
      if(!empty($wp-&gt;query_vars[&#x27;name&#x27;])) {
        $filename = $wp-&gt;query_vars[&#x27;name&#x27;];
      } else {
        $filename = preg_replace(&#x27;/^.*\/(.*\.pdf)$/&#x27;, &#x27;$1&#x27; ,$wp-&gt;request);
      }
      if(empty($filename)) {
        return $wp;
      }
    }

    //** Check file name */
    preg_match(&#x27;/\.pdf$/&#x27;, $filename, $pdf_m);
    if(empty($pdf_m)) {
      return $wp;
    }
    //** Get Slug */
    $slug = str_replace(&#x27;.pdf&#x27;,&#x27;&#x27;,$filename);

    if(empty($slug)) {
      return $wp;
    }

    if (!empty($wp_properties[&#x27;configuration&#x27;][&#x27;feature_settings&#x27;][&#x27;wpp_pdf_flyer&#x27;][&#x27;pdf_lists&#x27;][$slug])) {
      $list_data = $wp_properties[&#x27;configuration&#x27;][&#x27;feature_settings&#x27;][&#x27;wpp_pdf_flyer&#x27;][&#x27;pdf_lists&#x27;][$slug];
    } else {
      return $wp;
    }

    //** Set arguments for PDF rendering */
    $args = array(&#x27;display&#x27; =&gt; &#x27;true&#x27;);

    if(is_array($list_data[&#x27;options&#x27;])) {
      foreach ($list_data[&#x27;options&#x27;] as $option) {
        if($option == &#x27;restrict_public_access&#x27;) {
          //** Restricted Public Access */
          $user = wp_get_current_user();
          if($user-&gt;{$wpdb-&gt;prefix.&#x27;user_level&#x27;} == 0) {
            return $wp;
          }
        } else if ($option == &#x27;do_not_cache_list&#x27;) {
          $args[&#x27;force_generate&#x27;] = &#x27;true&#x27;;
        }
      }
    }
    ob_end_clean();
    //** Render PDF List */
    class_wpp_pdf_flyer::render_pdf_list($slug, $args);
    return false;
  }

  /**
  * Get a PDF list template, or use default
  *
  * Copyright Usability Dynamics, Inc. &lt;http://usabilitydynamics.com&gt;
  */
  function pdf_list_template($property, $list_data) {

    ob_start();
    //** Attempt to get design from template */

    $template_found = WPP_F::get_template_part(array(
      &quot;pdf-list-template&quot;
    ), array(WPP_Templates));

    if($template_found) {
      include $template_found;
    } else {
      self::default_pdf_list_template($property, $list_data);
    }

    $pdf_list_contents = ob_get_contents();
    ob_end_clean();

    return $pdf_list_contents;
  }

  /**
  * Default PDF list template
  *
  * Copyright Usability Dynamics, Inc. &lt;http://usabilitydynamics.com&gt;
  */
  function default_pdf_list_template($property, $list_data) {
    $descr = &#x27;&amp;nbsp;&#x27;;
    $title = &#x27;&amp;nbsp;&#x27;;
    $info = &#x27;&amp;nbsp;&#x27;;
    $image_width = &#x27;90&#x27;;
    $image_height = &#x27;90&#x27;;

    //** Prepare and Render view of Property Stats */
    $wpp_property_stats = class_wpp_pdf_flyer::get_pdf_list_attributes(&#x27;property_stats&#x27;);
    $exclude_property_stats = array();
    foreach ((array)$wpp_property_stats as $key =&gt; $value) {
      if(!array_key_exists($key, $list_data[&#x27;attributes&#x27;])) {
        $exclude_property_stats[] = $key;
      } else {
        unset($list_data[&#x27;attributes&#x27;][$key]);
      }
    }
    $property_stats = @draw_stats( &#x27;exclude=&#x27; . implode(&#x27;,&#x27;, $exclude_property_stats) . &#x27;&amp;display=array&#x27;, $property );

    foreach ((array)$property_stats as $label =&gt; $value) {
      $info .= &#x27;&lt;br/&gt;&#x27;. $label .&#x27;: &#x27;. $value;
    }


    //** Prepare and Render view of Taxonomies */
    $wpp_taxonomies = class_wpp_pdf_flyer::get_pdf_list_attributes(&#x27;taxonomies&#x27;);
    if(is_array($wpp_taxonomies)) {
      foreach ($wpp_taxonomies as $key =&gt; $value) {
        if(array_key_exists($key, $list_data[&#x27;attributes&#x27;])) {
          if(get_features(&quot;type=$key&amp;format=count&quot; , $property)) {
            $features = get_features(&quot;type=$key&amp;format=array&amp;links=false&quot;, $property);
            $info .= &#x27;&lt;br/&gt;&#x27;. $value .&#x27;: &#x27;. implode($features, &quot;, &quot;);
          }
          unset($list_data[&#x27;attributes&#x27;][$key]);
        }
      }
    }

    //** Prepare other property attributes (image, title, description, tagline, etc) */
    foreach ( (array)$list_data[&#x27;attributes&#x27;] as $attr_id =&gt; $attr_value) {
      if ( $attr_id == &#x27;post_thumbnail&#x27; &amp;&amp; !empty( $property[&#x27;images&#x27;][&#x27;thumbnail&#x27;] ) &amp;&amp; WPP_F::can_get_image($property[&#x27;images&#x27;][&#x27;thumbnail&#x27;])) {

        $image = &#x27;&lt;table cellspacing=&quot;0&quot; cellpadding=&quot;5&quot; border=&quot;0&quot; style=&quot;background-color:&#x27; . $list_data[&#x27;background&#x27;] . &#x27;&quot;&gt;&lt;tr&gt;&lt;td&gt;&#x27;;
        $image .= &#x27;&lt;img width=&quot;&#x27;. $image_width .&#x27;&quot; height=&quot;&#x27;. $image_height .&#x27;&quot; src=&quot;&#x27;. $property[&#x27;images&#x27;][&#x27;thumbnail&#x27;] .&#x27;&quot; alt=&quot;&quot; /&gt;&#x27;;
        $image .= &#x27;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&#x27;;

      } elseif( $attr_id == &#x27;post_content&#x27; &amp;&amp; !empty( $property[&#x27;post_content&#x27;] ) ) {
        //** Post Content */
        $descr = strip_shortcodes( $property[&#x27;post_content&#x27;] );
        $descr = apply_filters(&#x27;the_content&#x27;, $descr);
        $descr = str_replace(&#x27;]]&gt;&#x27;, &#x27;]]&amp;gt;&#x27;, $descr);
        $descr = strip_tags($descr);
        $excerpt_length = 65;
        $words = preg_split(&quot;/[\n\r\t ]+/&quot;, $descr, $excerpt_length + 1, PREG_SPLIT_NO_EMPTY);
        if ( count($words) &gt; $excerpt_length ) {
          array_pop($words);
          $descr = implode(&#x27; &#x27;, $words);
          $descr = $descr . &#x27;...&#x27;;
        } else {
          $descr = implode(&#x27; &#x27;, $words);
        }
      } elseif( $attr_id == &#x27;post_title&#x27; &amp;&amp; !empty( $property[&#x27;post_title&#x27;] ) ) {
        //** Title */
        $title = $property[&#x27;post_title&#x27;];
      } elseif( $attr_id == &#x27;tagline&#x27; &amp;&amp; !empty( $property[&#x27;tagline&#x27;] ) ) {
        //** Tagline */
        $tagline = &#x27;&lt;span&gt;&lt;b&gt;&#x27; . $property[&#x27;tagline&#x27;] . &#x27;&lt;/b&gt;&lt;/span&gt;&lt;br/&gt;&#x27;;
      }else {
        //** Attributes (Property Meta) */
        $info .= !empty($property[$attr_id]) ? &#x27;&lt;br&gt;&#x27;. $attr_value .&#x27;: &#x27;. $property[ $attr_id ] : &#x27;&#x27;;
      }
    }

    echo &#x27;&lt;table cellspacing=&quot;0&quot; cellpadding=&quot;0&quot; width=&quot;100%&quot; border=&quot;0&quot;&gt;&lt;tr&gt;&#x27;;
    if (!empty($image)) {
      echo &#x27;&lt;td colspan=&quot;7&quot; style=&quot;font-size:8px;height:8px;line-height:8px;&quot;&gt;$nbsp;&lt;/td&gt;&#x27;;
      echo &#x27;&lt;/tr&gt;&lt;tr&gt;&#x27;;
      echo &#x27;&lt;td width=&quot;2%&quot;&gt;$nbsp;&lt;/td&gt;&#x27;;
      echo &#x27;&lt;td width=&quot;12%&quot; align=&quot;left&quot; valign=&quot;middle&quot;&gt;&#x27; . $image . &#x27;&lt;/td&gt;&#x27;;
      echo &#x27;&lt;td width=&quot;2%&quot;&gt;$nbsp;&lt;/td&gt;&#x27;;
      echo &#x27;&lt;td width=&quot;25%&quot;&gt;&lt;b&gt;&#x27;. $title .&#x27;&lt;/b&gt;&#x27;.$info . &#x27;&lt;/td&gt;&#x27;;
      echo &#x27;&lt;td width=&quot;2%&quot;&gt;$nbsp;&lt;/td&gt;&#x27;;
      echo &#x27;&lt;td width=&quot;54%&quot;&gt;&#x27;. $tagline . $descr .&#x27;&lt;/td&gt;&#x27;;
      echo &#x27;&lt;td width=&quot;2%&quot;&gt;$nbsp;&lt;/td&gt;&#x27;;
      echo &#x27;&lt;/tr&gt;&lt;tr&gt;&#x27;;
      echo &#x27;&lt;td colspan=&quot;7&quot; style=&quot;font-size:8px;height:8px;line-height:8px;&quot;&gt;$nbsp;&lt;/td&gt;&#x27;;

    } else {
      echo &#x27;&lt;td colspan=&quot;5&quot; style=&quot;font-size:8px;height:8px;line-height:8px;&quot;&gt;$nbsp;&lt;/td&gt;&#x27;;
      echo &#x27;&lt;/tr&gt;&lt;tr&gt;&#x27;;
      echo &#x27;&lt;td width=&quot;2%&quot;&gt;$nbsp;&lt;/td&gt;&#x27;;
      echo &#x27;&lt;td width=&quot;39%&quot;&gt;&lt;b&gt;&#x27;. $title .&#x27;&lt;/b&gt;&#x27;.$info . &#x27;&lt;/td&gt;&#x27;;
      echo &#x27;&lt;td width=&quot;2%&quot;&gt;$nbsp;&lt;/td&gt;&#x27;;
      echo &#x27;&lt;td width=&quot;54%&quot;&gt;&#x27;. $tagline . $descr .&#x27;&lt;/td&gt;&#x27;;
      echo &#x27;&lt;td width=&quot;2%&quot;&gt;$nbsp;&lt;/td&gt;&#x27;;
      echo &#x27;&lt;/tr&gt;&lt;tr&gt;&#x27;;
      echo &#x27;&lt;td colspan=&quot;5&quot; style=&quot;font-size:8px;height:8px;line-height:8px;&quot;&gt;$nbsp;&lt;/td&gt;&#x27;;
    }
    echo &#x27;&lt;/tr&gt;&lt;/table&gt;&#x27;;
  }

  /**
  * Regenerate PDF lists.
  *
  * Copyright Usability Dynamics, Inc. &lt;http://usabilitydynamics.com&gt;
  */
  function regenerate_pdf_lists() {
    global $wp_properties;

     $lists = $wp_properties[&#x27;configuration&#x27;][&#x27;feature_settings&#x27;][&#x27;wpp_pdf_flyer&#x27;][&#x27;pdf_lists&#x27;];

     if(!is_array($lists))
      return;

     foreach($lists as $slug =&gt; $list) {
      class_wpp_pdf_flyer::render_pdf_list($slug, &quot;force_generate=true&amp;display=false&quot;);
     }

  }

  /**
  * Adds pages
  *
  * Copyright Usability Dynamics, Inc. &lt;http://usabilitydynamics.com&gt;
  */
  function admin_menu() {
    global $wp_properties;

    if($wp_properties[&#x27;configuration&#x27;][&#x27;feature_settings&#x27;][&#x27;wpp_pdf_flyer&#x27;][&#x27;use_pdf_property_lists&#x27;] == &#x27;on&#x27;)
      $wp_properties[&#x27;runtime&#x27;][&#x27;pages&#x27;][&#x27;wpp_flyer_pdf_list&#x27;] = add_submenu_page( &#x27;edit.php?post_type=property&#x27;, __(&#x27;PDF Lists&#x27;,&#x27;wpp&#x27;), __(&#x27;PDF Lists&#x27;,&#x27;wpp&#x27;), self::$capability, &#x27;wpp_property_pdf_lists&#x27;, array(&#x27;class_wpp_pdf_flyer&#x27;,&#x27;page_property_lists&#x27;));

    if ( !empty( $wp_properties[&#x27;runtime&#x27;][&#x27;pages&#x27;][&#x27;wpp_flyer_pdf_list&#x27;] ) ) {
      add_action(&quot;load-{$wp_properties[&#x27;runtime&#x27;][&#x27;pages&#x27;][&#x27;wpp_flyer_pdf_list&#x27;]}&quot;, array(&#x27;class_wpp_pdf_flyer&#x27;, &#x27;wpp_flyer_pdf_list_page_load&#x27;));
    }
  }

  /**
  * Get available attributes for PDF Flyer
  * @return array $available_stats
  *
  * Copyright Usability Dynamics, Inc. &lt;http://usabilitydynamics.com&gt;
  */
  static function get_pdf_list_attributes($type = false) {
    global $wp_properties;

    $available_stats = array();

    if (!$type) {
      $available_stats[&#x27;post_title&#x27;] = sprintf(__(&#x27;%1$s Title&#x27;, &#x27;wpp&#x27;), ucfirst(WPP_F::property_label(&#x27;singular&#x27;)));
      //**
      // Not sure that Excerpt is needed here.
      // And what is the highest priority: content or excerpt (if both will be checked)? Maxim Peshkov.
      //$available_stats[&#x27;post_excerpt&#x27;] = __(&#x27;Excerpt&#x27;, &#x27;wpp&#x27;);
      //*/
      $available_stats[&#x27;post_content&#x27;] = __(&#x27;Full Description&#x27;, &#x27;wpp&#x27;);
      $available_stats[&#x27;post_thumbnail&#x27;] = __(&#x27;Thumbnail&#x27;, &#x27;wpp&#x27;);
    }

    if ((!$type || $type == &#x27;property_stats&#x27;) &amp;&amp; is_array($wp_properties[&#x27;property_stats&#x27;])) {
      foreach( (array)$wp_properties[&#x27;property_stats&#x27;] as $slug =&gt; $label )
        $available_stats[$slug] = $label;
    }

    if((!$type || $type == &#x27;taxonomies&#x27;) &amp;&amp; is_array($wp_properties[&#x27;taxonomies&#x27;])) {
      foreach($wp_properties[&#x27;taxonomies&#x27;] as $slug =&gt; $tax_data)
        $available_stats[$slug] = $tax_data[&#x27;label&#x27;];
    }

    if((!$type || $type == &#x27;property_meta&#x27;) &amp;&amp; is_array($wp_properties[&#x27;property_meta&#x27;])) {
      foreach($wp_properties[&#x27;property_meta&#x27;] as $slug =&gt; $label)
        $available_stats[$slug] = $label;
    }

    $available_stats = apply_filters(&#x27;wpp_flyer_list_available_stats&#x27;, $available_stats);

    return $available_stats;
  }

  /**
  * Renders page to create and configure PDF lists
  *
  * Copyright Usability Dynamics, Inc. &lt;http://usabilitydynamics.com&gt;
  */
  function page_property_lists() {
    global $wp_properties;

    @include_once( WPP_Path.&#x27;third-party/tcpdf/wpp_tcpdf.php&#x27; );

    //** Save settings */
    if(wp_verify_nonce($_REQUEST[&#x27;_wpnonce&#x27;], &#x27;wpp_flyer_lists_page&#x27;)) {

      $wp_messages[&#x27;notice&#x27;][] = __(&#x27;List settings updated and old lists have been deleted. &#x27;, &#x27;wpp&#x27;);

      $pdf_lists = is_array($_REQUEST[&#x27;wpp_flyer_list_settings&#x27;]) ? $_REQUEST[&#x27;wpp_flyer_list_settings&#x27;] : array();

      $uploads = wp_upload_dir();

      $pdf_list_dir = $uploads[&#x27;basedir&#x27;].&#x27;/wpp-files/&#x27;;


      //** Check PDF Lists and set filenames */
      $tmp_pdf_lists = array();
      foreach((array)$pdf_lists as $slug =&gt; $list) {
        if(!empty($list[&#x27;title&#x27;])) {
          $list[&#x27;filename&#x27;] = $slug . &#x27;.pdf&#x27;;
          $tmp_pdf_lists[$slug] = $list;
        }

        //** Delete exisitng lists */
         if(class_wpp_pdf_flyer::pdf_list_exists($slug)) {
            unlink($pdf_list_dir.$slug.&#x27;.pdf&#x27;);
          }
      }

      $pdf_lists = $tmp_pdf_lists;
      unset($tmp_pdf_lists);



      $wp_properties[&#x27;configuration&#x27;][&#x27;feature_settings&#x27;][&#x27;wpp_pdf_flyer&#x27;][&#x27;pdf_lists&#x27;] = $pdf_lists;

      update_option(&#x27;wpp_settings&#x27;, $wp_properties);
    }

    if(!$pdf_lists) {
      $pdf_lists = $wp_properties[&#x27;configuration&#x27;][&#x27;feature_settings&#x27;][&#x27;wpp_pdf_flyer&#x27;][&#x27;pdf_lists&#x27;];
    }

    //** Set default (sample_pdf_list) List, if there is no any list */
    if(empty($pdf_lists)) {
      $pdf_lists[&#x27;sample_pdf_list&#x27;][&#x27;title&#x27;] = __(&#x27;Sample PDF List&#x27;, &#x27;wpp&#x27;);
    }

    $available_stats = class_wpp_pdf_flyer::get_pdf_list_attributes();

    ?&gt;
    &lt;style type=&quot;text/css&quot;&gt;
      ul.wpp_flyer_list_settings label {
        display: block;
        float: left;
        margin-top: 3px;
        width: 70px;
      }
      ul.wpp_flyer_list_settings label span {
        visibility: hidden;
      }
    &lt;/style&gt;
    &lt;script type=&#x27;text/javascript&#x27;&gt;
      jQuery(document).ready(function() {
        var wpp_pdf_root_url = jQuery(&quot;.wpp_pdf_root_url&quot;).val();

        jQuery(&#x27;.slug_setter&#x27;).live(&#x27;change&#x27;, function() {
          var value = jQuery(this).val();
          var parent = jQuery(this).parents(&#x27;tr.wpp_dynamic_table_row&#x27;);
          var slug = wpp_create_slug(value);

          jQuery(&#x27;.wpp_pdf_list_name&#x27;, parent).val(slug + &#x27;.pdf&#x27;);

          jQuery(&quot;.wpp_link&quot;, parent).attr(&quot;href&quot;, wpp_pdf_root_url + slug + &#x27;.pdf&#x27;);

        });

        jQuery(&quot;.wpp_flyer_show_advanced_query&quot;).live(&#x27;click&#x27;, function() {
          var parent = jQuery(this).parents(&#x27;li&#x27;);
          jQuery(&quot;.wpp_flyer_advanced_query_container&quot;, parent).toggle();
        });

        //**
        // When the .slug_setter input field is modified, we update names of other elements in row
        // This event also added in wp-property-backend-global.js file but only for new rows [new_row=true],
        // So be careful to avoid duplicate events functionality
        //*/
        if(window.updateRowNames) {
          jQuery(&quot;.wpp_dynamic_table_row[new_row=false] input.slug_setter&quot;).live(&quot;change&quot;, function() {
            updateRowNames(this);
          });
        }

        jQuery(&#x27;#wpp_ajax_regenerate_all_flyers&#x27;).click(function(){
          var ajaxSpinner = jQuery(&#x27;#regenerate_all_flyers_ajax_spinner&#x27;);
          var closeButton = jQuery(&quot;#wpp_ajax_regenerate_all_flyers_close&quot;);
          var resultBox = jQuery(&#x27;#wpp_ajax_regenerate_all_flyers_result&#x27;);
          var lists = [];

          jQuery(&#x27;.wpp_dynamic_table_row[new_row=&quot;false&quot;]&#x27;).each(function(i,e){
            var slug = jQuery(e).attr(&#x27;slug&#x27;);
            var name = jQuery(&#x27;.slug_setter&#x27;, jQuery(e)).val();
            lists.push( { &#x27;slug&#x27;: slug, &#x27;name&#x27; : name } );
          });

          var wpp_recursively_generate_pdf_list = function( data, callback ) {
            var item = data.shift();
            jQuery.ajax({
              url: &#x27;&lt;?php echo admin_url(&#x27;admin-ajax.php&#x27;); ?&gt;&#x27;,
              data: &#x27;action=wpp_generate_pdf_list&amp;slug=&#x27; + item.slug,
              complete: function( r, status ) {

                if( status == &#x27;success&#x27; ) {
                  var result = eval(&#x27;(&#x27; + r.responseText + &#x27;)&#x27;);
                  if(result.success == 1) {
                    putLog(&#x27;PDF List &quot;&#x27; + item.name + &#x27;&quot; is generated.&#x27;, resultBox);
                  } else {
                    putLog(&#x27;&lt;b&gt;Error. PDF List &quot;&#x27; + item.name + &#x27;&quot; could not be generated.&lt;/b&gt;&#x27;, resultBox);
                  }
                } else {
                  putLog(&#x27;Could not regenerate PDF List &quot;&#x27; + item.name + &#x27;&quot;. Looks like, something caused error on server.&#x27;, resultBox);
                }

                if ( data.length == 0 ) {
                  if( typeof callback === &#x27;function&#x27; ) {
                    callback();
                  }
                } else {
                  wpp_recursively_generate_pdf_list( data, callback );
                }

              }
            });
          }

          ajaxSpinner.show( &#x27;fast&#x27;, function() {
            resultBox.show( &#x27;fast&#x27;, function() {
              putLog(&quot;&lt;?php _e(&quot;Regenerating PDF Lists. If you have a lot of properties this process may take a while, please do not close this browser window until it is complete.&quot;); ?&gt;&quot;, resultBox);

              // Loop all properties
              wpp_recursively_generate_pdf_list( lists, function() {
                putLog(&#x27;&lt;?php _e(&quot;Finished.&quot;); ?&gt;&#x27;, resultBox);
                ajaxSpinner.hide();
                closeButton.show();
              } );
            } );
          } );

          return false;
        });

        function putLog (log, el) {
          if (typeof log != &#x27;undefined&#x27; &amp;&amp; typeof el == &#x27;object&#x27;){
            if (jQuery(&#x27;.logs&#x27;, el).length == 0) {
              el.append(&#x27;&lt;ul class=&quot;logs&quot;&gt;&lt;/ul&gt;&#x27;);
            }
            jQuery(&#x27;.logs&#x27;, el).append(&#x27;&lt;li&gt;&#x27; + log + &#x27;&lt;/li&gt;&#x27;);
          }
        }

      });
    &lt;/script&gt;
    &lt;div class=&#x27;wrap&#x27;&gt;
      &lt;h2&gt;&lt;?php _e(&#x27;PDF Lists&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/h2&gt;

      &lt;?php if(isset($wp_messages[&#x27;error&#x27;]) &amp;&amp; $wp_messages[&#x27;error&#x27;]): ?&gt;
      &lt;div class=&quot;error&quot;&gt;
      &lt;?php foreach($wp_messages[&#x27;error&#x27;] as $error_message): ?&gt;
        &lt;p&gt;&lt;?php echo $error_message; ?&gt;
      &lt;?php endforeach; ?&gt;
      &lt;/div&gt;
      &lt;?php endif; ?&gt;

      &lt;?php if(isset($wp_messages[&#x27;notice&#x27;]) &amp;&amp; $wp_messages[&#x27;notice&#x27;]): ?&gt;
      &lt;div class=&quot;updated fade&quot;&gt;
      &lt;?php foreach($wp_messages[&#x27;notice&#x27;] as $notice_message): ?&gt;
        &lt;p&gt;&lt;?php echo $notice_message; ?&gt;
      &lt;?php endforeach; ?&gt;
      &lt;/div&gt;
      &lt;?php endif; ?&gt;

      &lt;form action=&quot;&lt;?php echo admin_url(&#x27;edit.php?post_type=property&amp;page=wpp_property_pdf_lists&#x27;); ?&gt;&quot; method=&quot;post&quot;&gt;
      &lt;input type=&quot;hidden&quot; class=&quot;wpp_pdf_root_url&quot; value=&quot;&lt;?php echo get_pdf_list_permalink(); ?&gt;&quot; /&gt;
      &lt;input type=&quot;hidden&quot; name=&quot;_wpnonce&quot; value=&quot;&lt;?php echo wp_create_nonce(&#x27;wpp_flyer_lists_page&#x27;); ?&gt;&quot; /&gt;
      &lt;table class=&quot;ud_ui_dynamic_table widefat form-table&quot; allow_random_slug=&quot;true&quot;&gt;
          &lt;thead&gt;
            &lt;tr&gt;
              &lt;th&gt;&lt;?php _e(&#x27;Settings&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/th&gt;
              &lt;th style=&quot;width:200px;&quot;&gt;&lt;?php _e(&#x27;Options&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/th&gt;
              &lt;th style=&quot;width:200px;&quot;&gt;&lt;?php _e(&#x27;Attributes&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/th&gt;
               &lt;th class=&#x27;wpp_delete_col&#x27;&gt;&amp;nbsp;&lt;/th&gt;
            &lt;/tr&gt;
          &lt;/thead&gt;
          &lt;tbody&gt;

          &lt;?php foreach( (array)$pdf_lists as $slug =&gt; $list):  ?&gt;

              &lt;tr class=&quot;wpp_dynamic_table_row&quot; slug=&quot;&lt;?php echo $slug; ?&gt;&quot; new_row=&quot;false&quot;&gt;
                &lt;td&gt;
                  &lt;ul class=&#x27;wpp_flyer_list_settings&#x27;&gt;

                  &lt;li&gt;
                    &lt;label for=&quot;&quot;&gt;&lt;?php _e(&#x27;List Name:&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/label&gt;
                    &lt;input type=&quot;text&quot; class=&quot;slug_setter&quot; name=&quot;wpp_flyer_list_settings[&lt;?php echo $slug; ?&gt;][title]&quot; value=&quot;&lt;?php echo $list[&#x27;title&#x27;]; ?&gt;&quot; /&gt;
                  &lt;/li&gt;

                  &lt;li&gt;
                    &lt;label for=&quot;&quot;&gt;&lt;?php _e(&#x27;File Name:&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/label&gt;
                    &lt;input type=&quot;text&quot; readonly=&quot;readonly&quot; class=&quot;wpp_pdf_list_name&quot; name=&quot;wpp_flyer_list_settings[&lt;?php echo $slug; ?&gt;][filename]&quot; value=&quot;&lt;?php echo $list[&#x27;filename&#x27;]; ?&gt;&quot; /&gt;
                  &lt;/li&gt;

                  &lt;li&gt;
                    &lt;label&gt;&lt;span&gt;&lt;?php _e(&#x27;Actions:&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/span&gt;&lt;/label&gt;
                    &lt;a href=&#x27;&lt;?php echo get_pdf_list_permalink($slug); ?&gt;&#x27; class=&quot;wpp_link&quot; target=&quot;_blank&quot;&gt;&lt;?php _e(&#x27;View PDF&#x27;); ?&gt;&lt;/a&gt;
                    &lt;?php do_action(&#x27;wpp_flyer_list_ui_actions&#x27;); ?&gt;
                  &lt;/li&gt;


                 &lt;/ul&gt;
                &lt;/td&gt;

                &lt;td&gt;
                  &lt;ul&gt;
                    &lt;li&gt;
                      &lt;label&gt;&lt;?php _e(&#x27;Group by:&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/label&gt;
                      &lt;?php echo WPP_F::draw_attribute_dropdown(&quot;name=wpp_flyer_list_settings[{$slug}][group_by]&amp;selected={$list[&#x27;group_by&#x27;]}&quot;, array(&#x27;property_type&#x27; =&gt; __(&#x27;Property Type&#x27;))); ?&gt;
                    &lt;/li&gt;

                    &lt;li&gt;
                      &lt;label&gt;&lt;?php _e(&#x27;Properties per page:&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/label&gt;
                      &lt;select name=&quot;wpp_flyer_list_settings[&lt;?php echo $slug; ?&gt;][per_page]&quot; style=&quot;width:40px;&quot;&gt;
                        &lt;?php for ($i=4; $i&gt;=1; $i--) : ?&gt;
                        &lt;option value=&quot;&lt;?php echo $i; ?&gt;&quot; &lt;?php echo ($list[&#x27;per_page&#x27;] == $i) ? &#x27;selected=&quot;selected&quot;&#x27; : &#x27;&#x27;; ?&gt;&gt;&lt;?php echo $i; ?&gt;&lt;/option&gt;
                        &lt;?php endfor; ?&gt;
                      &lt;/select&gt;
                    &lt;/li&gt;

                    &lt;li&gt;
                      &lt;input type=&quot;checkbox&quot; name=&quot;wpp_flyer_list_settings[&lt;?php echo $slug; ?&gt;][options][]&quot; value=&quot;show_child_properties&quot; &lt;?php echo WPP_F::checked_in_array(&#x27;show_child_properties&#x27;, $list[&#x27;options&#x27;]); ?&gt; /&gt;
                      &lt;label&gt;&lt;?php _e(&#x27;Show child properties.&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/label&gt;
                    &lt;/li&gt;

                    &lt;li&gt;
                      &lt;input type=&quot;checkbox&quot; name=&quot;wpp_flyer_list_settings[&lt;?php echo $slug; ?&gt;][options][]&quot; value=&quot;restrict_public_access&quot; &lt;?php echo WPP_F::checked_in_array(&#x27;restrict_public_access&#x27;, $list[&#x27;options&#x27;]); ?&gt; /&gt;
                      &lt;label&gt;&lt;?php _e(&#x27;Don\&#x27;t make accessible for public.&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/label&gt;
                    &lt;/li&gt;

                    &lt;li&gt;
                      &lt;input type=&quot;checkbox&quot; name=&quot;wpp_flyer_list_settings[&lt;?php echo $slug; ?&gt;][options][]&quot; value=&quot;do_not_cache_list&quot; &lt;?php echo WPP_F::checked_in_array(&#x27;do_not_cache_list&#x27;, $list[&#x27;options&#x27;]); ?&gt; /&gt;
                      &lt;label&gt;&lt;?php _e(&#x27;Regenerate list every time it is opened.&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/label&gt;
                    &lt;/li&gt;

                    &lt;?php do_action(&#x27;wpp_flyer_list_ui_options&#x27;); ?&gt;

                    &lt;li&gt;
                      &lt;div class=&quot;wpp_link wpp_flyer_show_advanced_query&quot; style=&#x27;margin-bottom: 4px;&#x27;&gt;&lt;?php _e(&#x27;Tagline&#x27;,&#x27;wpp&#x27;); ?&gt;&lt;/div&gt;
                      &lt;div class=&quot;wpp_flyer_advanced_query_container &lt;?php echo (empty($list[&#x27;tagline&#x27;]) ? &#x27; hidden &#x27; : &#x27;&#x27;); ?&gt;&quot;&gt;
                        &lt;textarea class=&#x27;large-text code&#x27; name=&quot;wpp_flyer_list_settings[&lt;?php echo $slug; ?&gt;][tagline]&quot;&gt;&lt;?php echo $list[&#x27;tagline&#x27;]; ?&gt;&lt;/textarea&gt;
                      &lt;/div&gt;
                    &lt;/li&gt;

                    &lt;li&gt;
                      &lt;div class=&quot;wpp_link wpp_flyer_show_advanced_query&quot; style=&#x27;margin-bottom: 4px;&#x27;&gt;&lt;?php _e(&#x27;Contact Information&#x27;,&#x27;wpp&#x27;); ?&gt;&lt;/div&gt;
                      &lt;div class=&quot;wpp_flyer_advanced_query_container &lt;?php echo (empty($list[&#x27;contact_info&#x27;]) ? &#x27; hidden &#x27; : &#x27;&#x27;); ?&gt;&quot;&gt;
                        &lt;textarea class=&#x27;large-text code&#x27; name=&quot;wpp_flyer_list_settings[&lt;?php echo $slug; ?&gt;][contact_info]&quot;&gt;&lt;?php echo $list[&#x27;contact_info&#x27;]; ?&gt;&lt;/textarea&gt;
                        &lt;div class=&quot;description&quot;&gt;&lt;?php _e(&quot;Contact Information will be shown on every page&quot;, &#x27;wpp&#x27;); ?&gt;&lt;/div&gt;
                      &lt;/div&gt;
                    &lt;/li&gt;

                    &lt;li&gt;
                      &lt;div class=&quot;wpp_link wpp_flyer_show_advanced_query&quot; style=&#x27;margin-bottom: 4px;&#x27;&gt;&lt;?php _e(&#x27;Advanced Query&#x27;,&#x27;wpp&#x27;); ?&gt;&lt;/div&gt;
                      &lt;div class=&quot;wpp_flyer_advanced_query_container &lt;?php echo (empty($list[&#x27;advanced_query&#x27;]) ? &#x27; hidden &#x27; : &#x27;&#x27;); ?&gt;&quot;&gt;
                        &lt;textarea class=&#x27;large-text code&#x27; name=&quot;wpp_flyer_list_settings[&lt;?php echo $slug; ?&gt;][advanced_query]&quot;&gt;&lt;?php echo $list[&#x27;advanced_query&#x27;]; ?&gt;&lt;/textarea&gt;
                        &lt;div class=&quot;description&quot;&gt;&lt;?php _e(&#x27;You may use WPP Query arguments here to perform a more advanced queryies, and limits. Wrap your query into [property_overview] as with a regular shortcode.&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/div&gt;
                      &lt;/div&gt;
                    &lt;/li&gt;


                    &lt;li&gt;
                      &lt;label style=&quot;width:50px;display:block;float:left;line-height:22px;&quot;&gt;&lt;?php _e(&#x27;Font:&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/label&gt;
                      &lt;?php wpp_tcpdf_get_HTML_font_list(&quot;name=wpp_flyer_list_settings[{$slug}][setfont]&amp;selected={$list[&#x27;setfont&#x27;]}&quot;); ?&gt;
                      &lt;br/&gt;&lt;span class=&quot;description&quot;&gt;&lt;?php _e(&#x27;The default font is Helvetica. If you have any problems with current font try choosing another one from the list.&#x27;,&#x27;wpp&#x27;); ?&gt;&lt;/span&gt;
                      &lt;div class=&quot;clear&quot;&gt;&lt;/div&gt;
                    &lt;/li&gt;
                    &lt;li&gt;
                      &lt;label style=&quot;width:220px;display:block;float:left;line-height:22px;&quot;&gt;&lt;?php _e(&#x27;Header &amp; Footer background color:&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/label&gt;
                      &lt;input type=&quot;text&quot; class=&quot;wpp_input_colorpicker&quot; name=&quot;wpp_flyer_list_settings[&lt;?php echo $slug; ?&gt;][background]&quot; value=&quot;&lt;?php echo $list[&#x27;background&#x27;]; ?&gt;&quot; /&gt;
                      &lt;div class=&quot;clear&quot;&gt;&lt;/div&gt;
                    &lt;/li&gt;
                    &lt;li&gt;
                      &lt;label style=&quot;width:220px;display:block;float:left;line-height:22px;&quot;&gt;&lt;?php _e(&#x27;Header &amp; Footer text color:&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/label&gt;
                      &lt;input type=&quot;text&quot; class=&quot;wpp_input_colorpicker&quot; name=&quot;wpp_flyer_list_settings[&lt;?php echo $slug; ?&gt;][header_text_color]&quot; value=&quot;&lt;?php echo $list[&#x27;header_text_color&#x27;]; ?&gt;&quot; /&gt;
                      &lt;div class=&quot;clear&quot;&gt;&lt;/div&gt;
                    &lt;/li&gt;
                    &lt;li&gt;
                      &lt;label style=&quot;width:220px;display:block;float:left;line-height:22px;&quot;&gt;&lt;?php _e(&#x27;Text color:&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/label&gt;
                      &lt;input type=&quot;text&quot; class=&quot;wpp_input_colorpicker&quot; name=&quot;wpp_flyer_list_settings[&lt;?php echo $slug; ?&gt;][text_color]&quot; value=&quot;&lt;?php echo $list[&#x27;text_color&#x27;]; ?&gt;&quot; /&gt;
                      &lt;div class=&quot;clear&quot;&gt;&lt;/div&gt;
                    &lt;/li&gt;

                  &lt;/ul&gt;
                &lt;/td&gt;

                &lt;td&gt;
                  &lt;div class=&quot;wp-tab-panel&quot;&gt;
                  &lt;ul&gt;
                    &lt;?php foreach( (array) $available_stats as $s_slug =&gt; $s_label): ?&gt;
                    &lt;li&gt;
                      &lt;input &lt;?php echo WPP_F::checked_in_array($s_slug, $list[&#x27;attributes&#x27;]); ?&gt; type=&quot;checkbox&quot; name=&quot;wpp_flyer_list_settings[&lt;?php echo $slug; ?&gt;][attributes][]&quot; value=&quot;&lt;?php echo $s_slug; ?&gt;&quot; /&gt;
                      &lt;label&gt;&lt;?php echo $s_label;?&gt;&lt;/label&gt;
                    &lt;/li&gt;
                    &lt;?php endforeach; ?&gt;
                  &lt;/ul&gt;

                &lt;/td&gt;


                &lt;td&gt;
                  &lt;ul&gt;

                    &lt;li&gt;&lt;span verify_action=&quot;true&quot; class=&quot;wpp_delete_row delete wpp_link&quot;&gt;&lt;?php _e(&#x27;Delete&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/span&gt;&lt;/li&gt;
                  &lt;/ul&gt;

                  &lt;/td&gt;
              &lt;/tr&gt;
           &lt;?php endforeach; ?&gt;

            &lt;/tbody&gt;
          &lt;tfoot&gt;
            &lt;tr&gt;
              &lt;td colspan=&quot;4&quot;&gt;
              &lt;input type=&quot;button&quot; class=&quot;wpp_add_row button-secondary&quot; value=&quot;&lt;?php _e(&#x27;Add List&#x27;); ?&gt;&quot;&gt;
              &lt;input  type=&quot;submit&quot; name=&quot;Submit&quot; class=&quot;button-primary btn&quot; style=&quot;margin-left: 20px;&quot; value=&quot;&lt;?php _e(&#x27;Save Lists&#x27;); ?&gt;&quot; /&gt;
              &lt;/td&gt;
            &lt;/tr&gt;
          &lt;/tfoot&gt;
        &lt;/table&gt;


        &lt;div class=&quot;wpp_settings_block&quot; style=&quot;margin: 10px 0;&quot;&gt;
          &lt;span&gt;&lt;?php _e(&quot;Regenerate all PDF Lists.  This will create, or recreate, all your lists.&quot;); ?&gt;&lt;/span&gt;
          &lt;input type=&quot;button&quot; id=&quot;wpp_ajax_regenerate_all_flyers&quot; value=&quot;Regenerate&quot;&gt;&amp;nbsp;&lt;img style=&quot;display:none;&quot; id=&quot;regenerate_all_flyers_ajax_spinner&quot; src=&quot;&lt;?php echo WPP_URL; ?&gt;images/ajax_loader.gif&quot; /&gt;
          &lt;br/&gt;&lt;input style=&quot;display:none;&quot; type=&quot;button&quot; id=&quot;wpp_ajax_regenerate_all_flyers_close&quot; value=&quot;&lt;?php _e(&#x27;Refresh Page&#x27;); ?&gt;&quot; onClick=&quot;window.location.reload();&quot;&gt;
          &lt;pre class=&quot;wpp_class_pre hidden&quot; id=&quot;wpp_ajax_regenerate_all_flyers_result&quot; style=&quot;height:300px;&quot;&gt;&lt;/pre&gt;
        &lt;/div&gt;

        &lt;div class=&#x27;widefat&#x27; style=&quot;margin:10px 0;padding:10px;width:auto;&quot;&gt;
          &lt;p&gt;&lt;span class=&quot;description&quot;&gt;&lt;?php _e(&#x27;Shortcode examples:&#x27;); ?&gt;&lt;/span&gt;&lt;/p&gt;
          &lt;ul&gt;
            &lt;li&gt;&lt;span class=&quot;description&quot;&gt;&lt;b&gt;[wpp_pdf_list name=&#x27;list_name&#x27;]&lt;/b&gt; - &lt;?php _e(&#x27;Returns a formatted HTML link to the PDF List.&#x27;); ?&gt;&lt;/span&gt;&lt;/li&gt;
            &lt;li&gt;&lt;span class=&quot;description&quot;&gt;&lt;b&gt;[wpp_pdf_list name=&#x27;list_name&#x27; title=&#x27;PDF Flyer&#x27;]&lt;/b&gt; - &lt;?php _e(&#x27;Returns a html link to the PDF List with custom title.&#x27;); ?&gt;&lt;/span&gt;&lt;/li&gt;
            &lt;li&gt;&lt;span class=&quot;description&quot;&gt;&lt;b&gt;[wpp_pdf_list name=&#x27;list_name&#x27; urlonly=&#x27;yes&#x27;]&lt;/b&gt; -  &lt;?php _e(&#x27;Returns the raw URL to the PDF List (for use in custom html).&#x27;); ?&gt;&lt;/span&gt;&lt;/li&gt;
            &lt;li&gt;&lt;span class=&quot;description&quot;&gt;&lt;b&gt;[wpp_pdf_list name=&#x27;list_name&#x27; class=&#x27;custom_css_class&#x27;]&lt;/b&gt; - &lt;?php _e(&#x27;For use with a custom CSS class.&#x27;); ?&gt;&lt;/span&gt;&lt;/li&gt;
            &lt;li&gt;&lt;span class=&quot;description&quot;&gt;&lt;b&gt;[wpp_pdf_list name=&#x27;list_name&#x27; image=&#x27;url_to_custom_image&#x27;]&lt;/b&gt; - &lt;?php _e(&#x27;Returns url_to_custom_image with a link to the PDF List.&#x27;); ?&gt;&lt;/span&gt;&lt;/li&gt;
          &lt;/ul&gt;
        &lt;/div&gt;



        &lt;/form&gt;

    &lt;/div&gt;
    &lt;?php


  }


/**
  * Handles front-end functions.
  *
  * Creates a flyer on-the-fly if wpp_flyer_create is passed, then redirects to it automatically.
  * If wpp_flyer_create is passed, but flyer already exists, simply opens the flyer -&gt; does not re-generate
  *
  *
  * Copyright Usability Dynamics, Inc. &lt;http://usabilitydynamics.com&gt;
  */
  function template_redirect() {
    global $post, $wpdb;


    if($_REQUEST[&#x27;wpp_flyer_create&#x27;] == &#x27;true&#x27; &amp;&amp; $post-&gt;ID)  {

      //** Make sure flyer doesn&#x27;t already exist * /
      if(self::flyer_exists($post-&gt;ID)) {
        wp_redirect(get_pdf_flyer_permalink($post-&gt;ID)); exit;
      }

      if(self::create_flyer_pdf($post-&gt;ID) !== false)  {
        wp_redirect(get_pdf_flyer_permalink($post-&gt;ID)); exit;
      } else {
        return;
      }
    }
  }


  /**
  * Adds a PDF Flyer link to property objects in the back-end property view table
  *
  * Returns link if it flyer exists, or if on-the-fly creation is enabled.
  *
  * Copyright Usability Dynamics, Inc. &lt;http://usabilitydynamics.com&gt;
  */
  function page_row_actions($actions, $post)
  {

    if($post-&gt;post_type != &#x27;property&#x27;)
      return $actions;

    $pdf_link = get_pdf_flyer_permalink($post-&gt;ID);

    if($pdf_link)
      $actions[&#x27;pdf_flyer&#x27;] = &quot;&lt;a href=&#x27;$pdf_link&#x27;&gt;&quot;. __(&#x27;PDF Flyer&#x27;, &#x27;wpp&#x27;) . &quot;&lt;/a&gt;&quot;;

    return $actions;

  }

    /**
    * Default left middle added via hook into flyer template
    *
    *
    * Copyright Usability Dynamics, Inc. &lt;http://usabilitydynamics.com&gt;
    */
    function flyer_left_column( $property, $wpp_pdf_flyer ){
      global $wp_properties;

      $map_width = round($wpp_pdf_flyer[&#x27;first_col_width&#x27;] / 2 - 27 );

      $static_google_map = &quot;http://maps.google.com/maps/api/staticmap?center={$property[latitude]},{$property[longitude]}&amp;zoom=&quot;.
      apply_filters(&#x27;wpp_flyer_map_scale&#x27;, 14, $property, $wpp_pdf_flyer)
      .&quot;&amp;size={$map_width}x250&amp;scale=2&amp;sensor=true&amp;markers=color:blue%7C{$property[latitude]},{$property[longitude]}&quot;;

      if(!WPP_F::can_get_image($static_google_map)) {
        $static_google_map = false;
      }

      //** disabled Groupped attributes */
      //$sort_by_groups = !empty( $wp_properties[ &#x27;property_groups&#x27; ] ) &amp;&amp; $wp_properties[ &#x27;configuration&#x27; ][ &#x27;property_overview&#x27; ][ &#x27;sort_stats_by_groups&#x27; ] == &#x27;true&#x27; ? &#x27;true&#x27; : &#x27;false&#x27;;

      $property[&#x27;post_content&#x27;] = apply_filters(&#x27;wpp_flyer_description&#x27;, $property[&#x27;post_content&#x27;], $wpp_pdf_flyer);


      if (!empty($wpp_pdf_flyer[&#x27;pr_details&#x27;]) &amp;&amp; !empty($wpp_pdf_flyer[&#x27;detail_attributes&#x27;])): ?&gt;

        &lt;tr&gt;
            &lt;td&gt;
              &lt;div class=&quot;heading_text&quot;&gt;&lt;?php echo __(&#x27;Details&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/div&gt;
            &lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
            &lt;td class=&quot;pdf-text&quot;&gt;&lt;br/&gt;
                &lt;?php echo @draw_stats( &#x27;exclude=&#x27;.$wpp_pdf_flyer[&#x27;excluded_details_stats&#x27;].&#x27;&amp;display=plain_list&amp;sort_by_groups=false&#x27;, $property ); ?&gt;
            &lt;/td&gt;
        &lt;/tr&gt;
        &lt;?php endif; ?&gt;

        &lt;?php if (!empty($wpp_pdf_flyer[&#x27;pr_description&#x27;]) &amp;&amp; $property[&#x27;post_content&#x27;] != &#x27;&#x27;) : ?&gt;
        &lt;tr&gt;
            &lt;td&gt;&lt;div class=&quot;heading_text&quot;&gt;&lt;?php echo __(&#x27;Description&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/div&gt;
            &lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
            &lt;td class=&quot;pdf-text&quot;&gt;&lt;br/&gt;
                &lt;?php echo $property[&#x27;post_content&#x27;]; ?&gt;
            &lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
            &lt;td height=&quot;15&quot;&gt;&amp;nbsp;
            &lt;/td&gt;
        &lt;/tr&gt;
        &lt;?php endif; ?&gt;

        &lt;?php if (!empty($wpp_pdf_flyer[&#x27;pr_location&#x27;]) &amp;&amp; !empty($property[&#x27;latitude&#x27;]) &amp;&amp; !empty($property[&#x27;longitude&#x27;])) : ?&gt;
        &lt;tr&gt;
            &lt;td&gt;&lt;div class=&quot;heading_text&quot;&gt;&lt;?php echo __(&#x27;Location&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/div&gt;
            &lt;/td&gt;
        &lt;/tr&gt;
        &lt;?php if($static_google_map) { ?&gt;
        &lt;tr&gt;
            &lt;td class=&quot;pdf-text&quot;&gt;&lt;br/&gt;
                &lt;table cellspacing=&quot;0&quot; cellpadding=&quot;10&quot; border=&quot;0&quot; class=&quot;bg-section&quot;&gt;
                &lt;tr&gt;
                    &lt;td&gt;&lt;img width=&quot;&lt;?php echo $map_width?&gt;&quot; src=&quot;&lt;?php echo $static_google_map; ?&gt;&quot; /&gt;&lt;/td&gt;
                &lt;/tr&gt;
                &lt;/table&gt;
            &lt;/td&gt;
        &lt;/tr&gt;
        &lt;?php
        }
        endif;
    }


    /**
    * Default column middle added via hook into flyer template
    *
    *
    * Copyright Usability Dynamics, Inc. &lt;http://usabilitydynamics.com&gt;
    */
    function flyer_middle_column( $property, $wpp_pdf_flyer )
    {
        global $wp_properties;

        if (!empty($wpp_pdf_flyer[&#x27;pr_features&#x27;])) {
          if(!empty($wp_properties[&#x27;taxonomies&#x27;]))
            foreach($wp_properties[&#x27;taxonomies&#x27;] as $tax_slug =&gt; $tax_data): ?&gt;
              &lt;?php if(get_features(&quot;type=$tax_slug&amp;format=count&quot;, $property)):  ?&gt;
                &lt;tr&gt;
                    &lt;td&gt;&lt;div class=&quot;heading_text&quot;&gt;&lt;?php echo $tax_data[&#x27;label&#x27;]; ?&gt;&lt;/div&gt;
                    &lt;/td&gt;
                &lt;/tr&gt;
                &lt;tr&gt;
                    &lt;td class=&quot;pdf-text&quot;&gt;&lt;br/&gt;
                        &lt;?php get_features(&quot;type=$tax_slug&amp;format=comma&amp;links=false&quot;, $property); ?&gt;
                    &lt;/td&gt;
                &lt;/tr&gt;
                &lt;tr&gt;
                    &lt;td height=&quot;15&quot;&gt;&amp;nbsp;
                    &lt;/td&gt;
                &lt;/tr&gt;
            &lt;?php endif;
            endforeach;
        }
    }

  /**
  * Default left middle added via hook into flyer template
  *
  *
  * Copyright Usability Dynamics, Inc. &lt;http://usabilitydynamics.com&gt;
  */
  function flyer_right_column( $property, $wpp_pdf_flyer ) {
    if(!empty($wpp_pdf_flyer[&#x27;qr_code&#x27;])) {
    ?&gt;
        &lt;tr&gt;
            &lt;td&gt;&lt;table cellspacing=&quot;0&quot; cellpadding=&quot;10&quot; class=&quot;bg-section&quot; width=&quot;100%&quot;&gt;
                &lt;tr&gt;
                    &lt;td style=&quot;text-align:justify;&quot;&gt;&lt;a href=&quot;&lt;?php echo $property[&#x27;permalink&#x27;]?&gt;&quot;&gt;&lt;img width=&quot;&lt;?php echo ($wpp_pdf_flyer[&#x27;second_photo_width&#x27;] - 20 ); ?&gt;&quot; src=&quot;&lt;?php echo $wpp_pdf_flyer[&#x27;qr_code&#x27;]; ?&gt;&quot; alt=&quot;&quot; /&gt;&lt;/a&gt;
                    &lt;?php if (!empty($wpp_pdf_flyer[&#x27;qr_code_note&#x27;])) : ?&gt;
                    &lt;br/&gt;&lt;br/&gt;&lt;span class=&quot;pdf-note&quot;&gt;Scan the code above with your mobile device or click it to go directly to the &lt;?php echo get_bloginfo(); ?&gt; website for &lt;?php echo $property[&#x27;post_title&#x27;]; ?&gt;&lt;/span&gt;
                    &lt;?php endif; ?&gt;
                    &lt;/td&gt;
                &lt;/tr&gt;
                &lt;/table&gt;
            &lt;/td&gt;
        &lt;/tr&gt;
    &lt;?php
    }
  }

  /**
  * &#x27;Cleans&#x27; Property Description before display it in Flyer
  *
  * Copyright Usability Dynamics, Inc. &lt;http://usabilitydynamics.com&gt;
  * @return string $description
  * @author Maxim Peshkov
  * @since 1.5.1
  */
  function flyer_description ($description, $wpp_pdf_flyer) {

    //** Cleans description */
    $description = strip_shortcodes( $description );
    $description = apply_filters(&#x27;the_content&#x27;, $description);
    $description = str_replace(&#x27;]]&gt;&#x27;, &#x27;]]&amp;gt;&#x27;, $description);
    $description = strip_tags($description);

    //** Truncates description when it&#x27;s enabled in PDF Flyer Settings */
    if($wpp_pdf_flyer[&#x27;truncate_description&#x27;] == &#x27;on&#x27;) {
      $excerpt_length = 25;
      $words = preg_split(&quot;/[\n\r\t ]+/&quot;, $description, $excerpt_length + 1, PREG_SPLIT_NO_EMPTY);
      if ( count($words) &gt; $excerpt_length ) {
        array_pop($words);
        $description = implode(&#x27; &#x27;, $words);
        $description = $description . &#x27;...&#x27;;
      } else {
        $description = implode(&#x27; &#x27;, $words);
      }
    }

    return $description;
  }

  /**
  * Modifies updated message after saving / creating a property with link to flyer
  *
  *
  * Copyright Usability Dynamics, Inc. &lt;http://usabilitydynamics.com&gt;
  */
  function wpp_updated_messages($messages) {

    $messages[&#x27;property&#x27;][1] = $messages[&#x27;property&#x27;][1] . sprintf( __(&#x27;, or &lt;a href=&quot;%s&quot; target=&quot;_blank&quot;&gt;view flyer&lt;/a&gt;.&#x27;,&#x27;wpp&#x27;), esc_url( get_pdf_flyer_permalink($post_id) ) );
    return $messages;

  }

  /**
  * Adds pdf flyer menu to settings page navigation
  *
  * Copyright Usability Dynamics, Inc. &lt;http://usabilitydynamics.com&gt;
  */
  function settings_nav($tabs) {

  $tabs[&#x27;pdf_flyer&#x27;] = array(
    &#x27;slug&#x27; =&gt; &#x27;pdf_flyer&#x27;,
    &#x27;title&#x27; =&gt; __(&#x27;PDF&#x27;,&#x27;wpp&#x27;)
  );
  return $tabs;
  }

  /**
  * Content for PDF Flyer settings on WPP settings apge
  *
  * Copyright Usability Dynamics, Inc. &lt;http://usabilitydynamics.com&gt;
  */
  function settings_page($tabs) {
    global $wp_properties;

    @include_once(WPP_Path.&#x27;third-party/tcpdf/wpp_tcpdf.php&#x27;);

    $wpp_pdf_flyer = $wp_properties[&#x27;configuration&#x27;][&#x27;feature_settings&#x27;][&#x27;wpp_pdf_flyer&#x27;];
    $uploads = wp_upload_dir();

    if(empty($wpp_pdf_flyer[&#x27;header_color&#x27;]))
      $wpp_pdf_flyer[&#x27;header_color&#x27;] = &#x27;#e6e6fa&#x27;;

    if(empty($wpp_pdf_flyer[&#x27;section_bgcolor&#x27;]))
      $wpp_pdf_flyer[&#x27;section_bgcolor&#x27;] = &#x27;#bbbbbb&#x27;;

    if(empty($wpp_pdf_flyer[&#x27;num_pictures&#x27;]))
      $wpp_pdf_flyer[&#x27;num_pictures&#x27;] = &#x27;3&#x27;;

    $available_image_sizes = get_intermediate_image_sizes();

  ?&gt;

  &lt;table class=&quot;form-table&quot;&gt;
  &lt;tbody&gt;

  &lt;?php if(!is_writable($uploads[&#x27;path&#x27;])) { ?&gt;
    &lt;tr valign=&quot;top&quot;&gt;
    &lt;th scope=&quot;row&quot; colspan=&quot;2&quot; style=&quot;color:red&quot;&gt;
      &lt;div class=&quot;updated fade&quot;&gt;&lt;p&gt;&lt;?php printf(__(&quot;Warning: &lt;b&gt;%s&lt;/b&gt; is not writable, PDF flyer cannot be created.&quot;, &#x27;wpp&#x27;), $uploads[&#x27;path&#x27;]); ?&gt;&lt;/p&gt;&lt;/div&gt;
    &lt;/th&gt;
    &lt;/tr&gt;
  &lt;?php } ?&gt;

    &lt;tr valign=&quot;top&quot;&gt;
      &lt;th scope=&quot;row&quot;&gt;&lt;?php _e(&#x27;Options&#x27;,&#x27;wpp&#x27;); ?&gt;&lt;/th&gt;
      &lt;td&gt;
      &lt;ul&gt;

        &lt;li&gt;
            &lt;input type=&quot;checkbox&quot; id=&quot;use_pdf_property_lists&quot; name=&quot;wpp_settings[configuration][feature_settings][wpp_pdf_flyer][use_pdf_property_lists]&quot; &lt;?php checked($wpp_pdf_flyer[&#x27;use_pdf_property_lists&#x27;],&#x27;on&#x27;); ?&gt;&gt;
            &lt;label for=&quot;use_pdf_property_lists&quot; class=&quot;description&quot;&gt;&lt;?php _e(&#x27;Show panel that allows you to create PDF property lists.&#x27;,&#x27;wpp&#x27;); ?&gt;&lt;/label&gt;
        &lt;/li&gt;

        &lt;li&gt;
            &lt;input type=&quot;checkbox&quot; id=&quot;generate_flyers_on_the_fly&quot; name=&quot;wpp_settings[configuration][feature_settings][wpp_pdf_flyer][generate_flyers_on_the_fly]&quot; &lt;?php checked($wpp_pdf_flyer[&#x27;generate_flyers_on_the_fly&#x27;],&#x27;on&#x27;); ?&gt;&gt;
            &lt;label for=&quot;generate_flyers_on_the_fly&quot; class=&quot;description&quot;&gt;&lt;?php _e(&#x27;Generate property flyers automatically when somebody tries to view them for the first time.&#x27;,&#x27;wpp&#x27;); ?&gt;&lt;/label&gt;
        &lt;/li&gt;

        &lt;li&gt;
          &lt;input type=&quot;checkbox&quot; id=&quot;wpp_settings[configuration][feature_settings][wpp_pdf_flyer][qr_code]&quot; name=&quot;wpp_settings[configuration][feature_settings][wpp_pdf_flyer][qr_code]&quot; &lt;?php if(isset($wpp_pdf_flyer[&#x27;qr_code&#x27;]) &amp;&amp; $wpp_pdf_flyer[&#x27;qr_code&#x27;]==&#x27;on&#x27;) echo &quot; CHECKED &quot;; ?&gt;&gt;
          &lt;span class=&quot;description&quot;&gt;&lt;label for=&quot;wpp_settings[configuration][feature_settings][wpp_pdf_flyer][qr_code]&quot;&gt;&lt;?php _e(&quot;Generate QR Code.&quot;, &#x27;wpp&#x27;); ?&gt;&lt;/label&gt;&lt;/span&gt;
        &lt;/li&gt;

        &lt;li&gt;
          &lt;input type=&quot;checkbox&quot; id=&quot;wpp_settings[configuration][feature_settings][wpp_pdf_flyer][truncate_description]&quot; name=&quot;wpp_settings[configuration][feature_settings][wpp_pdf_flyer][truncate_description]&quot; &lt;?php if(isset($wpp_pdf_flyer[&#x27;truncate_description&#x27;]) &amp;&amp; $wpp_pdf_flyer[&#x27;truncate_description&#x27;]==&#x27;on&#x27;) echo &quot; CHECKED &quot;; ?&gt;&gt;
          &lt;span class=&quot;description&quot;&gt;&lt;label for=&quot;wpp_settings[configuration][feature_settings][wpp_pdf_flyer][truncate_description]&quot;&gt;&lt;?php _e(&#x27;Truncate the Description when it\&#x27;s displayed in Flyer (It can be helpful, when the data can not be placed on one page).&#x27;,&#x27;wpp&#x27;); ?&gt;&lt;/label&gt;&lt;/span&gt;
        &lt;/li&gt;

      &lt;/ul&gt;
      &lt;/td&gt;
    &lt;/tr&gt;

    &lt;tr valign=&quot;top&quot;&gt;
      &lt;th scope=&quot;row&quot;&gt;&lt;?php _e(&#x27;Flyer Display&#x27;,&#x27;wpp&#x27;); ?&gt;&lt;/th&gt;
      &lt;td&gt;
        &lt;ul&gt;
            &lt;li&gt;
              &lt;input type=&quot;checkbox&quot; id=&quot;wpp_settings[configuration][feature_settings][wpp_pdf_flyer][pr_title]&quot; name=&quot;wpp_settings[configuration][feature_settings][wpp_pdf_flyer][pr_title]&quot; &lt;?php if(isset($wpp_pdf_flyer[&#x27;pr_title&#x27;]) &amp;&amp; $wpp_pdf_flyer[&#x27;pr_title&#x27;]==&#x27;on&#x27;) echo &quot; CHECKED &quot;; ?&gt;&gt;
              &lt;span class=&quot;description&quot;&gt;&lt;label for=&quot;wpp_settings[configuration][feature_settings][wpp_pdf_flyer][pr_title]&quot;&gt;&lt;?php _e(&#x27;Title (Header)&#x27;,&#x27;wpp&#x27;); ?&gt;&lt;/label&gt;&lt;/span&gt;
            &lt;/li&gt;

            &lt;li&gt;
              &lt;input type=&quot;checkbox&quot; id=&quot;wpp_settings[configuration][feature_settings][wpp_pdf_flyer][pr_tagline]&quot; name=&quot;wpp_settings[configuration][feature_settings][wpp_pdf_flyer][pr_tagline]&quot; &lt;?php if(isset($wpp_pdf_flyer[&#x27;pr_tagline&#x27;]) &amp;&amp; $wpp_pdf_flyer[&#x27;pr_tagline&#x27;]==&#x27;on&#x27;) echo &quot; CHECKED &quot;; ?&gt;&gt;
              &lt;span class=&quot;description&quot;&gt;&lt;label for=&quot;wpp_settings[configuration][feature_settings][wpp_pdf_flyer][pr_tagline]&quot;&gt;&lt;?php _e(&#x27;Tagline under Title (Header)&#x27;,&#x27;wpp&#x27;); ?&gt;&lt;/label&gt;&lt;/span&gt;
            &lt;/li&gt;

            &lt;li&gt;
              &lt;input type=&quot;checkbox&quot; id=&quot;wpp_settings[configuration][feature_settings][wpp_pdf_flyer][qr_code_note]&quot; name=&quot;wpp_settings[configuration][feature_settings][wpp_pdf_flyer][qr_code_note]&quot; &lt;?php if(isset($wpp_pdf_flyer[&#x27;qr_code_note&#x27;]) &amp;&amp; $wpp_pdf_flyer[&#x27;qr_code_note&#x27;]==&#x27;on&#x27;) echo &quot; CHECKED &quot;; ?&gt;&gt;
              &lt;span class=&quot;description&quot;&gt;&lt;label for=&quot;wpp_settings[configuration][feature_settings][wpp_pdf_flyer][qr_code_note]&quot;&gt;&lt;?php _e(&quot;QR Code&#x27;s note (a note explaining what a QR Code is, if it exists)&quot;, &#x27;wpp&#x27;); ?&gt;&lt;/label&gt;&lt;/span&gt;
            &lt;/li&gt;

            &lt;li&gt;
              &lt;?php $attrs = self::get_pdf_list_attributes(&#x27;property_stats&#x27;); ?&gt;
              &lt;?php if (!empty($attrs)) : ?&gt;
              &lt;input type=&quot;checkbox&quot; id=&quot;wpp_settings[configuration][feature_settings][wpp_pdf_flyer][pr_details]&quot; name=&quot;wpp_settings[configuration][feature_settings][wpp_pdf_flyer][pr_details]&quot; &lt;?php if(isset($wpp_pdf_flyer[&#x27;pr_details&#x27;]) &amp;&amp; $wpp_pdf_flyer[&#x27;pr_details&#x27;]==&#x27;on&#x27;) echo &quot; CHECKED &quot;; ?&gt;&gt;
              &lt;span class=&quot;description&quot;&gt;&lt;label for=&quot;wpp_settings[configuration][feature_settings][wpp_pdf_flyer][pr_details]&quot;&gt;&lt;?php _e(&#x27;Details&#x27;,&#x27;wpp&#x27;); ?&gt;&lt;/label&gt;&lt;/span&gt;
              &lt;div class=&quot;flyer-detail-attributes wp-tab-panel hidden&quot;&gt;
                &lt;ul&gt;
                &lt;?php foreach ($attrs as $slug =&gt; $attr) : ?&gt;
                  &lt;li&gt;
                    &lt;input type=&quot;checkbox&quot; id=&quot;wpp_settings[configuration][feature_settings][wpp_pdf_flyer][detail_attributes][&lt;?php echo $slug; ?&gt;]&quot; name=&quot;wpp_settings[configuration][feature_settings][wpp_pdf_flyer][detail_attributes][&lt;?php echo $slug; ?&gt;]&quot; &lt;?php if(isset($wpp_pdf_flyer[&#x27;detail_attributes&#x27;][$slug]) &amp;&amp; $wpp_pdf_flyer[&#x27;detail_attributes&#x27;][$slug]==&#x27;on&#x27;) echo &quot; CHECKED &quot;; ?&gt;&gt;
                    &lt;span class=&quot;description&quot;&gt;&lt;label for=&quot;wpp_settings[configuration][feature_settings][wpp_pdf_flyer][detail_attributes][&lt;?php echo $slug; ?&gt;]&quot;&gt;&lt;?php echo $attr; ?&gt;&lt;/label&gt;&lt;/span&gt;
                  &lt;/li&gt;
                &lt;?php endforeach; ?&gt;
                &lt;/ul&gt;

              &lt;/div&gt;

              &lt;script type=&quot;text/javascript&quot;&gt;
                jQuery(document).ready(function(){
                  var pr_details = jQuery(&quot;input[name=&#x27;wpp_settings[configuration][feature_settings][wpp_pdf_flyer][pr_details]&#x27;]&quot;);
                  var attrs_block = jQuery(&quot;.flyer-detail-attributes&quot;);
                  /* When details option is checked we show options for attributes */
                  if (pr_details.is(&#x27;:checked&#x27;)) {
                    attrs_block.show();
                  }

                  pr_details.change(function(){
                    if (pr_details.is(&#x27;:checked&#x27;)) {
                      attrs_block.show(&#x27;slow&#x27;);
                    } else {
                      attrs_block.hide(&#x27;slow&#x27;);
                    }
                  });
                });
              &lt;/script&gt;
              &lt;?php endif; ?&gt;
            &lt;/li&gt;

            &lt;li&gt;
              &lt;input type=&quot;checkbox&quot; id=&quot;wpp_settings[configuration][feature_settings][wpp_pdf_flyer][pr_description]&quot; name=&quot;wpp_settings[configuration][feature_settings][wpp_pdf_flyer][pr_description]&quot; &lt;?php if(isset($wpp_pdf_flyer[&#x27;pr_description&#x27;]) &amp;&amp; $wpp_pdf_flyer[&#x27;pr_description&#x27;]==&#x27;on&#x27;) echo &quot; CHECKED &quot;; ?&gt;&gt;
              &lt;span class=&quot;description&quot;&gt;&lt;label for=&quot;wpp_settings[configuration][feature_settings][wpp_pdf_flyer][pr_description]&quot;&gt;&lt;?php _e(&#x27;Description (if exists)&#x27;,&#x27;wpp&#x27;); ?&gt;&lt;/label&gt;&lt;/span&gt;
            &lt;/li&gt;

            &lt;li&gt;
              &lt;input type=&quot;checkbox&quot; id=&quot;wpp_settings[configuration][feature_settings][wpp_pdf_flyer][pr_location]&quot; name=&quot;wpp_settings[configuration][feature_settings][wpp_pdf_flyer][pr_location]&quot; &lt;?php if(isset($wpp_pdf_flyer[&#x27;pr_location&#x27;]) &amp;&amp; $wpp_pdf_flyer[&#x27;pr_location&#x27;]==&#x27;on&#x27;) echo &quot; CHECKED &quot;; ?&gt;&gt;
              &lt;span class=&quot;description&quot;&gt;&lt;label for=&quot;wpp_settings[configuration][feature_settings][wpp_pdf_flyer][pr_location]&quot;&gt;&lt;?php _e(&#x27;Location on Map (if exists)&#x27;,&#x27;wpp&#x27;); ?&gt;&lt;/label&gt;&lt;/span&gt;
            &lt;/li&gt;

            &lt;li&gt;
              &lt;input type=&quot;checkbox&quot; id=&quot;wpp_settings[configuration][feature_settings][wpp_pdf_flyer][pr_features]&quot; name=&quot;wpp_settings[configuration][feature_settings][wpp_pdf_flyer][pr_features]&quot; &lt;?php if(isset($wpp_pdf_flyer[&#x27;pr_features&#x27;]) &amp;&amp; $wpp_pdf_flyer[&#x27;pr_features&#x27;]==&#x27;on&#x27;) echo &quot; CHECKED &quot;; ?&gt;&gt;
              &lt;span class=&quot;description&quot;&gt;&lt;label for=&quot;wpp_settings[configuration][feature_settings][wpp_pdf_flyer][pr_features]&quot;&gt;&lt;?php _e(&#x27;Features (if exists)&#x27;,&#x27;wpp&#x27;); ?&gt;&lt;/label&gt;&lt;/span&gt;
            &lt;/li&gt;

            &lt;li&gt;
              &lt;input type=&quot;checkbox&quot; id=&quot;wpp_settings[configuration][feature_settings][wpp_pdf_flyer][pr_agent_info]&quot; name=&quot;wpp_settings[configuration][feature_settings][wpp_pdf_flyer][pr_agent_info]&quot; &lt;?php if(isset($wpp_pdf_flyer[&#x27;pr_agent_info&#x27;]) &amp;&amp; $wpp_pdf_flyer[&#x27;pr_agent_info&#x27;]==&#x27;on&#x27;) echo &quot; CHECKED &quot;; ?&gt;&gt;
              &lt;span class=&quot;description&quot;&gt;&lt;label for=&quot;wpp_settings[configuration][feature_settings][wpp_pdf_flyer][pr_agent_info]&quot;&gt;&lt;?php _e(&#x27;Agent Information (if exists)&#x27;,&#x27;wpp&#x27;); ?&gt;&lt;/label&gt;&lt;/span&gt;
            &lt;/li&gt;
        &lt;/ul&gt;
      &lt;/td&gt;
    &lt;/tr&gt;

    &lt;tr valign=&quot;top&quot;&gt;
    &lt;th scope=&quot;row&quot;&gt;&lt;?php _e(&#x27;Primary Photo Size&#x27;,&#x27;wpp&#x27;); ?&gt;&lt;/th&gt;
    &lt;td&gt;
      &lt;?php WPP_F::image_sizes_dropdown(&quot;name=wpp_settings[configuration][feature_settings][wpp_pdf_flyer][primary_photo_size]&amp;selected={$wpp_pdf_flyer[&#x27;primary_photo_size&#x27;]}&quot;); ?&gt;
    &lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr valign=&quot;top&quot;&gt;
      &lt;th scope=&quot;row&quot;&gt;&lt;?php _e(&#x27;Font&#x27;,&#x27;wpp&#x27;); ?&gt;&lt;/th&gt;
      &lt;td&gt;
        &lt;?php wpp_tcpdf_get_HTML_font_list(&quot;name=wpp_settings[configuration][feature_settings][wpp_pdf_flyer][setfont]&amp;selected={$wpp_pdf_flyer[&#x27;setfont&#x27;]}&quot;); ?&gt;&lt;br&gt;
        &lt;span class=&quot;description&quot;&gt;&lt;?php _e(&#x27;The default font is Helvetica. If you have any problems with the current font try choosing another one from the list.&#x27;,&#x27;wpp&#x27;); ?&gt;&lt;/span&gt;
      &lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;th&gt;&lt;?php _e(&#x27;Secondary Images&#x27;,&#x27;wpp&#x27;); ?&gt;&lt;/th&gt;
      &lt;td&gt;
      &lt;ul&gt;
        &lt;li&gt;
        &lt;?php WPP_F::image_sizes_dropdown(&quot;name=wpp_settings[configuration][feature_settings][wpp_pdf_flyer][secondary_photos]&amp;selected={$wpp_pdf_flyer[&#x27;secondary_photos&#x27;]}&quot;); ?&gt;
      &lt;/li&gt;
      &lt;li&gt;
    &lt;?php printf(__(&#x27;Show %1$s images.&#x27;, &#x27;wpp&#x27;), &#x27;&lt;input type=&quot;text&quot; size=&quot;5&quot; name=&quot;wpp_settings[configuration][feature_settings][wpp_pdf_flyer][num_pictures]&quot; value=&#x27;.$wpp_pdf_flyer[&#x27;num_pictures&#x27;].&#x27;&gt;&#x27;); ?&gt;
      &lt;/li&gt;
      &lt;/ul&gt;
      &lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr valign=&quot;top&quot;&gt;
      &lt;th scope=&quot;row&quot;&gt;&lt;?php _e(&#x27;Logo URL&#x27;,&#x27;wpp&#x27;); ?&gt;&lt;/th&gt;
      &lt;td&gt;
      &lt;input type=&quot;text&quot; size=&quot;60&quot; name=&quot;wpp_settings[configuration][feature_settings][wpp_pdf_flyer][logo_url]&quot; value=&quot;&lt;?php echo $wpp_pdf_flyer[&#x27;logo_url&#x27;]; ?&gt;&quot;&gt;
      &lt;span class=&quot;description&quot;&gt;&lt;?php _e(&#x27;Use JPEG and GIF images only.&#x27;,&#x27;wpp&#x27;); ?&gt;&lt;/span&gt;
      &lt;/td&gt;
    &lt;/tr&gt;
    &lt;?php /* Removed because sized are hardcoded in generation.
    &lt;tr valign=&quot;top&quot;&gt;
      &lt;th scope=&quot;row&quot;&gt;&lt;?php _e(&#x27;Page Format&#x27;, &#x27;wpp&#x27;); ?&gt;&lt;/th&gt;
      &lt;td&gt;
      &lt;select name=&quot;wpp_settings[configuration][feature_settings][wpp_pdf_flyer][flyer_page_format]&quot;&gt;
        &lt;option value=&quot;A4&quot; &lt;?php selected(&#x27;A4&#x27;, $wpp_pdf_flyer[&#x27;flyer_page_format&#x27;]); ?&gt;&gt;A4&lt;/option&gt;
        &lt;option value=&quot;LETTER&quot; &lt;?php selected(&#x27;LETTER&#x27;, $wpp_pdf_flyer[&#x27;flyer_page_format&#x27;]); ?&gt;&gt;Letter&lt;/option&gt;
        &lt;option value=&quot;LEGAL&quot; &lt;?php selected(&#x27;LEGAL&#x27;, $wpp_pdf_flyer[&#x27;flyer_page_format&#x27;]); ?&gt;&gt;US Legal&lt;/option&gt;
      &lt;/select&gt;
      &lt;/td&gt;
    &lt;/tr&gt;
    */ ?&gt;
    &lt;tr valign=&quot;top&quot;&gt;
      &lt;th scope=&quot;row&quot;&gt;&lt;?php _e(&#x27;Header color&#x27;,&#x27;wpp&#x27;); ?&gt;&lt;/th&gt;
      &lt;td&gt;
      &lt;input type=&quot;text&quot; class=&quot;wpp_input_colorpicker&quot; name=&quot;wpp_settings[configuration][feature_settings][wpp_pdf_flyer][header_color]&quot; value=&quot;&lt;?php echo $wpp_pdf_flyer[&#x27;header_color&#x27;]; ?&gt;&quot;&gt;
      &lt;span class=&quot;description&quot;&gt;&lt;?php _e(&#x27;Header color&#x27;,&#x27;wpp&#x27;); ?&gt;&lt;/span&gt;
      &lt;/td&gt;
    &lt;/tr&gt;

    &lt;tr valign=&quot;top&quot;&gt;
      &lt;th scope=&quot;row&quot;&gt;&lt;?php _e(&#x27;Section background color&#x27;,&#x27;wpp&#x27;); ?&gt;&lt;/th&gt;
      &lt;td&gt;
      &lt;input type=&quot;text&quot; class=&quot;wpp_input_colorpicker&quot; name=&quot;wpp_settings[configuration][feature_settings][wpp_pdf_flyer][section_bgcolor]&quot; value=&quot;&lt;?php echo $wpp_pdf_flyer[&#x27;section_bgcolor&#x27;]; ?&gt;&quot;&gt;
       &lt;/td&gt;
    &lt;/tr&gt;

     &lt;?php do_action(&#x27;wpp_flyer_settings_table_bottom&#x27;, $wpp_pdf_flyer); ?&gt;

    &lt;/table&gt;



    &lt;table class=&#x27;form-table&#x27;&gt;
    &lt;tr valign=&quot;top&quot;&gt;
      &lt;td colspan=&quot;2&quot;&gt;
      &lt;br class=&quot;cb&quot; /&gt;
      &lt;span class=&quot;description&quot;&gt;
      &lt;?php _e(&#x27;Shortcode examples:&lt;br /&gt;&#x27;,&#x27;wpp&#x27;); ?&gt;
      &lt;?php _e(&#x27;&lt;strong&gt;[property_flyer]&lt;/strong&gt; - Returns a html link to the PDF Flyer&lt;br /&gt;&#x27;,&#x27;wpp&#x27;); ?&gt;
      &lt;?php _e(&#x27;&lt;strong&gt;[property_flyer title=\&#x27;PDF Flyer\&#x27;]&lt;/strong&gt; - Returns a html link to the PDF Flyer with custom title.&lt;br /&gt;&#x27;,&#x27;wpp&#x27;); ?&gt;
      &lt;?php _e(&#x27;&lt;strong&gt;[property_flyer urlonly=\&#x27;yes\&#x27;]&lt;/strong&gt; -  Returns the raw URL to the PDF Flyer (for use in custom html).&lt;br /&gt;&#x27;,&#x27;wpp&#x27;); ?&gt;
      &lt;?php _e(&#x27;&lt;strong&gt;[property_flyer class=\&#x27;custom_css_class\&#x27;]&lt;/strong&gt; - For use with a custom CSS class.&lt;br /&gt;&#x27;,&#x27;wpp&#x27;); ?&gt;
      &lt;?php _e(&#x27;&lt;strong&gt;[property_flyer image=\&#x27;url_to_custom_image\&#x27;]&lt;/strong&gt; - Returns url_to_custom_image with a link to the PDF Flyer.&#x27;,&#x27;wpp&#x27;); ?&gt;
      &lt;/span&gt;
      &lt;/td&gt;
    &lt;/tr&gt;
    &lt;/table&gt;

    &lt;div class=&quot;wpp_settings_block&quot; style=&quot;margin: 10px 10px 0;&quot;&gt;
        &lt;span&gt;&lt;?php _e(&#x27;You can regenerate all your PDF flyers, but depending on your server, it can be very time consuming if you have many properties.&#x27;,&#x27;wpp&#x27;); ?&gt;&lt;/span&gt;
        &lt;input type=&quot;button&quot; id=&quot;wpp_ajax_regenerate_all_flyers&quot; value=&quot;&lt;?php _e(&#x27;Regenerate all Flyers&#x27;,&#x27;wpp&#x27;); ?&gt;&quot;&gt;&amp;nbsp;&lt;img style=&quot;display:none;&quot; id=&quot;regenerate_all_flyers_ajax_spinner&quot; src=&quot;&lt;?php echo WPP_URL; ?&gt;images/ajax_loader.gif&quot; /&gt;
        &lt;br/&gt;&lt;input style=&quot;display:none;&quot; type=&quot;button&quot; id=&quot;wpp_ajax_regenerate_all_flyers_close&quot; value=&quot;&lt;?php _e(&#x27;Close Result\&#x27;s Logs&#x27;,&#x27;wpp&#x27;); ?&gt;&quot;&gt;
        &lt;pre class=&quot;wpp_class_pre hidden&quot; id=&quot;wpp_ajax_regenerate_all_flyers_result&quot; style=&quot;height:300px;&quot;&gt;&lt;/pre&gt;
    &lt;/div&gt;
    &lt;script type=&quot;text/javascript&quot;&gt;
    jQuery(&#x27;#wpp_ajax_regenerate_all_flyers&#x27;).click(function(){
        var ajaxSpinner = jQuery(&#x27;#regenerate_all_flyers_ajax_spinner&#x27;);
        var closeButton = jQuery(&quot;#wpp_ajax_regenerate_all_flyers_close&quot;);
        var resultBox = jQuery(&#x27;#wpp_ajax_regenerate_all_flyers_result&#x27;);

        var wpp_recursively_generate_pdf_flyer = function( data, callback ) {
          var item = data.shift();
          jQuery.ajax({
            url: &#x27;&lt;?php echo admin_url(&#x27;admin-ajax.php&#x27;); ?&gt;&#x27;,
            data: &#x27;action=wpp_generate_pdf_flyer&amp;post_id=&#x27; + item.post_id,
            complete: function( r, status ) {
              if( status === &#x27;success&#x27; ) {
                var result = eval(&#x27;(&#x27; + r.responseText + &#x27;)&#x27;);
                if(result.success == 1) {
                  putLog(&#x27;&lt;?php _e(&#x27;PDF Flyer for property &quot;&#x27;,&#x27;wpp&#x27;); ?&gt;&#x27; + item.post_title + &#x27;&lt;?php _e(&#x27;&quot; is generated.&#x27;,&#x27;wpp&#x27;); ?&gt;&#x27;, resultBox);
                } else {
                  putLog(&#x27;&lt;?php _e(&#x27;&lt;b&gt;Error. PDF Flyer for property &quot;&#x27;,&#x27;wpp&#x27;); ?&gt;&#x27; + item.post_title + &#x27;&lt;?php _e(&#x27;&quot; could not be generated.&lt;/b&gt;&#x27;,&#x27;wpp&#x27;); ?&gt;&#x27;, resultBox);
                }
              } else {
                putLog(&#x27;&lt;?php _e(&#x27;Could not regenerate PDF Flyer for property &quot;&#x27;,&#x27;wpp&#x27;); ?&gt;&#x27; + item.post_title + &#x27;&lt;?php _e(&#x27;&quot;. Looks like, something caused error on server.&#x27;,&#x27;wpp&#x27;); ?&gt;&#x27;, resultBox);
              }
              if ( data.length == 0 ) {
                if( typeof callback === &#x27;function&#x27; ) {
                  callback();
                }
              } else {
                wpp_recursively_generate_pdf_flyer( data, callback );
              }
            }
          });
        }

        ajaxSpinner.show( &#x27;fast&#x27;, function() {
          resultBox.show( &#x27;fast&#x27;, function() {
            jQuery.ajax({
              url: &#x27;&lt;?php echo admin_url(&#x27;admin-ajax.php&#x27;); ?&gt;&#x27;,
              //async: false,
              data: &#x27;action=wpp_get_property_ids&#x27;,
              complete: function( r, status ) {

                if( status === &#x27;success&#x27; ) {

                  var data = eval(&#x27;(&#x27; + r.responseText + &#x27;)&#x27;);
                  if( data.length &gt; 0 ) {
                    putLog(&#x27;&lt;?php _e(&#x27;Property List is got. Start generate PDF Flyers...&#x27;,&#x27;wpp&#x27;); ?&gt;&#x27;, resultBox);

                    // Loop all properties
                    wpp_recursively_generate_pdf_flyer( data, function() {
                      putLog(&#x27;&lt;?php _e(&#x27;Finished.&#x27;,&#x27;wpp&#x27;); ?&gt;&#x27;, resultBox);
                      ajaxSpinner.hide();
                      closeButton.show();
                    } );

                  } else {
                    putLog(&#x27;&lt;?php _e(&#x27;There are no any property to generate PDF Flyer for.&#x27;,&#x27;wpp&#x27;); ?&gt;&#x27;, resultBox);
                    ajaxSpinner.hide();
                    closeButton.show();
                  }
                } else {
                  putLog(&#x27;&lt;?php _e(&#x27;Looks like, something caused error on server. Please, try to regenerate PDF Flyers later.&#x27;,&#x27;wpp&#x27;); ?&gt;&#x27;, resultBox);
                  ajaxSpinner.hide();
                  closeButton.show();
                }

              }
            } );
          } );
        } );
        return false;
    });

    jQuery(&quot;#wpp_ajax_regenerate_all_flyers_close&quot;).click(function(){
        var closeButton = jQuery(this);
        var resultBox = jQuery(&#x27;#wpp_ajax_regenerate_all_flyers_result&#x27;);

        resultBox.hide();
        resultBox.html(&#x27;&#x27;);
        closeButton.hide();
    });


    function putLog (log, el) {
        if (typeof log != &#x27;undefined&#x27; &amp;&amp; typeof el == &#x27;object&#x27;){
            if (jQuery(&#x27;.logs&#x27;, el).length == 0) {
                el.append(&#x27;&lt;ul class=&quot;logs&quot;&gt;&lt;/ul&gt;&#x27;);
            }
            jQuery(&#x27;.logs&#x27;, el).append(&#x27;&lt;li&gt;&#x27; + log + &#x27;&lt;/li&gt;&#x27;);
        }
    }

    &lt;/script&gt;
    &lt;?php

  }


  /**
  * Pdf Flyer overview page.
  *
  * Everything handles via this page. Other functions are done via AJAX.
  *
  * @Page ID: property_page_wpp_pdf_flyer
  * Copyright Usability Dynamics, Inc. &lt;http://usabilitydynamics.com&gt;
  */
    function page_main()
  {
    global $wp_properties, $wpdb, $wpp_pdf_flyer, $current_screen;
    class_wpp_pdf_flyer::settings_page($tabs);
  }

    /**
    * Return default PDF settings
    *
    * @return array
    */
    function return_defaults() {
        $default = array ();
        $default[&#x27;num_pictures&#x27;] = 3;
        $default[&#x27;header_color&#x27;] = &#x27;#e6e6fa&#x27;;
        $default[&#x27;section_bgcolor&#x27;] = &#x27;#bbbbbb&#x27;;
        return $default;
    }

  /**
   * Handles the pdf_flyer shortcodes and it&#x27;s attributes.
   *
   * @param string $atts parameter string
   * @global $post
   * @uses get_pdf_flyer_permalink
   * @return string
   */
  function shortcode_pdf_flyer( $atts ) {
    global $post;

    if($post-&gt;post_type != &#x27;property&#x27;) {
      return false;
    }

    extract(shortcode_atts(array(
      &#x27;title&#x27; =&gt; &#x27;&lt;span class=&quot;wpp_pdf_flyer_icon&quot;&gt;[PDF]&lt;/span&gt; &#x27; . $post-&gt;post_title,
      &#x27;urlonly&#x27; =&gt; &#x27;no&#x27;,
      &#x27;class&#x27; =&gt; &#x27;wpp_pdf_link btn btn-info btn-large&#x27;,
      &#x27;image&#x27; =&gt; false
    ), $atts));

    $get_pdf_url = get_pdf_flyer_permalink($post-&gt;ID);

    if( $get_pdf_url == false ) {
      return sprintf(__(&#x27;Could not find a PDF flyer for %1s.&#x27;, &#x27;wpp&#x27;), $post-&gt;post_name);
    }

    /**
     * Image attribute is set. Return the image linked to the pdf document.
     */
    if( $image != false ) {
      return &#x27;&lt;a href=&quot;&#x27; . $get_pdf_url . &#x27;&quot; class=&quot;&#x27; . $class .&#x27;&quot;&gt;&lt;img src=&quot;&#x27;. $image . &#x27;&quot; /&gt;&lt;/a&gt;&#x27;;
    }

    /**
     * Only returns url to the PDF, not any formatted html. So users can format their
     * own html easily.
     */
    if( $urlonly == &#x27;yes&#x27; ) {
      return $get_pdf_url;
    }


    return &#x27;&lt;a href=&quot;&#x27; . $get_pdf_url . &#x27;&quot; class=&quot;&#x27; . $class .&#x27;&quot;&gt;&#x27; . $title . &#x27;&lt;/a&gt;&#x27;;

  }

  /**
   * Handles the pdf_flyer shortcodes and it&#x27;s attributes.
   *
   * @param string $atts parameter string
   * @global $post
   * @uses get_pdf_flyer_permalink
   * @return string
   */
  function shortcode_pdf_list( $atts ) {
    global $wp_properties, $wpdb;

    extract(shortcode_atts(array(
      &#x27;title&#x27; =&gt; &#x27;&lt;span class=&quot;wpp_pdf_flyer_icon&quot;&gt;[PDF]&lt;/span&gt; &#x27; . $atts[&#x27;name&#x27;],
      &#x27;name&#x27; =&gt; &#x27;&#x27;,
      &#x27;urlonly&#x27; =&gt; &#x27;no&#x27;,
      &#x27;class&#x27; =&gt; &#x27;wpp_pdf_link btn btn-info btn-large&#x27;,
      &#x27;image&#x27; =&gt; false
      ), $atts));

    //** If name is not set, there is no sense to continue */
    if(empty($name)) {
      return &#x27;&#x27;;
    }

    //** Get all PDF Lists */
    $pdf_lists = $wp_properties[&#x27;configuration&#x27;][&#x27;feature_settings&#x27;][&#x27;wpp_pdf_flyer&#x27;][&#x27;pdf_lists&#x27;];

    //** Try find PDF List by title (name) */
    if(is_array($pdf_lists)) {
      foreach($pdf_lists as $key =&gt; $list) {
        if(strtolower($name) == strtolower($list[&#x27;title&#x27;])) {
          $slug = $key;
          $pdf_list = $list;
          break;
        }
      }
    }

    if(empty($pdf_list) || empty($slug)) {
      return &#x27;&#x27;;
    }

    //** Determine if Restricted Public Access is set */
    if(is_array($pdf_list[&#x27;options&#x27;])) {
      $key = array_search(&#x27;restrict_public_access&#x27;, $pdf_list[&#x27;options&#x27;]);
      if($key !== false) {
        $user = wp_get_current_user();
        if($user-&gt;{$wpdb-&gt;prefix.&#x27;user_level&#x27;} == 0) {
          return &#x27;&#x27;;
        }
      }
    }

    $pdf_url = get_pdf_list_permalink($slug);

    //** Image attribute is set. Return the image linked to the pdf document. */
    if( $image != false ) {
      return &#x27;&lt;a href=&quot;&#x27; . $pdf_url . &#x27;&quot; class=&quot;&#x27; . $class .&#x27;&quot;&gt;&lt;img src=&quot;&#x27;. $image . &#x27;&quot; /&gt;&lt;/a&gt;&#x27;;
    }

    //** Only returns url to the PDF, not any formatted html. So users can format their */
    //** own html easily. */
    if( $urlonly == &#x27;yes&#x27; ) {
      return $pdf_url;
    }

    return &#x27;&lt;a href=&quot;&#x27; . $pdf_url . &#x27;&quot; class=&quot;&#x27; . $class .&#x27;&quot;&gt;&#x27; . $title . &#x27;&lt;/a&gt;&#x27;;
  }

   /**
    * Removed PDF flyer on property save.
    * It will be created on next request.
    *
    * Hooks into save_property hook.
    *
    * @author odokienko@UD
    */
    function check_flyer_pdf ($post_id){
      global $wp_properties, $wpdb;

      foreach( (array) $wpdb-&gt;get_col( $wpdb-&gt;prepare( &quot;
        SELECT ID FROM {$wpdb-&gt;posts} WHERE post_parent = %d AND post_title like %s AND post_type = &#x27;attachment&#x27;
      &quot;, $post_id, &#x27;% &#x27; . __(&#x27;Flyer&#x27;, &#x27;wpp&#x27;) ) ) as $attachment_id) {

        wp_delete_attachment( $attachment_id, true );

      }

      return;

    }


    /**
    * Creates the PDF flyer and saves it to disk.
    *
    * Hooks into save_property hook.
    *
    * @todo Fix the dimensions so they can actually be set by user to A4, Letter, US Legal, etc. Right now an arbitrary document size is generated based on image sizes. - potanin@UD
    * @todo Need to display some sort of warning if PDF cache directy cannot be created
    *
    * Copyright Usability Dynamics, Inc. &lt;http://usabilitydynamics.com&gt;
    */
    function create_flyer_pdf($post_id, $debug = false)  {
        global $wp_properties, $post, $wpdb;

        //** Include TCPDF here to avoid double class declaration. korotkov@ud */
        @include_once(WPP_Path.&#x27;third-party/tcpdf/tcpdf.php&#x27;);

        //** Include extended TCPDF class WPP_PDF_Flyer */
        @include_once(WPP_Path.&#x27;third-party/tcpdf/wpp_pdf_flyer.php&#x27;);

        ini_set(&#x27;memory_limit&#x27;, &#x27;608M&#x27;);

        $property = WPP_F::get_property( $post_id );

        //** Load PDF Settings */
        $wpp_pdf_flyer = $wp_properties[&#x27;configuration&#x27;][&#x27;feature_settings&#x27;][&#x27;wpp_pdf_flyer&#x27;];

        //** If, some reason, PDF Settings don&#x27;t exist, we load PDF default settings */
        if(empty($wpp_pdf_flyer)) {
          $wpp_pdf_flyer = class_wpp_pdf_flyer::return_defaults();
        }

        //** Check Primary Photo&#x27;s (Featured Photo) size */
        if (empty($wpp_pdf_flyer[&#x27;primary_photo_size&#x27;]) || trim($wpp_pdf_flyer[&#x27;primary_photo_size&#x27;]) == &#x27;-&#x27;) {
            $wpp_pdf_flyer[&#x27;primary_photo_size&#x27;] = &#x27;medium&#x27;;
        }
        //** Check Secondary Photo&#x27;s size */
        if (empty($wpp_pdf_flyer[&#x27;secondary_photos&#x27;]) || trim($wpp_pdf_flyer[&#x27;secondary_photos&#x27;]) == &#x27;-&#x27;) {
            $wpp_pdf_flyer[&#x27;secondary_photos&#x27;] = &#x27;medium&#x27;;
        }
        //** Check Agent Photo&#x27;s size */
        if (empty($wpp_pdf_flyer[&#x27;agent_photo_size&#x27;]) || trim($wpp_pdf_flyer[&#x27;agent_photo_size&#x27;]) == &#x27;-&#x27;) {
            $wpp_pdf_flyer[&#x27;agent_photo_size&#x27;] = &#x27;thumbnail&#x27;;
        }

        if (empty($wpp_pdf_flyer[&#x27;flyer_page_format&#x27;])) {
          $wpp_pdf_flyer[&#x27;flyer_page_format&#x27;] = &#x27;A4&#x27;;
        }

        $uploads = wp_upload_dir();

        //** Make sure that PDF cache folder is writable, attempt making the directory
        if(is_writable($uploads[&#x27;path&#x27;])) {
          if(!file_exists($uploads[&#x27;path&#x27;])) mkdir($uploads[&#x27;path&#x27;]);
        } else {
        //** @TODO: Need to display some sort of warning if PDF cache directy cannot be created */

          return false;
        }

        $property_type = $property[&#x27;property_type&#x27;];

      //** Load best template, or $template_path is false, and default will be loaded from this file */

        $template_path = WPP_F::get_template_part(array(
          &quot;property-flyer-$property_type&quot;,
          &#x27;custom-flyer&#x27;,
          &#x27;property-flyer&#x27;
        ), array(WPP_Templates) );

      //** At this point everything should be in order to load TCPDF files */
        require_once WPP_Path.&#x27;third-party/tcpdf/phpqrcode.php&#x27;;

      //** Check, if featured image&#x27;s url exsists we approve featured image&#x27;s url */
        if( !empty( $property[&#x27;featured_image&#x27;] ) ) {

            $primary_image = wpp_get_image_link($property[&#x27;featured_image&#x27;], $wpp_pdf_flyer[&#x27;primary_photo_size&#x27;], array(&#x27;return&#x27; =&gt; &#x27;array&#x27;));

            if(WPP_F::file_in_uploads_exists_by_url($primary_image[&#x27;link&#x27;])) {
              if(isset($headers[&#x27;Content-Type&#x27;]) &amp;&amp; strpos( $headers[&#x27;Content-Type&#x27;], &#x27;image&#x27; ) === false) {
                unset($featured_image_url);
                unset($property[&#x27;featured_image_url&#x27;]);
              } else {
                $featured_image_url = $primary_image[&#x27;link&#x27;];
              }
            } else {
              unset($featured_image_url);
              unset($property[&#x27;featured_image_url&#x27;]);
            }
        }

      //** Check, if logo image&#x27;s url exsists we approve logo&#x27;s image url */
        if( !empty( $wpp_pdf_flyer[&#x27;logo_url&#x27;] ) ) {
            $headers = @get_headers( $wpp_pdf_flyer[&#x27;logo_url&#x27;] , 1 );
            if( strpos( $headers[0], &#x27;200&#x27; )) {
              if(isset($headers[&#x27;Content-Type&#x27;]) &amp;&amp; strpos( $headers[&#x27;Content-Type&#x27;], &#x27;image&#x27; ) === false) {
                unset($logo_url);
                unset($wpp_pdf_flyer[&#x27;logo_url&#x27;]);
              } else {
                $logo_url= $wpp_pdf_flyer[&#x27;logo_url&#x27;];
              }
            } else {
              unset($logo_url);
              unset($wpp_pdf_flyer[&#x27;logo_url&#x27;]);
            }
        }
        $filename = $property[&#x27;post_name&#x27;];
        $filename = remove_accents ($filename);     // WordPress remove_accents. /wp-includes/formatting.php.
        $filename = sanitize_file_name ($filename);   // WordPresssanitize_file_name /wp-includes/formatting.php
        $filename = ereg_replace(&quot;[^-_.A-Za-z0-9]&quot;, &quot;&quot;, $filename); // remove all character symbols
        $filename = ereg_replace(&quot;_-&quot;, &quot;_&quot;, $filename); // Change &quot;abc_-abc&quot; to &quot;abc_abc&quot;
        $filename = ereg_replace(&quot;-_&quot;, &quot;-&quot;, $filename); // Change &quot;abc-_abc&quot; to &quot;abc-abc&quot;

//** Set QR code. If image&#x27;s file doesn&#x27;t exist, we create it. */
        $qrcode_path = $uploads[&#x27;path&#x27;].&#x27;/&#x27;.$filename.&#x27;_qr.png&#x27;;
        $qrcode      = $uploads[&#x27;url&#x27;] .&#x27;/&#x27;.$filename.&#x27;_qr.png&#x27;;
        if($wpp_pdf_flyer[&#x27;qr_code&#x27;]==&#x27;on&#x27; &amp;&amp; class_exists(&#x27;QRcode&#x27;)) {
          // If, some reason, file already exists, - remove it to avoid conflict.
          if(file_exists($qrcode_path)) {
            unlink($qrcode_path);
          }
          // Generates QR Code image file
          QRcode::png($property[&#x27;permalink&#x27;], $qrcode_path,2,2);
        }

        $wpp_pdf_flyer[&#x27;featured_image_url&#x27;] = $featured_image_url;
        $wpp_pdf_flyer[&#x27;featured_image_width&#x27;] = $primary_image[&#x27;width&#x27;];
        $wpp_pdf_flyer[&#x27;featured_image_height&#x27;] = $primary_image[&#x27;height&#x27;];
        if(file_exists($qrcode_path)) {
          $wpp_pdf_flyer[&#x27;qr_code&#x27;] = $qrcode;
        }

      //** Set list of excluded property stats */
        $property_stats = self::get_pdf_list_attributes(&#x27;property_stats&#x27;);
        $excluded_stats = array();
        foreach((array)$property_stats as $slug =&gt; $attr) {
          if(!array_key_exists($slug, (array)$wpp_pdf_flyer[&#x27;detail_attributes&#x27;])) {
            $excluded_stats[] = $slug;
          }
        }
        $wpp_pdf_flyer[&#x27;excluded_details_stats&#x27;] = implode(&#x27;,&#x27;,$excluded_stats);

        if(!empty($logo_url)) {
            $wpp_pdf_flyer[&#x27;logo_url&#x27;] = $logo_url;
        }

        $wpp_pdf_flyer[&#x27;agent_photo_width&#x27;] = class_wpp_pdf_flyer::get_pdf_image_size($wpp_pdf_flyer[&#x27;agent_photo_size&#x27;]);

        if ( $wpp_pdf_flyer[&#x27;featured_image_width&#x27;] &lt; ($wpp_pdf_flyer[&#x27;agent_photo_width&#x27;] * 2 + 400) ) {
            $wpp_pdf_flyer[&#x27;first_col_width&#x27;] = $wpp_pdf_flyer[&#x27;agent_photo_width&#x27;] * 2 + 400;
        } else {
            $wpp_pdf_flyer[&#x27;first_col_width&#x27;] = $wpp_pdf_flyer[&#x27;featured_image_width&#x27;];
        }

        $wpp_pdf_flyer[&#x27;second_photo_width&#x27;] = class_wpp_pdf_flyer::get_pdf_image_size($wpp_pdf_flyer[&#x27;secondary_photos&#x27;]);
        $wpp_pdf_flyer[&#x27;pdf_width&#x27;] = $wpp_pdf_flyer[&#x27;first_col_width&#x27;] + $wpp_pdf_flyer[&#x27;second_photo_width&#x27;] + 70;

      //** Set font sizes */
        $em = round($wpp_pdf_flyer[&#x27;pdf_width&#x27;] / 350);
        if ($em == 0) $em = 1;
        $wpp_pdf_flyer[&#x27;font_size_content&#x27;] = $em * 16;
        $wpp_pdf_flyer[&#x27;font_size_header&#x27;] = $em * 26;
        $wpp_pdf_flyer[&#x27;font_size_note&#x27;] = $em * 12;

      //** Set format of PDF document */
        $wpp_pdf_flyer[&#x27;format&#x27;] = array(round($wpp_pdf_flyer[&#x27;pdf_width&#x27;], 3), round($wpp_pdf_flyer[&#x27;pdf_width&#x27;] *  841.89 / 595.276, 3));

        //** Scan through images and verify they are accessible */
        foreach( (array) $property[&#x27;gallery&#x27;] as $attachment_key =&gt; $attachment ) {
          if( !file_exists( get_attached_file( $attachment[&#x27;attachment_id&#x27;] )  ) ) {
            unset(  $property[ &#x27;gallery&#x27; ][ $attachment_key ] );
          }
        }

        $wpp_pdf_flyer = array_filter( (array) $wpp_pdf_flyer );

        //** TODO: if a custom template is placed in the theme directory. Suggest calling it property-flyer.php */
        if( $template_path ) {
            $site_url = site_url();
            ob_start();
            include $template_path;
            $html = ob_get_contents();
            ob_end_clean();
        } else {
            //** No custom template, using the default one from the function */
            $html = class_wpp_pdf_flyer::default_flyer_template( $wpp_pdf_flyer, $property );
        }



        $pdf = new WPP_PDF_Flyer(&#x27;P&#x27;, PDF_UNIT, $wpp_pdf_flyer[&#x27;format&#x27;], true, &#x27;UTF-8&#x27;, false);

        $pdf-&gt;setPrintHeader(false);
        $pdf-&gt;setPrintFooter(false);
        $pdf-&gt;setFontSubsetting(true);
        if ($wpp_pdf_flyer[&#x27;setfont&#x27;]){
          $pdf-&gt;SetFont($wpp_pdf_flyer[&#x27;setfont&#x27;]);
        }
        $pdf-&gt;SetCreator(&quot;WP-Property&quot;);
        $pdf-&gt;SetAuthor(&quot;WP-Property&quot;);
        $pdf-&gt;SetTitle($property[&#x27;post_name&#x27;]);
        $pdf-&gt;SetSubject($property[&#x27;permalink&#x27;]);
        $pdf-&gt;SetFooterMargin(0);
        $pdf-&gt;SetTopMargin(1);
        $pdf-&gt;SetLeftMargin(10);
        $pdf-&gt;SetRightMargin(10);
        $pdf-&gt;AddPage(&#x27;P&#x27;, $wpp_pdf_flyer[&#x27;format&#x27;]);

        if($pdf-&gt;wpp_error_log) {
          update_post_meta($post_id, &#x27;wpp_post_error&#x27;, $pdf-&gt;wpp_error_log);
        }

        $pdf-&gt;writeHTML( $html, true, false, true, false, &#x27;&#x27; );

        $lastPage = $pdf-&gt;getPage();
        $lastPageContentLength = strlen($pdf-&gt;getPageBuffer($lastPage));
        if ($lastPageContentLength &lt; 400){
          $pdf-&gt;deletePage($lastPage);
        }


        if(!empty($property[&#x27;post_name&#x27;])) {
          $pdf-&gt;Output($uploads[&#x27;path&#x27;].&#x27;/&#x27;.$filename.&#x27;.pdf&#x27;, &#x27;F&#x27;);
        }

        //** Checks if the flyer has been created, and adds it as an attachment to the Post */
        if( file_exists($uploads[&#x27;path&#x27;].&#x27;/&#x27;.$filename.&#x27;.pdf&#x27;) ) {
            $attachment_title = $property[&#x27;post_title&#x27;] . &#x27; &#x27; . __(&#x27;Flyer&#x27;, &#x27;wpp&#x27;);
              //** Check to see if the flyer is already attached to the object */
            $flyer_id = $wpdb-&gt;get_var( $wpdb-&gt;prepare( &quot;SELECT ID FROM {$wpdb-&gt;posts} WHERE post_title = %s AND post_type=&#x27;attachment&#x27;&quot;, $attachment_title ));

            if($flyer_id){
              update_attached_file( $flyer_id, $uploads[&#x27;path&#x27;].&#x27;/&#x27;.$filename.&#x27;.pdf&#x27; );
            }

            if(!$flyer_id){
                $flyer_url =  $uploads[&#x27;url&#x27;].&#x27;/&#x27;.$filename.&#x27;.pdf&#x27;;//get_pdf_flyer_permalink( $post_id );

                // Attach the PDF and QR code as attachments, need filter to exclude QR code from image galleries
                $object = array(
                    &#x27;post_title&#x27; =&gt; $attachment_title,
                    &#x27;post_content&#x27; =&gt; __(&#x27;PDF flyer for &#x27;, &#x27;wpp&#x27;) . $property[&#x27;post_title&#x27;],
                    &#x27;post_type&#x27; =&gt; &#x27;attachment&#x27;,
                    &#x27;post_parent&#x27; =&gt; $post_id,
                    &#x27;post_date&#x27; =&gt;  current_time(&#x27;mysql&#x27;),
                    &#x27;post_mime_type&#x27; =&gt; &#x27;application/pdf&#x27;,
                    &#x27;guid&#x27; =&gt; $flyer_url
                );

                $flyer_id = wp_insert_attachment($object);
                update_attached_file( $flyer_id, $uploads[&#x27;path&#x27;].&#x27;/&#x27;.$filename.&#x27;.pdf&#x27; );
            }
        }

        if(file_exists($qrcode_path)) {
          //** Remove QR code image if it exists. The reason: It&#x27;s not used anywhere except the current function */
          unlink($qrcode_path);
        }

        return $flyer_id ? $flyer_id : false;
    }


    /**
    * Returns HTML for a default PDF flyer template
    *
    * Called by class_wpp_pdf_flyer::create_flyer_pdf()  if no template is found.
    * @ Todo fix default template.
    * Copyright Usability Dynamics, Inc. &lt;http://usabilitydynamics.com&gt;
    */
    function default_flyer_template($wpp_pdf_flyer,$property) {
        ob_start();
        ?&gt;
        &lt;html&gt;
            &lt;head&gt;
                &lt;title&gt;&lt;/title&gt;
                &lt;style type=&quot;text/css&quot;&gt;
                    div.heading_text {font-size:&lt;?php echo $wpp_pdf_flyer[&#x27;font_size_header&#x27;]; ?&gt;px;border-bottom:2px solid &lt;?php echo (!empty($wpp_pdf_flyer[&#x27;section_bgcolor&#x27;]) ? $wpp_pdf_flyer[&#x27;section_bgcolor&#x27;] : &#x27;#DADADA&#x27;); ?&gt;;}
                    .pdf-text {font-size:&lt;?php echo $wpp_pdf_flyer[&#x27;font_size_content&#x27;]; ?&gt;px;}
                    .pdf-text .attribute .separator{ display: inline-block; padding: 0 5px 0 2px; }
                    .pdf-note {font-size:&lt;?php echo $wpp_pdf_flyer[&#x27;font_size_note&#x27;]; ?&gt;px;}
                    table.bg-header {background-color:&lt;?php echo (!empty($wpp_pdf_flyer[&#x27;header_color&#x27;]) ? $wpp_pdf_flyer[&#x27;header_color&#x27;] : &#x27;#EDEDED&#x27;); ?&gt;;}
                    table.bg-section {background-color:&lt;?php echo (!empty($wpp_pdf_flyer[&#x27;section_bgcolor&#x27;]) ? $wpp_pdf_flyer[&#x27;section_bgcolor&#x27;] : &#x27;#EDEDED&#x27;); ?&gt;;}
                &lt;/style&gt;
            &lt;/head&gt;
            &lt;body&gt;&lt;table cellspacing=&quot;0&quot; cellpadding=&quot;0&quot; border=&quot;0&quot; width=&quot;100%&quot;&gt;
                    &lt;tr&gt;
                        &lt;td height=&quot;15&quot;&gt;&amp;nbsp;
                        &lt;/td&gt;
                    &lt;/tr&gt;
                    &lt;?php if( !empty( $wpp_pdf_flyer[&#x27;logo_url&#x27;] ) ) : ?&gt;
                    &lt;tr&gt;
                        &lt;td&gt;&lt;img class=&quot;header_logo_image&quot; src=&quot;&lt;?php echo $wpp_pdf_flyer[&#x27;logo_url&#x27;]; ?&gt;&quot; alt=&quot;&quot;/&gt;
                        &lt;/td&gt;
                    &lt;/tr&gt;
                    &lt;tr&gt;
                        &lt;td height=&quot;15&quot;&gt;&amp;nbsp;
                        &lt;/td&gt;
                    &lt;/tr&gt;
                    &lt;?php endif; ?&gt;
                    &lt;?php if ( !empty( $wpp_pdf_flyer[&#x27;pr_title&#x27;]) ) : ?&gt;
                    &lt;tr&gt;
                        &lt;td&gt;&lt;table cellspacing=&quot;0&quot; cellpadding=&quot;10&quot; border=&quot;0&quot; class=&quot;bg-header&quot; style=&quot;text-align:left;&quot; width=&quot;100%&quot;&gt;
                                &lt;tr&gt;
                                    &lt;td&gt;&lt;span style=&quot;font-size:&lt;?php echo $wpp_pdf_flyer[&#x27;font_size_header&#x27;]; ?&gt;px;&quot;&gt;&lt;b&gt;&lt;?php echo $property[&#x27;post_title&#x27;];?&gt;&lt;/b&gt;&lt;/span&gt;
                                        &lt;?php $tagline = $property[&#x27;tagline&#x27;]; ?&gt;
                                        &lt;?php if (!empty($wpp_pdf_flyer[&#x27;pr_tagline&#x27;]) &amp;&amp; !empty($tagline)) : ?&gt;
                                      &lt;br/&gt;&lt;span style=&quot;font-size:&lt;?php echo $wpp_pdf_flyer[&#x27;font_size_content&#x27;]; ?&gt;px;color:#797979;&quot;&gt;&lt;?php echo $tagline ?&gt;&lt;/span&gt;
                                        &lt;?php endif; ?&gt;
                                    &lt;/td&gt;
                                &lt;/tr&gt;
                            &lt;/table&gt;
                        &lt;/td&gt;
                    &lt;/tr&gt;
                    &lt;?php endif; ?&gt;
                    &lt;tr&gt;
                        &lt;td height=&quot;15&quot;&gt;&amp;nbsp;
                        &lt;/td&gt;
                    &lt;/tr&gt;
                    &lt;tr&gt;
                        &lt;td&gt;&lt;table cellspacing=&quot;0&quot; cellpadding=&quot;0&quot; border=&quot;0&quot;&gt;
                                &lt;tr&gt;
                                    &lt;td width=&quot;&lt;?php echo $wpp_pdf_flyer[&#x27;first_col_width&#x27;] ?&gt;&quot;&gt;&lt;table&gt;
                                        &lt;?php if( !empty( $wpp_pdf_flyer[&#x27;featured_image_url&#x27;]) ) : ?&gt;
                                        &lt;tr&gt;
                                            &lt;td colspan=&quot;3&quot;&gt;&lt;table cellspacing=&quot;0&quot; cellpadding=&quot;10&quot; border=&quot;0&quot; class=&quot;bg-section&quot;&gt;
                                                &lt;tr&gt;
                                                    &lt;td&gt;&lt;img src=&quot;&lt;?php echo $wpp_pdf_flyer[&#x27;featured_image_url&#x27;]; ?&gt;&quot; width=&quot;&lt;?php echo ($wpp_pdf_flyer[&#x27;first_col_width&#x27;]-20); ?&gt;&quot; alt=&quot;&quot; /&gt;
                                                    &lt;/td&gt;
                                                &lt;/tr&gt;
                                                &lt;/table&gt;
                                            &lt;/td&gt;
                                        &lt;/tr&gt;
                                        &lt;tr&gt;
                                            &lt;td height=&quot;15&quot;&gt;&amp;nbsp;
                                            &lt;/td&gt;
                                        &lt;/tr&gt;
                                        &lt;?php endif; ?&gt;
                                        &lt;tr&gt;
                                            &lt;td id=&quot;left_column&quot; border=&quot;0&quot; width=&quot;&lt;?php echo ($wpp_pdf_flyer[&#x27;first_col_width&#x27;] / 2 - 7 ); ?&gt;&quot;&gt;&lt;table cellspacing=&quot;0&quot; cellpadding=&quot;0&quot; border=&quot;0&quot;&gt;
                                                &lt;?php do_action( &#x27;wpp_flyer_left_column&#x27;, $property, $wpp_pdf_flyer ); ?&gt;
                                                &lt;tr&gt;
                                                    &lt;td&gt;&lt;/td&gt;
                                                &lt;/tr&gt;
                                                &lt;/table&gt;
                                            &lt;/td&gt;
                                            &lt;td width=&quot;14&quot;&gt;&amp;nbsp;
                                            &lt;/td&gt;
                                            &lt;td id=&quot;middle_column&quot; border=&quot;0&quot; width=&quot;&lt;?php echo ($wpp_pdf_flyer[&#x27;first_col_width&#x27;] / 2 - 7 ); ?&gt;&quot;&gt;&lt;table cellspacing=&quot;0&quot; cellpadding=&quot;0&quot; border=&quot;0&quot;&gt;
                                                &lt;?php do_action( &#x27;wpp_flyer_middle_column&#x27;, $property, $wpp_pdf_flyer ); ?&gt;
                                                &lt;tr&gt;
                                                    &lt;td&gt;&lt;/td&gt;
                                                &lt;/tr&gt;
                                                &lt;/table&gt;
                                            &lt;/td&gt;
                                        &lt;/tr&gt;
                                        &lt;/table&gt;
                                    &lt;/td&gt;
                                    &lt;td width=&quot;15&quot;&gt;&amp;nbsp;
                                    &lt;/td&gt;
                                    &lt;td width=&quot;&quot;&gt;&lt;table cellspacing=&quot;0&quot; cellpadding=&quot;0&quot; width=&quot;100%&quot;&gt;
                                        &lt;?php if(is_array($property[&#x27;gallery&#x27;]) &amp;&amp; !empty($property[&#x27;gallery&#x27;])) :
                                          $counter = 0;
                                        ?&gt;
                                        &lt;?php foreach($property[&#x27;gallery&#x27;] as $image) : ?&gt;
                                            &lt;?php
                                            if($counter == $wpp_pdf_flyer[&#x27;num_pictures&#x27;]): break; endif;
                                            $counter++;
                                            $this_image = wpp_get_image_link($image[&#x27;attachment_id&#x27;], $wpp_pdf_flyer[&#x27;secondary_photos&#x27;], array(&#x27;return&#x27; =&gt; &#x27;array&#x27;));
                                            if( empty($this_image)): continue; endif;
                                            ?&gt;

                                              &lt;tr&gt;
                                                  &lt;td&gt;&lt;table cellspacing=&quot;0&quot; cellpadding=&quot;10&quot; border=&quot;0&quot; class=&quot;bg-section&quot;&gt;
                                                      &lt;tr&gt;
                                                          &lt;td&gt;
                                                            &lt;img width=&quot;&lt;?php echo ($this_image[&#x27;width&#x27;] - 20 ); ?&gt;&quot; src=&quot;&lt;?php echo $this_image[&#x27;link&#x27;]; ?&gt;&quot; alt=&quot;&quot; /&gt;

                                                          &lt;/td&gt;
                                                      &lt;/tr&gt;
                                                      &lt;/table&gt;
                                                  &lt;/td&gt;
                                              &lt;/tr&gt;
                                              &lt;tr&gt;
                                                  &lt;td height=&quot;15&quot;&gt;&amp;nbsp;
                                                  &lt;/td&gt;
                                              &lt;/tr&gt;
                                        &lt;?php endforeach; ?&gt;
                                        &lt;?php endif; ?&gt;
                                        &lt;?php do_action( &#x27;wpp_flyer_right_column&#x27;, $property, $wpp_pdf_flyer );?&gt;
                                        &lt;tr&gt;
                                          &lt;td width=&quot;15&quot;&gt;&amp;nbsp;
                                          &lt;/td&gt;
                                        &lt;/tr&gt;
                                        &lt;/table&gt;
                                    &lt;/td&gt;
                                &lt;/tr&gt;
                            &lt;/table&gt;
                        &lt;/td&gt;
                    &lt;/tr&gt;
                &lt;/table&gt;
            &lt;/body&gt;
        &lt;/html&gt;
        &lt;?php
        $html = ob_get_contents();
        ob_clean();
        return $html;
    }

  /**
  * Check if a flyer exists
  *
  * @author odokienko@UD
  */
  function flyer_exists($post_id) {
    global $wpdb;

    foreach( (array) $wpdb-&gt;get_col( $wpdb-&gt;prepare( &quot;
      SELECT ID FROM {$wpdb-&gt;posts} WHERE post_parent = %d AND post_title like %s AND post_type = &#x27;attachment&#x27;;
    &quot;, $post_id, &#x27;% &#x27; . __( &#x27;Flyer&#x27;, &#x27;wpp&#x27; ) ) ) as $attachment_id) {

      $url = wp_get_attachment_url($attachment_id);
      //var_dump(&quot;\$url&quot;, $url);

      $result = wp_remote_retrieve_response_code($url, array( &#x27;timeout&#x27; =&gt; 10));

      if( $result == 200) {
        return true;
      }

    }

    return false;
  }


    /**
  * Add things to Help tab
  *
  * Copyright 2011 TwinCitiesTech.com, Inc.
  */
  function wpp_settings_help_tab() {
  }

  /*
   * Get image size for pdf document
   */
  function get_pdf_image_size($image_size){
    if ($image_size == &#x27;thumbnail&#x27;){
      return 150;
    } elseif ($image_size == &#x27;medium&#x27;){
      return 300;
    } elseif ($image_size == &#x27;large&#x27;){
      return 1024;
    } else {
      $size = WPP_F::image_sizes($image_size);
      return (!empty($size[&#x27;width&#x27;])) ? $size[&#x27;width&#x27;] : false;
    }
  }

    /*
     * Returns ids of properties.
     * Used by AJAX call
     *
     *
     * @return json
     */
    function ajax_get_properties () {
        global $wpdb;
        ob_start();
        $ids = $wpdb-&gt;get_results(&quot;
            SELECT &#x60;pm&#x60;.&#x60;post_id&#x60;,
                &#x60;p&#x60;.&#x60;post_title&#x60;
            FROM {$wpdb-&gt;prefix}postmeta as &#x60;pm&#x60;
            LEFT JOIN {$wpdb-&gt;prefix}posts AS &#x60;p&#x60; ON &#x60;p&#x60;.&#x60;ID&#x60; = &#x60;pm&#x60;.&#x60;post_id&#x60;
            WHERE (meta_key = &#x27;property_type&#x27;)
        &quot;);

        if(!is_array($ids) &amp;&amp; empty($ids)) {
            $ids = array();
        }
        ob_end_clean();
        print json_encode($ids);
        exit();
    }

    /*
     * Generate PDF Flyer for property.
     * Used by AJAX call
     *
     * @return json
     */
    function ajax_generate_pdf_flyer () {
        ob_start();
        $result = array(
            &quot;success&quot; =&gt; 1
        );

        if (!empty($_REQUEST[&#x27;post_id&#x27;])) {
            if(self::create_flyer_pdf((int)$_REQUEST[&#x27;post_id&#x27;]) === false)  {
                $result[&#x27;success&#x27;] = 0;
                $result[&#x27;message&#x27;] = &#x27;Can not generate PDF Flyer.&#x27;;
            }
        } else {
            $result[&#x27;success&#x27;] = 0;
            $result[&#x27;message&#x27;] = &#x27;Property ID is absent.&#x27;;
        }
        ob_end_clean();
        print json_encode($result);
        exit();
    }

    /*
     * Generate PDF List.
     * Used by AJAX call
     *
     * @return json
     */
    function ajax_generate_pdf_list () {
        ob_start();
        $result = array(
            &quot;success&quot; =&gt; 1
        );

        if (!empty($_REQUEST[&#x27;slug&#x27;])) {
            if(self::render_pdf_list($_REQUEST[&#x27;slug&#x27;], &quot;force_generate=true&amp;display=false&quot;)) {
                $result[&#x27;success&#x27;] = 0;
                $result[&#x27;message&#x27;] = &quot;Can not generate PDF List.&quot;;
            }
        } else {
            $result[&#x27;success&#x27;] = 0;
            $result[&#x27;message&#x27;] = &quot;List&#x27;s Slug is absent.&quot;;
        }

        ob_end_clean();
        print json_encode($result);
        exit();
    }

}

  /**
  * Returns link to flyer, or creates a link to on-the-fly Flyer generation if enabled
  *
  * Copyright Usability Dynamics, Inc. &lt;http://usabilitydynamics.com&gt;
  * @author odokienko@UD
  */
  function get_pdf_flyer_permalink($post_id = false, $name = false) {
    global $post, $wpdb, $wp_properties;

    if(!$post_id)
      $post_id = $post-&gt;ID;


    if(!$post_id)
      return false;

    foreach( (array) $wpdb-&gt;get_col( $wpdb-&gt;prepare( &quot;
      SELECT ID FROM {$wpdb-&gt;posts} WHERE post_parent = %d AND post_title like %s AND post_type = &#x27;attachment&#x27;
    &quot;, $post_id, &#x27;% &#x27; . __( &#x27;Flyer&#x27;, &#x27;wpp&#x27; ) ) ) as $attachment_id) {
      //var_dump(wp_get_attachment_metadata($attachment_id));
      return wp_get_attachment_url($attachment_id);

    }

    //** Flyer does not exist, create it */
    $permalink = get_option(&#x27;permalink_structure&#x27;);
    return get_permalink($post_id) . ( &#x27;&#x27; != $permalink ? &#x27;?&#x27; : &#x27;&amp;&#x27;) . &#x27;wpp_flyer_create=true&#x27;;

  }

  /**
  * Return permalink for PDF List
  *
  * @param string $slug Slug of the PDF List
  * Copyright Usability Dynamics, Inc. &lt;http://usabilitydynamics.com&gt;
  */
  function get_pdf_list_permalink ($slug = false) {
    global $wp_properties;

    //** Get Base Url for PDF List */
    $url = WPP_F::base_url($wp_properties[&#x27;configuration&#x27;][&#x27;base_slug&#x27;]);

    //** Determine if permalink is set */
    //** If not, we use GET params */
    $permalink = get_option(&#x27;permalink_structure&#x27;);
    if ( &#x27;&#x27; == $permalink) {
      $slug = &#x27;&amp;pdf_list=&#x27; . $slug;
    } else {
      //** Check url for slash in the end */
      preg_match(&#x27;/\/$/&#x27;, $url, $m);
      if(!$m) {
        $url .= &#x27;/&#x27;;
      }
    }

    return $url . ($slug ? $slug . &#x27;.pdf&#x27; : &#x27;&#x27;);
  }

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
